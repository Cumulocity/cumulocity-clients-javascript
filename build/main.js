(function(){"use strict";checkGettextModule();angular.module("c8y.core",["ngRoute","angularFileUpload","gettext"]).constant("c8yConfig",window.c8yConfig);function checkGettextModule(){try{angular.module("gettext")}catch(e){angular.module("gettext",[]).constant("gettext",identity).constant("gettextCatalog",{getString:identity})}}function identity(str){return str}})();(function(){"use strict";var gettext=_.identity;window.c8yConfig={validation:{deviceId:{pattern:/^[^\s\/]*$/,message:gettext('Device ID must not contain spaces or slashes ("/").')},domain:{pattern:/^[a-z]+[a-z0-9_]*[a-z0-9]+\.{1}.+$/,message:gettext("Only lowercase letters, digits and underscore character allowed in the first part of the URI! It must start with a letter, underscore only allowed in the middle. Must be a valid URI.")},groupName:{maxlength:254},internationalPhoneNumber:{message:gettext("International phone number required, in the format +49 9 876 543 210.")},jsonPath:{pattern:/^(\$\.){0,1}[\$\.\[\]\w\@\<\>\-\*\(\)\d\'\?\s,:]*$/,message:gettext("Must be valid JSONPath expression.")},opcuaBrowsePath:{pattern:/^(opc.tcp|http|https):\/\/[^ "]+$/},password:{pattern:/^[a-zA-Z0-9`~!@#$%^&*()_|+\-=?;:'",.<>\{\}\[\]\\\/]{8,32}$/,message:gettext("Password must have at least 8 characters and no more than 32 and can only contain letters, numbers and following symbols: `~!@#$%^&*()_|+-=?;:'\",.<>{}[]\\/")},phoneNumber:{pattern:/^$|^(\+|0{2})[\d\s\/-]{1,30}$/,message:gettext('Invalid phone number format. Only digits, spaces, slashes ("/") and dashes ("-") allowed.')},tennantId:{pattern:/^[a-z]+[a-z0-9_]*[a-z0-9]+$/,message:gettext("Only lowercase letters, digits and underscore character allowed! Must start with a letter, underscore only allowed in the middle, minimum 2 characters.")},user:{pattern:/^[^\\\/\s$:+]*$/,message:gettext('Username must not contain spaces nor slashes ("/", "\\") nor ("+"), (":"), ("$") signs.')}},deviceListMap:{},tracking:{},smartRules:{},administration:{statistics:{}},deviceDetailControl:{showControls:false}}})();(function(){"use strict";angular.module("c8y.core").factory("c8ySMSGateway",["$http","$q","c8yAlert","c8ySettings",factory]);function factory($http,$q,c8yAlert,c8ySettings){function updateSMSGatewayInfo(username,password){return $http.put("/service/register/messaging",{provider:"openit","openit.baseUrl":"https://sms.openit.de/put.php","sms.senderAddress":"cumulocity","sms.senderName":"cumulocity","openit.username":username,"credentials.openit.password":password})}function getSMSGatewayUsername(){return c8ySettings.detail({category:"messaging",key:"openit.username"})}function deleteSMSGatewayCredentials(){return $q.all([c8ySettings.deleteOption({category:"messaging",key:"openit.username"}),c8ySettings.deleteOption({category:"messaging",key:"credentials.openit.password"})]).then(function(response){return response})}return{updateSMSGatewayInfo:updateSMSGatewayInfo,getSMSGatewayUsername:getSMSGatewayUsername,deleteSMSGatewayCredentials:deleteSMSGatewayCredentials}}})();(function(){"use strict";angular.module("c8y.core").service("c8yAlarms",["$http","c8yBase","c8yCounter","$q","c8yAudits","gettext","gettextCatalog","KeysMixin",C8yAlarms]);function C8yAlarms($http,c8yBase,c8yCounter,$q,c8yAudits,gettext,gettextCatalog,KeysMixin){var self=this;var clean=c8yBase.cleanFields,path="alarm/alarms",pathReports=path+"/reports",defaultConfig={headers:c8yBase.contentHeaders("alarm")},severity={WARNING:gettext("WARNING"),MINOR:gettext("MINOR"),MAJOR:gettext("MAJOR"),CRITICAL:gettext("CRITICAL")},severityList=_.keys(severity),status={ACTIVE:gettext("ACTIVE"),ACKNOWLEDGED:gettext("ACKNOWLEDGED"),CLEARED:gettext("CLEARED")},statusList=_.keys(status),removeKeys=["id"],removeKeysOnUpdate=["id","self","creationTime","type","time","count","history","firstOccurence","firstOccurrenceTime"],icons={},statusAttribute="status";this.reservedKeys=["history","id","severity","self","source","creationTime","time","text","firstOccurrence","count","firstOccurrenceTime","status"];this.standardKeys={type:gettext("Type")};icons[severity.WARNING]="circle";icons[severity.MINOR]="exclamation-circle";icons[severity.MAJOR]="exclamation-circle";icons[severity.CRITICAL]="warning";icons[status.CLEARED]="check-circle";icons[status.ACKNOWLEDGED]="eye";icons[status.ACTIVE]="bell";function buildDetailUrl(alarm){var id=alarm.id||alarm;return c8yBase.url(path+"/"+id)}function list(filters){var url=c8yBase.url(path),_filters=c8yBase.timeOrderFilter(c8yBase.pageSizeNoTotalFilter(filters)),cfg={params:_filters},onList=c8yBase.cleanListCallback("alarms",list,_filters);return $http.get(url,cfg).then(onList)}function detail(alarm){var url=buildDetailUrl(alarm);return $http.get(url)}function create(alarm){var url=c8yBase.url(path),data=clean(alarm,removeKeys);return $http.post(url,data,defaultConfig)}function update(alarm){var url=buildDetailUrl(alarm),data=clean(alarm,removeKeysOnUpdate);return $http.put(url,data,defaultConfig)}function save(alarm){return alarm.id?update(alarm):create(alarm)}function acknowledgedBy(alarm,audits){var username;if(audits){username=fn(audits)}else{username=c8yAudits.list({source:alarm.id,pageSize:1e3}).then(fn)}return username;function fn(audits){var ackBy="--";if(alarm.status===status.ACKNOWLEDGED&&!_.isEmpty(audits)){ackBy=_.last(audits).user}audits.forEach(function(audit){var changes=audit.changes||[];var acknowledged=false;changes.forEach(function(change){if(change.attribute===statusAttribute&&change.newValue===status.ACKNOWLEDGED){acknowledged=true;return false}});if(acknowledged){ackBy=audit.user||ackBy;return false}});return ackBy}}function ackTime(alarm,audits){function fn(audits){var history=audits||[],time=history.length?history[history.length-1].creationTime:undefined;history.forEach(function(historyItem){var changes=historyItem.changes||[],found=false;changes.forEach(function(change){if(change.attribute===statusAttribute&&change.newValue===status.ACKNOWLEDGED){time=historyItem.creationTime;found=true;return false}});if(found){return false}});return time}if(audits){return fn(audits)}else{return c8yAudits.list({source:alarm.id,pageSize:1e3}).then(fn)}}function alarmDuration(alarm,audits){var diff=alarmDurationDiff(alarm,audits);if(diff.humanize){return diff.humanize()}else{return diff.then(function(d){return d.humanize?d.humanize():""})}}function alarmDurationDiff(alarm,audits){function fn(audits){var history=audits||[],time=alarm.creationTime,endTime=history.length?history[history.length-1].creationTime:undefined,diff="";_.forEach(history,function(historyItem){var changes=historyItem.changes||[],found=false;changes.forEach(function(change){if(change.attribute===statusAttribute&&change.newValue===status.CLEARED){endTime=historyItem.creationTime;found=true;return false}});if(found){return false}});if(time&&endTime){var _time=moment(time),_endTime=moment(endTime);diff=moment.duration(_time.diff(_endTime))}return diff}if(audits){return fn(audits)}else{return c8yAudits.list({source:alarm.id,pageSize:1e3}).then(fn)}}function icon(alarm){var severity=(_.isObjectLike(alarm)?alarm.severity:alarm).toUpperCase();return icons[severity]}function buildReportUrl(report,filters){var parts=[pathReports,report];if(filters.id){parts.push(filters.id)}return c8yBase.url(parts.join("/"))}function reportDownTimeDuration(filters){var report="downtimeDuration",_filters=c8yBase.timeOrderFilter(filters),url=buildReportUrl(report,_filters),cfg={params:_filters};return $http.get(url,cfg)}function createCounter(filter){var counter=new c8yCounter.Counter(list,"/alarms/*");if(filter){var filterConfig=[c8yCounter.defaultPropertyMaps.date,c8yCounter.defaultPropertyMaps.source];if(filter.type){var type=filter.type;filterConfig.push([function(obj){return type===obj.type}])}delete filter.type;counter.filter(filter,filterConfig)}return counter}function listByStatus(status,filters){return $q.all(_.map(status,function(value,key){if(value){filters.status=key;return list(filters)}})).then(onAlarms)}function listByDevices(ids,filters){return $q.all(_.map(ids,function(id){filters.source=id;return list(filters)})).then(onAlarms)}function getSeverityCount(alarms,severity){var result=_.filter(alarms,{severity:severity});return result.length}function onAlarms(alarms){return _.filter(alarms,function(alarm){return!_.isUndefined(alarm)})}function memoize(fn){var memoizedFn=_.memoize(fn,function(alarm){return[alarm.id,alarm.status,alarm.count].join(":")});return function(alarm,auditList){return memoizedFn(alarm,auditList)}}function statusText(alarm,audits){var statusFn;var alarmStatus=(alarm.status||"").toUpperCase();switch(alarmStatus){case status.ACKNOWLEDGED:statusFn=getStatusMessageAcknowledged;break;case status.CLEARED:statusFn=getStatusMessageCleared;break;case status.ACTIVE:statusFn=getStatusMessageActive;break}return statusFn&&statusFn(alarm,audits)}function getStatusMessageAcknowledged(alarm,audits){var ackBy=$q.when(self.acknowledgedBy(alarm,audits));var ackTime=$q.when(self.ackTime(alarm,audits));return $q.all([ackBy,ackTime]).then(function(results){return gettextCatalog.getString("ACKNOWLEDGED by: {{ackBy}} {{ackTimeFromNow}}",{ackBy:results[0],ackTimeFromNow:moment(results[1]).fromNow()})})}function getStatusMessageCleared(alarm,audits){return $q.when(self.alarmDuration(alarm,audits)).then(function(alarmDuration){return gettextCatalog.getString("CLEARED: was active for {{alarmDuration}}",{alarmDuration:alarmDuration})})}function getStatusMessageActive(alarm){return $q.when(gettextCatalog.getString("ACTIVE: triggered {{alarmTimeFromNow}}",{alarmTimeFromNow:moment(alarm.time).fromNow()}))}_.assign(this,{list:list,listByStatus:listByStatus,listByDevices:listByDevices,getSeverityCount:getSeverityCount,detail:detail,update:update,create:create,save:save,acknowledgedBy:memoize(acknowledgedBy),ackTime:memoize(ackTime),alarmDuration:memoize(alarmDuration),alarmDurationDiff:memoize(alarmDurationDiff),severity:severity,severityList:severityList,status:status,statusList:statusList,statusText:memoize(statusText),icon:icon,reports:{downtimeDuration:reportDownTimeDuration},createCounter:createCounter});_.assign(this,KeysMixin);_.bindAll(this,_.keys(KeysMixin))}})();(function(){"use strict";angular.module("c8y.core").factory("c8yApplication",["$http","$location","$q","$window","$interval","$timeout","$log","$injector","c8yBase","c8yUser","c8yInventory","$upload","gettext",c8yApplication]);function c8yApplication($http,$location,$q,$window,$interval,$timeout,$log,$injector,c8yBase,c8yUser,c8yInventory,$upload,gettext){var basePath="application/",basePath2=basePath+"applications",defaultConfig={headers:c8yBase.contentHeaders("application",true)},self=this,iconMap={HOSTED:"cloud",EXTERNAL:"external-link-square",SMARTAPP:"puzzle-piece"},typeLabelMap={HOSTED:gettext("Hosted application"),REPOSITORY:gettext("Repository"),EXTERNAL:gettext("External application")},c8yLocales,PLUGINS_LIST_PAGE_SIZE=1e3;try{c8yLocales=$injector.get("c8yLocales")}catch(e){c8yLocales={getTranslatedServerMessage:_.identity}}gettext("Administration");gettext("Cockpit");gettext("Device management");gettext("Fieldbus4");function clean(app){var _app=_.cloneDeep(app);delete _app.type;return _app}function cleanFileName(name){return name.replace(/\s+/g,"_")}function _list(path,filters){return c8yUser.current().then(function(user){var tenant=user.tenant,_filters=c8yBase.pageSizeFilter(filters),cfg={params:_filters,cache:true},url=c8yBase.url(path)+"/"+tenant,onList=c8yBase.cleanListCallback("applications",angular.bind(self,_list,path),_filters);return $http.get(url,cfg).then(onList).then(rejectBackendApplications)})}function listByUser(user,filters){return c8yUser.current().then(function(currentUser){user=user||currentUser;var _filters=c8yBase.pageSizeFilter(filters),cfg={params:_.defaults(_filters,{noPaging:true,dropOverwrittenApps:true}),cache:true},url=c8yBase.url(basePath+"applicationsByUser/"+encodeURIComponent(user.id)),onList=c8yBase.cleanListCallback("applications",angular.bind(self,listByUser,user),_filters);return $http.get(url,cfg).then(onList).then(rejectBackendApplications)})}function convertType(app){app=_.cloneDeep(app);if(app.type===undefined){return app}app.type=isTypeRepository(app)?"REPOSITORY":app.type;return app}function isTypeRepository(app){return app.type==="HOSTED"&&app.resourcesUrl&&app.resourcesUrl.charAt(0)!=="/"}function listByOwner(filters){return _list(basePath+"applicationsByOwner",filters)}function listByTenant(filters){return _list(basePath+"applicationsByTenant",filters)}function listPlugins(){var url=c8yBase.url(basePath+"plugins"),cfg={params:{pageSize:PLUGINS_LIST_PAGE_SIZE}};return $http.get(url,cfg).then(function(res){return _.uniqBy(res.data.plugins,"id")})}function listPluginsByTenant(){return listByTenant().then(function(apps){apps=_.uniqBy(apps,"id");var pluginPromises=[];_.forEach(apps,function(app){if(isHostedOrRepositoryApp(app)){pluginPromises.push(listPluginsByApplication(app))}});return $q.all(pluginPromises).then(_.flattenDeep).then(_.partialRight(_.uniqBy,function(p){return p.id}))})}function listPluginsByApplication(app){var url=c8yBase.url(basePath2+"/"+app.contextPath+"/manifest"),cfg={params:c8yBase.pageSizeNoTotalFilter()};return $http.get(url,cfg).then(function(res){return _.map(res.data.imports,getPluginFromImportedManifest)})}listPluginsByPaasApp._cache={};function listPluginsByPaasApp(app){var cache=listPluginsByPaasApp._cache;var delay=2e3;var appId=app.id||app,url=c8yBase.url(basePath2+"/"+appId+"/binaries/plugins"),cfg={params:c8yBase.pageSizeNoTotalFilter()},cleanCache=function(){delete cache[appId]},request=function(){return $http.get(url,cfg).then(c8yBase.getResData).finally(cleanCache)};if(!cache[appId]){cache[appId]=$timeout(_.noop,delay).then(request)}return cache[appId]}function getPluginFromImportedManifest(manifest){return{id:manifest.id,contextPath:manifest.rootContextPath,directoryName:manifest.directoryName,manifest:manifest}}function buildDetailUrl(app){var id=app.id||app;return c8yBase.url(basePath2+"/"+id)}function detail(app){var url=buildDetailUrl(app);return $http.get(url)}function remove(app){var url=buildDetailUrl(app),_app=_.isObjectLike(app)?app:{id:app},actions=[];var configPromise=getConfig(_app).then(function(app){if(app.config&&app.config.id){return c8yInventory.remove(app.config)}return true});actions.push(configPromise);actions.push($http.delete(url));return $q.all(actions)}function update(app,cfg){var url=buildDetailUrl(app),cleanData=clean(app),_cfg=_.defaults(cfg||{},defaultConfig);return $http.put(url,cleanData,_cfg).finally(function(){$window.localStorage.setItem("refresh",app.contextPath)})}function create(app,cfg){var url=c8yBase.url(basePath2),_cfg=_.defaults(cfg||{},defaultConfig);return $http.post(url,app,_cfg)}function revertType(app){app=_.cloneDeep(app);if(app.type==="HOSTED"){app.resourcesUrl="/"}if(app.type==="REPOSITORY"){app.type="HOSTED"}return app}function updateManifest(appId,manifest){return detail(appId).then(function(res){var app=res.data;app.manifest=manifest;return app}).then(update)}function save(app,cfg){return app.id?update(app,cfg):create(app,cfg)}function trySave(app,cfg,retryNo,deferred){var maxSaveRetries=10;var _app=_.cloneDeep(app);retryNo=retryNo||0;deferred=deferred||$q.defer();_app.name=retryNo===0?app.name:[app.name,retryNo].join("-");_app.key=retryNo===0?app.key:[app.key,retryNo].join("-");_app.contextPath=retryNo===0?app.contextPath:[app.contextPath,retryNo].join("-");save(_app,{silentError:true}).then(function(res){deferred.resolve(c8yBase.getResData(res))},function(res){if(res.status===409&&retryNo<maxSaveRetries){trySave(app,cfg,retryNo+1,deferred)}else{var svrMsg=res&&res.data&&(res.data.message||res.data.details&&res.data.details.exceptionMessage);var msg=svrMsg&&c8yLocales.getTranslatedServerMessage(svrMsg)||gettext('Could not create application due to an error! Click "More" for details.');deferred.reject({errorMessage:msg,errorDetails:res})}});return deferred.promise}function clone(srcApp,newAppProps){var url=buildDetailUrl(srcApp)+"/clone";return $http.post(url).then(c8yBase.getResData).then(function(clonedApp){if(_.isObjectLike(newAppProps)){_.assign(clonedApp,newAppProps);return trySave(clonedApp).then(c8yBase.getResData)}return clonedApp})}function listArchives(app,filter){var url=buildDetailUrl(app)+"/binaries";filter=c8yBase.pageSizeNoTotalFilter(filter);var cfg={params:filter};return $http.get(url,cfg).then(c8yBase.getResData)}function uploadArchive(app,file){var url=buildDetailUrl(app)+"/binaries";return $upload.upload({url:url,method:"POST",headers:{Content:"multipart/form-data",Accept:"application/json"},file:file,fileName:cleanFileName(file.name)})}function deleteArchive(app,archive){var id=archive.id||archive;var url=[buildDetailUrl(app),"binaries",id].join("/");return $http.delete(url)}function setActiveArchive(app,archive){return save({id:app.id,activeVersionId:archive.id})}function addPaasAppPlugin(app,archive){var pluginName=getPluginNameFromArchive(archive);var url=buildDetailUrl(app)+"/binaries/plugins/"+pluginName;var uploadPromise=$upload.upload({url:url,method:"POST",headers:{Content:"multipart/form-data",Accept:"application/json"},file:archive});var finalPromise=uploadPromise.then(_.partial(refreshPaasApp,app));finalPromise.progress=uploadPromise.progress;return finalPromise}function getPluginNameFromArchive(archive){var name=archive.name.split(".");name.pop();return name.join(".")}function refreshPaasApp(app){var appDetails=detail(app).then(c8yBase.getResData);var appPlugins=appDetails.then(listPluginsByPaasApp);var appManifest=appDetails.then(getPaasAppManifest);var appIndex=appDetails.then(getPaasAppIndex);return $q.all([appDetails,appPlugins,appManifest,appIndex]).then(function(promises){var appDetails=promises[0];var appPlugins=sortPaasAppPlugins(promises[1]);var appManifest=promises[2];var appIndex=promises[3];return $q.all([getUpdatedPaasAppManifest(appDetails,appPlugins,appManifest),getUpdatedPaasAppIndex(appDetails,appPlugins,appIndex)]).then(function(promises){var newAppManifest=promises[0];var newAppIndex=promises[1];return uploadPaasAppFiles(app,[{path:"cumulocity.json",file:new Blob([JSON.stringify(newAppManifest)],{type:"application/json"})},{path:"index.html",file:new Blob([newAppIndex],{type:"text/html"})}])})})}function sortPaasAppPlugins(appPlugins){var sortedPlugins=[];appPlugins=_.sortBy(appPlugins,function(p){return p&&p.pluginPackage&&-p.pluginPackage.priority||0});_.forEach(appPlugins,function(appPlugin){addPluginToList(appPlugin,sortedPlugins,appPlugins)});return sortedPlugins}function addPluginToList(plugin,sortedPlugins,appPlugins){var alreadyAdded=findPlugin(sortedPlugins,plugin&&plugin.pluginPackage&&plugin.pluginPackage.contextPath);if(alreadyAdded){return}var importedPluginsContextPaths=plugin&&plugin.pluginPackage&&plugin.pluginPackage.imports||[];_.forEach(importedPluginsContextPaths,function(ctxPath){var depPlugin=findPlugin(appPlugins,ctxPath);if(depPlugin){addPluginToList(depPlugin,sortedPlugins,appPlugins)}else{$log.error("Plugin with context path "+ctxPath+" is missing.")}});sortedPlugins.push(plugin)}function findPlugin(list,contextPath){var ctxPath=getPluginPaasContextPath(contextPath);return _.find(list,function(p){return p&&p.pluginPackage&&p.pluginPackage.contextPath===ctxPath})}function getPluginPaasContextPath(contextPath){var ctx=contextPath;if(replacePluginPath(ctx)){ctx=ctx.replace(/\//g,"_")}return ctx}function replacePluginPath(context){return/^core\//.test(context)||/^administration\//.test(context)||/^devicemanagement\//.test(context)||/^cockpit\//.test(context)||/^platformadmin\//.test(context)||/^fieldbus4\//.test(context)||/^fieldbus3\//.test(context)||/^fieldbus2\//.test(context)||/^fieldbus\//.test(context)||/^demoboard\//.test(context)||/^vendme_plugins\//.test(context)}function getPaasAppManifest(appDetails){var url=buildWebUrl(appDetails)+"/cumulocity.json";return $http.get(url).then(c8yBase.getResData)}function getPaasAppIndex(appDetails){var url=buildWebUrl(appDetails)+"/index.html";return $http.get(url).then(c8yBase.getResData)}function buildWebUrl(appDetails){return c8yBase.url("apps/"+appDetails.contextPath)}function getUpdatedPaasAppManifest(appDetails,appPlugins,appManifest){var newAppManifest=_.cloneDeep(appManifest);newAppManifest.imports.length=0;_.forEach(appPlugins,function(appPlugin){newAppManifest.imports.push(appPlugin.pluginName)});return newAppManifest}function getUpdatedPaasAppIndex(appDetails,appPlugins,appIndex){appIndex=replacePaasAppIndexCSS(appDetails,appPlugins,appIndex);appIndex=replacePaasAppIndexJS(appDetails,appPlugins,appIndex);appIndex=replacePaasAppIndexNgModules(appDetails,appPlugins,appIndex);return appIndex}function replacePaasAppIndexCSS(appDetails,appPlugins,appIndex){var cssFiles=_(appPlugins).map(function(appPlugin){var flist=appPlugin.pluginPackage&&appPlugin.pluginPackage.css||[];flist=!flist.length?appPlugin.pluginPackage&&appPlugin.pluginPackage.less||[]:flist;return flist.length?appPlugin.pluginName+"/style.css":false}).filter(_.identity).value();var cssPrioritized=_.flattenDeep(["<!--MODULES_CSS-->",_.map(cssFiles.slice(0,1),function(cssFilePath){return'<link rel="stylesheet" href="'+cssFilePath+'"></link>'}),"<!--/MODULES_CSS-->"]).join("\n");var cssDeferred=_.flattenDeep(["<!--MODULES_CSS_DEFER-->","<script>",["[",'"'+cssFiles.slice(1).join('", "')+'"',"].forEach(function(f){loadCSS(f)})"].join(""),"</script>","<!--/MODULES_CSS_DEFER-->"]).join("\n");appIndex=appIndex.replace(new RegExp("<!--MODULES_CSS-->(.|\n|\r)*<!--\\/MODULES_CSS-->","gm"),cssPrioritized);return appIndex.replace(new RegExp("<!--MODULES_CSS_DEFER-->(.|\n|\r)*<!--\\/MODULES_CSS_DEFER-->","gm"),cssDeferred)}function replacePaasAppIndexJS(appDetails,appPlugins,appIndex){var js=_.flattenDeep(["<!--MODULES_JS-->",_(appPlugins).map(function(appPlugin){var flist=appPlugin.pluginPackage&&appPlugin.pluginPackage.js||[];return flist.length?appPlugin.pluginName+"/main.js":false}).filter(_.identity).map(function(jsFilePath){return'<script defer src="'+jsFilePath+'"></script>'}).value(),"<!--/MODULES_JS-->"]).join("\n");return appIndex.replace(new RegExp("<!--MODULES_JS-->(.|\n|\r)*<!--\\/MODULES_JS-->","gm"),js)}function replacePaasAppIndexNgModules(appDetails,appPlugins,appIndex){var c8yNgModules=['C8Y_NG_MODULES=["',_.uniq(_.flattenDeep(_.map(appPlugins,function(appPlugin){return appPlugin.pluginPackage&&appPlugin.pluginPackage.ngModules||[]}))).join('","'),'"];'].join("");return appIndex.replace(new RegExp("C8Y_NG_MODULES=\\[(.|\n|\r)*?\\];","gm"),c8yNgModules)}function uploadPaasAppFiles(app,files){var url=buildDetailUrl(app)+"/binaries/files";var fd=new FormData;_.forEach(files,function(f){fd.append(f.path,new File([f.file],f.path))});return $http.post(url,fd,{transformRequest:_.identity,headers:{"Content-Type":undefined}})}function removePaasAppPlugin(app,plugin){var pluginName=plugin.pluginName||plugin;var url=buildDetailUrl(app)+"/binaries/plugins/"+pluginName;return $http.delete(url).then(_.partial(refreshPaasApp,app))}function isPaasApp(app){return getPaasAppManifest(app).then(function(paasAppManifest){return paasAppManifest._webpaas},function(){return false})}function createUrl(app){var port=$location.port();if(port===80||port===443){port=""}else{port=":"+port}return $location.protocol()+"://"+$location.host()+port+"/apps/"+(app.public?"public/":"")+app.contextPath}function getCurrentContextPath(){var match=$window.location.pathname.match(/\/apps\/(public\/){0,1}(.+?)(\/|\?|\#|$)/);return match&&match[2]}function isCurrentAppAccessedViaPublicEndpoint(){var match=$window.location.pathname.match(/\/apps\/(public\/([^\/]+)|([^\/]+))/);return match&&match[1].indexOf("public")!==-1}function getCurrent(){var currentContextPath=getCurrentContextPath();var accessedViaPublic=!!isCurrentAppAccessedViaPublicEndpoint();function findApp(app){var isMarket=app.availability==="MARKET";var matchesContextPath=app.contextPath===currentContextPath;return matchesContextPath&&(!accessedViaPublic||isMarket)}return listByUser(null,{dropOverwrittenApps:false}).then(function(applications){var currentApp=_.find(applications,findApp);return currentApp})}function getAppConfig(_app){return c8yInventory.list({type:"c8y_SmartAppApplication"}).then(function(apps){var config=null;apps.forEach(function(app){if(app.appId===_app.id){config=app;return false}});return config})}function getConfig(app){var outputApp,promise=app?$q.when(app):getCurrent();return promise.then(function(app){outputApp=app;return app}).then(getAppConfig).then(function(config){outputApp.config=config;return outputApp})}function getRefreshMessage(ignore){var contextPath=$window.localStorage.getItem("refresh");if(contextPath===getCurrentContextPath()){$window.localStorage.setItem("refresh",undefined);if(!ignore){$window.location.reload()}}}function getHref(app){return isHostedOrRepositoryApp(app)?createUrl(app):app.externalUrl}function icon(application){var type=_.isString(application)?application:application.type;if(application.manifest){type="SMARTAPP"}return iconMap[type]}function typeLabel(application){var type=_.isString(application)?application:application.type;return typeLabelMap[type]}function pollRefreshMessages(){$interval(function(){getRefreshMessage()},1e3,0,false)}function filterApplications(apps){return _(apps).uniq("id").filter(function(app){var manifest=app.manifest;var noAppSwitcher=false;var visibleApplicationTypes=["HOSTED","EXTERNAL"];if(manifest){noAppSwitcher=manifest.noAppSwitcher}return!noAppSwitcher&&_.includes(visibleApplicationTypes,app.type)}).value()}function rejectBackendApplications(apps){var filteredApps=_.reject(apps,function(app){return app.name==="management"&&app.owner.tenant.id==="management"});_.assign(filteredApps,_.pick(apps,_.filter(_.keys(apps),isNaN)));return filteredApps}function listByVisibleLinks(){return listByUser().then(filterApplications).then(function(applications){return $q.when(applications)})}function parseAppName(name){if(name&&name.toLowerCase()==="devicemanagement"){return"Device management"}return name||"Cumulocity"}function isHostedOrRepositoryApp(app){return app.type==="HOSTED"||app.type==="REPOSITORY"}if(c8yBase.getFlag("test")){currentAppCached._cache=$q.when({name:"app",manifest:{}})}function currentAppCached(){if(currentAppCached._cache){return currentAppCached._cache}function config(url){return{url:url,noAppKey:true}}function manifest(){return $http(config([c8yBase.url(basePath2),(isCurrentAppAccessedViaPublicEndpoint()?"public/":"")+getCurrentContextPath(),"manifest"].join("/")))}function getAppDetail(res){return $http(config([c8yBase.url(basePath2),res.data.application.id].join("/")))}return manifest().then(getAppDetail).then(c8yBase.getResData).then(function(currentApp){currentAppCached._cache=$q.when(currentApp);return currentAppCached._cache})}return{list:listByTenant,listByUser:listByUser,listByTenant:listByTenant,listByOwner:listByOwner,listPlugins:listPlugins,listPluginsByTenant:listPluginsByTenant,listPluginsByApplication:listPluginsByApplication,listPluginsByPaasApp:listPluginsByPaasApp,listByVisibleLinks:listByVisibleLinks,detail:detail,update:update,create:create,remove:remove,save:save,trySave:trySave,clone:clone,getHref:getHref,icon:icon,typeLabel:typeLabel,getCurrent:getCurrent,getConfig:getConfig,pollRefreshMessages:pollRefreshMessages,getCurrentContextPath:getCurrentContextPath,updateManifest:updateManifest,listArchives:listArchives,uploadArchive:uploadArchive,deleteArchive:deleteArchive,setActiveArchive:setActiveArchive,addPaasAppPlugin:addPaasAppPlugin,removePaasAppPlugin:removePaasAppPlugin,uploadPaasAppFiles:uploadPaasAppFiles,getPaasAppManifest:getPaasAppManifest,refreshPaasApp:refreshPaasApp,isPaasApp:isPaasApp,convertType:convertType,revertType:revertType,parseAppName:parseAppName,currentAppCached:currentAppCached}}})();(function(){"use strict";angular.module("c8y.core").service("c8yAudits",C8yAudits);function C8yAudits($http,c8yBase,KeysMixin,gettext){var clean=c8yBase.cleanFields;var path="audit/auditRecords";var defaultConfig={headers:c8yBase.contentHeaders("auditRecord")};var severity={WARNING:"WARNING",MINOR:"MINOR",MAJOR:"MAJOR",CRITICAL:"CRITICAL"};var severityList=_.keys(severity);var _reservedKeys=["id","self","creationTime"];var removeKeys=_reservedKeys;this.types={User:gettext("User"),Group:gettext("Group"),Alarm:gettext("Alarm"),Operation:gettext("Operation"),SmartRule:gettext("Smart Rule"),CepModule:gettext("Event processing"),Tenant:gettext("Tenant")};this.reservedKeys=_reservedKeys;this.standardKeys={};_.assign(this,{list:list,detail:detail,create:create,severity:severity,severityList:severityList});_.assign(this,KeysMixin);_.bindAll(this,_.keys(KeysMixin));function buildDetailUrl(audit){var id=audit.id||audit;return c8yBase.url(path+"/"+id)}function list(filters){var url=c8yBase.url(path);var _filters=c8yBase.pageSizeNoTotalFilter(filters);if(_filters.revert){var minMaxDates=c8yBase.timeOrderFilter({});_filters.dateFrom=_filters.dateFrom||minMaxDates.dateFrom;_filters.dateTo=_filters.dateTo||minMaxDates.dateTo}var cfg={params:_filters};var onList=c8yBase.cleanListCallback("auditRecords",list,_filters);return $http.get(url,cfg).then(onList)}function detail(audit){var url=buildDetailUrl(audit);return $http.get(url)}function create(audit){var url=c8yBase.url(path);var data=clean(audit,removeKeys);return $http.post(url,data,defaultConfig)}}})();(function(){"use strict";angular.module("c8y.core").factory("c8yAuth",c8yAuth).config(["$httpProvider",config]);function config($httpProvider){$httpProvider.interceptors.push("c8yAuth")}function c8yAuth($location,$rootScope,$injector,$q,$log,$window,$timeout,info){var TOKEN_KEY="_tcy8";var TFATOKEN_KEY="TFAToken";var HEADER_APPKEY="X-Cumulocity-Application-Key";var PASSWORD_RESET_USER={u:"passwordreset",p:"p455w0rdr3537"};var URL_PARAM_PASSWORD_RESET="token";var authTokenDefered=$q.defer();var emptyDefer=$q.defer();var testHtml=/\.html$/;var testJson=/\.json$/;var urlObj=document.createElement("a");var authState={hasAuth:false};var appKey=info.appKey;var resetPasswordToken;var authToken;var lastTriedAuthToken;var TFAToken;var $http;var c8yBase;var c8yApplication;emptyDefer.resolve();setRecoverPassToken(info.passResetToken||search().token);function search(){if($location.search){return $location.search()}return{}}function decodeToken(token){var decoded=decodeURIComponent(escape(atob(token)));var split=decoded.match(/(([^\/]*)\/)?([^\/:]+):(.+)/);return{tenant:split[2],user:split[3],password:split[4]}}function encodeToken(user,password,tenant){var str=(tenant?tenant+"/":"")+user+":"+password;return btoa(unescape(encodeURIComponent(str)))}function updatePassword(password){var decodedToken=decodeToken(authToken);var token=encodeToken(decodedToken.user,password,decodedToken.tenant);return onSetToken(token)}function transformApiRequest(config){if(!config.headers){config.headers={}}_.defaults(config.headers,headers());return config}function hasAuthHeader(config){return!!(config.headers&&config.headers.Authorization)}function shouldWaitForAppKey(config){return!authToken||!config.noAppKey}function request(config){var url=config.url;var isApi=isApiDomain(url);if(!isApi||testHtml.test(url)||testJson.test(url)){return config}var wait=isApi&&!hasAuthHeader(config)&&shouldWaitForAppKey(config);var promise;if(wait){if(!out.initializing.done){promise=$q.all([out.initializing,authTokenDefered.promise])}else{promise=authTokenDefered.promise}}else{promise=emptyDefer.promise}var doTransform=isApi?_.partial(transformApiRequest,config):function(){return config};if(authToken&&window.c8y_testing){return doTransform()}return promise.then(doTransform)}function logout(){clearTokens();if(_.isFunction(info.logout)){info.logout()}}function responseError(rejection){if(rejection.headers("tfatokenexpired")&&authState.hasAuth){logout()}return $q.reject(rejection)}function isApiDomain(url){var baseUrl=info.baseUrl||"/"
;if(!url){return true}urlObj.href=url||"";var host=urlObj.host;return baseUrl.length>1&&url.indexOf(baseUrl)>-1||!host||host===fullHost()}function fullHost(){var host=$location.host();var port=$location.port();if(port===80||port===443){return host}return[host,port].join(":")}function setAuthToken(token){lastTriedAuthToken=token;var url=c8yBase.url("user/currentUser?auth");if(window.c8y_testing){return $q.when(onSetToken(token))}var httpConfig={url:url,silentError:true,headers:{Authorization:token?"Basic "+token:undefined,UseXBasic:true,Accept:"application/vnd.com.nsn.cumulocity.user+json;"}};return $http(httpConfig).then(c8yBase.getResData).then(_.partial(updateTokenFromUser,token)).then(onSetToken)}function updateTokenFromUser(token,user){var decodedToken=decodeToken(token);return encodeToken(decodedToken.user,decodedToken.password,getTenantFromUser(user))}function getTenantFromUser(user){return user.self.match(/\/user\/(\w+)\//)[1]}function onSetToken(token){authToken=info.token=token;setAppKey(info.appKey);var needsAppKey=!appKey;var promise=needsAppKey?fetchAppInfo():$q.when();updateSavedAuthToken();return promise.then(authReady)}function clearAuthToken(){delete info.token;if(authTokenDefered.promise.$$state.status){authTokenDefered=$q.defer()}notifyAuthState({hasAuth:false});clearSavedAuthToken()}function fetchAppInfo(){return c8yApplication.currentAppCached().then(function(app){info.appConfig=_.defaults(info.appConfig||{},app);setAppKey(app.key)})}function authReady(){authTokenDefered.resolve();notifyAuthState({hasAuth:true})}function notifyAuthState(state){if(_.isEqual(state,authState)){return}else{authState=state;$rootScope.$emit("authStateChange",authState)}}function clearTFAToken(){TFAToken=undefined;delete info.TFAToken;clearSavedTFAToken()}function setTFAToken(token){TFAToken=info.TFAToken=token;saveToken(TFAToken,true,TFATOKEN_KEY)}function clearTokens(){clearTFAToken();clearAuthToken()}function saveToken(token,remember,key){var storage=$window[(remember?"local":"session")+"Storage"];storage.setItem(key,token)}function getSavedToken(key){return $window.localStorage.getItem(key)||$window.sessionStorage.getItem(key)}function updateSavedAuthToken(){if($window.sessionStorage){$window.sessionStorage.setItem(TOKEN_KEY,authToken)}if($window.localStorage.getItem(TOKEN_KEY)){$window.localStorage.setItem(TOKEN_KEY,authToken)}}function saveAuthToken(remember){saveToken(authToken,remember,TOKEN_KEY)}function setAppKey(key){appKey=info.appKey=key}function clearSavedAuthToken(){$window.localStorage.removeItem(TOKEN_KEY);$window.sessionStorage.removeItem(TOKEN_KEY)}function clearSavedTFAToken(){$window.localStorage.removeItem(TFATOKEN_KEY)}function checkSavedTokens(){var savedAuthToken=info.token||getSavedToken(TOKEN_KEY);var savedTFAToken=info.TFAToken||getSavedToken(TFATOKEN_KEY);setAppKey(info.appKey);if(savedTFAToken){setTFAToken(savedTFAToken)}if(savedAuthToken){var promise=setAuthToken(savedAuthToken);promise.catch(clearSavedAuthToken);return promise}return $q.when()}function headers(){var headers={Authorization:authToken?"Basic "+authToken:undefined,tfatoken:TFAToken,UseXBasic:true};headers[HEADER_APPKEY]=appKey;return headers}function headersResetUser(tenant){var token=encodeToken(PASSWORD_RESET_USER.u,PASSWORD_RESET_USER.p,tenant);return{Authorization:"Basic "+token}}function resetPasword(user){var config={silentError:true,url:c8yBase.url("user/passwordReset"),method:"POST",data:{email:user.email},headers:headersResetUser(user.tenant)};return $http(config)}function changePasswordWithResetToken(user){var tenant=user.tenant;var newPassword=user.newPassword;var passwordStrength=(user.passwordStrength||"").toUpperCase();var config={silentError:true,url:c8yBase.url("user/passwordReset"),method:"PUT",data:{token:resetPasswordToken,newPassword:newPassword,passwordStrength:passwordStrength},headers:headersResetUser(tenant)};function onSuccess(res){resetPasswordToken=undefined;$location.url($location.path());return res}return $http(config).then(onSuccess)}function setRecoverPassToken(token){resetPasswordToken=token}function verifyTFACode(code){clearSavedTFAToken();var config={url:c8yBase.url("user/pin"),data:{pin:code},method:"POST",silentError:true,headers:{Authorization:"Basic "+lastTriedAuthToken,"Content-Type":"application/vnd.com.nsn.cumulocity.user+json;"}};return $http(config).then(onTFAVerification)}function onTFAVerification(res){var tfatoken=res.headers("tfatoken");if(tfatoken){setTFAToken(tfatoken)}setAuthToken(lastTriedAuthToken)}function getPassword(){return authToken&&decodeToken(authToken).password}function mustEnforcePasswordStrength(tenant){var settings=[{path:"system/options/password/enforce.strength",prop:"systemLevel",checkFn:function(res){return(res.data||{}).value==="true"}},{path:"security-options/password/strength.validity",prop:"tenantLevel",checkFn:function(res){return(res.data||{}).value==="true"}}];return getOptionSettings(settings,tenant).then(function(props){return props.systemLevel||props.tenantLevel})}function getPasswordMinGreenLength(tenant){var settings=[{path:"system/options/password/green.min-length",prop:"minGreenLength",checkFn:function(res){return _.parseInt((res.data||{}).value)}}];return getOptionSettings(settings,tenant).then(function(props){return props.minGreenLength})}function getOptionSettings(settings,tenant){var promises=_.map(settings,function(obj){var o={};o[obj.prop]=false;return $http({url:c8yBase.url("tenant/"+obj.path),headers:headersResetUser(tenant),silentError:true}).then(function(res){var o={};o[obj.prop]=obj.checkFn(res);return o}).catch(function(){return o})});return $q.all(promises).then(function(objs){var props=_.reduce(objs,function(merged,o){return _.assign(merged,o)},{});return props})}var out={decodeToken:decodeToken,encodeToken:encodeToken,logout:logout,updatePassword:updatePassword,request:request,responseError:responseError,setAuthToken:setAuthToken,clearTokens:clearTokens,setTFAToken:setTFAToken,clearTFAToken:clearTFAToken,saveAuthToken:saveAuthToken,checkSavedTokens:checkSavedTokens,setAppKey:setAppKey,headers:headers,resetPasword:resetPasword,changePasswordWithResetToken:changePasswordWithResetToken,setRecoverPassToken:setRecoverPassToken,verifyTFACode:verifyTFACode,getPassword:getPassword,mustEnforcePasswordStrength:mustEnforcePasswordStrength,getPasswordMinGreenLength:getPasswordMinGreenLength};out.initializing=$q.when().then(function(){$http=$injector.get("$http");c8yBase=$injector.get("c8yBase");c8yApplication=$injector.get("c8yApplication");if(window.c8y_testing){onSetToken(info.token);return{testing:true}}if(resetPasswordToken){$location.search(URL_PARAM_PASSWORD_RESET,resetPasswordToken);clearTokens();return{recoverPassword:true}}if(info.noSavedTokens){return{noSavedTokens:true}}else{return checkSavedTokens()}}).finally(function(){out.initializing.done=true});if(window.c8y_testing){if(!$window.localStorage){$window.localStorage=window.localStorage}if(!$window.sessionStorage){$window.sessionStorage=window.sessionStorage}}return out}})();(function(){"use strict";angular.module("c8y.core").factory("c8yBinary",c8yBinary);function c8yBinary($q,$upload,$http,$rootScope,$window,c8yBase,c8yInventory,c8yAuth,c8ySettings,c8yBinaryCommon){var path="inventory/binaries";var managedObjectsPath="inventory/managedObjects";var BYTES_SIZE_LIMIT=52428800;var fileSizeLimitConf={category:"files",key:"max.size"};var fileNameRegexp=/(?:\.([^.]+))?$/;var fileTypeIconsMap={archive:{mimes:[],exts:["7z","apk","cab","gz","iso","jar","rar","tar","zip"]},audio:{mimes:[],exts:["3gp","aiff","aac","amr","m4a","m4p","mp3","oga","ogg","raw","wav","wma"]},code:{mimes:[],exts:["aspx","exe","htm","html","jad","js","json","jsp","php","xml"]},excel:{mimes:[],exts:["xls","xlsx"]},image:{mimes:[],exts:["bmp","gif","jpeg","jpg","png","tiff","svg"]},pdf:{mimes:[],exts:["pdf"]},powerpoint:{mimes:[],exts:["ppt","pptx"]},text:{mimes:[],exts:["txt"]},video:{mimes:[],exts:["3gp","asf","avi","flv","mov","mp4","ogv","qt","rm","rmvb","wmv"]},word:{mimes:[],exts:["doc","docx"]}};function updateFileSizeLimit(){c8ySettings.getSystemOptionValue(fileSizeLimitConf,BYTES_SIZE_LIMIT).then(function(value){output.BYTES_SIZE_LIMIT=BYTES_SIZE_LIMIT=value})}if(!window.c8y_testing){c8yAuth.initializing.then(updateFileSizeLimit);$rootScope.$on("authStateChange",authStateChange)}function authStateChange(ev,data){if(data&&data.hasAuth){updateFileSizeLimit()}}function list(filters){var url=c8yBase.url(path);var _filters=c8yBase.pageSizeFilter(filters);var cfg={params:_filters};var blindPaging=true;var onList=c8yBase.cleanListCallback("managedObjects",list,_filters,blindPaging);return $http.get(url,cfg).then(onList)}function upload(binary,moConf){var mo={name:binary.name,type:binary.type};var binaryMo=_.assign(mo,moConf);return c8yBinaryCommon.upload(binary,{url:c8yBase.url(path),headers:c8yBase.contentHeaders("managedObject","managedObject"),data:{object:binaryMo}})}function downloadAndSaveAs(binary,length){var url=buildFileUrl(binary);return c8yBinaryCommon.download(binary,url,length).then(function(xhr){var contentType=xhr.getResponseHeader("Content-Type");var contentDisposition=xhr.getResponseHeader("Content-Disposition");var blob=isLegacyBinaryObject(binary)?getBlobFromLegacyBinaryObject(binary,contentType):new Blob([xhr.response],{type:contentType});saveAs(blob,c8yBinaryCommon.getFilenameFromContentDisposition(contentDisposition))})}function isLegacyBinaryObject(binary){return binary&&binary.data}function getBlobFromLegacyBinaryObject(binary,contentType,sliceSize){var ct=contentType||"";var ss=sliceSize||512;var byteCharacters=$window.atob(binary.data);var byteArrays=[];for(var offset=0;offset<byteCharacters.length;offset+=ss){var slice=byteCharacters.slice(offset,offset+ss);var byteNumbers=new Array(slice.length);for(var i=0;i<slice.length;i++){byteNumbers[i]=slice.charCodeAt(i)}var byteArray=new Uint8Array(byteNumbers);byteArrays.push(byteArray)}return new Blob(byteArrays,{type:ct})}function downloadAsDataUri(binary){var url=buildFileUrl(binary);return c8yBinaryCommon.download(binary,url).then(function(xhr){var contentType=xhr.getResponseHeader("Content-Type");var base64=c8yBinaryCommon.arrayBufferToBase64(xhr.response);var dataUri=isLegacyBinaryObject(binary)?getDataUri(binary):"data:"+contentType+";base64,"+base64;return dataUri}).catch(function(){return getDataUri(binary)||$q.reject()})}function downloadAsText(binary){var url=buildFileUrl(binary);var config={headers:c8yAuth.headers(),responseType:"text",transformResponse:function(data){return data}};return $http.get(url,config)}function buildFileUrl(binary){var id=binary.id||binary;return c8yBase.url(path+"/"+id)}function getDownloadUrl(binary){return binary&&binary.self&&binary.self.replace(c8yBase.url(managedObjectsPath),c8yBase.url(path))}function removeBinary(binary){var url=buildFileUrl(binary);return $http.delete(url)}function icon(binary){var targetIcon=["file","o"];var fileGenericType=getFileGenericType(binary);if(fileGenericType){targetIcon.splice(1,0,fileGenericType)}return targetIcon.join("-")}function getFileGenericType(binary){var type="";_.forEach(fileTypeIconsMap,function(iconCfg,icon){var moExt=fileNameRegexp.exec(binary.name)[1];_.forEach(iconCfg.exts,function(ext){if(ext===_.lowerCase(moExt)){type=icon;return false}});if(!type){var moMimeType=getBinaryContentType(binary);_.forEach(iconCfg.mimes,function(mime){if(mime===moMimeType){type=icon;return false}})}});return type}function getBinaryContentType(binary){var contentType=binary.contentType;if(!contentType&&!_.isUndefined(binary._attachments)){contentType=binary._attachments[_.keys(binary._attachments)[0]].content_type}return contentType}function size(binary){return c8yBinaryCommon.size(binary)}function isImage(binary){var fileGenericType=getFileGenericType(binary);return fileGenericType==="image"}function hasValidSize(file){return file&&file.size<=BYTES_SIZE_LIMIT}function save(binary){return binary.id?update(binary):create(binary)}function create(binary){var mo=_.assign(binary,{c8y_IsBinary:true});return c8yInventory.createConfirm(mo)}function update(binary){return c8yInventory.update(binary)}function detail(binaryId,params){return c8yInventory.detail(binaryId,params)}function remove(binary){return c8yInventory.remove(binary)}function getDataUri(binary){var type=_.get(binary,"type")||_.get(binary,"dataType");var data=_.get(binary,"data");var result="";if(type&&data){try{$window.atob(data)}catch(e){data=$window.btoa(data)}result="data:"+type+";base64,"+data}return result}function readDataUri(binary){var reader=new FileReader;var deferred=$q.defer();reader.addEventListener("load",function(){deferred.resolve(reader.result)},false);reader.addEventListener("error",function(evt){deferred.reject(evt)});if(binary){reader.readAsDataURL(binary)}return deferred.promise}function getText(binary){if(binary&&binary.data){return $window.atob(binary.data)}return""}function getIdFromUrl(url){var regexp=new RegExp("\\/inventory\\/binaries\\/(\\d+)|\\/inventory\\/managedObjects\\/(\\d+)");var matches=url.match(regexp);return matches&&(matches[1]||matches[2])}function decodeDataUri(dataUri){return $window.atob(_.last(dataUri.split(",")))}var output=_.assign(_.cloneDeep(c8yInventory),{BYTES_SIZE_LIMIT:BYTES_SIZE_LIMIT,list:list,upload:upload,downloadAndSaveAs:downloadAndSaveAs,downloadAsDataUri:downloadAsDataUri,downloadAsText:downloadAsText,getDownloadUrl:getDownloadUrl,removeBinary:removeBinary,icon:icon,size:size,isImage:isImage,hasValidSize:hasValidSize,getIdFromUrl:getIdFromUrl,readDataUri:readDataUri,decodeDataUri:decodeDataUri,save:save,detail:detail,remove:remove,getDataUri:getDataUri,getText:getText});return output}})();(function(){"use strict";var c8y=window.c8y=window.c8y||{};function coreFilePath(f){var p=(window.C8Y_APP||{}).core_path||"/apps/core/";return p+f}function dataFilePath(f){var p=(window.C8Y_APP||{}).data_path||(window.C8Y_PAAS?"/apps/core/c8ydata/":"/apps/c8ydata/");return p+f}c8y.coreFilePath=coreFilePath;c8y.dataFilePath=dataFilePath;angular.module("c8y.core").factory("c8yBase",c8yBase);function c8yBase($window,$q,$injector,info,gettextCatalog,latestMixinFactory){var basePath=function(){return info.baseUrl||"/"},NAMESPACE="application/vnd.com.nsn.cumulocity.",pageSize=info.pageSize||100,dateFormat="YYYY-MM-DD",dateFullFormat="YYYY-MM-DDTHH:mm:ssZ";function mimeType(type){return NAMESPACE+type+"+json"}function contentHeaders(contentType,acceptType){return{"Content-Type":mimeType(contentType),Accept:acceptType?mimeType(_.isString(acceptType)?acceptType:contentType):undefined}}function deleteProperties(obj,properties){return cleanFields(obj,properties)}function url(path){return basePath()+path}function pageSizeNoTotalFilter(filter){return _.assign({pageSize:pageSize},filter)}function pageSizeFilter(filter){return _.assign({withTotalPages:true,pageSize:pageSize},filter)}function timeOrderFilter(filter){return _.assign({dateFrom:"1970-01-01",dateTo:moment().add(1,"day").format(dateFormat)},filter)}function lastWeekFilter(filter){return _.assign({dateFrom:moment().subtract(1,"week").format(dateFormat),dateTo:moment().add(1,"day").format(dateFormat)},filter)}function fromThisMonthStartFilter(filter){return _.assign({dateFrom:moment().startOf("month").format(dateFormat)},filter)}function monthFilter(filter,monthDiff){var month=moment().subtract(monthDiff||0,"months");return _.assign({dateFrom:month.startOf("month").format(dateFormat),dateTo:month.endOf("month").format(dateFormat)},filter)}function todayFilter(filter){return _.assign({dateFrom:moment().subtract(1,"day").format(dateFormat),dateTo:moment().add(1,"day").format(dateFormat)},filter)}function createListFilter(filterFn){var fn=function(list){var paging=list.paging;var propertiesToFilter=["refresh","next"];_.forEach(propertiesToFilter,function(p){var _p="__"+p;if(!paging[_p]&&paging[p]){paging[_p]=paging[p];paging[p]=function(){return paging[_p]().then(fn)}}});var filtered=list.filter(filterFn);filtered.statistics=list.statistics;filtered.paging=list.paging;return filtered};return fn}function getParamFromUrl(paramName,url){var params={};if(url){url.split("?")[1].split("&").forEach(function(param){var split=param.split("=");params[split[0]]=decodeURIComponent(split[1])})}return params[paramName]}function buildPagingObject(data,step){var stats=data.statistics,page=step===1?"next":"prev",pageUrl=data[page],result={currentPage:stats.currentPage,pageSize:stats.pageSize,startkey:getParamFromUrl("startkey",pageUrl),startkey_docid:getParamFromUrl("startkey_docid",pageUrl)},currentPageStr=getParamFromUrl("currentPage",pageUrl);result.currentPage=parseInt(currentPageStr);return result}function buildRefreshObject(data,changingPage){var stats=data.statistics||{},result={currentPage:changingPage?stats.currentPage:1,pageSize:changingPage?stats.pageSize:stats.pageSize*stats.currentPage,startkey:null,startkey_docid:null};if(!_.isUndefined(data.totalPages)){result.pageSize=stats.pageSize}return result}function buildPaging(data,fn,filter,blindPaging,changingPage){var stats=data.statistics,hasPrev=!_.isUndefined(data.prev),hasNext=!_.isUndefined(data.next),output={};if(hasPrev){var prevFilter=_.assign(_.cloneDeep(filter),buildPagingObject(data,-1));output.prev=angular.bind({},fn,prevFilter)}if(hasNext){var nextFilter=_.assign(_.cloneDeep(filter),buildPagingObject(data,1));output.next=angular.bind({},fn,nextFilter);if(!_.isUndefined(stats.totalPages)){output.more=(stats.totalPages-stats.currentPage)*stats.pageSize}}var refreshFilter=_.assign(_.cloneDeep(filter),buildRefreshObject(data,changingPage)),refreshFn=angular.bind({},fn,refreshFilter);output.statistics=stats;output.blind=blindPaging;output.refresh=function(){return refreshFn().then(function(list){if(changingPage){list.paging=buildPaging(list,fn,filter,blindPaging,changingPage)}return list})};var changePageFn=function(page){var changePageFilter=_.assign({},filter,{pageSize:stats.pageSize,currentPage:page});return fn(changePageFilter)};output.changePage=function(page){return changePageFn(page).then(function(list){list.paging=buildPaging(list,fn,filter,blindPaging,true);return list})};return output}function cleanListCallback(name,listFn,filters){return function(res){var data=res.data||{},list=data[name]||[];list.statistics=data.statistics;if(!filters.withTotalPages&&list.length===parseInt(filters.pageSize,10)){data.statistics.totalPages=list.statistics.totalPages=+Infinity}list.paging=buildPaging(data,listFn,filters,!filters.withTotalPages);return list}}function removeFromList(list,item){var ix=list.indexOf(item);if(ix>=0){list.splice(ix,1)}}function cleanFields(obj,fields){return _.omit(obj,fields)}function invalid(scope,_form,_field){var form=scope&&scope[_form],field=form&&form[_field],pristine=field&&field.$pristine,_invalid=field&&field.$invalid;return pristine===false&&_invalid===true}function invalidFormOrField(formOrField){return formOrField.$dirty&&formOrField.$invalid}function validationHints(formOrField,errorsToMessages){var hints=[];if(formOrField&&formOrField.$error){_.forEach(formOrField.$error,function(error,key){if(error&&!_.isUndefined(errorsToMessages[key])){if(_.isObjectLike(errorsToMessages[key])&&errorsToMessages[key][formOrField.$name]){hints.push(errorsToMessages[key][formOrField.$name])}else{hints.push(errorsToMessages[key])}}})}return _.map(hints,function(hint){return gettextCatalog.getString(hint)}).join(" ")}function getCount(fn,filters){filters.pageSize=1;filters.withTotalPages=true;return fn(filters).then(function(list){return list.statistics.totalPages})}function humanizeFragment(str){if(!str){str=""}return String(str).replace(/c8y_/,"").replace(/([A-Z])/g," $1").replace(/^\s*/,"").replace(/\s*$/,"")}function getResData(res){return res&&res.data||res}function createEnum(values){var e={};var ordinal=0;e.values=_.constant(_.map(values,function(value){var v={};if(_.isObjectLike(value)){_.defaults(v,value,{name:value.name,value:value.name,label:value.name})}else{_.defaults(v,{name:value,value:value,label:value})}_.assign(v,{ordinal:ordinal++});e[v.name]=v;return v}));return e}function createLocalId(mo,key){key=key||"id";if(!_.isObjectLike(mo)){throw new Error("mo is not an object")}if(_.isUndefined(mo[key])){mo[key]=String(Math.random()).substr(2)}return mo}function getId(refId){var id;if(_.isObjectLike(refId)){id=refId.id}if(_.isNumber(refId)||_.isString(refId)&&refId.match(/^\d+$/)){id=String(refId)}if(!id){throw new Error("id cannot be found")}return id}function checkIfModulesExist(modules){try{_.forEach(modules,function(module){angular.module(module)});return true}catch(e){return false}}function getInfoProperty(name){return info[name]}function appOption(name){var appManifest=(info.appConfig||{}).manifest;var oldAppOptions=window.C8Y_APP&&window.C8Y_APP.C8Y_INSTANCE_OPTIONS;var appOptions=window.C8Y_INSTANCE_OPTIONS;var o=_.merge({},appManifest,oldAppOptions,appOptions);return o[name]}function getPluginService(serviceName){return $injector.has(serviceName)?$injector.get(serviceName):undefined}var result={url:url,deleteProperties:deleteProperties,mimeType:mimeType,contentHeaders:contentHeaders,PAGESIZE:pageSize,pageSizeFilter:pageSizeFilter,pageSizeNoTotalFilter:pageSizeNoTotalFilter,timeOrderFilter:timeOrderFilter,lastWeekFilter:lastWeekFilter,todayFilter:todayFilter,fromThisMonthStartFilter:fromThisMonthStartFilter,monthFilter:monthFilter,createListFilter:createListFilter,cleanListCallback:cleanListCallback,removeFromList:removeFromList,cleanFields:cleanFields,dateFormat:dateFormat,dateFullFormat:dateFullFormat,invalid:invalid,invalidFormOrField:invalidFormOrField,validationHints:validationHints,getCount:getCount,humanizeFragment:humanizeFragment,getResData:getResData,createEnum:createEnum,createLocalId:createLocalId,getId:getId,checkIfModulesExist:checkIfModulesExist,coreFilePath:coreFilePath,dataFilePath:dataFilePath,getFlag:getInfoProperty,getRuntimeOption:getInfoProperty,appOption:appOption,getPluginService:getPluginService};_.mixin(result,latestMixinFactory($q));return result}})();angular.module("c8y.core").factory("c8yCepModule",["$http","$q","$timeout","c8yBase","c8yCepModuleExamples",function($http,$q,$timeout,c8yBase,c8yCepModuleExamples){"use strict";var path="cep/modules",contentType="cepModule",cacheCreateOrDeploy={};function updateStatus(module){var url=c8yBase.url(path+"/"+module.id),cfg={headers:c8yBase.contentHeaders(contentType,true)},data={status:module.status};if(!module.id){throw new Error("Module id no defined")}return $http.put(url,data,cfg)}function updateModule(module){var id=module.id,url=c8yBase.url(path+(id?"/"+id:"")),method=id?"put":"post",headers=_.assign(c8yBase.contentHeaders(contentType,true),{"Content-Type":"text/plain"}),cfg={headers:headers};return $http[method](url,module.body,cfg)}function list(filters){var url=c8yBase.url(path),_filters=c8yBase.pageSizeFilter(filters),cfg={params:_filters},onList=c8yBase.cleanListCallback("modules",list,_filters);return $http.get(url,cfg).then(filterSmartRulesFromRes).then(onList)}function filterSmartRulesFromRes(res){res.data.modules=_.filter(res.data.modules,function(module){return!isSmartRuleModule(module)});return res}function isSmartRuleModule(module){return module&&/^smartRule\d+$/.test(module.name)}function listWithSmartRules(filters){var url=c8yBase.url(path),_filters=c8yBase.pageSizeFilter(filters),cfg={params:_filters},onList=c8yBase.cleanListCallback("modules",listWithSmartRules,_filters);return $http.get(url,cfg).then(onList)}function detail(_module){var id=_module.id||_module,url=c8yBase.url(path+"/"+id),def=$q.defer(),body=null,module=null,fileConfig={headers:{"Content-Type":"text/plain",Accept:"text/plain"}},dataConfig={headers:{Accept:c8yBase.mimeType(contentType)}},checkFinal=function(){if(body&&module){var nameMatch=/module (\w*);\s*\n*/;module.name=body.match(nameMatch)[1];module.body=body.replace(nameMatch,"");def.resolve(module)}};$http.get(url,dataConfig).then(function(res){module=res.data;$http.get(url+"?text",fileConfig).success(function(data){body=data;checkFinal()})});return def.promise}function remove(module){var id=module.id||module,url=c8yBase.url(path+"/"+id);return $http["delete"](url)}function save(_module){var def=$q.defer(),module=_.cloneDeep(_module),firstStep;if(module.body){if(module.name){module.body="module "+module.name+";\n"+module.body}firstStep=updateModule(module).then(null,function(data){def.reject(data);return $q.reject()})}else{firstStep=detail(module)}firstStep.then(function(res){var _module=res.body?res:res.data;if(module.status&&_module.status!==module.status){_module.status=module.status;updateStatus(_module).then(function(res){def.resolve(res.data)},function(res){def.reject(res.data)})}else{def.resolve(_module)}});return def.promise}function detailByName(name){return listWithSmartRules().then(function(modules){var _module;modules.forEach(function(m){if(m.name===name){_module=m;return false}});return _module||$q.reject("not found")})}function createOrDeploy(module){var name=module.name;if(!cacheCreateOrDeploy[name]){cacheCreateOrDeploy[name]=detailByName(name).then(function(module){if(module.status!=="DEPLOYED"){module.status="DEPLOYED";return save(module)}else{return module}},function(){return save(module)})}return cacheCreateOrDeploy[name]}function deploy(module){module.status="DEPLOYED";return save(module)}function redeploy(module){return undeploy(module).then(deploy)}function undeploy(module){module.status="NOT_DEPLOYED";return save(module)}function examples(){return $q.when(c8yCepModuleExamples)}return{list:list,listWithSmartRules:listWithSmartRules,isSmartRuleModule:isSmartRuleModule,detail:detail,save:save,remove:remove,examples:examples,detailByName:detailByName,createOrDeploy:createOrDeploy,deploy:deploy,redeploy:redeploy,undeploy:undeploy}}]).factory("c8yCepModuleExamples",["gettext",function(gettext){return[{name:gettext("Change the severities of alarms based on activity time"),value:'/* Create "context" - definition of a group of events to be processed separately.\n'+' * Context "Alarms" consists of AlarmCreated and AlarmUpdated: \n'+' * with the same source and type = "power off". */\n'+"create context Alarms partition by \n"+'alarm.source from AlarmCreated(alarm.type = "power off"),\n'+'alarm.source from AlarmUpdated(alarm.type = "power off");\n'+"\n"+"/* Update severity for all active AlarmCreated \n"+" * after which there is no change to other status in 15 minutes. */\n"+"context Alarms \n"+"insert into UpdateAlarm \n"+"select \n"+"   a.alarm.id as id,\n"+'   "MAJOR" as severity\n'+"from pattern [\n"+"   every a = AlarmCreated(alarm.status = CumulocityAlarmStatuses.ACTIVE) \n"+"   -> (timer:interval(15 minutes) \n"+"      and not AlarmUpdated(alarm.status != CumulocityAlarmStatuses.ACTIVE))\n"+"];"},{name:gettext("Create alarm if temperature was to low for 15 minutes"),value:"create schema NotZeroMeasurementCreated (\n"+"  measurement Measurement\n"+");\n"+"create schema ZeroMeasurementCreated (\n"+"  measurement Measurement\n"+");\n"+"create schema CheckTimeDifference (\n"+"  firstMeasurement Measurement,\n"+"  lastMeasurement Measurement\n"+");\n"+"insert into CreateAlarm\n"+"  select\n"+"    check.lastMeasurement.source as source,\n"+"    check.lastMeasurement.time as time,\n"+'    "c8y_LowTemperatureAlarm" as type,\n'+"    CumulocitySeverities.WARNING as severity,\n"+"    CumulocityAlarmStatuses.ACTIVE as status,\n"+'    "Temperature was too low for more than 15 minutes" as text\n'+"  from CheckTimeDifference check\n"+"  where check.lastMeasurement.time.after(check.firstMeasurement.time, 15min);\n"+"insert into CheckTimeDifference\n"+"  select\n"+"    firstZero.measurement as firstMeasurement,\n"+"    firstNotZeroAgain.measurement as lastMeasurement\n"+"  from pattern [\n"+"    every (lastNotZero = NotZeroMeasurementCreated ->\n"+"    firstZero = ZeroMeasurementCreated(measurement.source.value = lastNotZero.measurement.source.value)) ->\n"+"    ZeroMeasurementCreated until firstNotZeroAgain = NotZeroMeasurementCreated(measurement.source.value = lastNotZero.measurement.source.value)\n"+"  ];\n"+"insert into NotZeroMeasurementCreated\n"+"  select\n"+"    m.measurement as measurement\n"+"  from\n"+"    MeasurementCreated m\n"+'  where getNumber(m, "c8y_TemperatureMeasurement.T.value") > 0\n'+'  AND m.measurement.type = "c8y_TemperatureMeasurement";\n'+"insert into ZeroMeasurementCreated\n"+"  select\n"+"    m.measurement as measurement\n"+"  from\n"+"    MeasurementCreated m\n"+'  where getNumber(m, "c8y_TemperatureMeasurement.T.value") <= 0\n'+'  AND m.measurement.type = "c8y_TemperatureMeasurement";'},{name:gettext("Create alarm on not processed operation"),value:"create constant variable int operation_timeout_in_seconds = 300; \n"+'create constant variable string alarm_severity = "MAJOR"; \n'+'create constant variable string alarm_text = "Operation with id=#{id.value} haven\'t been finished!"; \n'+'create constant variable string alarm_type = "c8y_OperationNotFinished"; \n'+"create schema OperationNotFinished ( operation com.cumulocity.model.operation.Operation ); \n"+"create schema OperationFinished ( operation com.cumulocity.model.operation.Operation, alarm Alarm); \n"+'@Name("create_alarm_from_not_finished_operation")\n'+"insert into CreateAlarm\n"+"  select \n"+"    operation.deviceId as source,\n"+'    "ACTIVE" as status,\n'+"    alarm_severity as severity,\n"+"    alarm_type as type,\n"+"    current_timestamp().toDate() as time,\n"+"    replaceAllPlaceholders(alarm_text, operation) as text,\n"+'    { "operationId", operation.id.value } as fragments \n'+"  from OperationNotFinished;\n"+'@Name("handle_not_finished_operation")\n'+"insert into OperationNotFinished\n"+"  select\n"+"    prevOp.operation as operation\n"+"  from pattern [ \n"+"    every prevOp = OperationCreated \n"+"    -> (timer:interval(operation_timeout_in_seconds second)\n"+"    and not OperationUpdated(\n"+"    operation.id.value = prevOp.operation.id.value\n"+"    and (operation.status in (OperationStatus.SUCCESSFUL, OperationStatus.FAILED))\n"+"    ))"+"  ];\n"},{name:gettext("Create alarm when temperature below 0 degree"),value:"insert into CreateAlarm \n"+"  select\n"+"    e.measurement.time as time,\n"+"    e.measurement.source.value as source,\n"+'    "com_cumulocity_TemperatureAlert" as type,\n'+'    "Temperature too low" as text,\n'+'    "ACTIVE" as status,\n'+'    "CRITICAL" as severity\n'+"  from MeasurementCreated e\n"+'  where getNumber(e, "c8y_TemperatureMeasurement.T.value") < 0'},{name:gettext("Create alarm when temperature over 100 degree"),value:"insert into CreateAlarm \n"+"  select\n"+"    e.measurement.time as time,\n"+"    e.measurement.source.value as source,\n"+'    "com_cumulocity_TemperatureAlert" as type,\n'+'    "Temperature too high" as text,\n'+'    "ACTIVE" as status,\n'+'    "CRITICAL" as severity\n'+"  from MeasurementCreated e\n"+'  where getNumber(e, "c8y_TemperatureMeasurement.T.value") > 100'},{name:gettext("Create close relay operation when temperature readings over 100 degree"),value:"insert into CreateOperation\n"+"  select\n"+'    "PENDING" as status,\n'+"    «heating ID» as deviceId,\n"+"    {\n"+'      "c8y_Relay.relayState", "CLOSED"\n'+"    } as fragments\n"+"  from MeasurementCreated e\n"+'  where getNumber(e, "c8y_TemperatureMeasurement.T.value") > 100'},{name:gettext("Display current temperature on device"),
value:"expression string js:prepareText(temp) [\n"+"  function format(text, params){\n"+"    for(param in params) {\n"+'        text = text.replace("{" + param + "}", params[param])\n'+"    }\n"+"    return text\n"+"  }\n"+'  format("Current temperature is {0}", [temp])\n'+"]\n"+"insert into CreateOperation\n"+"\tselect\n"+'      "PENDING" as status,\n'+"      e.measurement.source.value as deviceId,\n"+'      { "c8y_Message.text", prepareText(\n'+'        getNumber(e, "c8y_TemperatureMeasurement.T.value")\n'+"\t   ) } as fragments\n"+"    from MeasurementCreated e\n"+'    where e.measurement.type = "c8y_TemperatureMeasurement";'},{name:gettext("Schedule device restart every day at 1am"),value:"insert into CreateOperation\n"+"select\n"+'  "PENDING" as status,\n'+"  «device ID» as deviceId,\n"+'  { "c8y_Restart", {} } as fragments\n'+"from pattern [every timer:at(*, 1, *, *, *, *)];"},{name:gettext("Select location change event once for 60 seconds"),value:"select * from EventCreated e\n"+'where getObject(e, "c8y_LocationMeasurement") is not null\n'+"output first every 60 seconds"},{name:gettext("Select temperature readings over 100 degree"),value:"select * from MeasurementCreated e\n"+'where getNumber(e, "c8y_TemperatureMeasurement.T.value") > 100'},{name:gettext("Send alarms that are active since 30 minutes to email"),value:"insert into SendEmail\n"+"select\n"+'  "<RECEIVER@COMPANY.COM>" as receiver,\n'+'  "Alarm active since 30 mins: " || e.alarm.text as subject,\n'+'  "Time: " || e.alarm.time.format() || \n'+'  " Severity: " || e.alarm.severity.name() || \n'+'  " Source: " || findManagedObjectById(e.alarm.source.value).getName() as text,\n'+'  "<REPLY_TO@COMPANY.COM>" as replyTo\n'+"from pattern [\n"+"   every e = AlarmCreated(alarm.status = CumulocityAlarmStatuses.ACTIVE, alarm.severity = CumulocitySeverities.CRITICAL) \n"+"   -> (timer:interval(30 minutes) \n"+"      and not AlarmUpdated(alarm.status != CumulocityAlarmStatuses.ACTIVE, alarm.id.value = e.alarm.id.value))\n"+"];"},{name:gettext("Send sales to Zapier"),value:'@Name("sales")\n'+"select\n"+'  getString(e, "com_nsn_startups_vendme_fragments_SalesReportInfo.vendingMachine_name") as id,\n'+'  getString(e, "com_nsn_startups_vendme_fragments_SalesReportInfo.product_name") as name,\n'+"  e.event.time.format() as time,\n"+'  getNumber(e, "com_nsn_startups_vendme_fragments_SalesReportInfo.totalPaid") as value,\n'+'  getString(e, "com_nsn_startups_vendme_fragments_SalesReportInfo.payment_type") as text\n'+"from EventCreated e\n"+'  where e.event.type = "com_nsn_startups_vendme_LiveSalesReport"\n'},{name:gettext("Send simulator temperature to Zapier"),value:'@Name("simulatortemperature")\n'+"select\n"+"  e.measurement.source.value as id,\n"+"  findManagedObjectById(e.measurement.source.value).getName() as name,\n"+"  e.measurement.time.format() as time,\n"+'  getNumber(e, "c8y_TemperatureMeasurement.T.value") as value,\n'+"from MeasurementCreated e\n"+'  where e.measurement.type = "TemperatureMeasurement"\n'}]}]);(function(){"use strict";angular.module("c8y.core").factory("c8yBinaryCommon",c8yBinaryCommon);function c8yBinaryCommon($q,$upload,c8yBase,c8yAuth){var service={upload:upload,download:download,getFilenameFromContentDisposition:getFilenameFromContentDisposition,arrayBufferToBase64:arrayBufferToBase64,size:size};function upload(binary,configOverride){var defaultConfig={method:"POST",data:{filesize:binary.size},file:binary};var finalConfig=_.assign({},defaultConfig,configOverride);return $upload.upload(finalConfig)}function download(binary,url,length){var deferred=$q.defer();var xhr=new XMLHttpRequest;xhr.open("GET",url,true);xhr.responseType="arraybuffer";xhr.onload=function(){if(xhr.status===200){deferred.resolve(xhr)}else{deferred.reject(xhr)}};xhr.onprogress=function(e){if(!_.isUndefined(e.loaded)){var totalLength=_.isNumber(Number(length))&&length||size(binary);if(!_.isUndefined(totalLength)){var loadedPercentage=e.loaded/totalLength;deferred.notify(loadedPercentage)}}};_.forEach(c8yAuth.headers(),function(val,key){if(val){xhr.setRequestHeader(key,val)}});if(service.__test){service.__downloadDeferred=deferred}else{xhr.send()}return deferred.promise}function size(binary){var binaryLength=_.get(binary,"length");var attachments=_.get(binary,"_attachments");var attachmentsObj=_.get(attachments,_.first(_.keys(attachments)));return _.isUndefined(binaryLength)?_.get(attachmentsObj,"length"):binaryLength}function getFilenameFromContentDisposition(contentDisposition){return/filename="(.*)"/.exec(contentDisposition)[1]}function arrayBufferToBase64(buffer){var binary="";var bytes=new Uint8Array(buffer);var len=bytes.byteLength;for(var i=0;i<len;i++){binary+=String.fromCharCode(bytes[i])}return btoa(binary)}return service}})();(function(){"use strict";angular.module("c8y.core").factory("c8yCombain",c8yCombain);function c8yCombain(c8yApplication){var service={gsmTrackingAvailable:gsmTrackingAvailable};return service;function gsmTrackingAvailable(device){return c8yApplication.listByUser().then(function(apps){if(!_.find(apps,{key:"combain-application-key"})){return false}return!!(device.c8y_CellInfo||device.c8y_Mobile)})}}})();(function(){"use strict";angular.module("c8y.core").factory("c8yConnectivity",["$http","$q","c8yBase","c8yConnectivitySettings",c8yConnectivity]);function c8yConnectivity($http,$q,c8yBase,c8yConnectivitySettings){var mainPath="service/connectivity",typePaths={getTerminalDetails:{prefix:"mo",suffix:"op/terminal",mo:true,method:"GET"},getTerminalSessionInfo:{prefix:"mo",suffix:"op/terminal/session",mo:true,method:"GET"},setTerminalSimStatus:{prefix:"mo",suffix:"op/terminal/sim_status",mo:true,method:"PUT"},getTerminalAuditLogs:{prefix:"mo",suffix:"op/terminal/audit",mo:true,method:"GET"},getTerminalUsage:{prefix:"mo",suffix:"op/billing",mo:true,method:"GET"},getTerminalVoiceUsage:{prefix:"mo",suffix:"op/billing/voice",mo:true,method:"GET"},getTerminalDataUsage:{prefix:"mo",suffix:"op/billing/data",mo:true,method:"GET"},getTerminalSmsUsage:{prefix:"mo",suffix:"op/billing/sms",mo:true,method:"GET"},sendSms:{prefix:"mo",suffix:"op/sms",mo:true,method:"POST"},getSms:{prefix:"mo",suffix:"op/sms",mo:true,method:"GET"},getSmsDetails:{prefix:"mo",suffix:"op/sms/details",mo:true,method:"GET"},ping:{suffix:"op/ping",mo:false,method:"GET"}};function buildRequestFunction(type,mo,data,params,cfg){var pathArray=[c8yBase.url(mainPath)],componentArray=["prefix","mo","suffix"],url,_cfg;if(typePaths[type].mo){typePaths[type].mo=mo}else{delete typePaths.mo}_.forEach(componentArray,function(component){if(typePaths[type][component]){pathArray.push(typePaths[type][component])}});url=pathArray.join("/");_cfg={method:[typePaths[type].method],url:url,data:data,params:params,headers:{Accept:"application/json","Content-type":"application/json;charset=UTF-8"}};_cfg=_.assign(_cfg,cfg||{});return $http(_cfg)}function formattedRequest(type,mo,data,params,cfg){return request(type,mo,data,params,cfg).then(c8yBase.getResData)}function request(type,mo,data,params,cfg){return mo&&type?buildRequestFunction(type,mo,data,params,cfg):$q.reject("Device not valid")}function updateValidityOption(value){return c8yConnectivitySettings.update({valid:value})}function updateValidityAfterPing(response){var willUpdate=response&&(response.status===200||response.status===400),updateValue=willUpdate&&response.status===200;return!willUpdate?$q.reject(response):updateValidityOption(updateValue).then(function(){return response})}function ping(){return request("ping","mo",{},{},{silentError:true}).then(updateValidityAfterPing,updateValidityAfterPing)}function pingIfPossible(options){if(options.valid){return ping()}else{return $q.reject()}}function safePing(){return c8yConnectivitySettings.detail().then(pingIfPossible)}return{detail:formattedRequest,getTerminalDetails:_.partial(formattedRequest,"getTerminalDetails"),getTerminalSessionInfo:_.partial(formattedRequest,"getTerminalSessionInfo"),setTerminalSimStatus:_.partial(formattedRequest,"setTerminalSimStatus"),getTerminalAuditLogs:_.partial(formattedRequest,"getTerminalAuditLogs"),getTerminalUsage:_.partial(formattedRequest,"getTerminalUsage"),getTerminalVoiceUsage:_.partial(formattedRequest,"getTerminalVoiceUsage"),getTerminalDataUsage:_.partial(formattedRequest,"getTerminalDataUsage"),getTerminalSmsUsage:_.partial(formattedRequest,"getTerminalSmsUsage"),getSms:_.partial(formattedRequest,"getSms"),sendSms:_.partial(formattedRequest,"sendSms"),getSmsDetails:_.partial(formattedRequest,"getSmsDetails"),ping:ping,safePing:safePing}}})();(function(){"use strict";angular.module("c8y.core").factory("c8yConnectivitySettings",["$http","c8yBase","c8ySettings",c8yConnectivitySettings]);function c8yConnectivitySettings($http,c8yBase,c8ySettings){var url=c8yBase.url("service/register/connectivity");function request(method,data){if(data&&data.microservice&&data.microservice.url){delete data.microservice}var cfg={method:method,url:url,data:data,headers:{Accept:"application/json","Content-type":"application/json"}};return $http(cfg).then(c8yBase.getResData).then(function(response){response.valid=response.valid==="true";return response})}function exists(){return request("GET").then(function(response){return!!response["microservice.url"]}).catch(function(){return false})}function shouldShow(){var option={category:"connectivity",key:"microservice.url"};var defaultValue=false;return c8ySettings.getSystemOptionValue(option,defaultValue).then(function(value){return!!value})}return{detail:_.partial(request,"GET"),update:_.partial(request,"PUT"),exists:exists,shouldShow:shouldShow}}})();(function(){"use strict";angular.module("c8y.core").factory("c8yCounter",["$q","c8yBase","c8yRealtime",c8yCounter]);function c8yCounter($q,c8yBase,c8yRealtime){function PropertyMap(propertyMap){propertyMap=_.cloneDeep(propertyMap);var that=this;this.properties=null;this.filterFn=null;this.dependencies=null;if(_.isArray(propertyMap)){if(!parse(propertyMap)){throw new Error("property map is not valid")}}else if(_.isString(propertyMap)){createDefault(propertyMap)}else{throw new Error("parameter is invalid")}function createDefault(prop){that.properties=[prop];that.filterFn=function(propVal,obj){return _.isEqual(propVal,obj[prop])};that.dependencies=[prop]}function parse(propertyMap){var len=propertyMap.length;var lastElem=_.last(propertyMap);if(_.isArray(lastElem)){that.dependencies=lastElem;that.filterFn=propertyMap[len-2];that.properties=propertyMap.slice(0,len-2);return _.isFunction(that.filterFn)&&_.every(that.properties,String)}if(_.isFunction(lastElem)){that.dependencies=_.initial(propertyMap);that.filterFn=lastElem;that.properties=that.dependencies;return _.every(that.properties,String)}return false}}PropertyMap.prototype.matches=function(filter,obj){filter=_.cloneDeep(filter);_.forEach(this.properties,function(prop){filter[prop]=filter[prop]||undefined});var args=_.values(_.pick(filter,this.properties));args.push(obj);return this.filterFn.apply(this,args)};function FilterConfiguration(filter,config){var that=this;this.pickList=null;this.queryParams=filter;this.propertyMapList=config&&_.map(config,function(propertyMap){return new PropertyMap(propertyMap)})||[];clearUndefinedProperties();fillEmptyMappings();createPickList();function clearUndefinedProperties(){filter=_.pickBy(filter,function(val){return val!==undefined})}function fillEmptyMappings(){_.forEach(_.keys(filter),function(filterName){var hasMapping=_.some(that.propertyMapList,function(propertyMap){return _.some(propertyMap.properties,function(prop){return prop===filterName})});if(!hasMapping){that.propertyMapList.push(new PropertyMap(filterName))}})}function createPickList(){var pickListObj=_.reduce(that.propertyMapList,function(result,propertyMap){_.forEach(propertyMap.dependencies,function(prop){result[prop]=true});return result},{});pickListObj.id=true;that.pickList=_.keys(pickListObj)}}FilterConfiguration.prototype.matches=function(obj){var that=this;return _.every(this.propertyMapList,function(propertyMap){return propertyMap.matches(that.queryParams,obj)})};function Counter(listFn,realtimeChannel){if(!_.isFunction(listFn)){throw new Error("list function must be provided")}var that=this,isRefreshing=false,objects,count,notificationCallback,filterConfig,hasFilter=false,filter={pageSize:1},isStarted=false,isStopped=false;var REALTIME_FN_MAP={CREATE:onCreate,UPDATE:onUpdate,DELETE:onDelete};c8yBase.createLocalId(this,"__realtimeId");this.start=function(){if(isStarted){throw new Error("Cannot restart a counter instance, please create a new instance")}isStarted=true;return this.refresh().then(subscribe)};this.stop=function(){if(!isStarted){throw new Error("Cannot stop counter instance without starting it first")}if(isStopped){throw new Error("Cannot stop an already stopped counter instance")}isStopped=true;unsubscribe()};this.onNotification=function(callback){notificationCallback=callback};this.refresh=function(){isRefreshing=true;var queryParams=hasFilter?filterConfig.queryParams:filter;return $q.when(listFn(queryParams)).then(function(objs){if(hasFilter){objects=_(objs).filter(filterMatches).map(map).value()}else{count=objs.statistics.totalPages}updateCount();isRefreshing=false})};this.filter=function(_filter,_filterConfig){if(!_filter&&!_filterConfig){return filter}if(hasFilter){throw new Error("filter can be set only once")}hasFilter=true;filterConfig=new FilterConfiguration(_filter,_filterConfig)};function subscribe(){if(!realtimeChannel){return}var realtimeActions=c8yRealtime.realtimeActions();_.forEach(realtimeActions,function(action){c8yRealtime.addListener(that.__realtimeId,realtimeChannel,action,onNotification)});return $q.when(c8yRealtime.start(that.__realtimeId,realtimeChannel))}function unsubscribe(){if(realtimeChannel){c8yRealtime.removeSubscriber(that.__realtimeId,realtimeChannel)}}function onNotification(evt,obj){if(!isRefreshing){var oldCount=that.count;REALTIME_FN_MAP[evt.name||evt](obj);updateCount();var newCount=that.count;if(notificationCallback&&newCount!==oldCount){notificationCallback(newCount,oldCount)}}}function onCreate(obj){if(!hasFilter){count+=1}else if(filterMatches(obj)){objects.unshift(map(obj))}}function onUpdate(obj){if(hasFilter){var idx=_.findIndex(objects,{id:obj.id});if(idx===-1&&filterMatches(obj)){objects.unshift(map(obj))}else if(idx!==-1&&!filterMatches(obj)){objects.splice(idx,1)}}}function onDelete(obj){if(!hasFilter){count-=1}else{var idx=_.findIndex(objects,{id:obj.id});if(idx!==-1){objects.splice(idx,1)}}}function updateCount(){that.count=objects&&objects.length||count||0}function map(obj){return _.pick(obj,filterConfig.pickList)}function filterMatches(obj){return filterConfig.matches(obj)}}var datePropertyMap=["dateFrom","dateTo",function(dateFrom,dateTo,obj){var date=obj&&(obj.date||obj.time);if(!date){return false}if(dateFrom&&moment(dateFrom).isAfter(date)){return false}if(dateTo&&moment(dateTo).isBefore(date)){return false}return true},["date","time"]];var sourcePropertyMap=["source",function(source,obj){return(obj&&(obj.source&&obj.source.id))===source},["source"]];var defaultPropertyMaps={date:datePropertyMap,source:sourcePropertyMap};return{Counter:Counter,defaultPropertyMaps:defaultPropertyMaps}}})();(function(){"use strict";angular.module("c8y.core").factory("c8yDeviceBulkControl",["$http","c8yBase",c8yDeviceBulkControl]);function c8yDeviceBulkControl($http,c8yBase){var path="devicecontrol/bulkoperations",opIdLocationRegExp="\\/devicecontrol\\/bulkoperations\\/(\\d+)",clean=c8yBase.cleanFields,defaultConfig={headers:c8yBase.contentHeaders("bulkOperation")},cleanKeys=["creationTime","id","self","operations"],cleanKeysUpdate=[],status={SCHEDULED:"SCHEDULED",EXECUTING:"EXECUTING",COMPLETED_WITH_FAILURES:"COMPLETED_WITH_FAILURES",COMPLETED_SUCCESSFULLY:"COMPLETED_SUCCESSFULLY",CANCELLED:"CANCELLED"},statusList=_.keys(status),internalStatus={ACTIVE:"ACTIVE",IN_PROGRESS:"IN_PROGRESS",COMPLETED:"COMPLETED",DELETED:"DELETED"},singleOpStatusMap={PENDING:[status.SCHEDULED],EXECUTING:[status.EXECUTING],SUCCESSFUL:[status.COMPLETED_SUCCESSFULLY],FAILED:[status.COMPLETED_WITH_FAILURES,status.CANCELLED]},style={};style["SCHEDULED"]={label:"SCHEDULED",icon:"clock-o",cls:"text-muted"};style["EXECUTING"]={label:"EXECUTING",icon:"refresh",cls:"text-info"};style["COMPLETED_WITH_FAILURES"]={label:"COMPLETED WITH FAILURES",icon:"times-circle",cls:"text-danger"};style["COMPLETED_SUCCESSFULLY"]={label:"COMPLETED SUCCESSFULLY",icon:"check-circle",cls:"text-success"};style["CANCELLED"]={label:"CANCELLED",icon:"times-circle",cls:"text-danger"};function buildDetailUrl(operation){var id=operation.id||operation;return c8yBase.url(path+"/"+id)}function list(filters,silentError){var url=c8yBase.url(path),_filters=c8yBase.pageSizeNoTotalFilter(filters),cfg={params:_filters,silentError:silentError},onList=c8yBase.cleanListCallback("bulkOperations",list,_filters);return $http.get(url,cfg).then(onList).then(_.partialRight(filterByStatus,_filters.status))}function filterByStatus(operations,statuses){var result;if(_.isUndefined(statuses)){result=operations}else{var list=_.isArray(statuses)?statuses:[statuses];result=_.filter(operations,function(o){return _.includes(statuses,getStatus(o))})}return result}function detail(operation){var url=buildDetailUrl(operation);return $http.get(url)}function save(operation){return operation.id?update(operation):create(operation)}function create(operation){var url=c8yBase.url(path),data=clean(operation,cleanKeys),cfg=_.cloneDeep(defaultConfig);return $http.post(url,data,cfg).then(getIdFromRes)}function getIdFromRes(res){var regexp=new RegExp(opIdLocationRegExp);var matches=res.headers("Location").match(regexp);return parseInt(matches[1],10)}function update(operation){var url=c8yBase.url(path+"/"+operation.id),data=clean(operation,cleanKeys.concat(cleanKeysUpdate)),cfg=_.cloneDeep(defaultConfig);return $http.put(url,data,cfg)}function canCancel(operation){var s=operation&&operation.status;return _.includes([internalStatus.ACTIVE,internalStatus.IN_PROGRESS],s)}function cancel(operation){var url=buildDetailUrl(operation);return $http["delete"](url)}function retryFailed(operation){var op=_.cloneDeep(operation);delete op.groupId;op.failedParentId=operation.id;return create(op)}function getStatus(operation){if(operation.status==="CANCELED"||operation.status==="DELETED"){return status.CANCELLED}if(!operation.progress||!operation.progress.all||operation.progress.pending===0&&operation.progress.executing===0&&operation.progress.successful===0&&operation.progress.failed===0){return status.SCHEDULED}else if(operation.progress&&operation.progress.successful+operation.progress.failed<operation.progress.all){return status.EXECUTING}else{if(operation.progress.failed>0){return status.COMPLETED_WITH_FAILURES}else{return status.COMPLETED_SUCCESSFULLY}}}function getStatusStyle(operationOrStatus){var status=_.isObjectLike(operationOrStatus)?getStatus(operationOrStatus):operationOrStatus;return style[status]}function doesMatchSingleOpStatus(bulkOperationOrStatus,singleOpStatus){var status=_.isObjectLike(bulkOperationOrStatus)?getStatus(bulkOperationOrStatus):bulkOperationOrStatus;var matchingStatuses=getMappedSingleOpStatus(singleOpStatus);return _.includes(matchingStatuses,status)}function getMappedSingleOpStatus(singleOpStatus){return singleOpStatusMap[singleOpStatus]}return{list:list,detail:detail,create:create,save:save,update:update,canCancel:canCancel,cancel:cancel,retryFailed:retryFailed,status:status,statusList:statusList,getStatus:getStatus,getStatusStyle:getStatusStyle,doesMatchSingleOpStatus:doesMatchSingleOpStatus,getMappedSingleOpStatus:getMappedSingleOpStatus}}})();(function(){"use strict";angular.module("c8y.core").service("c8yDeviceControl",["$http","$rootScope","$q","c8yBase","c8yRealtime","gettext","KeysMixin",C8yDeviceControl]);function C8yDeviceControl($http,$rootScope,$q,c8yBase,c8yRealtime,gettext,KeysMixin){var clean=c8yBase.cleanFields,path="devicecontrol/operations",opIdLocationRegExp="\\/devicecontrol\\/operations\\/(\\d+)",defaultConfig={headers:c8yBase.contentHeaders("operation")},status={PENDING:gettext("PENDING"),SUCCESSFUL:gettext("SUCCESSFUL"),EXECUTING:gettext("EXECUTING"),FAILED:gettext("FAILED")},statusList=_.keys(status),cleanKeys=["creationTime","deviceExternalIDs","id","self"],cleanKeysUpdate=["deviceId","deviceName","bulkOperationId"],style={};this.reservedKeys=cleanKeys.concat(["deviceId","deviceName","bulkOperationId"]);this.standardKeys={failureReason:gettext("Failure reason"),description:gettext("Description"),status:gettext("Status")};var evtBus=$rootScope.$new(true);style[status.PENDING]={icon:"clock-o",cls:"text-muted"};style[status.EXECUTING]={icon:"refresh",cls:"text-info"};style[status.SUCCESSFUL]={icon:"check-circle",cls:"text-success"};style[status.FAILED]={icon:"times-circle",cls:"text-danger"};function buildDetailUrl(operation){var id=operation.id||operation;return c8yBase.url(path+"/"+id)}function list(filters){var url=c8yBase.url(path),_filters=c8yBase.pageSizeNoTotalFilter(filters),cfg={params:_filters},onList=c8yBase.cleanListCallback("operations",list,_filters);return $http.get(url,cfg).then(onList)}function listPaged(filters){var defer=$q.defer(),_filters=_.assign(filters||{},{pageSize:1e3}),cancelled=false,onList=function(list){var isNext=!_.isUndefined(list.paging.next)&&list.length>=_filters.pageSize;defer.notify(list);if(!isNext){defer.resolve(true)}if(cancelled){return true}return isNext?list.paging.next().then(onList):true};_.assign(defer.promise,{cancel:function(){cancelled=true;defer.reject("canceled")}});list(_filters).then(onList);return defer.promise}function detail(operation){var url=buildDetailUrl(operation);return $http.get(url)}function create(operation){var url=c8yBase.url(path),data=clean(operation,cleanKeys),cfg=_.cloneDeep(defaultConfig);if(!data.deviceId){throw new Error("c8yDeviceControl: data must have a deviceId property")}return $http.post(url,data,cfg).then(getIdFromRes).finally(function(id){evtBus.$emit("create");return id})}function getIdFromRes(res){var regexp=new RegExp(opIdLocationRegExp);var matches=res.headers("Location").match(regexp);return parseInt(matches[1],10)}function createWithNotifications(operation){var created=create(operation);var completed=created.then(function(operationId){operation.id=operationId;var deferred=$q.defer();var subscriptionId="operation"+operation.id;var subscriptionChannel="/operations/"+operation.deviceId;c8yRealtime.addListener(subscriptionId,subscriptionChannel,"UPDATE",function(evt,data){if(data.id==operation.id){if(data.status===status.SUCCESSFUL||data.status===status.FAILED){c8yRealtime.stop(subscriptionId,subscriptionChannel);deferred.resolve(data)}else{deferred.notify(data)}}});c8yRealtime.start(subscriptionId,subscriptionChannel);return deferred.promise});return $q.when({created:created,completed:completed})}function update(operation){var url=c8yBase.url(path)+"/"+operation.id,data=clean(operation,cleanKeys.concat(cleanKeysUpdate)),cfg=_.cloneDeep(defaultConfig);return $http.put(url,data,cfg).finally(function(){evtBus.$emit("update")})}function cancel(operation){operation.status=status.FAILED;operation.failureReason=gettext("Operation cancelled by user.");return update(operation)}function save(operation){return operation.id?update(operation):create(operation)}function getStyle(operationOrStatus){var _status=_.isString(operationOrStatus)?operationOrStatus:operationOrStatus.status;return style[_status.toUpperCase()]}_.assign(this,{list:list,listPaged:listPaged,detail:detail,create:create,createWithNotifications:createWithNotifications,update:update,cancel:cancel,save:save,status:status,statusList:statusList,getStyle:getStyle,events:evtBus});_.assign(this,KeysMixin);_.bindAll(this,_.keys(KeysMixin))}})();angular.module("c8y.core").factory("c8yDeviceGroup",["c8yInventory",function(c8yInventory){"use strict";var exports={},deviceGroupType="c8y_DeviceGroup",deviceGroupFragmentType="c8y_IsDeviceGroup";function hasDevices(group){return!!group.childAssets.references.length}exports.list=function list(filter){var _filter={fragmentType:deviceGroupFragmentType,pageSize:1e4};if(_.isObjectLike(filter)){_filter=_.assign(_filter,filter)}return c8yInventory.list(_filter)};exports.detail=function detail(id){return c8yInventory.detail(id)};exports.create=function create(data){data.type=deviceGroupType;return c8yInventory.create(data)};exports.remove=function remove(data){if(hasDevices(data)){return false}return c8yInventory.remove(data)};exports.addDevice=function addDevice(group,device){device.c8y_Groups=_.isArray(device.c8y_Groups)?device.c8y_Groups:[];device.c8y_Groups.push({name:group.name,id:group.id});c8yInventory.update(device.id,{c8y_Groups:device.c8y_Groups});return c8yInventory.addChildAsset(group,device)};exports.removeDevice=function removeDevice(group,device){device.c8y_Groups=device.c8y_Groups.filter(function(g){return g.id!==group.id});c8yInventory.update(device.id,{c8y_Groups:device.c8y_Groups});return c8yInventory.removeChildAsset(group,device)};return exports}]);(function(){"use strict";angular.module("c8y.core").service("c8yDeviceRegistration",["$http","$injector","c8yBase","$upload","gettext","KeysMixin","c8yRealtime",C8yDeviceRegistration]);function C8yDeviceRegistration($http,$injector,c8yBase,$upload,gettext,KeysMixin,c8yRealtime){var self=this,clean=c8yBase.cleanFields,path="devicecontrol/newDeviceRequests",bulkPath="devicecontrol/bulkNewDeviceRequests",defaultConfig={headers:c8yBase.contentHeaders("newDeviceRequest")},status={WAITING_FOR_CONNECTION:"WAITING_FOR_CONNECTION",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",ACCEPTED:"ACCEPTED"},statusList=_.keys(status),cleanKeys=[],style={},registrationHooks=[],devicesCredentials=[];this.reservedKeys=[];this.standardKeys={};gettext("WAITING FOR CONNECTION");gettext("PENDING ACCEPTANCE");gettext("ACCEPTED");style[status.WAITING_FOR_CONNECTION]={icon:"unlink",cls:"text-danger"};style[status.PENDING_ACCEPTANCE]={icon:"circle",cls:"text-info"};style[status.ACCEPTED]={icon:"check-circle",cls:"text-success"};function buildDetailUrl(device){var id=device.id||device;return c8yBase.url(path+"/"+encodeURIComponent(id))}function list(filters){var url=c8yBase.url(path);var _filters=c8yBase.pageSizeFilter(filters);var cfg={params:_filters};var onList=c8yBase.cleanListCallback("newDeviceRequests",list,_filters);return $http.get(url,cfg).then(onList)}function detail(devReg){var url=buildDetailUrl(devReg);return $http.get(url)}function create(device){var url=c8yBase.url(path),data=clean(device,cleanKeys),cfg=_.cloneDeep(defaultConfig);if(!data.id){throw new Error("c8yDeviceRegistration: data must have an id property")}return $http.post(url,data,cfg)}function bulkCreate(file,cfg){var _cfg=_.assign({url:c8yBase.url(bulkPath),method:"POST",headers:{Accept:"application/json"},file:file},cfg||{});return $upload.upload(_cfg)}function accept(device){_runHooks(device);var url=buildDetailUrl(device),data={status:status.ACCEPTED},cfg=_.cloneDeep(defaultConfig),promise=$http.put(url,data,cfg);return promise}function cancel(devReg){var url=buildDetailUrl(devReg);return $http.delete(url)}function getStyle(devReg){var status=devReg.status||"UNKNOWN";return style[status.toUpperCase()]}function newDeviceRequestsStatusIcon(device){return getStyle(device).icon}function newDeviceRequestsStatusClass(device){return getStyle(device).cls}function addHook(injectionFunction){registrationHooks.push(injectionFunction);return function(){var ix=registrationHooks.indexOf(injectionFunction);if(ix>-1){registrationHooks.splice(ix,1)}}}function clearHooks(){registrationHooks.length=0}function _adjustRealtimeChannelForHooks(){var hasRegistrationHooks=registrationHooks.length;var id="_deviceRegistration";var channel="/managedobjects/*";var evt="CREATE";var status=c8yRealtime.getStatus(id,channel);if(!_adjustRealtimeChannelForHooks.addedListener&&hasRegistrationHooks){c8yRealtime.addListener(id,channel,evt,_onMoCreate);_adjustRealtimeChannelForHooks.addedListener=true}if(!status&&hasRegistrationHooks){c8yRealtime.start(id,channel)}if(status&&!hasRegistrationHooks){c8yRealtime.stop(id,channel)}}function _runHooks(device){var id=device.id||device;var owner="device_"+id;devicesCredentials.push(owner);_adjustRealtimeChannelForHooks()}function _isMoCreatedByRegisteredDevice(mo){return devicesCredentials.indexOf(mo.owner)>-1}function _onMoCreate(op,mo){if(!_isMoCreatedByRegisteredDevice(mo)){return}var locals={managedObject:mo};_.forEach(registrationHooks,function(fnHook){$injector.invoke(fnHook,self,locals)})}if(window.jasmine){self._onMoCreate=_onMoCreate;self._runHooks=_runHooks;self._registrationHooks=registrationHooks}_.assign(this,{list:list,detail:detail,create:create,bulkCreate:bulkCreate,accept:accept,cancel:cancel,status:status,statusList:statusList,getStyle:getStyle,statusIcon:newDeviceRequestsStatusIcon,statusClass:newDeviceRequestsStatusClass,addHook:addHook,clearHooks:clearHooks});_.assign(this,KeysMixin);_.bindAll(this,_.keys(KeysMixin))}})();(function(){"use strict";angular.module("c8y.core").factory("c8yDeviceShell",["$http","$q","c8yBase","c8ySettings",c8yDeviceShell]);function c8yDeviceShell($http,$q,c8yBase,c8ySettings){function _getCommandTemplatesForDeviceTypeInMemory(deviceType){var store=window.c8y&&window.c8y.collections&&window.c8y.collections.devicecommands||{};var commands=store[deviceType];return commands&&$q.when(commands)}function getCommandTemplatesForDeviceType(deviceType){var url=getCommandTemplatesUrl(deviceType);var promise=_getCommandTemplatesForDeviceTypeInMemory(deviceType)||$http.get(url).then(c8yBase.getResData);return promise.then(_.partial(extractCommandTemplatesFromData,deviceType))}function getCommandTemplatesUrl(deviceType){var commandTemplatesBaseUrl=c8yBase.dataFilePath("devicecommands/");return commandTemplatesBaseUrl+deviceType+".json"}function extractCommandTemplatesFromData(deviceType,data){var templates;if(_.isArray(data)){templates=_(data).map(function(d){return getExtendedTemplates(d.templates,d.syntax,deviceType)}).flatten().value()}else{templates=getExtendedTemplates(data.templates,data.syntax,deviceType)}return $q.when(templates)}function getExtendedTemplates(templates,syntax,deviceType){return _.map(templates||[],function(t){return _.assign(t,{syntax:syntax,deviceType:deviceType})})}function canSendCommandsViaSMS(){return c8ySettings.getSystemOptionValue({category:"messaging",key:"provider"},false).then(function(messagingProvider){return!!messagingProvider})}return{getCommandTemplatesForDeviceType:getCommandTemplatesForDeviceType,canSendCommandsViaSMS:canSendCommandsViaSMS}}})();angular.module("c8y.core").factory("c8yDeviceStatus",["$filter","c8yBase","gettext","gettextCatalog",function($filter,c8yBase,gettext,gettextCatalog){"use strict";var availabilityIconMap={sendData:{AVAILABLE:{icon:"long-arrow-right",class:"statusOk"},UNAVAILABLE:{icon:"long-arrow-right",class:"statusNok"},UNKNOWN:{icon:"long-arrow-right",class:"statusUnknown"},NOT_MONITORED:{icon:"long-arrow-right",class:"statusUnknown"}},push:{CONNECTED:{icon:"long-arrow-left",class:"statusOk"},DISCONNECTED:{icon:"long-arrow-left",class:"statusUnknown"},UNKNOWN:{icon:"long-arrow-left",class:"statusUnknown"}},device:{MAINTENANCE:{icon:"wrench",class:"statusAlert"}}};function status(device){var requiredAvailability=device&&device.c8y_RequiredAvailability,availabilityStatus=availabilityFor(device);if(availabilityStatus==="MAINTENANCE"){var statuses={sendStatus:false,pushStatus:false,maintenanceStatus:{icon:availabilityIconMap.device.MAINTENANCE.icon,class:availabilityIconMap.device.MAINTENANCE.class,tooltip:getMaintenanceTooltip(device)}}}else{var sendStatus=availabilityStatus||(requiredAvailability?"UNKNOWN":"NOT_MONITORED");var pushStatus=device&&device.c8y_Connection&&device.c8y_Connection.status||"UNKNOWN";var statuses={sendStatus:{icon:availabilityIconMap.sendData[sendStatus].icon,
class:availabilityIconMap.sendData[sendStatus].class,status:sendStatus,tooltip:getSendStatusTooltip(device)},pushStatus:{icon:availabilityIconMap.push[pushStatus].icon,class:availabilityIconMap.push[pushStatus].class,status:pushStatus,tooltip:getPushStatusTooltip(device,pushStatus==="CONNECTED")},maintenanceStatus:false}}return statuses}function getSendStatusTooltip(device){var availability=device&&device.c8y_Availability;var lastMessage=availability&&availability.lastMessage;if(lastMessage){return gettextCatalog.getString("Last request from device to server:<br>{{date}}",{date:$filter("absoluteDate")(lastMessage)})}else{return gettext("Connection not monitored")}}function getPushStatusTooltip(device,isActive){return isActive?gettext("Push connection: active"):gettext("Push connection: inactive")}function getMaintenanceTooltip(device){return gettext("Under maintenance")}function isDeviceAvailable(device){return availabilityFor(device)==="AVAILABLE"}function isDeviceMaintenance(device){return availabilityFor(device)==="MAINTENANCE"}function availabilityFor(device){return device&&device.c8y_Availability&&device.c8y_Availability.status}return{status:status,isDeviceAvailable:isDeviceAvailable,isDeviceMaintenance:isDeviceMaintenance}}]);(function(){"use strict";angular.module("c8y.core").factory("c8yDevices",c8yDevices);function c8yDevices($q,$filter,$cacheFactory,c8yBase,c8yUser,c8yGroups,c8yInventory,gettextCatalog){var deviceFragmentType="c8y_IsDevice";var KEYS_FOR_NODEVICE=["c8y_Dashboard","c8y_Report","c8y_Kpi","c8y_ExportConfiguration","c8y_IsBinary","c8y_NoDevice","c8y_IsDeviceGroup","c8y_Group","com_cumulocity_model_smartrest_SmartRestTemplate","com_cumulocity_model_devicesimulator_SensorTemplate","_attachments"];var TYPES_FOR_NO_DEVICE=["c8y_ConfigurationDump","c8y_Firmware","c8y_SmartRule","c8y_Software"];var FRAGMENTS_FOR_IP_ADDRESS=["c8y_Network.c8y_LAN.ip","c8y_ModbusDevice.ipAddress"];var breadcrumbsCache={};var availabilityIconMap={CONNECTED:{icon:"exchange",cls:"statusOk"},AVAILABLE:{icon:"check-circle",cls:"statusOk"},MAINTENANCE:{icon:"wrench",cls:"statusAlert"},UNAVAILABLE:{icon:"exclamation-circle",cls:"statusNok"},UNKNOWN:{icon:"circle",cls:"statusUnknown"},NOT_MONITORED:{icon:"circle",cls:"statusUnknown"}};var lastValidMessageIconMap={true:{icon:"check-circle",color:"green",tooltipText:"Valid"},false:{icon:"exclamation-circle",color:"red",tooltipText:"Invalid"},null:{icon:"circle",color:"#f3f3f3",tooltipText:"Unknown"}};function buildFilter(filter){return _.assign({skipChildrenNames:true,fragmentType:deviceFragmentType},filter||{})}var filterDevices=c8yBase.createListFilter(filterDeviceFragment);function filterDeviceFragment(mo){return!!mo[deviceFragmentType]}var filterAllDevices=c8yBase.createListFilter(filterNoDevices);function filterNoDevices(mo){var keys=KEYS_FOR_NODEVICE;var ownerReg=/^device_/;var isdevice=filterDeviceFragment(mo)||TYPES_FOR_NO_DEVICE.indexOf(mo.type)===-1&&!_.find(keys,function(k){return!_.isUndefined(mo[k])});return isdevice}function list(filter){var _filter=buildFilter(filter);var http=c8yInventory.list(_filter);if(_filter.text){http=http.then(filterDevices)}return http}function searchIncludingChildDevices(opt){opt=opt||{};var filter=_.omit(buildFilter(opt),["fragmentType","query"]);var serverCall=opt.query?c8yInventory.listQuery(opt.query,filter):c8yInventory.list(filter);return serverCall.then(filterAllDevices)}function create(device){var mo=_.cloneDeep(device);mo[deviceFragmentType]=true;c8yInventory.create(mo)}function save(device){return device.id?update(device):create(device)}function supportsOperation(device,operation){var ops=device&&device.c8y_SupportedOperations;var supports=_.isArray(ops)&&ops.indexOf(operation)>-1;return!!supports}function getSupportedOperations(device){var ops=[];if(_.isArray(device.c8y_SupportedOperations)){ops=device.c8y_SupportedOperations}return ops}function isVendme(device){return device.type==="com_nsn_startups_vendme_VendingMachine"}function parseAvailability(device){var requiredAvailability=device&&device.c8y_RequiredAvailability;var availability=device&&device.c8y_Availability;var status=availability&&availability.status||(requiredAvailability?"UNKNOWN":"NOT_MONITORED");return status}function statusIcon(device){return availabilityIconMap[parseAvailability(device)].icon}function statusClass(device){return availabilityIconMap[parseAvailability(device)].cls}function lastValidMessageColor(device){return lastValidMessageIconMap[isLastValidMessage(device)].color}function lastValidMessageIcon(device){return lastValidMessageIconMap[isLastValidMessage(device)].icon}function lastValidMessageTooltip(device){return lastValidMessageIconMap[isLastValidMessage(device)].tooltipText}function isLastValidMessage(device){if(device.c8y_Availability&&device.c8y_Availability.lastMessage&&device.c8y_RequiredAvailability&&device.c8y_RequiredAvailability.responseInterval){var msInMunute=6e4;var now=moment().valueOf();var lastMessage=moment(device.c8y_Availability.lastMessage).valueOf();var responseInterval=device.c8y_RequiredAvailability.responseInterval*msInMunute;return now-lastMessage-responseInterval>0}else{return null}}function update(mo){removeCache(mo);return c8yInventory.update(mo)}function removeCache(mo){var id=mo&&mo.id||mo;if(_detailCached.cache){delete _detailCached.cache[id]}}function detail(mo,params){var _params=_.assign(params||{},{withParents:true});var detailPromise=c8yInventory.detail(mo,_params);if(_detailCached.cache){_detailCached.cache.set(mo&&(mo.id||mo),detailPromise)}return detailPromise}function listChildren(mo){var id=mo&&mo.id||mo;return $q.all([c8yInventory.childDevices(id),c8yInventory.childAssets(id)]).then(_.flattenDeep)}function getCount(filter){var _filter=buildFilter(filter);return c8yInventory.getCount(_filter)}var _detailCached=_.memoize(detail,function(moOrId){var moId=moOrId&&(moOrId.id||moOrId);detail(moId);return moId});function isDevice(mo){return!_.isUndefined(mo[deviceFragmentType])}function isChildDevice(mo){return mo.deviceParents.references.length>0}function model(mo){var prop=isVendme(mo)?"com_nsn_startups_vendme_fragments_VendingMachineTypeInfo":"c8y_Hardware";var hardware=mo&&mo[prop];return hardware&&hardware.model}function serial(mo){var prop=isVendme(mo)?"com_nsn_startups_vendme_fragments_VendingMachineTypeInfo":"c8y_Hardware";var prop2=isVendme(mo)?"serial":"serialNumber";var hardware=mo&&mo[prop];return hardware&&hardware[prop2]}function availabilityTooltip(mo){var availability=mo.c8y_Availability;var lastMessage=availability&&availability.lastMessage&&$filter("absoluteDate")(availability.lastMessage);return lastMessage?gettextCatalog.getString("Last message: {{date}}",{date:lastMessage}):gettextCatalog.getString("Connection not monitored")}function removeWithUser(device){return detail(device).then(function(res){var device=res.data;var owner=device.owner;var canBeDevice=device.c8y_IsDevice&&owner&&owner.match(/^device_/);canBeDevice=false;return canBeDevice?c8yUser.detail(owner).then(function(res){var user=res.data;var groups=c8yUser.groups(user);var isDevice=_.find(groups,{name:"devices"});return isDevice?c8yUser.remove(user):c8yUser}):device}).then(function(){return c8yInventory.remove(device)})}function properName(device){var paths=["name","id"];return(_.find(_.at(device,paths))||gettextCatalog.getString("<no name>"))+""}function getIPAddress(device){return _.find(_.at(device,FRAGMENTS_FOR_IP_ADDRESS))}function getChildren(device){var childAssets=device.childAssets?device.childAssets.references:[];var childDevices=device.childDevices?device.childDevices.references:[];var promiseArray=_.map(_.uniqBy(_.union(childAssets,childDevices),"id"),function(child){return detail(child.managedObject.id)});return $q.all(promiseArray).then(function(responses){return _.map(responses,function(response){return response.data})})}function canSwitchResponseInterval(device){return device&&device.c8y_RequiredAvailability&&device.c8y_RequiredAvailability.responseInterval&&parseInt(device.c8y_RequiredAvailability.responseInterval,10)!==0}function switchResponseInterval(device){var mo={id:device.id,c8y_RequiredAvailability:{}};if(canSwitchResponseInterval(device)){mo.c8y_RequiredAvailability.responseInterval=-device.c8y_RequiredAvailability.responseInterval}return c8yInventory.update(mo)}function getBreadcrumbsData(device){function collectBreadcrumbs(breadcrumbs,path,item){if(item){path.unshift(getBreadcrumb(item));return $q.all([c8yInventory.directParentDevices(item),c8yInventory.directParentAssets(item)]).then(function(results){var parents=[].concat(results[0]).concat(results[1]);if(parents.length===0){breadcrumbs.push(path);return $q.when(breadcrumbs)}else{var promises=[];_.forEach(parents,function(parent){promises.push(c8yInventory.detail(parent.id,{withParents:true}).then(c8yBase.getResData).then(function(p){return $q.when(collectBreadcrumbs(breadcrumbs,_.cloneDeep(path),p))}))});return $q.all(promises).then(function(){return breadcrumbs})}})}else{return $q.when(breadcrumbs)}}function getBreadcrumb(item){return{label:item.name||"Device "+item.id,path:getBreadcrumbPath(item),icon:getBreadcrumbIcon(item),isDevice:isDevice(item),isGroup:c8yGroups.isGroup(item),id:item.id}}function getBreadcrumbPath(item){var path="#/";path+=isDevice(item)?"device":"group";return path+"/"+item.id}function getBreadcrumbIcon(item){return isDevice(item)?"hdd-o":"folder-open"}function filterBreadcrumbPaths(breadcrumbPaths){return _.filter(breadcrumbPaths,function(path){return _.some(_.without(path,path[path.length-1]),function(breadcrumb){return breadcrumb.isDevice||breadcrumb.isGroup})})}function orderBreadcrumbPaths(breadcrumbPaths){return _.sortBy(breadcrumbPaths,function(item){return-1*item.length})}var deviceId=device?device.id||device:undefined;var breadcrumbsPromise=null;if(deviceId){if(breadcrumbsCache[deviceId]){breadcrumbsPromise=$q.when(breadcrumbsCache[deviceId])}var refreshedBreadcrumbsPromise=_detailCached(deviceId).then(c8yBase.getResData).then(function(currentDevice){return collectBreadcrumbs([],[],currentDevice).then(function(breadcrumbs){breadcrumbs=filterBreadcrumbPaths(breadcrumbs);breadcrumbs=orderBreadcrumbPaths(breadcrumbs);breadcrumbsCache[deviceId]=breadcrumbs;return breadcrumbs})});breadcrumbsPromise=breadcrumbsPromise||refreshedBreadcrumbsPromise}return breadcrumbsPromise||$q.when([])}return _.assign(_.cloneDeep(c8yInventory),{list:list,searchIncludingChildDevices:searchIncludingChildDevices,save:save,update:update,detail:detail,listChildren:listChildren,detailCached:_detailCached,create:create,removeWithUser:removeWithUser,supportsOperation:supportsOperation,getSupportedOperations:getSupportedOperations,getChildren:getChildren,isVendme:isVendme,statusIcon:statusIcon,statusClass:statusClass,parseAvailability:parseAvailability,getCount:getCount,isDevice:isDevice,isChildDevice:isChildDevice,model:model,serial:serial,availabilityTooltip:availabilityTooltip,properName:properName,getIPAddress:getIPAddress,canSwitchResponseInterval:canSwitchResponseInterval,switchResponseInterval:switchResponseInterval,isLastValidMessage:isLastValidMessage,lastValidMessageColor:lastValidMessageColor,lastValidMessageTooltip:lastValidMessageTooltip,lastValidMessageIcon:lastValidMessageIcon,getBreadcrumbsData:getBreadcrumbsData,isProbablyDevice:filterNoDevices})}})();(function(){"use strict";angular.module("c8y.core").factory("c8yDynamicGroups",c8yDynamicGroups);function c8yDynamicGroups($q,c8yBase,c8yModal,c8yInventory,c8yQueriesUtil,c8yFilteringSortingInventoryQueries){var DYNAMIC_GROUP_TYPE="c8y_DynamicGroup";var DYNAMIC_GROUP_FRAGMENT="c8y_IsDynamicGroup";var COLUMNS_CONFIG_FRAGMENT="c8y_UIDeviceFilterConfig";var QUERY_STRING_FRAGMENT="c8y_DeviceQueryString";var service={spawnEmpty:spawnEmpty,createWithUI:createWithUI,create:create,getGroupList:getGroupList,getGroupItems:getGroupItems,getColumnsConfig:getColumnsConfig,saveColumnsConfig:saveColumnsConfig,isDynamicGroup:isDynamicGroup,isDynamicGroupForId:isDynamicGroupForId};function spawnEmpty(){var empty={type:DYNAMIC_GROUP_TYPE};empty[DYNAMIC_GROUP_FRAGMENT]={};return empty}function createWithUI(columns,columnsConfig){return c8yModal({templateUrl:"/apps/core/scripts/ui/views/addDynamicGroupModal.html",controller:"addDynamicGroupModalController",resolve:{columns:_.constant(_.cloneDeep(columns)),columnsConfig:_.constant(_.cloneDeep(columnsConfig))}})}function create(dynamicGroup,columns,columnsConfig){dynamicGroup[COLUMNS_CONFIG_FRAGMENT]=columnsConfig;dynamicGroup[QUERY_STRING_FRAGMENT]=c8yQueriesUtil.buildQuery(c8yFilteringSortingInventoryQueries.getQuery(columns,columnsConfig));return c8yInventory.create(dynamicGroup).then(c8yBase.getResData)}function getGroupList(){return c8yInventory.list({fragmentType:DYNAMIC_GROUP_FRAGMENT})}function getGroupItems(group,filters){var groupPromise=_.isObjectLike(group)?$q.when(group):c8yInventory.detail(group).then(c8yBase.getResData);return groupPromise.then(function(mo){return c8yInventory.list(_.assign({q:mo[QUERY_STRING_FRAGMENT]},filters))})}function getColumnsConfig(group){var groupPromise=_.isObjectLike(group)?$q.when(group):c8yInventory.detail(group).then(c8yBase.getResData);return groupPromise.then(function(mo){return mo[COLUMNS_CONFIG_FRAGMENT]})}function saveColumnsConfig(group,columns,columnsConfig){var o={id:group.id||group};o[COLUMNS_CONFIG_FRAGMENT]=columnsConfig;o[QUERY_STRING_FRAGMENT]=c8yQueriesUtil.buildQuery(c8yFilteringSortingInventoryQueries.getQuery(columns,columnsConfig));return c8yInventory.save(o)}function isDynamicGroup(managedObject){return Boolean(managedObject[DYNAMIC_GROUP_FRAGMENT]||managedObject.type===DYNAMIC_GROUP_TYPE)}function isDynamicGroupForId(managedObjectId){return _.isUndefined(managedObjectId)?$q.when(false):c8yInventory.detailCached(managedObjectId).then(c8yBase.getResData).then(function(managedObject){return isDynamicGroup(managedObject)})}return service}})();(function(){"use strict";angular.module("c8y.core").service("c8yEvents",["$http","c8yBase","c8yCounter","gettext","KeysMixin",C8yEvents]);function C8yEvents($http,c8yBase,c8yCounter,gettext,KeysMixin){var self=this;var clean=c8yBase.cleanFields,path="event/events",defaultConfig={headers:c8yBase.contentHeaders("event","event")};this.reservedKeys=["creationTime","id","self","source","text","time","type","c8y_IsBinary"];this.standardKeys={type:gettext("Type")};function buildDetailUrl(evt){var id=evt.id||evt;return c8yBase.url(path+"/"+id)}function list(filters,cfg){var url=c8yBase.url(path);cfg=cfg||{};cfg.params=c8yBase.timeOrderFilter(c8yBase.pageSizeNoTotalFilter(filters));var onList=c8yBase.cleanListCallback("events",list,cfg.params);return $http.get(url,cfg).then(onList)}function detail(evt){var url=buildDetailUrl(evt);return $http.get(url)}function create(evt){var url=c8yBase.url(path),data=evt,cfg=_.cloneDeep(defaultConfig);return $http.post(url,data,cfg)}function update(evt){var url=buildDetailUrl(evt);var data=clean(evt,self.reservedKeys);var cfg=_.cloneDeep(defaultConfig);return $http.put(url,data,cfg)}function save(evt){return evt.id?self.update(evt):self.create(evt)}function createCounter(filter){var counter=new c8yCounter.Counter(list,"/events/*");var filterConfig=[c8yCounter.defaultPropertyMaps.date,c8yCounter.defaultPropertyMaps.source];if(filter.type){var type=filter.type;filterConfig.push([function(obj){return type===obj.type}])}delete filter.type;counter.filter(filter,filterConfig);return counter}_.assign(this,{list:list,detail:detail,create:create,update:update,save:save,createCounter:createCounter});_.assign(this,KeysMixin);_.bindAll(this,_.keys(KeysMixin))}})();angular.module("c8y.core").factory("c8yGeo",["$http","c8yKeys",function($http,c8yKeys){"use strict";var geoCodeSearchUrl="//open.mapquestapi.com/nominatim/v1/search.php?key="+c8yKeys.get("MAPQUESTAPI")+"&json_callback=JSON_CALLBACK";function geoCode(address){return $http.jsonp(geoCodeSearchUrl,{params:{format:"json",q:address}})}function Bounds(){this.points=[];return this}Bounds.prototype.add=function(p){var self=this;if(_.isArray(p)){_.forEach(p,function(x){self.points.push(x)});return self}if(p instanceof Bounds){self.add(p.points);return self}this.points.push(p);return self};Bounds.prototype.reset=function(){this.points.length=0};Bounds.prototype.get=function(){var bounds={southWest:{},northEast:{}};if(!this.points.length){bounds=null}this.points.forEach(function(p){if(p.lat<(bounds.southWest.lat||Infinity)){bounds.southWest.lat=p.lat}if(p.lng<(bounds.southWest.lng||Infinity)){bounds.southWest.lng=p.lng}if(p.lat>(bounds.northEast.lat||-Infinity)){bounds.northEast.lat=p.lat}if(p.lng>(bounds.northEast.lng||-Infinity)){bounds.northEast.lng=p.lng}});return bounds};var c8y_Position="c8y_Position";var v4e_Position="com_nsn_startups_vendme_fragments_GPSCoordinates";function getLocationFragment(mo){var fragment=mo[c8y_Position]||mo[v4e_Position];if(!fragment){return}var lat=Number(fragment.lat);var lng=Number(fragment.lng);if(!_.isNaN(lat)&&!_.isNaN(lng)&&Math.abs(fragment.lng)<=180&&Math.abs(fragment.lat)<=90){return{lat:lat,lng:lng}}else{var name=mo.name||mo.source&&mo.source.name;console.warn("Device",name,"has an invalid location")}}return{geoCode:geoCode,Bounds:Bounds,getLocationFragment:getLocationFragment,c8y_Position:c8y_Position,v4e_Position:v4e_Position}}]);(function(){"use strict";angular.module("c8y.core").factory("c8yGroupTypesConfig",c8yGroupTypesConfig);function c8yGroupTypesConfig(c8yInventory,$q){var type="c8y_GroupTypesConfig";var filtersGet={type:type,pageSize:1};return{save:save,get:get,getLookup:getLookup,getDeviceGroupType:getDeviceGroupType,getDeviceSubgroupType:getDeviceSubgroupType,getEmptyGroupType:getEmptyGroupType};function save(config){config.type=type;return c8yInventory.save(config)}function get(){return c8yInventory.list(filtersGet).then(getFirstOrDefault)}function getFirstOrDefault(configs){return configs.length>0?configs[0]:getDefault()}function getDefault(){return{type:type,groups:getDefaultGroupTypes()}}function getDefaultGroupTypes(){return[getDeviceGroupType()]}function getLookup(config){var configPromise=config?$q.when(config):get();return configPromise.then(_.partial(getGroupTypesConfigLookup,{}))}function getGroupTypesConfigLookup(_lookup,config){var lookup=_lookup||{};_.forEach(config.groups||{},function(groupConfig){lookup[groupConfig.type]=groupConfig;lookup=getGroupTypesConfigLookup(lookup,groupConfig)});return lookup}function getDeviceGroupType(){return{type:"c8y_DeviceGroup",name:"Default Group",namePlural:"Default Groups",showInNavigator:true,groups:[]}}function getDeviceSubgroupType(){return{type:"c8y_DeviceSubgroup",name:"Default Subgroup",namePlural:"Default Subgroups",showInNavigator:false,groups:[]}}function getEmptyGroupType(){return{name:"",namePlural:"",type:"",showInNavigator:false,groups:[]}}}})();(function(){"use strict";angular.module("c8y.core").factory("c8yGroups",c8yGroups);function c8yGroups($q,c8yBase,c8yInventory,c8yGroupTypesConfig,c8yPermissions){function getGroupItems(group){return c8yInventory.listQuery(getGroupItemsQuery(group),{withParents:true},true)}function getGroupAssetsAndDevices(group){var groupId=String(c8yBase.getId(group));var rejectAdditions=c8yBase.createListFilter(function(item){var additionParentsIds=_.map(_.get(item,"additionParents.references"),_.property("managedObject.id"));return!_.includes(additionParentsIds,groupId)});return getGroupItems(group).then(rejectAdditions)}function getGroupItemsQuery(group){return{__bygroupid:c8yBase.getId(group)}}function getGroupTypeItems(groupTypeName){return c8yGroupTypesConfig.getLookup().then(function(lookup){return[lookup[groupTypeName]]}).then(getGroupsByGroupTypes)}function getTopLevelGroups(){return c8yPermissions.mustHaveAllRoles(["ROLE_INVENTORY_READ"]).then(_getTopLevelGroups,loadRootDeviceGroups)}function _getTopLevelGroups(){return getTopLevelGroupTypes().then(getGroupsByGroupTypes)}function getTopLevelGroupTypes(){return c8yGroupTypesConfig.get().then(function(config){return config.groups})}function getGroupsByGroupTypes(groupTypesList){if(groupTypesList.length>0){var promises=[];_.forEach(groupTypesList,function(groupType){promises.push(c8yInventory.list({type:groupType.type}))});return $q.all(promises).then(_.flattenDeep)}return $q.when([])}function loadRootDeviceGroups(){var filter={fragmentType:"c8y_IsDeviceGroup",pageSize:1e3,withParents:true};var rootGroupsOnly=function(groups){return _.reject(groups,hasParents(groups))};return c8yInventory.list(filter).then(rootGroupsOnly)}function hasParents(groups){var groupsMap=_.keyBy(groups,"id");return function(group){var parentsIds=_.map(_.get(group,"assetParents.references"),_.property("managedObject.id"));return _.some(parentsIds,function(id){return _.get(groupsMap,id)})}}function isGroup(mo){return!!mo.c8y_IsDeviceGroup||mo.type==="c8y_DeviceGroup"}return{getGroupItems:getGroupItems,getGroupAssetsAndDevices:getGroupAssetsAndDevices,getGroupTypeItems:getGroupTypeItems,getTopLevelGroups:getTopLevelGroups,isGroup:isGroup}}})();angular.module("c8y.core").factory("c8yIdentity",["$http","c8yBase",function($http,c8yBase){"use strict";var path="identity",defaultConfig={headers:c8yBase.contentHeaders("externalId")};function onExternalIds(res){return res.data.externalIds}function buildUrlMo(mo){return c8yBase.url(path)+"/globalIds/"+(mo.id||mo)+"/externalIds"}function buildUrl(identity){return c8yBase.url(path)+"/externalIds/"+identity.type+"/"+encodeURIComponent(identity.externalId)}function createIdentity(mo,identity,cfg){var url=buildUrlMo(mo),_cfg=_.assign(_.cloneDeep(defaultConfig),cfg);return $http.post(url,identity,_cfg)}function deleteIdentity(identity){var url=buildUrl(identity);return $http["delete"](url)}function listExternalIds(mo){var url=buildUrlMo(mo);return $http.get(url).then(onExternalIds)}function getExternalId(identity,cfg){var url=buildUrl(identity);return $http.get(url,cfg)}return{createIdentity:createIdentity,deleteIdentity:deleteIdentity,listExternalIds:listExternalIds,getExternalId:getExternalId}}]);(function(){"use strict";angular.module("c8y.core").factory("c8yInventory",c8yInventory);function c8yInventory($http,$q,c8yBase,c8yUser,c8yRealtime,c8yQueriesUtil){var path="inventory/managedObjects";var moIdLocationRegExp="\\/inventory\\/managedObjects\\/(\\d+)";var defaultConfig={headers:c8yBase.contentHeaders("managedObject","managedObject")};var defaultConfigReference={headers:c8yBase.contentHeaders("managedObjectReference")};var fieldsToClean=["lastUpdated","assetParents","deviceParents","additionParents","childAssets","childDevices","childAdditions","c8y_ActiveAlarmsStatus","c8y_Availability"];var CHILD_ASSET="asset";var CHILD_DEVICE="device";var CHILD_ADDITION="addition";function buildDetailUrl(mo){var id=mo&&(mo.id||mo);return id&&c8yBase.url(path+"/"+id)}function buildChildrenUrl(mo,type){return buildDetailUrl(mo)+"/"+type}function buildChildUrl(mo,moChild,type){var id=moChild.id||moChild;return buildChildrenUrl(mo,type)+"/"+id}function cleanFilters(filters){var _filters=filters||{};var allowedWithText=["text","pageSize","currentPage","skipChildrenNames","fragmentType","q","query"];if(_filters.text){_filters=_.pick(_filters,allowedWithText)}return _filters}function list(filters){var url=c8yBase.url(path);var _filters=c8yBase.pageSizeFilter(cleanFilters(filters));var config={params:_filters};var blindPaging=true;var onList=c8yBase.cleanListCallback("managedObjects",list,_filters,blindPaging);return $http.get(url,config).then(onList)}function listQuery(query,params,queryAll){var _params=c8yBase.pageSizeFilter(params);var queryParam=queryAll?"query":"q";_params[queryParam]=c8yQueriesUtil.buildQuery(query);return list(_params)}function detail(mo,params,config){var url=buildDetailUrl(mo);var _params=params||{};var _config=_.defaults({params:_params},config);return url?$http.get(url,_config):$q.reject("Managed object not valid")}function detailCached(id){return detail(id)}function detailRealtime(mo,scope){var moRT;var moId=mo.id||mo;var moDetails=_.isObjectLike(mo)?$q.when(mo):detail(moId).then(c8yBase.getResData);var scopeId;var channel="/managedobjects/"+moId;var op=c8yRealtime.realtimeActions().UPDATE;var result;function updateListener(evt,data){mergeMoRT(data)}function mergeMoRT(_mo){if(!moRT){moRT=_mo}else{_.assign(moRT,_mo)}_.forEach(moRT,function(val,key){if(_mo[key]===undefined){delete moRT[key]}})}if(scope){scopeId=scope.$id;c8yRealtime.addListener(scopeId,channel,op,updateListener);c8yRealtime.start(scopeId,channel);scope.$on("stopRealtime",function(){c8yRealtime.stop(scopeId,channel)});scope.$on("$destroy",function(){c8yRealtime.stop(scopeId,channel)});result=moDetails.then(function(moData){mergeMoRT(moData);return moRT})}else{var output={};var promise=result=detail(moId).then(function(val){return _.merge(output,val.data)});var RTConfig={ops:op,channel:channel,onUpdate:function(e,data){_.merge(output,data);_.forEach(output,function(val,key){if(data[key]===undefined){delete output[key]}})}};var RTObject=c8yRealtime.watch(RTConfig);promise.stop=_.bind(RTObject.stop,RTObject);return promise}return result}function remove(mo,params){var url=buildDetailUrl(mo);if(!url){throw new Error("No managed object id provided!")}return $http.delete(url,{params:_.isObjectLike(params)?params:{}})}function create(mo){var url=c8yBase.url(path);var config=_.cloneDeep(defaultConfig);var data=c8yBase.cleanFields(mo,fieldsToClean);return $http.post(url,data,config)}function createChildAsset(mo,parent){return createChild(mo,parent,"childAssets")}function createChildDevice(mo,parent){return createChild(mo,parent,"childDevices")}function createChildAddition(mo,parent){return createChild(mo,parent,"childAdditions")}function createChild(mo,parent,type){var url=buildChildrenUrl(parent,type);var data=_.omit(mo,["id"]);var cfg=_.assign({},defaultConfig,{Accept:"application/json"});return $http.post(url,data,cfg)}function createConfirm(mo){return create(mo).then(getIdFromRes).then(detail)}function getIdFromRes(res){var regexp=new RegExp(moIdLocationRegExp);var matches=res.headers("Location").match(regexp);return matches[1]}function update(mo){var url=buildDetailUrl(mo);var cfg=_.cloneDeep(defaultConfig);var data=c8yBase.cleanFields(mo,fieldsToClean);removeCache(mo);return $http.put(url,data,cfg)}function save(mo){return mo.id?update(mo):create(mo)}function hasChildAssets(mo){return hasChildren(mo,"childAssets")}function hasChildDevices(mo){return hasChildren(mo,"childDevices")}function hasChildAdditions(mo){return hasChildren(mo,"childAdditions")}function hasChildren(mo,childType){return!!getChildrenCount(mo,childType)}function getChildAssetsCount(mo){return getChildrenCount(mo,"childAssets")}function getChildDevicesCount(mo){return getChildrenCount(mo,"childDevices")}function getChildAdditionsCount(mo){return getChildrenCount(mo,"childAdditions")}function getChildrenCount(mo,childType){return _.get(mo,[childType,"references","length"])}function childAssets(mo,config){return children(mo,"childAssets",config).then(onChildren)}function childDevices(mo,config){return children(mo,"childDevices",config).then(onChildren)}function childAdditions(mo,config){return children(mo,"childAdditions",config).then(onChildren)}function children(mo,type,config){var url=buildChildrenUrl(mo,type);var cfg=config||{};return detailCached(mo).then(function(res){return res.data[type].references.length}).then(function(childrenCount){cfg.params={pageSize:childrenCount};return $http.get(url,cfg)})}function onChildren(res){return _.map(res.data.references,_.property("managedObject"))}function addChildAsset(mo,moChild){return addChild(mo,moChild,"childAssets")}function addChildDevice(mo,moChild){return addChild(mo,moChild,"childDevices")}function addChildAddition(mo,moChild){return addChild(mo,moChild,"childAdditions")}function addChild(mo,moChild,type){var url=buildChildrenUrl(mo,type);var data={managedObject:moChild};var cfg=_.cloneDeep(defaultConfigReference);return $http.post(url,data,cfg)}function parentsAsset(mo,moType,moFragmentType){return parents(mo,"asset",moType,moFragmentType)}function parentsDevice(mo,moType,moFragmentType){return parents(mo,"device",moType,moFragmentType)}function parentsAddition(mo,moType,moFragmentType){return parents(mo,"addition",moType,moFragmentType)}function parents(mo,parentType,moType,moFragmentType){return detail(mo,{withParents:true}).then(function(res){var refPath="data."+parentType+"Parents.references";return _.map(_.get(res,refPath),_.property("managedObject.id"))}).then(function(parentIds){var out=[];var listFilter={ids:parentIds.join(",")};if(parentIds.length){out=list(listFilter);if(moType||moFragmentType){out=out.then(createFilterForTypes(moType,moFragmentType))}}return out})}function createFilterForTypes(moType,moFragmentType){return function(mos){return _.filter(mos,function(_mo){return moType&&_mo.type===moType||moFragmentType&&!_.isUndefined(_mo[moFragmentType])})}}function directParentAssets(mo,moType,moFragmentType){return directParents(mo,"asset",moType,moFragmentType)}function directParentDevices(mo,moType,moFragmentType){return directParents(mo,"device",moType,moFragmentType)}function directParentAdditions(mo,moType,moFragmentType){return directParents(mo,"addition",moType,moFragmentType)}function directParents(mo,parentType,moType,moFragmentType){var childIdParamName=_.camelCase(["child",_.lowerCase(parentType),"id"]);var filters={withParents:true};filters[childIdParamName]=mo.id||mo;return list(filters).then(function(_parents){return moType||moFragmentType?createFilterForTypes(moType,moFragmentType)(_parents):_parents})}function removeChildAsset(mo,moChild){return removeChild(mo,moChild,"childAssets")}function removeChildDevice(mo,moChild){return removeChild(mo,moChild,"childDevices")}function removeChildAddition(mo,moChild){return removeChild(mo,moChild,"childAdditions")}function removeChild(mo,moChild,type){var url=buildChildUrl(mo,moChild,type);return $http.delete(url)}function removeCache(mo){var id=mo&&mo.id||mo;delete _detailCached.cache[id]}function getCount(filter){return c8yBase.getCount(list,filter||{})}function getSupportedMeasurements(mo){var url=buildDetailUrl(mo)+"/supportedMeasurements";return $http.get(url).then(_.property("data.c8y_SupportedMeasurements"))}function _getSupportedSeries(mo){var url=buildDetailUrl(mo)+"/supportedSeries";return $http.get(url).then(_.property("data.c8y_SupportedSeries"))}function getSupportedSeries(mo){return $q.all([getSupportedMeasurements(mo),_getSupportedSeries(mo)]).then(function(results){var supportedMeasurements=_.sortBy(results[0],"length").reverse();var supportedSeries=results[1];return _(supportedSeries).map(function(s){var fragment=_.find(supportedMeasurements,function(m){return s.indexOf(m)===0});var series=s.replace(fragment+".","");return{fragment:fragment,series:series}}).filter(_.property("fragment")).value()})}function getFragments(mo){var fieldsToIgnore=_.union(fieldsToClean,["id","type","name","owner","self"]);return _.keys(c8yBase.cleanFields(mo,fieldsToIgnore))}function isOwner(mo,user){var promises={user:user?$q.when(user):c8yUser.current(),owner:getOwner(mo)};return $q.all(promises).then(function(results){return results.user.userName===results.owner})}function isOwnerCached(mo,user){var promises={user:user?$q.when(user):c8yUser.current(),owner:getOwnerCached(mo)};return $q.all(promises).then(function(results){return results.user.userName===results.owner})}function getOwner(mo){var propertyOwner="owner";var knownOwner=_.get(mo,propertyOwner);var detailsPromise=knownOwner?$q.when(mo):detail(mo).then(c8yBase.getResData);return detailsPromise.then(_.property(propertyOwner))}var getOwnerCached=_.memoize(getOwner,function(mo){return c8yBase.getId(mo)});var _detailCached=_.memoize(detailCached,_.identity);return{list:list,listQuery:listQuery,detail:detail,detailCached:_detailCached,detailRealtime:detailRealtime,create:create,createChild:createChild,createConfirm:createConfirm,
update:update,save:save,remove:remove,hasChildAssets:hasChildAssets,hasChildDevices:hasChildDevices,hasChildAdditions:hasChildAdditions,getChildAssetsCount:getChildAssetsCount,getChildDevicesCount:getChildDevicesCount,getChildAdditionsCount:getChildAdditionsCount,childAssets:childAssets,childDevices:childDevices,childAdditions:childAdditions,addChildAsset:addChildAsset,addChildDevice:addChildDevice,addChildAddition:addChildAddition,createChildAsset:createChildAsset,createChildDevice:createChildDevice,createChildAddition:createChildAddition,removeChildAsset:removeChildAsset,removeChildDevice:removeChildDevice,removeChildAddition:removeChildAddition,parentsAsset:parentsAsset,parentsDevice:parentsDevice,parentsAddition:parentsAddition,directParentAssets:directParentAssets,directParentDevices:directParentDevices,directParentAdditions:directParentAdditions,getCount:getCount,getFragments:getFragments,getSupportedMeasurements:getSupportedMeasurements,getSupportedSeries:getSupportedSeries,isOwner:isOwner,isOwnerCached:isOwnerCached,getOwner:getOwner,getOwnerCached:getOwnerCached}}})();(function(){"use strict";angular.module("c8y.core").factory("c8yJsonSchemas",c8yJsonSchemas);function c8yJsonSchemas(c8yBase,c8yInventory){var type="c8y_JsonSchema";var defaults={type:type,name:"",appliesTo:{},c8y_JsonSchema:{type:"object",properties:{}}};var listPageSize=1e3;var defaultListFilter={type:type,pageSize:listPageSize};var service={getDefaults:getDefaults,list:list,detail:detail,create:create,update:update,save:save,remove:remove};return service;function getDefaults(){return _.cloneDeep(defaults)}function list(filter){return c8yInventory.list(_.defaults(filter,defaultListFilter))}function detail(schemaId){return c8yInventory.detail(schemaId).then(c8yBase.getResData)}function save(schema){return _.isUndefined(schema.id)?create(schema):update(schema)}function create(schema){return c8yInventory.create(_.defaults(schema,defaults))}function update(schema){return c8yInventory.update(schema)}function remove(schema){return c8yInventory.remove(schema)}}})();(function(){"use strict";angular.module("c8y.core").factory("c8yKpi",["$q","$log","c8yInventory","c8yMeasurements","c8yUser","c8yBase","c8yPermissions","c8yAlert","c8yBatchOp",c8yKpi]);function c8yKpi($q,$log,c8yInventory,c8yMeasurements,c8yUser,c8yBase,c8yPermissions,c8yAlert,c8yBatchOp){var FRAG="c8y_Kpi",FLOAT_FIELDS=["target","min","max","yellowRangeMin","yellowRangeMax","redRangeMin","redRangeMax"];function list(){return c8yInventory.list({fragmentType:FRAG}).then(filterOld).then(updateGlobalFlagIfNeededAndReturnList)}function updateGlobalFlagIfNeededAndReturnList(list){return c8yPermissions.mustHaveAnyRole(["ROLE_INVENTORY_ADMIN"]).then(function(){var kpisToUpdate=_.filter(list,function(kpi){return!!_.isUndefined(kpi.c8y_Global)});var ops=_.map(kpisToUpdate,function(kpi){return function(){return save(kpi)}});return c8yBatchOp.run(ops,"Updating KPIs...").result.then(function(result){if(result!=="complete"){c8yAlert.danger("Failed to update KPIs!")}return list})},_.noop)}function listByIds(ids){return list().then(function(kpis){if(ids&&ids.length){return _.filter(kpis,function(kpi){return ids.indexOf(kpi.id)>-1})}else{return kpis}})}function isPureKpi(mo){var allowedKeys=[FRAG,"id","lastUpdated","creationTime","owner","self","c8y_Global","_fragments","assetParents","deviceParents","additionParents","childAssets","childDevices","childAdditions"];var keys=_.keys(mo);return _.every(keys,function(key){return allowedKeys.indexOf(key)>-1})}function filterOld(managedObjects){var oldDevices=_.filter(managedObjects,function(mo){return!isPureKpi(mo)&&!mo.c8y_Kpi_Migrated});if(oldDevices.length){$log.info("Not migrated deprecated KPI found: ",oldDevices.length)}return $q.when(_.filter(managedObjects,isPureKpi))}function detail(id){return c8yInventory.detail(id).then(function(res){var data=res.data.c8y_Kpi;_.forEach(FLOAT_FIELDS,function(field){if(!_.isUndefined(data[field])){data[field]=parseFloat(data[field]);if(isNaN(data[field])){delete data[field]}}});return res})}function listKpiForDevice(device){var deviceId=device.id||device;return $q.all([list(),c8yInventory.getSupportedSeries(deviceId)]).then(function(promises){var kpis=promises[0],series=promises[1];var matchKpi=_.filter(kpis,function(k){return _.find(series,{fragment:k.c8y_Kpi.fragment,series:k.c8y_Kpi.series})}),nonKpiSeries=_.filter(series,function(s){return!_.find(kpis,function(k){return k.c8y_Kpi.fragment===s.fragment&&k.c8y_Kpi.series===s.series})});return{matchKpi:matchKpi,nonKpiSeries:nonKpiSeries}})}function onMeasurement(kpi,measurement){var data=(measurement||{})[kpi.fragment]||{};data.kpi=kpi;data.time=(measurement||{}).time;data.source=(measurement||{}).source;return data}function getMeasurement(_kpi,device,overRidePageSize){var kpi=_kpi.c8y_Kpi||_kpi;return c8yMeasurements.list(_.assign(c8yBase.timeOrderFilter(),{revert:true,fragmentType:kpi.fragment,source:device,pageSize:overRidePageSize||10})).then(function(measurements){return _.find(measurements,function(m){var frag=m[_kpi.fragment];return frag&&!_.isUndefined(frag[_kpi.series])})}).then(_.partial(onMeasurement,kpi))}function save(kpi){var kpiCopy=_.cloneDeep(kpi);delete kpiCopy._measurement;kpiCopy.c8y_Global={};return c8yInventory.save(kpiCopy)}return{list:list,listByIds:listByIds,detail:detail,remove:c8yInventory.remove,save:save,listKpiForDevice:listKpiForDevice,getMeasurement:getMeasurement}}})();(function(){"use strict";angular.module("c8y.core").factory("c8yMeasurements",["$http","$q","$timeout","c8yBase","c8yCepModule","c8yRealtime",c8yMeasurements]);function c8yMeasurements($http,$q,$timeout,c8yBase,c8yCepModule,c8yRealtime){var clean=c8yBase.clean;var path="measurement/measurements";var defaultConfig={headers:c8yBase.contentHeaders("measurement")};var cepModule={status:"DEPLOYED",name:"c8yui_measurements",body:'insert into SendNotification select measurement as payload, "c8yui/measurements" as channelName '+"from MeasurementCreated;"};var PAGE_SIZE=1440;var checkForJsonStream=_.once(_checkForJsonStream);function buildDetailUrl(measurement){var id=measurement.id||measurement;return c8yBase.url(path)+"/"+id}var Format=c8yBase.createEnum([{name:"stream",value:"application/json-stream"},{name:"csv",value:"text/csv"},{name:"xlsx",value:"application/vnd.ms-excel"}]);function acceptHeader(_format){return checkForJsonStream().then(function(){var isValid=_format&&_(Format).reject("notAcceptable").map("value").includes(_format.value);return isValid?_format.value:"application/json"})}function list(filters,format){var url=c8yBase.url(path);var _filters=_.assign({},c8yBase.todayFilter({}),{pageSize:PAGE_SIZE},filters);var cfg={params:_filters};var onList;if(format){cfg.responseType="blob";onList=function(res){return res.data}}else{onList=c8yBase.cleanListCallback("measurements",list,_filters)}return acceptHeader(format||Format.stream).then(function(accept){cfg.headers={Accept:accept};return $http.get(url,cfg).then(function(res){if(res.status===202){return $q.reject({async:true,data:res.data})}return res})}).then(onList)}function listPaged(filters){var defer=$q.defer();var _filters=_.assign(filters||{},{pageSize:1e3,withTotalPages:true});var cancelled=false;var onList=function(list){var isNext=!_.isUndefined(list.paging.next)&&list.length>=_filters.pageSize;defer.notify(list);if(!isNext){defer.resolve(true)}if(cancelled){return true}return isNext?list.paging.next().then(onList):true};_.assign(defer.promise,{cancel:function(){cancelled=true;defer.reject("canceled")}});list(_filters).then(onList);return defer.promise}function listSeries(filters){var pageSizeCustom=PAGE_SIZE;var url=c8yBase.url(path+"/series");var _filters=c8yBase.todayFilter(_.assign({pageSize:pageSizeCustom,revert:true},filters||{}));function cleanCachequest(filter,request){_.remove(listSeries._cacheFilter,filter);_.remove(listSeries._cacheRequest,request)}if(_filters.dateFrom){_filters.dateFrom=moment(_filters.dateFrom).format(c8yBase.dateFullFormat)}if(_filters.dateTo){_filters.dateTo=moment(_filters.dateTo).format(c8yBase.dateFullFormat)}var cfg={params:_filters};var onList=function(res){return res.data};var requestIndex=_.findIndex(listSeries._cacheFilter,_.partial(_.isEqual,_filters));var request=requestIndex>=0?listSeries._cacheRequest[requestIndex]:null;if(_filters.dateFrom){_filters.dateFrom=moment(_filters.dateFrom).format(c8yBase.dateFullFormat)}if(_filters.dateTo){_filters.dateTo=moment(_filters.dateTo).format(c8yBase.dateFullFormat)}if(!request){request=$http.get(url,cfg).then(onList);var filtersRef=_.cloneDeep(_filters);var cacheDuration=3e3;listSeries._cacheFilter.push(_.cloneDeep(filtersRef));listSeries._cacheRequest.push(request);if(moment(_filters.dateTo).isAfter(moment())){setTimeout(function(){cleanCachequest(filtersRef,request)},cacheDuration)}}return request}listSeries._cacheFilter=[];listSeries._cacheRequest=[];function listSeriesPaged(filters){var defer=$q.defer();var _filters=_.assign({revert:true},filters||{},{pageSize:1e3,withTotalPages:true});var cancelled=false;var onList=function(list){defer.notify(list);if(!list.paging.next){defer.resolve(true)}if(cancelled){return true}return list.paging.next?list.paging.next().then(onList):true};_.assign(defer.promise,{cancel:function(){cancelled=true;defer.reject("canceled")}});listSeries(_filters).then(onList);return defer.promise}function detail(measurement){var url=buildDetailUrl(measurement);return $http.get(url)}function create(measurement){var url=c8yBase.url(path),data=measurement,cfg=_.cloneDeep(defaultConfig);if(!data.source){throw new Error("c8yMeasurement: source must be defined")}return $http.post(url,data,cfg)}function update(measurement){var url=buildDetailUrl(measurement),data=clean(measurement),cfg=_.cloneDeep(defaultConfig);return $http.put(url,data,cfg)}function save(measurement){return measurement.id?update(measurement):create(measurement)}function remove(measurement){var url=buildDetailUrl(measurement);return $http["delete"](url)}function activateCep(){return c8yCepModule.createOrDeploy(cepModule)}function latest(filter,realtime){var _filter=filter||{},output={};if(!_filter.device){throw new Error("filter.device must be defined")}if(!_filter.fragment){throw new Error("filter.fragment must be defined")}if(!_filter.series){throw new Error("filter.series must be defined")}var cfg=_.assign(c8yBase.timeOrderFilter(),{revert:true,fragmentType:_filter.fragment,source:_filter.device,pageSize:10});var promise=list(cfg).then(function(measurements){return _.find(measurements,function(m){var frag=m[_filter.fragment];return frag&&!_.isUndefined(frag[_filter.series])})}).then(function(val){_.assign(output,val||{});return output});if(realtime){var rt_cfg={ops:"CREATE",channel:"/measurements/"+_filter.device,onUpdate:function(e,data){var f=data[_filter.fragment],s=f&&f[_filter.series];if(s){_.assign(output,data)}}},rt_obj=c8yRealtime.watch(rt_cfg);promise.stop=_.bind(rt_obj.stop,rt_obj)}return promise}function listForDataPoint(dataPoint,dateFrom,dateTo,aggregation){listForDataPoint._cachedRequests=listForDataPoint._cachedRequests||[];var cachedRequests=listForDataPoint._cachedRequests;var deviceId=dataPoint.__target.id;var aggregationType=(aggregation!=="NONE"?aggregation:0)||undefined;if(dateFrom){dateFrom=moment(dateFrom);switch(aggregation){case"HOURLY":dateFrom.subtract(1,"hour").startOf("hour");break;case"DAILY":dateFrom.subtract(1,"day").startOf("day");break;default:dateFrom.subtract(1,"minute").startOf("minute")}dateFrom=dateFrom.format(c8yBase.dateFullFormat)}if(dateTo){dateTo=moment(dateTo);switch(aggregation){case"HOURLY":dateTo.add(1,"hour").startOf("hour");break;case"DAILY":dateTo.add(1,"days").startOf("day");break;default:dateTo.add(1,"minute").startOf("minute")}dateTo=dateTo.format(c8yBase.dateFullFormat)}var filters={dateFrom:dateFrom,dateTo:dateTo,source:deviceId,aggregationType:aggregationType};var request=_.find(cachedRequests,function(cr){return _.isMatch(cr.filters,filters)});if(!request){request={deferred:$q.defer(),sendThrottled:function(){request._sendThrottled();return request.deferred.promise},_sendThrottled:_.throttle(function(){listSeries(request.filters).then(_.unary(request.deferred.resolve))},500),filters:filters};cachedRequests.push(request)}var seriesName=[dataPoint.fragment,dataPoint.series].join(".");request.filters.series=_.uniq((request.filters.series||[]).concat([seriesName]));return $timeout(function(){return request.sendThrottled().then(callbackForListDataPoint(dataPoint)).then(function(obj){obj.aggregation=aggregation;obj.dateFrom=dateFrom;obj.dateTo=dateTo;return obj}).finally(function(){_.remove(cachedRequests,request)})},5)}function callbackForListDataPoint(dataPoint){return function(data){var ix=_.findIndex(data.series,function(s){return s.name===dataPoint.series&&s.type===dataPoint.fragment}),list=[];if(ix>-1){_.forEach(data.values,function(obj,key){if(_.isObjectLike(obj[ix])){list.push({time:key,min:Number(obj[ix].min),max:Number(obj[ix].max)})}})}return{dataPoint:dataPoint,values:list,truncated:data.truncated}}}function rtMeasurementForDatapoint(datapoint){return function(m){var id=datapoint.__target.id,frag=datapoint.fragment,series=datapoint.series,fits=m.source.id===id&&m[frag]&&m[frag][series];return fits&&{dataPoint:datapoint,values:[{time:m.time,min:m[frag][series].value,max:m[frag][series].value}]}}}function _checkForJsonStream(){var url=c8yBase.url(path);var config={params:{pageSize:1},headers:{Accept:Format.stream.value},silentError:true};if(window.c8y_testing){return $q.when()}return $http.get(url,config).catch(function(res){Format.stream.notAcceptable=res.status===406})}return{format:Format,list:list,listPaged:listPaged,listSeries:listSeries,listSeriesPaged:listSeriesPaged,detail:detail,create:create,update:update,save:save,remove:remove,activateCep:activateCep,latest:latest,listForDataPoint:listForDataPoint,rtMeasurementForDatapoint:rtMeasurementForDatapoint}}})();(function(){"use strict";angular.module("c8y.core").factory("c8yMessaging",["$http","$q","c8yBase",c8yMessaging]);function c8yMessaging($http,$q,c8yBase){var METHOD="POST",PATH={prefix:"service/sms/smsmessaging/v1/outbound/",suffix:"/requests"};function buildRequestFunction(data){var url,cfg;url=c8yBase.url(PATH.prefix+data.outboundSMSMessageRequest.senderAddress+PATH.suffix);data.outboundSMSMessageRequest.receiptRequest=data.outboundSMSMessageRequest.receiptRequest||{notifyUrl:null,callbackData:null};data.outboundSMSMessageRequest.receiptRequest.notifyUrl=data.outboundSMSMessageRequest.receiptRequest.notifyUrl||null;data.outboundSMSMessageRequest.receiptRequest.callbackData=data.outboundSMSMessageRequest.receiptRequest.callbackData||null;data.outboundSMSMessageRequest.senderName=data.senderName||null;cfg={method:METHOD,url:url,data:data,headers:{Accept:"application/json","Content-type":"application/json"}};return $http(cfg)}function sendSms(data){return data.outboundSMSMessageRequest&&data.outboundSMSMessageRequest.address&&data.outboundSMSMessageRequest.senderAddress&&data.outboundSMSMessageRequest.outboundSMSTextMessage&&data.outboundSMSMessageRequest.outboundSMSTextMessage.message?buildRequestFunction(data):$q.reject("Invalid SMS data")}return{sendSms:sendSms}}})();(function(){"use strict";angular.module("c8y.core").factory("c8yNotifications",c8yNotifications);function c8yNotifications($rootScope,$q,$timeout,c8yBase,c8yAuth,c8yLongPollingTransport){var cometd=new org.cometd.CometD;var subscriptionMap={};var path="cep/customnotifications";var pathNotifications="cep/notifications";var url=c8yBase.url(path);var cfg={url:url,logLevel:"info",requestHeaders:c8yAuth.headers(),appendMessageTypeToURL:false};var timeout=57e4;var abortConnection;var onSubscribeListener;var debugNotificationsCfg=_.cloneDeep(cfg);debugNotificationsCfg.url=c8yBase.url(pathNotifications);cometd.unregisterTransports();if(c8yBase.getFlag("e2e")){timeout=1}else{cometd.registerTransport("long-polling",new c8yLongPollingTransport.LongPollingTransport)}cometd.registerExtension("acceptEmptyMessages",{incoming:function(message){if(message.successful===undefined&&message.data===undefined){message.data={message:"The output from statement was empty"}}}});cometd.configure(_.cloneDeep(cfg));function newAbortConnectionTimer(){return $timeout(function(){cometd.getTransport().abort()},timeout)}function onSubscribe(msg){var subscription=getSubscriptionByMsg(msg);subscription.scope.$emit("connected");subscription.scope.connected=true}function onMessage(scope,msg){if(abortConnection){$timeout.cancel();abortConnection=newAbortConnectionTimer()}scope.$emit("message",msg)}function onUnsubscribe(sub){sub.counter--;if(!sub.counter){cometd.unsubscribe(sub.comet);delete subscriptionMap[sub.channel];if(!_.keys(subscriptionMap).length){disconnect()}}}function disconnect(){if(abortConnection){$timeout.cancel(abortConnection);abortConnection=undefined}cometd.removeListener(onSubscribeListener);cometd.disconnect()}function status(){return cometd.getStatus()}function updateHeaders(){cfg.requestHeaders=c8yAuth.headers();debugNotificationsCfg.requestHeaders=c8yAuth.headers()}function connect(){var defer=$q.defer();if(cometd.isDisconnected()){cometd.handshake();var connectListener=cometd.addListener("/meta/connect",function(){defer.resolve(true);cometd.removeListener(connectListener)});var unauthorizedListener=cometd.addListener("/meta/connect",function(message){if(message.failure&&message.failure.httpCode===401){cometd.disconnect();cometd.removeListener(unauthorizedListener)}});onSubscribeListener=cometd.addListener("/meta/subscribe",onSubscribe)}else{defer.resolve(true)}return defer.promise}function getSubscriptionByMsg(msg){var subscriptions=_.keys(subscriptionMap).filter(function(sub){return msg.subscription.match(sub)});return subscriptionMap[subscriptions[0]]}function getSubscription(channel){return subscriptionMap[channel]}function subscribe(channel){var sub=getSubscription(channel)||{};var created=false;if(!sub.channel){created=true;subscriptionMap[channel]=sub;sub.channel=channel;sub.scope=$rootScope.$new(true);sub.scope.unsubscribe=angular.bind({},onUnsubscribe,sub);sub.counter=0}sub.counter++;return connect().then(function(){if(created){sub.comet=cometd.subscribe(channel,angular.bind({},onMessage,sub.scope));abortConnection=newAbortConnectionTimer()}return sub.scope})}function configure(type){updateHeaders();var _cfg=_.cloneDeep(type==="debug"?debugNotificationsCfg:cfg);cometd.configure(_cfg)}return{subscribe:subscribe,configure:configure,status:status}}})();(function(){"use strict";angular.module("c8y.core").factory("c8yPermissions",c8yPermissions);function c8yPermissions($routeParams,$q,$http,c8yBase,c8yUser,c8yUserGroup,c8yInventory,gettext){var moPermissionsPath="user/devicePermissions";var PERMISSION_SCOPES=c8yBase.createEnum([{name:"ALARM",value:"ALARM",label:gettext("Alarms")},{name:"AUDIT",value:"AUDIT",label:gettext("Audits")},{name:"EVENT",value:"EVENT",label:gettext("Events")},{name:"MANAGED_OBJECT",value:"MANAGED_OBJECT",label:gettext("Inventory")},{name:"MEASUREMENT",value:"MEASUREMENT",label:gettext("Measurements")},{name:"OPERATION",value:"OPERATION",label:gettext("Device control")},{name:"SUPPORT",value:"SUPPORT",label:gettext("Support")},{name:"ALL",value:"*",label:gettext("Full access")}]);var PERMISSIONS=c8yBase.createEnum([{name:"READ",value:"READ",label:gettext("Read")},{name:"CHANGE",value:"ADMIN",label:gettext("Change")},{name:"ALL",value:"*",label:gettext("All")}]);function hasRole(user,roleId){var result=hasRoleInUser(user,roleId);if(!result){result=hasRoleInGroups(user,roleId)}return result}function hasRoleInUser(user,roleId){var result=false;if(user.roles&&user.roles.references){_.forEach(user.roles.references,function(ref){if(ref.role.id===roleId){result=true}})}return result}function hasRoleInGroups(user,roleId){var result=false;if(user.groups&&user.groups.references){_.forEach(user.groups.references,function(groupRef){_.forEach(groupRef.group.roles.references,function(roleRef){if(roleRef.role.id===roleId){result=true}})})}return result}function hasDevicePermission(user,moId,scope,type,permission){var result=hasDevicePermissionInUser(user,moId,scope,type,permission);if(!result){result=hasDevicePermissionInGroups(user,moId,scope,type,permission)}return result}function hasDevicePermissionInUser(user,moId,scope,type,permission){var result=false;if(user.devicePermissions&&user.devicePermissions[moId]){result=doesAnyDevicePermissionMatch(user.devicePermissions[moId],scope,type,permission)}return result}function hasDevicePermissionInGroups(user,moId,scope,type,permission){var result=false;if(user.groups&&user.groups.references){_.forEach(user.groups.references,function(groupRef){if(groupRef.group.devicePermissions&&groupRef.group.devicePermissions[moId]){result=doesAnyDevicePermissionMatch(groupRef.group.devicePermissions[moId],scope,type,permission)}})}return result}function doesAnyDevicePermissionMatch(devicePermissions,scope,type,permission){return _.some(devicePermissions,_.partial(doesSingleDevicePermissionMatch,scope,type,permission))}function doesSingleDevicePermissionMatch(scope,type,permission,devicePermission){var result=false;var parts=devicePermission.split(":");var scopePart=parts[0];var typePart=parts[1];var permissionPart=parts[2];if(doesDevicePermissionPartMatch(scopePart,scope)&&doesDevicePermissionPartMatch(typePart,type)&&doesDevicePermissionPartMatch(permissionPart,permission)){result=true}return result}function doesDevicePermissionPartMatch(devicePermissionPart,value){return devicePermissionPart==="*"||devicePermissionPart===value}function hasAnyRole(roles,user){var userPromise=user?$q.when(user):c8yUser.current();return userPromise.then(function(u){return _.some(roles,_.partial(hasRole,u))})}function mustHaveAnyRole(roles,user){return booleanPromiseToRejectablePromise(hasAnyRole(roles,user))}function hasAllRoles(roles,user){var userPromise=user?$q.when(user):c8yUser.current();return userPromise.then(function(u){return _.every(roles,_.partial(hasRole,u))})}function mustHaveAllRoles(roles,user){return booleanPromiseToRejectablePromise(hasAllRoles(roles,user))}function canReadMOs(mos,user){return $q.all(_.map(_.filter(mos,_.identity),_.partialRight(canReadMO,user))).then(allTrue)}function canReadMO(mo,user){var moId=mo.id||mo;var useCurrentUser=!user;var userPromise=useCurrentUser?c8yUser.current():$q.when(user);var checkDevicePermission=function(_user){return function(result){return result||hasDevicePermission(_user,moId,"MANAGED_OBJECT","*","READ")}};var checkOwnership=function(_user){return function(result){return result||c8yInventory.isOwnerCached(mo,_user)}};var checkWithRequest=function(result){return result||checkAccessWithRequest(moId,"read")};return userPromise.then(function(_user){return hasAnyRole(["ROLE_INVENTORY_READ"],_user).then(checkDevicePermission(_user)).then(checkOwnership(_user)).then(useCurrentUser?checkWithRequest:_.identity)})}var checkAccessWithRequest=_.memoize(_checkAccessWithRequest,function(id,mode){return id+acccessModeToHttpMethod(mode)});function acccessModeToHttpMethod(mode){return mode==="admin"?"PUT":"HEAD"}function _checkAccessWithRequest(id,mode){var url=c8yBase.url("inventory/managedObjects/"+id);var method=acccessModeToHttpMethod(mode);return $http({method:method,data:method==="PUT"?{}:undefined,headers:{"content-type":"application/json",accept:undefined},silentError:true,url:url}).then(_.constant(true),_.constant(false))}function mustHaveReadMOs(mos,user){return booleanPromiseToRejectablePromise(canReadMOs(mos,user))}function canAdminMOs(mos,user){return $q.all(_.map(_.filter(mos,_.identity),_.partialRight(canAdminMO,user))).then(allTrue)}function canAdminMO(mo,user){var moId=mo.id||mo;var useCurrentUser=!user;var userPromise=useCurrentUser?c8yUser.current():$q.when(user);var checkDevicePermission=function(_user){return function(result){return result||hasDevicePermission(_user,moId,"MANAGED_OBJECT","*","ADMIN")}};var checkOwnership=function(_user){return function(result){return result||c8yInventory.isOwnerCached(mo,_user)}};var checkWithRequest=function(result){return result||checkAccessWithRequest(moId,"admin")};return userPromise.then(function(_user){return hasAnyRole(["ROLE_INVENTORY_ADMIN"],_user).then(checkDevicePermission(_user)).then(checkOwnership(_user)).then(useCurrentUser?checkWithRequest:_.identity)})}function mustHaveAdminMOs(mos,user){return booleanPromiseToRejectablePromise(canAdminMOs(mos,user))}function isAllowed(cfg,user){var promises=[];if(cfg.anyRole){promises.push(hasAnyRole(cfg.anyRole,user))}if(cfg.allRoles){promises.push(hasAllRoles(cfg.allRoles,user))}if(cfg.readMOs){promises.push(canReadMOs(resolveMOs(cfg.readMOs),user))}if(cfg.adminMOs){promises.push(canAdminMOs(resolveMOs(cfg.adminMOs),user))}return $q.all(promises).then(allTrue)}function resolveMOs(mos){return _.filter(_.map(mos,function(mo){return isRouteParam(mo)?getRouteParam(mo):mo}),_.identity)}function isRouteParam(str){return _.isString(str)&&/^:/.test(str)}function getRouteParam(str){return $routeParams[str.replace(/^:/,"")]}function mustBeAllowed(cfg,user){return booleanPromiseToRejectablePromise(isAllowed(cfg,user))}function booleanPromiseToRejectablePromise(promise){return promise.then(function(result){return result?$q.when(result):$q.reject(result)})}function allTrue(arr){return _.every(arr,function(a){return!!a})}function getMOPermissions(mo){var moId=mo.id||mo;var url=c8yBase.url(moPermissionsPath+"/"+moId);if(_.isObjectLike(moId)){return $q.when({groups:[],users:[]})}return $http.get(url).then(c8yBase.getResData).then(_.partial(parsePermissionsData,moId))}function parsePermissionsData(moId,data){var permissions={groups:[],users:[]};_.forEach(data.groups,_.partial(parseGroupPermissions,permissions,moId));_.forEach(data.users,_.partial(parseUserPermissions,permissions,moId));return permissions}function parseGroupPermissions(permissions,moId,group){_.forEach(group.devicePermissions[moId],function(devPerm){var parsedDevPerm=parseDevPerm(devPerm);var p={group:{id:group.id,name:group.name},scope:parsedDevPerm.scope,type:parsedDevPerm.type,access:parsedDevPerm.access};permissions.groups.push(p)})}function parseUserPermissions(permissions,moId,user){_.forEach(user.devicePermissions[moId],function(devPerm){var parsedDevPerm=parseDevPerm(devPerm);var p={username:user.userName,scope:parsedDevPerm.scope,type:parsedDevPerm.type,access:parsedDevPerm.access};permissions.users.push(p)})}function parseDevPerm(devPerm){var permissionParts=devPerm.split(":");return{scope:permissionParts[0],type:permissionParts[1],access:permissionParts[2]}}function setMOPermissions(mo,permissions){var moId=mo.id||mo;var url=c8yBase.url(moPermissionsPath+"/"+moId);var data=parsePermissions(moId,permissions);return $http.put(url,data)}function parsePermissions(moId,permissions){var data={groups:[],users:[]};parseGroupsPermissions(data.groups,moId,permissions.groups);parseUsersPermissions(data.users,moId,permissions.users);return data}function parseGroupsPermissions(groupsData,moId,groupsPermissions){var permissionsByGroupId=_.groupBy(groupsPermissions,function(groupPermission){return groupPermission.group.id});_.forEach(permissionsByGroupId,function(groupPermissions,groupId){var g={id:groupId,devicePermissions:{}};g.devicePermissions[moId]=_.map(groupPermissions,function(gp){return parsePermissionObjToString(gp)});groupsData.push(g)})}function parseUsersPermissions(usersData,moId,usersPermissions){var permissionsByUserName=_.groupBy(usersPermissions,function(userPermission){return userPermission.userName});_.forEach(permissionsByUserName,function(userPermissions,userName){var u={userName:userName,devicePermissions:{}};u.devicePermissions[moId]=_.map(userPermissions,function(up){return parsePermissionObjToString(up)});usersData.push(u)})}function parsePermissionObjToString(permissionObj){return[permissionObj.scope,permissionObj.type,permissionObj.access].join(":")}function getAccessTypes(){return["READ","ADMIN","*"]}function listGlobal(){return c8yUserGroup.listRoles().then(convertServerPermissionsToUI)}function convertServerPermissionsToUI(permissions){var PERMISSION_MATCH=/ROLE_(.+)_(\w+$)/;return _.map(permissions,function(permission){var matches=permission.id.match(PERMISSION_MATCH);var category=matches[1];var access=matches[2];return{id:permission.id,category:category,access:access}})}return{hasRole:hasRole,hasDevicePermission:hasDevicePermission,hasAnyRole:hasAnyRole,mustHaveAnyRole:mustHaveAnyRole,hasAllRoles:hasAllRoles,mustHaveAllRoles:mustHaveAllRoles,canReadMOs:canReadMOs,mustHaveReadMOs:mustHaveReadMOs,canAdminMOs:canAdminMOs,mustHaveAdminMOs:mustHaveAdminMOs,isAllowed:isAllowed,mustBeAllowed:mustBeAllowed,getMOPermissions:getMOPermissions,setMOPermissions:setMOPermissions,getAccessTypes:getAccessTypes,listGlobal:listGlobal,SCOPES:PERMISSION_SCOPES,ACCESS_TYPES:PERMISSIONS}}})();(function(){"use strict";angular.module("c8y.core").config(["$provide",function($provide){$provide.decorator("$q",["$delegate",function($delegate){function objWithProperties(source){return _.reduce(source,function(acc,val,key){acc[key]=undefined;return acc},{})}$delegate.some=function(promises,count){var deferred=$delegate.defer();var successCount=0;var failCount=0;var allCount=_.size(promises);var results,reasons;if(_.isArray(promises)){results=[];reasons=[]}else{results=objWithProperties(promises);reasons=objWithProperties(promises)}if(count===0){deferred.resolve(_.clone(results));return deferred.promise}_.forEach(promises,function(promise,idx){promise.then(function(val){successCount++;results[idx]=val;deferred.notify({key:idx,result:val});if(successCount===count){deferred.resolve(_.clone(results))}},function(reason){failCount++;reasons[idx]=reason;deferred.notify({key:idx,reason:reason});if(failCount===allCount){deferred.reject(_.clone(reasons))}})});return deferred.promise};$delegate.any=function(promises){return $delegate.some(promises,1).then(function(results){return _.filter(results,_.identity)[0]})};return $delegate}])}])})();(function(){"use strict";angular.module("c8y.core").factory("c8yQueriesUtil",["$rootScope","$injector",c8yQueriesUtil]);function c8yQueriesUtil($rootScope,$injector){var operatorFns={__not:function(operand){return["not(",buildQueryFilter(operand,null),")"].join("")},__and:function(operand){return buildQueryFilter(operand,null,"and")},__or:function(operand){return buildQueryFilter(operand,null,"or")},__eq:function(operand,contextKey){if(_.isObjectLike(operand)){return buildQueryFilter(operand,contextKey)}else{return[contextKey,"eq",quoteString(operand)].join(" ")}},__gt:function(operand,contextKey){return[contextKey,"gt",quoteString(operand)].join(" ")},__lt:function(operand,contextKey){return[contextKey,"lt",quoteString(operand)].join(" ")},__in:function(operand,contextKey){var stmts=_.map(_.filter(operand,_.identity),function(op){return[contextKey,"eq",quoteString(op)].join(" ")});return glue(stmts,"or")},__bygroupid:function(operand){return["bygroupid(",operand,")"].join("")},__has:function(operand){return["has(",operand,")"].join("")}};function glue(stmts,type){return stmts.length>1?["(",stmts.join(") "+type+" ("),")"].join(""):stmts[0]}function quoteString(s){return _.isString(s)?["'",s,"'"].join(""):s}function buildQuery(query){var q=[],filter=buildQueryFilter(query.__filter||query),orderby=buildQueryOrderby(query.__orderby);if(!_.isEmpty(filter)){q.push(["$filter=(",filter,")"].join(""))}if(!_.isEmpty(orderby)){q.push(["$orderby=",orderby].join(""))}return q.join(" ")}function buildQueryFilter(queryObj,queryKey,glueType){queryKey=queryKey||null;glueType=glueType||"and";var q=[];if(_.isArray(queryObj)){_.forEach(queryObj,function(qObj){var _q=buildQueryFilter(qObj,null,glueType);if(!_.isEmpty(_q)){q.push(_q)}})}else{_.forEach(queryObj,function(v,k){if(!_.isUndefined(operatorFns[k])){var _q=operatorFns[k](v,queryKey);if(!_.isEmpty(_q)){q.push(_q)}}else{
var _q=operatorFns.__eq(v,k);if(!_.isEmpty(_q)){q.push(_q)}}})}return glue(q,glueType)}function buildQueryOrderby(query){var o=[];_.forEach(query,function(q){_.forEach(q,function(v,k){if(0!==v){o.push([k,v>0?"asc":"desc"].join(" "))}})});return o.join(",")}return{buildQuery:buildQuery,buildQueryFilter:buildQueryFilter,buildQueryOrderby:buildQueryOrderby}}})();(function(){"use strict";angular.module("c8y.core").factory("c8yRealtime",c8yRealtime);c8yRealtime.$inject=["$q","$rootScope","c8yBase","c8yAuth","c8yLongPollingTransport"];function c8yRealtime($q,$rootScope,c8yBase,c8yAuth,c8yLongPollingTransport){if(c8yBase.getFlag("e2e")){var E2eExtension=function(){function setIntervalValue(interval){return _.toNumber(interval)||(_.toNumber(interval)===0?0:2e3)}function setTimeoutValue(timeout){return _.toNumber(timeout)||(_.toNumber(timeout)===0?0:1e3)}this.registered=function(){};this.outgoing=function(message){message.advice={reconnect:"retry",interval:setIntervalValue(c8yBase.getRuntimeOption("realtimeInterval")),timeout:setTimeoutValue(c8yBase.getRuntimeOption("realtimeTimeout"))}};this.getName=function(){return"e2eExtension"}};var e2eExtension=new E2eExtension}var cometd=new org.cometd.CometD;cometd.unregisterTransports();cometd.registerTransport("long-polling",new c8yLongPollingTransport.LongPollingTransport);cometd.websocketEnabled=false;function configure(){cometd.configure({url:c8yBase.url("cep/realtime"),logLevel:"info",requestHeaders:c8yAuth.headers(),appendMessageTypeToURL:false});if(c8yBase.getFlag("e2e")){cometd.registerExtension(e2eExtension.getName(),e2eExtension)}}var handshakeDeferred=$q.defer();cometd.addListener("/meta/handshake",function(message){if(message.successful){_.forEach(channels,function(channel){var subscription=channel.subscription;if(subscription){cometd.resubscribe(subscription)}});handshakeDeferred.resolve()}else{var err=new Error("Handshake failed.");handshakeDeferred.reject(err);throw err}});var unauthorizedListener=cometd.addListener("/meta/connect",function(message){if(message.failure&&message.failure.httpCode===401){disconnect();cometd.removeListener(unauthorizedListener)}});$rootScope.$on("authStateChange",function onAuthStateChange(evt,state){if(state.hasAuth){configure();cometd.handshake()}else{disconnect()}});function disconnect(){handshakeDeferred=$q.defer();cometd.disconnect()}cometd.onListenerException=function(err,subscription,isListener){if(isListener){this.removeListener(subscription)}else{this.unsubscribe(subscription)}if(c8yBase.getFlag("e2e")){cometd.unregisterExtension(e2eExtension.getName())}throw new Error("Something went wrong: "+err)};var channels=[];var service={addListener:_.wrap(addListener,commaSeparatedChannelSegmentDecorator),realtimeActions:realtimeActions,switchRealtime:_.wrap(switchRealtime,commaSeparatedChannelSegmentDecorator),getStatus:getStatus,start:_.wrap(start,commaSeparatedChannelSegmentDecorator),stop:_.wrap(stop,commaSeparatedChannelSegmentDecorator),removeSubscriber:_.wrap(removeSubscriber,commaSeparatedChannelSegmentDecorator),destroySubscription:_.wrap(destroySubscription,commaSeparatedChannelSegmentDecorator),icon:icon,watch:watch,_getSubscriptionChannels:getChannels,status:status};return service;function addListener(subscriberId,channelName,subscribedEventName,listener){var channel=_.find(channels,{name:channelName});if(!channel){channel=createChannel(channelName);channels.push(channel)}var subscribers=channel.subscribers;var subscriber=_.find(subscribers,{id:subscriberId});if(!subscriber){subscriber=createSubscriber(subscriberId);subscribers.push(subscriber)}var subscribedEvents=subscriber.subscribedEvents;var subscribedEvent=_.find(subscribedEvents,{name:subscribedEventName});if(!subscribedEvent){subscribedEvent=createSubscribedEvent(subscribedEventName);subscribedEvents.push(subscribedEvent)}subscribedEvent.listeners.push(listener)}function createChannel(name){return{name:name,subscription:undefined,subscribers:[]}}function createSubscriber(id){return{id:id,subscribedEvents:_.map(realtimeActions(),createSubscribedEvent),active:false}}function realtimeActions(){return{CREATE:"CREATE",UPDATE:"UPDATE",DELETE:"DELETE"}}function createSubscribedEvent(name){return{name:name,listeners:[]}}function switchRealtime(subscriberId,channelName){var active=getStatus(subscriberId,channelName);if(active){stop(subscriberId,channelName)}else{start(subscriberId,channelName)}}function getStatus(subscriberId,channelName){var channelNames=collectChannelNames(channelName);return _.every(channelNames,function(name){var active=false;var channel=_.find(channels,{name:name});if(channel){active=Boolean(_.find(channel.subscribers,{id:subscriberId,active:true}))}return active})}function stop(subscriberId,channelName){var subscriber=getSubscriber(subscriberId,channelName);if(subscriber){subscriber.active=false}}function start(subscriberId,channelName){var subscriber=getSubscriber(subscriberId,channelName);if(subscriber){subscriber.active=true;var channel=_.find(channels,{name:channelName});if(_.isUndefined(channel.subscription)){return subscribe(channel)}}}function subscribe(channel){ensureHandshakeSuccessful().then(function(){channel.subscription=cometd.subscribe(channel.name,function(message){var messageData=message.data;var subscribedEventName=messageData.realtimeAction;var data=messageData.data;_(channel.subscribers).filter("active").forEach(function(subscriber){var subscribedEvent=_.find(subscriber.subscribedEvents,{name:subscribedEventName});var listeners=subscribedEvent.listeners;_.forEach(listeners,function(listener){listener(subscribedEventName,data)})})})})}function ensureHandshakeSuccessful(){return handshakeDeferred.promise}function removeSubscriber(id,channelName){var subscriber=getSubscriber(id,channelName);if(subscriber){var channel=_.find(channels,{name:channelName});var subscribers=channel.subscribers;_.remove(subscribers,{id:id});if(_.isEmpty(subscribers)){unsubscribe(channel)}}}function getSubscriber(id,channelName){var subscriber;var channel=_.find(channels,{name:channelName});if(channel){subscriber=_.find(channel.subscribers,{id:id})}else{throw new Error("There is no listener registered for your scope "+'on the channel "'+channelName+'"')}return subscriber}function unsubscribe(channel){var subscription=channel.subscription;if(subscription){cometd.unsubscribe(subscription)}_.remove(channels,channel)}function destroySubscription(subscriberId,channelName){removeSubscriber(subscriberId,channelName)}function commaSeparatedChannelSegmentDecorator(func){var args=_.drop(arguments);var channelFullName=args[1];var channelNames=collectChannelNames(channelFullName);_.forEach(channelNames,function(channelName){args[1]=channelName;func.apply(this,args)}.bind(this))}function collectChannelNames(channelFullName){var channelNames=[];var matches=channelFullName.match(/(\/.*)\/(.*)$/);if(_.isEmpty(matches)){channelNames.push(channelFullName)}else{var channelBaseName=matches[1];var channelSegmentNames=matches[2].split(",");_.forEach(channelSegmentNames,function(channelSegmentName){channelNames.push(channelBaseName+"/"+channelSegmentName)})}return channelNames}function icon(state){return state?"check-circle-o":"circle-o"}function watch(config){var subscriberId=config.id||String(Math.random()).substr(2);var channelName=config.channel;var subscribedEventNames=_.flattenDeep([config.ops||_.values(realtimeActions())]);var listener=config.onUpdate||_.noop;_.forEach(subscribedEventNames,function(subscribedEventName){addListener(subscriberId,channelName,subscribedEventName,listener)});start(subscriberId,channelName);return{stop:function(){stop(subscriberId,channelName)}}}function getChannels(){if(!c8yBase.getFlag("test")){console.warn("DO NOT USE THIS API CALL: it will break encapsulation, "+"use it only for doing state verification in unit test.")}return channels}function status(){return cometd.getStatus()}}})();(function(){angular.module("c8y.core").factory("c8yLongPollingTransport",c8yLongPollingTransport);_.assign(org.cometd.JSON,{toJSON:JSON.stringify,fromJSON:JSON.parse});function c8yLongPollingTransport($http,c8yBase){var _send=send;var transport={LongPollingTransport:LongPollingTransport,enable:function(value){if(value){_send=send}else{_send=sendMock}}};transport.enable(!c8yBase.getFlag("test"));return transport;function LongPollingTransport(){var _super=new org.cometd.LongPollingTransport;var that=org.cometd.Transport.derive(_super);that.xhrSend=function(packet){return _send(packet)};return that}function send(packet){var xhr={};var hdrs=packet.headers||{};hdrs["Content-Type"]="application/json;charset=UTF-8";if(!transport.disabled){$http.post(packet.url,packet.body,{headers:hdrs,withCredentials:true}).success(function(data,status){xhr.status=status;packet.onSuccess(data)}).error(function(data,status,headers,config,reason){xhr.status=status;packet.onError(reason)})}return xhr}function sendMock(packet){var data=JSON.parse(packet.body);setTimeout(function(){packet.onSuccess({successful:true,id:data.id,channel:data.channel},100)});return{status:200}}}})();(function(){angular.module("c8y.core").factory("c8yRetentions",["$http","$q","c8yBase",c8yRetentions]);function c8yRetentions($http,$q,c8yBase){var path="retention/retentions",defaultConfig={headers:c8yBase.contentHeaders("retentionRule","retentionRule")};var dataTypes=["ALARM","EVENT","MEASUREMENT","OPERATION","AUDIT","*"];var unsupportedFieldsForDataTypes={ALARM:["fragmentType"],EVENT:[],MEASUREMENT:[],OPERATION:["type"],AUDIT:["fragmentType"],"*":[]};function list(filters){var url=c8yBase.url(path);filters=c8yBase.pageSizeFilter(filters);var cfg={params:filters,silentError:true};var onList=c8yBase.cleanListCallback("retentionRules",list,filters);return $http.get(url,cfg).then(onList,$q.reject)}function detail(ro){var url=buildDetailUrl(ro);if(!url){return $q.reject("Retention rule object is not valid")}return $http.get(url)}function create(ro){var url=c8yBase.url(path);return $http.post(url,ro,defaultConfig)}function update(ro){var url=buildDetailUrl(ro);return $http.put(url,ro,defaultConfig)}function save(ro){return ro.id?update(ro):create(ro)}function remove(ro){var url=buildDetailUrl(ro);if(!url){return $q.reject("Retention rule object is not valid")}return $http.delete(url)}function buildDetailUrl(ro){var id=ro&&ro.id||ro;if(!id){return}return c8yBase.url(path+"/"+id)}function isFieldSupportedByRule(rule,fieldName){return!_.includes(unsupportedFieldsForDataTypes[rule.dataType||"*"]||[],fieldName)}return{list:list,detail:detail,create:create,update:update,save:save,remove:remove,dataTypes:dataTypes,isFieldSupportedByRule:isFieldSupportedByRule}}})();(function(){"use strict";angular.module("c8y.core").factory("c8yRoles",c8yRoles);function c8yRoles($q,$http,c8yBase,c8yUserGroup){var GLOBAL_SELF_MATCH=/groups\/\d+$/;var INVENTORY_ROLES_PATH="user/inventoryroles";var CONTENT_HEADERS={"Content-Type":"application/json",Accept:"application/json"};function urlList(){return c8yBase.url(INVENTORY_ROLES_PATH)}function urlDetail(obj){var id=c8yBase.getId(obj);return c8yBase.url(INVENTORY_ROLES_PATH+"/"+id)}function list(filter){var _filters=c8yBase.pageSizeFilter(filter);var cfg={params:_filters};var onList=c8yBase.cleanListCallback("roles",list,_filters);return $http.get(urlList(),cfg).then(onList)}function detail(objId){var url=urlDetail(objId);return $http.get(url)}function remove(objId){var url=urlDetail(objId);return $http.delete(url,{silentError:true})}function update(role){var url=urlDetail(role);var config={headers:CONTENT_HEADERS};return $http.put(url,role,config)}function create(role){var url=urlList();var config={headers:CONTENT_HEADERS};delete role.id;return $http.post(url,role,config)}function save(role){return role.id?update(role):create(role)}function isGlobal(roleObj){var _isGlobal=false;if(roleObj&&roleObj.self){_isGlobal=GLOBAL_SELF_MATCH.test(roleObj.self)}return _isGlobal}return{list:list,detail:detail,remove:remove,create:create,update:update,save:save,global:c8yUserGroup,isGlobal:isGlobal}}})();angular.module("c8y.core").factory("c8ySettings",["$http","c8yBase","gettextCatalog",function($http,c8yBase,gettextCatalog){"use strict";var path="tenant/options",pathReadOnly="tenant/security-options",pathSystem="tenant/system/options",config={headers:c8yBase.contentHeaders("option")};function buildDetailUrl(option){return c8yBase.url(path+"/"+option.category+(option.key?"/"+option.key:""))}function buildDetailUrlForReadOnly(option){return c8yBase.url(pathReadOnly+"/"+option.category+(option.key?"/"+option.key:""))}function buildDetailUrlForSystem(option){return c8yBase.url(pathSystem+"/"+option.category+(option.key?"/"+option.key:""))}function list(filters){var url=c8yBase.url(path),_filters=c8yBase.pageSizeFilter(filters),cfg={params:_filters},onList=c8yBase.cleanListCallback("options",list,_filters),promise=$http.get(url,cfg).then(onList);if(filters&&filters.category){promise=promise.then(function(options){var filtered=options.filter(function(opt){return opt.category===filters.category});filtered.paging=options.paging;return filtered})}return promise}function updateOption(option){var url=buildDetailUrl(option),data=_.cloneDeep(option),cfg=_.cloneDeep(config);return $http.put(url,data,cfg)}function createOption(option){var url=c8yBase.url(path),data=_.cloneDeep(option),cfg=_.cloneDeep(config);return $http.post(url,data,cfg)}function deleteOption(option){var url=buildDetailUrl(option);return $http.delete(url)}function detail(option,config){var url=option.category==="password"?buildDetailUrlForReadOnly(option):buildDetailUrl(option);var conf=_.merge({silentError:true},config);return $http.get(url,conf)}function detailValue(option,defaultValue,config){defaultValue=!_.isUndefined(defaultValue)?defaultValue:false;return detail(option,config).then(_.partialRight(parseSettingsResponse,defaultValue),_.partial(_.identity,defaultValue))}function getSystemOption(option,config){var url=buildDetailUrlForSystem(option);var conf=_.merge({silentError:true},config);return $http.get(url,conf)}function getSystemOptionValue(option,defaultValue,config){defaultValue=!_.isUndefined(defaultValue)?defaultValue:false;return getSystemOption(option,config).then(_.partialRight(parseSettingsResponse,defaultValue),_.partial(_.identity,defaultValue))}function parseSettingsResponse(res,defaultValue){var result;try{result=JSON.parse(res.data.value)}catch(e){result=!_.isUndefined(res.data.value)?res.data.value:defaultValue}return result}var cache={};function setUserPasswordValidationParams(min,max){var defaultMin=8;var defaultMax=32;var min=min||defaultMin;var max=max||defaultMax;Object.defineProperty(window.c8yConfig.validation.password,"message",{get:function(){return gettextCatalog.getString("Password must have at least {{min}} characters and no more than {{max}} and can only contain letters, numbers and following symbols: `~!@#$%^&*()_|+-=?;:'\",.<>{}[]\\/",{min:min,max:max})}});Object.defineProperty(window.c8yConfig.validation.password,"pattern",{get:function(){var cacheKey=min+"_"+max;if(!cache[cacheKey]){cache[cacheKey]=new RegExp("^[a-zA-Z0-9`~!@#$%^&*()_|+\\-=?;:'\",.<>\\{\\}\\[\\]\\\\/]{"+min+","+max+"}$")}return cache[cacheKey]}})}return{list:list,detail:detail,detailValue:detailValue,updateOption:updateOption,createOption:createOption,deleteOption:deleteOption,getSystemOption:getSystemOption,getSystemOptionValue:getSystemOptionValue,setUserPasswordValidationParams:setUserPasswordValidationParams}}]);angular.module("c8y.core").factory("c8ySimulator",["$http","c8yBase","gettext",function($http,c8yBase,gettext){"use strict";var templatePath="simulator/templates",configPath="simulator/configurations",sensorsPath=templatePath+"/sensors",defaultConfigSimulator={headers:c8yBase.contentHeaders("simulator","simulator")},defaultConfigTemplate={headers:c8yBase.contentHeaders("template","template")};var STATES={NEW:gettext("NEW"),RUNNING:gettext("RUNNING"),PAUSED:gettext("PAUSED")};function list(){var simulatorUrl=c8yBase.url(configPath);return $http.get(simulatorUrl,{params:{pageSize:2e3}}).then(c8yBase.getResData)}function changeState(simulator,newstate){var id=simulator.id||simulator;var url=c8yBase.url(configPath+"/"+id),data={state:newstate},cfg=_.cloneDeep(defaultConfigSimulator);return $http.put(url,data,cfg)}function deleteSimulator(simulator){var id=simulator.id||simulator;var url=c8yBase.url(configPath+"/"+id),cfg=_.cloneDeep(defaultConfigSimulator);return $http.delete(url,cfg)}function getSensors(){var sensorsUrl=c8yBase.url(sensorsPath);return $http.get(sensorsUrl).then(c8yBase.getResData)}function createTemplate(template){var url=c8yBase.url(templatePath),data=_.cloneDeep(template),cfg=_.cloneDeep(defaultConfigTemplate);return $http.post(url,data,cfg)}function createSimulator(simulator){var url=c8yBase.url(configPath),data=_.cloneDeep(simulator),cfg=_.cloneDeep(defaultConfigSimulator);return $http.post(url,data,cfg)}return{list:list,changeState:changeState,deleteSimulator:deleteSimulator,createSimulator:createSimulator,createTemplate:createTemplate,getSensors:getSensors,STATES:STATES}}]);(function(){"use strict";angular.module("c8y.core").factory("c8ySmartRestTemplates",c8ySmartRestTemplates);function c8ySmartRestTemplates($q,c8yBase,c8yInventory,c8yIdentity,gettext,gettextCatalog){var type="c8y_SmartRest2Template";var fragmentType="com_cumulocity_model_smartrest_csv_CsvSmartRestTemplate";var externalIdType="c8y_SmartRest2DeviceIdentifier";var listPageSize=1e3;var APIs=c8yBase.createEnum(["INVENTORY","MEASUREMENT","ALARM","EVENT","OPERATION"]);var Methods=c8yBase.createEnum(["GET","PUT","POST"]);var Types=c8yBase.createEnum([{name:"STRING",value:"STRING",label:gettext("STRING")},{name:"DATE",value:"DATE",label:gettext("DATE")},{name:"NUMBER",value:"NUMBER",label:gettext("NUMBER"),numeric:true},{name:"INTEGER",value:"INTEGER",label:gettext("INTEGER"),numeric:true},{name:"UNSIGNED",value:"UNSIGNED",label:gettext("UNSIGNED"),numeric:true},{name:"FLAG",value:"FLAG",label:gettext("FLAG")},{name:"SEVERITY",value:"SEVERITY",label:gettext("SEVERITY")},{name:"ALARMSTATUS",value:"ALARMSTATUS",label:gettext("ALARM STATUS")},{name:"OPERATIONSTATUS",value:"OPERATIONSTATUS",label:gettext("OPERATION STATUS")},{name:"ARRAY",value:"ARRAY",label:gettext("ARRAY")},{name:"OBJECTARRAY",value:"OBJECTARRAY",label:gettext("OBJECT ARRAY")}]);var TYPES_HIDDEN_IN_UI=[Types.OBJECTARRAY.value,Types.ARRAY.value];var defaultTemplate={name:"",type:type,com_cumulocity_model_smartrest_csv_CsvSmartRestTemplate:{requestTemplates:[],responseTemplates:[]}};var defaultRequestTemplate={name:"",msgId:"",api:APIs.INVENTORY.name,method:Methods.GET.name,response:true,byId:true,mandatoryValues:[],customValues:[]};var defaultCustomValue={path:"",type:Types.STRING.name,value:""};var defaultResponseTemplate={name:"",msgId:"",base:"",condition:"",patterns:[]};var defaultResponseTemplatePattern={path:""};var mandatoryFields={MEASUREMENT:{POST:[{path:"$.type",type:Types.STRING.name},{path:"$.time",type:Types.DATE.name}]},EVENT:{POST:[{path:"$.type",type:Types.STRING.name},{path:"$.text",type:Types.STRING.name},{path:"$.time",type:Types.DATE.name}]},ALARM:{POST:[{path:"$.type",type:Types.STRING.name},{path:"$.text",type:Types.STRING.name},{path:"$.status",type:Types.ALARMSTATUS.name},{path:"$.severity",type:Types.SEVERITY.name},{path:"$.time",type:Types.DATE.name}],PUT:[{path:"$.type",type:Types.STRING.name}]},OPERATION:{PUT:[{path:"$.type",type:Types.STRING.name}]},INVENTORY:{POST:[{path:"$.type",type:Types.STRING.name}],PUT:[],GET:[]}};var BUILTIN_PUBLISH_MESSAGES=[{msgId:"100",name:gettext("Device creation"),values:[{label:gettext("device name"),type:Types.STRING.name,default:"MQTT Device <serialNumber>"},{label:gettext("device type"),type:Types.STRING.name,default:"c8y_MQTTDevice"}],hideInSimulators:true},{msgId:"101",name:gettext("Child device creation"),values:[{label:gettext("unique child ID"),type:Types.STRING.name,mandatory:true},{label:gettext("device name"),type:Types.STRING.name,default:"MQTT Device <serialNumber>"},{label:gettext("device type"),type:Types.STRING.name,default:"c8y_MQTTChildDevice"}],hideInSimulators:true},{msgId:"105",name:gettext("Get child device"),hideInSimulators:true},{msgId:"110",name:gettext("Configure hardware"),values:[{label:gettext("serialNumber"),type:Types.STRING.name},{label:gettext("model"),type:Types.STRING.name},{label:gettext("revision"),type:Types.STRING.name}]},{msgId:"111",name:gettext("Configure mobile"),values:[{label:gettext("imei"),type:Types.STRING.name},{label:gettext("iccid"),type:Types.STRING.name},{label:gettext("imsi"),type:Types.STRING.name},{label:gettext("mcc"),type:Types.STRING.name},{label:gettext("mnc"),type:Types.STRING.name},{label:gettext("lac"),type:Types.STRING.name},{label:gettext("cellId"),type:Types.STRING.name}]},{msgId:"112",name:gettext("Configure position"),values:[{label:gettext("latitude"),type:Types.STRING.name},{label:gettext("longitude"),type:Types.STRING.name},{label:gettext("altitude"),type:Types.STRING.name},{label:gettext("accuracy"),type:Types.STRING.name}]},{msgId:"113",name:gettext("Set configuration"),values:[{label:gettext("configuration"),type:Types.STRING.name}]},{msgId:"114",name:gettext("Set supported operations"),values:[{label:gettext("List of supported operations"),type:Types.ARRAY.name}],hideInSimulators:true},{msgId:"115",name:gettext("Set firmware"),values:[{label:gettext("name"),type:Types.STRING.name},{label:gettext("version"),type:Types.STRING.name},{label:gettext("url"),type:Types.STRING.name}]},{msgId:"116",name:gettext("Set software list"),values:[{label:gettext("List of 3 values per software"),type:Types.OBJECTARRAY.name,values:[{label:gettext("name"),type:Types.STRING.name},{label:gettext("version"),type:Types.STRING.name},{label:gettext("url"),type:Types.STRING.name}]}]},{msgId:"117",name:gettext("Set required availability"),values:[{label:gettext("required interval"),type:Types.NUMBER.name}]},{msgId:"200",name:gettext("Create custom measurement"),values:[{label:gettext("fragment"),type:Types.STRING.name,mandatory:true},{label:gettext("series"),type:Types.STRING.name,mandatory:true},{label:gettext("value"),type:Types.NUMBER.name,mandatory:true},{label:gettext("unit"),type:Types.STRING.name},{label:gettext("time"),type:Types.DATE.name}]},{msgId:"210",name:gettext("Create signal strength measurement"),values:[{label:gettext("rssi value"),type:Types.NUMBER.name,mandatory:true},{label:gettext("ber value"),type:Types.NUMBER.name,mandatory:true},{label:gettext("time"),type:Types.DATE.name}]},{msgId:"211",name:gettext("Create temperature measurement"),values:[{label:gettext("temperature value"),type:Types.NUMBER.name,mandatory:true},{label:gettext("time"),type:Types.DATE.name}]},{msgId:"212",name:gettext("Create battery measurement"),values:[{label:gettext("battery value"),type:Types.NUMBER.name,mandatory:true},{label:gettext("time"),type:Types.DATE.name}]},{msgId:"301",name:gettext("Create CRITICAL alarm"),values:[{label:gettext("type"),type:Types.STRING.name,mandatory:true},{label:gettext("text"),type:Types.STRING.name,default:"Alarm of type <alarmType> raised"},{label:gettext("time"),type:Types.DATE.name}]},{msgId:"302",name:gettext("Create MAJOR alarm"),values:[{label:gettext("type"),type:Types.STRING.name,mandatory:true},{label:gettext("text"),type:Types.STRING.name,default:"Alarm of type <alarmType> raised"},{label:gettext("time"),type:Types.DATE.name}]},{msgId:"303",name:gettext("Create MINOR alarm"),values:[{label:gettext("type"),type:Types.STRING.name,mandatory:true},{label:gettext("text"),type:Types.STRING.name,default:"Alarm of type <alarmType> raised"},{label:gettext("time"),type:Types.DATE.name}]},{msgId:"304",name:gettext("Create WARNING alarm"),values:[{label:gettext("type"),type:Types.STRING.name,mandatory:true},{label:gettext("text"),type:Types.STRING.name,default:"Alarm of type <alarmType> raised"},{label:gettext("time"),type:Types.DATE.name}]},{msgId:"305",name:gettext("Update severity of existing alarm"),values:[{label:gettext("type"),type:Types.STRING.name,mandatory:true},{label:gettext("severity"),type:Types.SEVERITY.name,mandatory:true}]},{msgId:"306",name:gettext("Clear existing alarm"),values:[{label:gettext("type"),type:Types.STRING.name,mandatory:true},{label:gettext("severity"),type:Types.SEVERITY.name,mandatory:true}]},{msgId:"400",name:gettext("Create basic event"),values:[{label:gettext("type"),type:Types.STRING.name,mandatory:true},{label:gettext("text"),type:Types.STRING.name,mandatory:true},{label:gettext("time"),type:Types.DATE.name}]},{msgId:"401",name:gettext("Create location update event"),values:[{label:gettext("latitude"),type:Types.STRING.name},{label:gettext("longitude"),type:Types.STRING.name},{label:gettext("altitude"),type:Types.STRING.name},{label:gettext("accuracy"),type:Types.STRING.name}]},{msgId:"402",name:gettext("Create location update event with device update"),values:[{label:gettext("latitude"),type:Types.STRING.name},{label:gettext("longitude"),type:Types.STRING.name},{label:gettext("altitude"),type:Types.STRING.name},{label:gettext("accuracy"),type:Types.STRING.name}]},{msgId:"500",name:gettext("Get PENDING operations"),hideInSimulators:true},{msgId:"501",name:gettext("Set operation to EXECUTING"),values:[{label:gettext("fragment"),type:Types.STRING.name,mandatory:true}],hideInSimulators:true},{msgId:"502",name:gettext("Set operation to FAILED"),values:[{label:gettext("fragment"),type:Types.STRING.name,mandatory:true},{label:gettext("failureReason"),type:Types.STRING.name}],hideInSimulators:true},{msgId:"503",name:gettext("Set operation to SUCCESSFUL"),values:[{label:gettext("fragment"),type:Types.STRING.name,mandatory:true},{label:gettext("parameters"),type:Types.ARRAY.name}],hideInSimulators:true}];var service={APIs:APIs,Methods:Methods,Types:Types,fragmentType:fragmentType,externalIdType:externalIdType,newTemplate:newTemplate,create:create,save:save,list:list,detail:detail,remove:remove,download:download,getAllMsgIds:getAllMsgIds,countRequestTemplates:countRequestTemplates,newRequestTemplate:newRequestTemplate,addRequestTemplate:addRequestTemplate,removeRequestTemplate:removeRequestTemplate,setupRequestTemplateDefaults:setupRequestTemplateDefaults,doesRequestTemplateRequireByIdOrByExternalId:doesRequestTemplateRequireByIdOrByExternalId,addRequestTemplateCustomValue:addRequestTemplateCustomValue,removeRequestTemplateCustomValue:removeRequestTemplateCustomValue,getRequestTemplatePreview:getRequestTemplatePreview,countResponseTemplates:countResponseTemplates,newResponseTemplate:newResponseTemplate,addResponseTemplate:addResponseTemplate,removeResponseTemplate:removeResponseTemplate,addResponseTemplatePattern:addResponseTemplatePattern,removeResponseTemplatePattern:removeResponseTemplatePattern,getResponseTemplatePreview:getResponseTemplatePreview,getPreviewsCsvData:getPreviewsCsvData,getPreviews:getPreviews,getMethodsForAPI:getMethodsForAPI,listAllPublishMessages:listAllPublishMessages,typesForUI:typesForUI};return service;function newTemplate(){return _.defaults({},defaultTemplate)}function create(mo,externalId){return save(_.defaults({},mo,defaultTemplate)).then(function(createdMo){return createExternalIdentity(createdMo,externalId).then(_.partial(_.identity,createdMo)).then(convertFromServer)})}function createExternalIdentity(mo,externalId){var identity={type:externalIdType,externalId:externalId};return c8yIdentity.createIdentity(mo,identity)}function save(mo){return c8yInventory.save(convertToServer(mo)).then(c8yBase.getResData).then(convertFromServer)}function list(){return c8yInventory.list({type:type,pageSize:listPageSize}).then(function(templates){return $q.all(_.map(templates,convertFromServer))})}function detail(moId){return c8yInventory.detail(moId).then(c8yBase.getResData).then(convertFromServer)}function getTemplateExternalId(template){return c8yIdentity.listExternalIds(template).then(function(identities){var identity=_.find(identities,{type:externalIdType});return identity&&identity.externalId})}function remove(mo){return c8yInventory.remove(mo)}function download(template){var filename=template.name+".json",contentType="application/json",content=JSON.stringify(cleanTemplateForDownload(template),null,2),blob=new Blob([content],{type:contentType});saveAs(blob,filename)}function cleanTemplateForDownload(template){return _(convertToServer(template)).pick(["name","type",fragmentType]).assign(_.pick(template,["__externalId"])).value()}function countRequestTemplates(template){return template[fragmentType].requestTemplates.length}function getAllMsgIds(template){return _.map(_.flatten([template[fragmentType].requestTemplates,template[fragmentType].responseTemplates]),"msgId")}function newRequestTemplate(){return _.defaults({},defaultRequestTemplate)}function addRequestTemplate(template,requestTemplate){var reqTpl=_.defaults({},requestTemplate,defaultRequestTemplate);template[fragmentType].requestTemplates.push(reqTpl);return reqTpl}function removeRequestTemplate(template,requestTemplate){_.pull(template[fragmentType].requestTemplates,requestTemplate)}function setupRequestTemplateDefaults(requestTemplate){if(!requestTemplate.api||!requestTemplate.method){return}var mfs=mandatoryFields[requestTemplate.api][requestTemplate.method]||[];requestTemplate.mandatoryValues=_.map(mfs,function(mf){var previousValue=(_.find(requestTemplate.mandatoryValues,{path:mf.path,type:mf.type})||{}).value;return _.assign({},mf,{value:previousValue})});requestTemplate.response=requestTemplate.method===Methods.GET.name?true:false}function doesRequestTemplateRequireByIdOrByExternalId(requestTemplate){var isInventory=requestTemplate.api===APIs.INVENTORY.name;var isGet=requestTemplate.method===Methods.GET.name;var isPut=requestTemplate.method===Methods.PUT.name;return isInventory&&(isGet||isPut)}function addRequestTemplateCustomValue(requestTemplate,customValue){var cv=_.defaults({},customValue,defaultCustomValue);requestTemplate.customValues.push(cv);return cv}function removeRequestTemplateCustomValue(requestTemplate,customValue){_.pull(requestTemplate.customValues,customValue)}function countResponseTemplates(template){return template[fragmentType].responseTemplates.length}function newResponseTemplate(){return _.defaults({},defaultResponseTemplate)}function addResponseTemplate(template,responseTemplate){var resTpl=_.defaults({},responseTemplate,defaultResponseTemplate);template[fragmentType].responseTemplates.push(resTpl);return resTpl}function removeResponseTemplate(template,responseTemplate){_.pull(template[fragmentType].responseTemplates,responseTemplate)}function addResponseTemplatePattern(responseTemplate,pattern){var p=_.defaults({},pattern,defaultResponseTemplatePattern);responseTemplate.patterns.push(p);return p}function removeResponseTemplatePattern(responseTemplate,pattern){_.pull(responseTemplate.patterns,pattern)}function getMethodsForAPI(api){var methodNames=_.keys(mandatoryFields[api]||{});return _.filter(Methods.values(),function(m){return _.includes(methodNames,m.name)})}function getPreviewsCsvData(template,options){options=options||{};var rows=[];var previews=getPreviews(template);if(!options.skipRequestTemplates){rows.push([gettextCatalog.getString("Messages")]);rows.push([gettextCatalog.getString("Name"),gettextCatalog.getString("API"),gettextCatalog.getString("Method"),gettextCatalog.getString("Preview")]);_.each(previews.requestTemplates,function(reqTpl){rows.push([reqTpl.name,reqTpl.api,reqTpl.method,reqTpl.csv])})}if(!options.skipRequestTemplates&&!options.skipResponseTemplates){rows.push([])}if(!options.skipResponseTemplates){rows.push([gettextCatalog.getString("Responses")]);rows.push([gettextCatalog.getString("Name"),gettextCatalog.getString("Preview")]);_.each(previews.responseTemplates,function(resTpl){rows.push([resTpl.name,resTpl.csv])})}return rows}function getPreviews(template){return{requestTemplates:_.map(template[fragmentType].requestTemplates,getRequestTemplatePreview),
responseTemplates:_.map(template[fragmentType].responseTemplates,getResponseTemplatePreview)}}function listAllPublishMessages(){return list().then(flattenRequestMessages).then(function(msgs){return _.union(msgs,_.cloneDeep(BUILTIN_PUBLISH_MESSAGES))})}function flattenRequestMessages(templates){return _(templates).reduce(requestMessageReducer,[])}function requestMessageReducer(messages,templateMo){var tpl=templateMo[fragmentType];var requests=tpl.requestTemplates;_.forEach(requests,function(r){Object.defineProperties(r,{_template:{value:templateMo}});messages.push(r)});return messages}function getRequestTemplatePreview(requestTemplate){return{name:requestTemplate.name,api:requestTemplate.api,method:requestTemplate.method,csv:getRequestTemplateCsv(requestTemplate)}}function getResponseTemplatePreview(responseTemplate){return{name:responseTemplate.name,csv:getResponseTemplateCsv(responseTemplate)}}function getRequestTemplateCsv(requestTemplate){return _.compact(_.flatten([requestTemplate.msgId,requestTemplate.api===APIs.INVENTORY.name&&requestTemplate.method===Methods.GET.name?requestTemplate.byId?"<deviceId>":requestTemplate.externalIdType?"<externalId>":"<externalIdType>,<externalId>":undefined,_.map(requestTemplate.mandatoryValues||[],function(v){if(v.type!==Types.FLAG.name&&!v.value){return["<",v.path,">"].join("")}}),_.map(requestTemplate.customValues||[],function(v){if(v.type!==Types.FLAG.name&&!v.value){return["<",v.path,">"].join("")}})])).join(",")}function getResponseTemplateCsv(responseTemplate){return _.compact(_.flatten([responseTemplate.msgId,_.map(responseTemplate.patterns||[],function(p){return["<",p.path,">"].join("")})])).join(",")}function convertFromServer(template){return getTemplateExternalId(template).then(function(externalId){var tpl=_.cloneDeep(template);tpl.__externalId=externalId;_.forEach(tpl[fragmentType].responseTemplates,function(resTpl){if(resTpl.pattern){resTpl.patterns=_.map(resTpl.pattern,function(path){return{path:path}});delete resTpl.pattern}});return tpl})}function convertToServer(template){var tpl=_.cloneDeep(template);tpl.__externalId=undefined;_.forEach((tpl[fragmentType]||{}).responseTemplates,function(resTpl){if(resTpl.patterns){resTpl.pattern=_.map(resTpl.patterns,function(pattern){return pattern.path});delete resTpl.patterns}});return tpl}function typesForUI(){return _.filter(Types.values(),function(type){return TYPES_HIDDEN_IN_UI.indexOf(type.value)===-1})}}})();angular.module("c8y.core").factory("c8yStatement",["$http","$q","$timeout","c8yBase",function($http,$q,$timeout,c8yBase){"use strict";var exports={},path="cep/modules",moduleConfig=function(){return c8yBase.requestConfig("cepModule","cepModule")},statementConfig=function(){return c8yBase.requestConfig("cepStatement","cepStatement")},defaultModule;function clean(statement){statement=_.cloneDeep(statement);delete statement.id;delete statement.module;return statement}function isDefaultModule(module){return module.name==="default"}var examples=[{name:"select temperate readings over 100 degree",value:"select * from MeasurementCreated e\n"+'where getNumber(e, "c8y_TemperatureMeasurement.T.value") > 100'},{name:"create alarm when temperature over 100 degree",value:"insert into CreateAlarm \n"+"  select\n"+"    e.measurement.time as time,\n"+"    e.measurement.source.value as source,\n"+'    "com_cumulocity_TemperatureAlert" as type,\n'+'    "Temperature too high" as text,\n'+'    "ACTIVE" as status,\n'+'    "CRITICAL" as severity\n'+"  from MeasurementCreated e\n"+'  where getNumber(e, "c8y_TemperatureMeasurement.T.value") > 100'},{name:"create alarm when temperature below 0 degree",value:"insert into CreateAlarm \n"+"  select\n"+"    e.measurement.time as time,\n"+"    e.measurement.source.value as source,\n"+'    "com_cumulocity_TemperatureAlert" as type,\n'+'    "Temperature too low" as text,\n'+'    "ACTIVE" as status,\n'+'    "CRITICAL" as severity\n'+"  from MeasurementCreated e\n"+'  where getNumber(e, "c8y_TemperatureMeasurement.T.value") > 100'},{name:"create close replay operation when temperature readings over 100 degree",value:"insert into CreateOperation\n"+"  select\n"+'    "PENDING" as status,\n'+"    «heating ID» as deviceId\n"+"    {\n"+'      "c8y_Relay.relayState", "CLOSED"\n'+"    } as fragments\n"+"  from MeasurementCreated e\n"+'  where getNumber(e, "c8y_TemperatureMeasurement.T.value") > 100'},{name:"select location change event once for 60 seconds",value:"select * from EventCreated e\n"+'where getObject(e, "c8y_LocationMeasurement") is not null\n'+"output first every 60 seconds"},{name:"send email notification with current temperature",value:"expression string js:prepareEmailText(temp, state) [\n"+"    function format(text, params){\n"+"            for(param in params) {\n"+'                text = text.replace("{" + param + "}", params[param])\n'+"            }\n"+"        return text\n"+"    }\n"+'    format("Hello,\\n current temperature is {0} (state = {1}). Regards.", [temp, state])\n'+"]\n"+"insert into SendEmail\n"+"select\n"+'  "sender@sender" as sender,\n'+'  "receiver@receiver" as receiver,\n'+'  "Temperature critical!" as subject,\n'+"  prepareEmailText(\n"+'    getNumber(e, "c8y_TemperatureMeasurement.T.value"),\n'+'    getString(e, "c8y_TemperatureMeasurement.T.state")\n'+"   ) as text\n"+"from MeasurementCreated e"},{name:"change the severities of alarms based on activity time",value:'/* Create "context" - definition of a group of events to be processed separately.\n'+' * Context "Alarms" consists of AlarmCreated and AlarmUpdated: \n'+' * with the same source and type = "power off". */\n'+"create context Alarms partition by \n"+'alarm.source from AlarmCreated(alarm.type = "power off"),\n'+'alarm.source from AlarmUpdated(alarm.type = "power off");\n'+"\n"+"/* Update severity for all active AlarmCreated \n"+" * after which there is no change to other status in 15 minutes. */\n"+"context Alarms \n"+"insert into UpdateAlarm \n"+"select \n"+"   a.alarm.id as id,\n"+'   "MAJOR" as severity\n'+"from pattern [\n"+"   every a = AlarmCreated(alarm.status = CumulocityAlarmStatuses.ACTIVE) \n"+"   -> (timer:interval(15 minutes) \n"+"      and not AlarmUpdated(alarm.status != CumulocityAlarmStatuses.ACTIVE))\n"+"];"}];function toId(id){return _.isObjectLike(id)?id.id:id}function buildStatementUrl(id){return c8yBase.url(path+"/"+defaultModule.id+"/statements"+(id?"/"+toId(id):""))}function ensureDefaultModule(callback){return function(param){var deferred=$q.defer(),success,fail;deferred.promise.then(function(){callback(param).success(success).error(fail)});if(defaultModule){deferred.resolve()}else{$http.get(c8yBase.url(path)).success(function(modules){for(var idx in modules.modules){var module=modules.modules[idx];if(isDefaultModule(module)){defaultModule=module;deferred.resolve();return}}$http.post(c8yBase.url(path),{name:"default"},moduleConfig()).success(function(module){defaultModule=module;deferred.resolve()})})}return{then:function(s,e){success=s;fail=e},success:function(s){success=s;return this},error:function(e){fail=e;return this}}}}exports.list=ensureDefaultModule(function(filters){return $http.get(c8yBase.url(path+"/"+defaultModule.id+"/statements"),filters)});exports.detail=ensureDefaultModule(function(id){return $http.get(buildStatementUrl(id))});exports.remove=ensureDefaultModule(function(statement){return $http["delete"](buildStatementUrl(statement.id))});exports.save=ensureDefaultModule(function(statement){var id=statement.id;var request;if(id){request=$http.put(buildStatementUrl(id),clean(statement),statementConfig())}else{request=$http.post(buildStatementUrl(),clean(statement),statementConfig())}return request});exports.examples=function(){return{success:function(callback){$timeout(function(){callback(examples)})}}};return exports}]);angular.module("c8y.core").factory("c8yStatistics",["c8yBase","$http",function(c8yBase,$http){"use strict";var path="tenant/statistics";function getSummary(params){var url=c8yBase.url(path+"/summary");var cfg={params:params};return $http.get(url,cfg)}function list(filters){var url=c8yBase.url(path+"/allTenantsSummary"),cfg={params:c8yBase.timeOrderFilter(c8yBase.pageSizeNoTotalFilter(filters))};return $http.get(url,cfg).then(c8yBase.getResData)}return{getSummary:getSummary,list:list}}]);(function(){"use strict";angular.module("c8y.core").factory("c8yStorageLimitation",["$routeParams","$q","c8ySettings",factory]);function factory($routeParams,$q,c8ySettings){function getStorageLimitationEmailData(){return c8ySettings.detail({category:"storage.limitation"})}function saveStorageLimitationEmailData(data){return c8ySettings.updateOption(_.defaults({category:"storage.limitation"},data))}function hasStorageLimitationEnabled(){return c8ySettings.detail({category:"storage.limitation"}).then(function(response){return!!response.data["group.name"]})}return{getStorageLimitationEmailData:getStorageLimitationEmailData,saveStorageLimitationEmailData:saveStorageLimitationEmailData,hasStorageLimitationEnabled:hasStorageLimitationEnabled}}})();angular.module("c8y.core").factory("c8ySystem",["$http","$q","c8yBase","$window",function($http,$q,c8yBase,$window){"use strict";var path="tenant/system/options/system/version";function getBackendVersion(){var url=c8yBase.url(path);return $http.get(url).then(c8yBase.getResData)}function getUIVersion(){return $q.when($window.UI_VERSION||"dev")}return{getBackendVersion:getBackendVersion,getUIVersion:getUIVersion}}]);(function(){"use strict";angular.module("c8y.core").factory("c8yTenant",c8yTenant);function c8yTenant($http,$location,$q,$window,$interval,c8yBase,c8yUser){var BASE_PATH="tenant/tenants";var TOP_TENANT_NAME="management";var PAGE_SIZE=1e3;var KEYS_TO_REMOVE_IF_NOT_NEW=["applications","ownedApplications","adminName"];var KEYS_TO_REMOVE_IF_NEW=["allowCreateTenants"];var KEYS_TO_REMOVE_IF_NOT_ADMIN_PASS=["adminPass"];var clean=c8yBase.cleanFields;function list(filters){var _filters=c8yBase.pageSizeFilter({pageSize:PAGE_SIZE});var cfg={params:_filters};var path=BASE_PATH;var url=c8yBase.url(path);var onList=c8yBase.cleanListCallback("tenants",list,_filters);return $http.get(url,cfg).then(onList)}function detail(tenant){var url=buildDetailUrl(tenant);return $http.get(url)}function buildDetailUrl(tenant){var id=tenant.id||tenant;return c8yBase.url(BASE_PATH+"/"+id)}function buildDetailApplicationsUrl(tenant){return buildDetailUrl(tenant)+"/applications"}function save(tenant){tenant=_.cloneDeep(tenant);var isNew=!tenant.applications;var method=isNew?"post":"put";var allowCreateTenants=tenant.allowCreateTenants;if(!tenant.adminPass){tenant=clean(tenant,KEYS_TO_REMOVE_IF_NOT_ADMIN_PASS)}tenant=isNew?clean(tenant,KEYS_TO_REMOVE_IF_NEW):clean(tenant,KEYS_TO_REMOVE_IF_NOT_NEW);var url=c8yBase.url(BASE_PATH)+(!isNew?"/"+tenant.id:"");var data=tenant;var cfg={headers:c8yBase.contentHeaders("tenant",true)};return $http[method](url,data,cfg).then(function(response){if(isNew&&allowCreateTenants){return saveTenantAllowOption(response,url,cfg,allowCreateTenants)}else{return $q.when()}})}function saveTenantAllowOption(response,url,cfg,allowCreateTenants){var tenantId=response.data.id;url+="/"+tenantId;return $http.put(url,{allowCreateTenants:allowCreateTenants},cfg)}function remove(tenant){var url=buildDetailUrl(tenant);return $http.delete(url)}function addApplication(tenant,application){var applicationId=application.id||application;var url=buildDetailApplicationsUrl(tenant);var data={application:{id:applicationId,self:application.self}};var cfg={headers:c8yBase.contentHeaders("applicationReference",true)};return $http.post(url,data,cfg)}function removeApplication(tenant,application){var applicationId=application.id||application;var url=buildDetailApplicationsUrl(tenant)+"/"+applicationId;return $http.delete(url)}function isCurrentUserTopTenant(){return c8yUser.current().then(function(res){return isTopTenant(res.tenant)})}function isParentTopTenant(tenant){return isTopTenant(tenant.parent)}function isTopTenant(tenantId){return tenantId===TOP_TENANT_NAME}return{list:list,save:save,remove:remove,detail:detail,addApplication:addApplication,removeApplication:removeApplication,isCurrentUserTopTenant:isCurrentUserTopTenant,isParentTopTenant:isParentTopTenant,isTopTenant:isTopTenant}}})();(function(){"use strict";angular.module("c8y.core").factory("c8yTracker",["c8yBase","c8yRealtime","c8yEvents","$q","c8yGeo",c8yTracker]);function c8yTracker(c8yBase,c8yRealtime,c8yEvents,$q,c8yGeo){function Tracker(scope,filter){var self=this;self.scope=scope;self.filter=filter||{dateFrom:moment().subtract(1,"days").startOf("day").format(c8yBase.dateFullFormat),dateTo:moment().format(c8yBase.dateFullFormat)};self.active={};self.events={};self.loadMore={};self._paths={};self.canceler=$q.defer();Object.defineProperty(self,"state",{get:function(){return c8yRealtime.getStatus(scope.$id,"/events/*")}})}Tracker.prototype.abortRequests=function(){var self=this;self.canceler.resolve();self.canceler=$q.defer()};Tracker.prototype.onPaths=function(callback){var self=this;self.callback=callback};Tracker.prototype._fetchAllEvents=function(){var self=this;var ids=_.keys(_.pickBy(self.active,_.identity));var promises=_.map(ids,_.bind(self._fetchEvents,self));return $q.all(promises).then(_.bind(self._notify,self,true))};Tracker.prototype._notify=function(shouldFitBounds){var self=this;if(!self.callback){return}self.callback(L.multiPolyline(_.values(self._paths),{color:"darkblue"}),shouldFitBounds)};Tracker.prototype._fetchEvents=function(id){var self=this;var mainFilter={source:id,type:"c8y_LocationUpdate",pageSize:1e3,withTotalPages:true};_.assign(mainFilter,self.filter);self._fetching=c8yEvents.list(mainFilter,{timeout:self.canceler.promise}).then(function(events){events=self._filterEvents(events);return self._buildEventListCallback(id,true)(events)});return self._fetching};function isLocationUpdateEvent(event){return event.type==="c8y_LocationUpdate"}function isGPSEvent(event){return!isGSMEvent(event)}function isGSMEvent(event){return/gsm/gi.test(_.get(event,"c8y_Position.fixType"))}Tracker.prototype._filterEvents=function(events){var self=this;var options=self.trackingOptions||{};var filteredEvents=_.filter(events,function(e){return isLocationUpdateEvent(e)&&(_.isUndefined(options.gps)&&_.isUndefined(options.gsm)||options.gps&&isGPSEvent(e)||options.gsm&&isGSMEvent(e))});var preservedStringKeys=_.filter(_.keys(events),isNaN);_.assign(filteredEvents,_.pick(events,preservedStringKeys));return filteredEvents};Tracker.prototype._buildLoadMore=function(id,next){var self=this;return function(){self._fetching=next().then(self._buildEventListCallback(id,false)).then(function(paths){if(paths.length){self._notify(true)}});return self._fetching}};Tracker.prototype._buildEventListCallback=function(id,firstRequest){var self=this;return function(events){var paging=events.paging;events=self.events[id]=firstRequest?events:(self.events[id]||[]).concat(events);self._paths[id]=_(events).filter(c8yGeo.getLocationFragment).map(c8yGeo.getLocationFragment).map(function(loc){return L.latLng(loc.lat,loc.lng)}).value();self.loadMore[id]=paging.next&&self._buildLoadMore(id,paging.next);self._fetching=false;return self._paths[id]}};Tracker.prototype.changeInterval=function(filter){var self=this;self.filter=filter;self.abortRequests();return self._fetchAllEvents()};Tracker.prototype.refresh=function(){var self=this;self.abortRequests();return self._fetchAllEvents()};Tracker.prototype.activate=function(id,options){var self=this;self.active[id]=true;self.trackingOptions=options;return self._fetchEvents(id).then(function(paths){if(!paths.length){return}self._notify(true)})};Tracker.prototype.getActiveDeviceIds=function(){var self=this;return _.keys(self.active)};Tracker.prototype.deactivate=function(id){var self=this;delete self.active[id];delete self._paths[id];delete self.events[id];self._notify()};Tracker.prototype.deactivateAll=function(){var self=this;_.forEach(_.keys(self.active),function(id){delete self.active[id];delete self._paths[id];delete self.events[id]});self._notify()};Tracker.prototype._onNotification=function(evt,data){var self=this;if(!self.active[data.source.id]){return}var path=c8yGeo.getLocationFragment(data);if(!path){return}if(self._filterEvents([data]).length){var lPath=L.latLng(path.lat,path.lng);self._paths[data.source.id].unshift(lPath);self.events[data.source.id].unshift(data);self._notify(true)}};Tracker.prototype.start=function(){var self=this;if(self.state){throw new Error("Tracker: Realtime is already started.")}var realtimeId=self.scope.$id;c8yRealtime.addListener(realtimeId,"/events/*","CREATE",_.bind(self._onNotification,self));c8yRealtime.start(realtimeId,"/events/*");self.scopeDestroyer=self.scope.$on("$destroy",function(){if(!self.state){return}self.stop()})};Tracker.prototype.stop=function(){var self=this;if(!self.state){throw new Error("Tracker: Cannot stop realtime, it has not been started.")}self.scopeDestroyer();c8yRealtime.stop(self.scope.$id,"/events/*")};return{Tracker:Tracker}}})();(function(){"use strict";angular.module("c8y.core").factory("c8yUser",c8yUser);function c8yUser($http,$q,$timeout,$rootScope,$routeParams,c8yBase,c8yAuth,c8ySettings){var path="user/{tenant}/users";var currentUserPath="user/currentUser";var currentUser=null;var config={headers:c8yBase.contentHeaders("user",true)};var configCurrentUser={headers:c8yBase.contentHeaders("user",true)};function applyTenant(url,tenant){return url.replace(/\{tenant\}/g,tenant)}function clean(user){user=_.cloneDeep(user);if(user.id){delete user.userName}delete user.id;delete user.self;delete user.effectiveRoles;return user}function buildUserUrl(user){var _id=user.id||user;return buildUsersUrl().then(function(url){return url+"/"+encodeURIComponent(_id)})}function buildCurrentUserUrl(){return $q.when(c8yBase.url(currentUserPath))}function buildUsersUrl(){return current().then(function(user){return c8yBase.url(applyTenant(path,user.tenant))})}function getTenantFromSelf(url){var FIND_TENANT=/\/user\/(\w+)\//;var match=url.match(FIND_TENANT);if(match.length<2){throw new Error("Cannot find tenant on user self URL")}return match[1]}function current(forceUpdate){var url=currentUserPath,cfg=_.cloneDeep(configCurrentUser),output;if(forceUpdate){currentUser=null}if(currentUser&&!_.isFunction(currentUser.then)){output=$q.when(currentUser)}else{output=currentUser=currentUser||$http.get(c8yBase.url(url),cfg).then(function(res){currentUser=res.data;currentUser.tenant=getTenantFromSelf(currentUser.self);return currentUser},function(){currentUser=null;return $q.reject()})}return output}function list(filter){var _filter=c8yBase.pageSizeFilter(filter),cfg={params:_filter},onList=c8yBase.cleanListCallback("users",list,_filter);return buildUsersUrl().then(function(url){return $http.get(url,cfg).then(onList)})}function detail(user,silentError){var cfg={silentError:!!silentError};return buildUserUrl(user).then(function(url){return $http.get(url,cfg)})}function detailCurrent(){var url=c8yBase.url(currentUserPath),cfg=_.cloneDeep(configCurrentUser);return $http.get(url,cfg)}function remove(user){return buildUserUrl(user).then(function(url){return $http["delete"](url)})}function create(user){var data=clean(user);var cfg=_.cloneDeep(config);return buildUsersUrl().then(function(url){return $http.post(url,data,cfg)})}function enable(user){var userId=user.id||user;return save({id:userId,enabled:true})}function disable(user){var userId=user.id||user;return save({id:userId,enabled:false})}function update(user,isCurrent){var data=clean(user);var cfg=_.cloneDeep(config);var urlPromise=isCurrent?buildCurrentUserUrl():buildUserUrl(user);return urlPromise.then(function(url){return $http.put(url,data,cfg)}).then(function(res){var output=res;var _user=res.data;var promises=[];if(!_.isUndefined(user.owner)&&user.owner!==_user.owner){promises.push(user.owner===null?removeOwner(_user):updateOwner(user,urlPromise))}if(!_.isUndefined(user.delegatedBy)&&user.delegatedBy!==_user.delegatedBy){promises.push(user.delegatedBy===null?removeDelegatedBy(_user):updateDelegatedBy(user,urlPromise))}if(promises.length){output=$q.all(promises).then(_.partial(detail,user))}return output})}function updateOwner(user,urlPromise){var data={owner:user.owner};var _headers={"Content-Type":c8yBase.mimeType("userOwnerReference")};return urlPromise.then(function(url){return url+"/owner"}).then(function(url){return $http.put(url,data,{headers:_headers})})}function updateDelegatedBy(user,urlPromise){var data={delegatedBy:user.delegatedBy};var _headers={"Content-Type":c8yBase.mimeType("userDelegatedByReference")};return urlPromise.then(function(url){return url+"/delegatedby"}).then(function(url){return $http.put(url,data,{headers:_headers})})}function save(user){var action=user.id?update(user):create(user);action.then(function(res){updateToken(user);return res});return action}function removeOwner(user){return buildUserUrl(user).then(function(_url){var url=_url+"/owner";return $http.delete(url)}).then(_.partial(detail,user))}function removeDelegatedBy(user){return buildUserUrl(user).then(function(_url){var url=_url+"/delegatedby";return $http.delete(url)}).then(_.partial(detail,user))}function saveCurrent(user){return update(user,true).then(function(){updateToken(user)})}function updateToken(user){checkIfCurrent(user).then(function(isCurrent){if(isCurrent){c8yAuth.updatePassword(getPassword(user))}})}function checkIfCurrent(user){var userId=user.id||user;return current().then(function(currentUser){return $q.when(currentUser.id===userId)})}function getPassword(user){return user.password||c8yAuth.getPassword()}function isCurrentPassword(password){return c8yAuth.getPassword()===password}function groups(user){var _groups=user.groups&&user.groups.references||[];return _groups.map(function(ref){return ref.group})}function isDeviceUser(user){return user.id.match(/^device_/)}function hasRole(user,roleId){var result=hasRoleInUser(user,roleId);if(!result){result=hasRoleInGroups(user,roleId)}return result}function hasRoleInUser(user,roleId){var result=false;if(user.roles&&user.roles.references){_.forEach(user.roles.references,function(ref){if(ref.role.id===roleId){result=true}})}return result}function hasRoleInGroups(user,roleId){var result=false;if(user.groups&&user.groups.references){_.forEach(user.groups.references,function(groupRef){_.forEach(groupRef.group.roles.references,function(roleRef){if(roleRef.role.id===roleId){result=true}})})}return result}function getDevicePermissions(user,deviceId){var _filter=c8yBase.pageSizeFilter({moId:deviceId});var cfg={params:_filter};return buildUserUrl(user).then(function(url){return $http.get(url+"/devicePermissions",cfg)})}function login(tenant,username,password,remember){var token=c8yAuth.encodeToken(username,password,tenant);return c8yAuth.setAuthToken(token).then(_.partial(c8yAuth.saveAuthToken,remember))}function logout(){return c8yAuth.logout()}function isAdmin(user){var admin=_.some(user.groups.references,function(ref){return ref.group.name==="admins"});return admin}function getHeaders(token){var headers=c8yAuth.headers();if(token){headers.Authorization="Basic "+token}return _.assign(headers,c8yBase.contentHeaders("user",true))}function isTfaActive(user){var newUser=_.isUndefined(user.id);return newUser?isTfaAvailable():$q.when(user).then(function(userDetails){var tfaActive=userDetails.twoFactorAuthenticationEnabled;return isTfaReadonly(user).then(function(enforced){if(enforced){tfaActive=true}return tfaActive})})}function isTfaAvailable(){var tfaEnabledOption={category:"two-factor-authentication",key:"enabled"};return $q.all([c8ySettings.detailValue(tfaEnabledOption),c8ySettings.getSystemOptionValue(tfaEnabledOption),isTfaEnforced()]).then(function(values){return _.reduce(values,function(available,value){return available||value},false)})}function isTfaReadonly(user){return isTfaEnforced({user:user})}function isTfaEnforced(options){var opts=options||{};var user=opts.user;var userPromise=user?$q.when(user):current();return userPromise.then(function(user){return $q.all([isTfaTenantEnforcedForUser(user),isTfaGroupEnforcedForUser(user)]).then(function(values){return Boolean(values[0]||values[1])})})}function c8ySettings2TFAEnforced(){if(!c8ySettings2TFAEnforced._calling){var calling=c8ySettings2TFAEnforced._calling=c8ySettings.getSystemOptionValue({category:"two-factor-authentication",key:"enforced"});calling.finally(function(){c8ySettings2TFAEnforced._calling=undefined})}return c8ySettings2TFAEnforced._calling}function c8ySettings2TFAEnforcedGroup(){if(!c8ySettings2TFAEnforcedGroup._calling){var calling=c8ySettings2TFAEnforcedGroup._calling=c8ySettings.getSystemOptionValue({category:"two-factor-authentication",key:"enforced.group"});calling.finally(function(){c8ySettings2TFAEnforcedGroup._calling=undefined})}return c8ySettings2TFAEnforcedGroup._calling}function isTfaTenantEnforcedForUser(user){return c8ySettings2TFAEnforced().then(function(enforcedTfaTenantsCsv){var enforcedTfaTenants=[];if(enforcedTfaTenantsCsv){enforcedTfaTenants=enforcedTfaTenantsCsv.split(",")}return _.some(enforcedTfaTenants,function(enforcedTfaTenant){return enforcedTfaTenant===user.tenant})})}function isTfaGroupEnforcedForUser(user){return c8ySettings2TFAEnforcedGroup().then(function(enforcedTfaGroupName){return _.some(groups(user),function(userGroup){return userGroup.name===enforcedTfaGroupName})})}function savePhoneNumber(user,phoneNumber){var url=c8yBase.url("user/currentUserPhone"),token=c8yAuth.encodeToken(user.name,user.password,user.tenant),config={headers:getHeaders(token),method:"PUT",url:url,data:{phone:phoneNumber},silentError:true};return $http(config)}function activateSupportUser(user){var promise=user?$q.when(user):current();var METHOD="PUT";var URL=c8yBase.url("tenant/support-user/enable");return promise.then(function(){return $http({method:METHOD,url:URL})})}function inventoryRolesUrl(userUrl){return userUrl+"/roles/inventory"}function listInventoryRoles(user){var userPromise=user?$q.when(user):current();var doCall=function(url){return $http.get(url)};return userPromise.then(buildUserUrl).then(inventoryRolesUrl).then(doCall)}function assignInventoryRoles(user,manageObjectId,roleIds){var userPromise=user?$q.when(user):current();var data={managedObject:manageObjectId,roles:_.map(roleIds,function(r){return _.pick(r,"id")})};var doCall=function(url){return $http.post(url,data)};return userPromise.then(buildUserUrl).then(inventoryRolesUrl).then(doCall)}function updateInventoryRoles(user,assignmentId,roleIds){var userPromise=user?$q.when(user):current();var data={roles:_.map(roleIds,function(r){return _.pick(r,"id")})};var doCall=function(url){var detailUrl=url+"/"+assignmentId;return $http.put(detailUrl,data)};return userPromise.then(buildUserUrl).then(inventoryRolesUrl).then(doCall)}function removeInventoryRoles(user,assignmentId){var userPromise=user?$q.when(user):current();var doCall=function(url){var detailUrl=url+"/"+assignmentId;return $http.delete(detailUrl)};return userPromise.then(buildUserUrl).then(inventoryRolesUrl).then(doCall)}function delegateTo(_user){var user={id:_user.id};return current().then(function(_currentUser){user.delegatedBy=_currentUser.id;return update(user)})}$rootScope.$on("authStateChange",function(evt,data){if(!data.hasAuth){currentUser=null}});return{current:current,checkIfCurrent:checkIfCurrent,list:list,detail:detail,detailCurrent:detailCurrent,remove:remove,enable:enable,disable:disable,save:save,saveCurrent:saveCurrent,savePhoneNumber:savePhoneNumber,groups:groups,isDeviceUser:isDeviceUser,hasRole:hasRole,getDevicePermissions:getDevicePermissions,login:login,logout:logout,isAdmin:isAdmin,isCurrentPassword:isCurrentPassword,isTfaAvailable:isTfaAvailable,isTfaActive:isTfaActive,isTfaReadonly:isTfaReadonly,getHeaders:getHeaders,activateSupportUser:activateSupportUser,delegateTo:delegateTo,listInventoryRoles:listInventoryRoles,assignInventoryRoles:assignInventoryRoles,updateInventoryRoles:updateInventoryRoles,removeInventoryRoles:removeInventoryRoles}}})();(function(){"use strict";angular.module("c8y.core").factory("c8yUserGroup",c8yUserGroup);function c8yUserGroup($http,$q,c8yBase,c8yUser){var basePath="user/";function buildGroupsUrl(){return c8yUser.current().then(function(user){var tenant=user.tenant;return c8yBase.url(basePath+tenant+"/groups")})}function buildRolesUrl(){return $q.when(c8yBase.url(basePath+"roles"))}function buildGroupUrl(group){var groupId=group.id||group;return c8yUser.current().then(function(user){var tenant=user.tenant;return c8yBase.url(basePath+tenant+"/groups/"+groupId)})}function buildGroupUsersUrl(group,user){return buildGroupUrl(group).then(function(url){return url+"/users"+(user?"/"+encodeURIComponent(user.id||user):"")})}function buildGroupRolesUrl(group){return buildGroupUrl(group).then(function(url){return url+"/roles"})}function buildGroupRoleUrl(group,role){var roleId=role.id||role;return buildGroupRolesUrl(group).then(function(url){return url+"/"+roleId})}function list(filters){var _filter=c8yBase.pageSizeFilter(filters);var cfg={params:_filter};var onList=c8yBase.cleanListCallback("groups",list,_filter);return buildGroupsUrl().then(function(url){return $http.get(url,cfg).then(onList)})}function detail(group){return buildGroupUrl(group).then(function(url){return $http.get(url)})}function remove(group){return buildGroupUrl(group).then(function(url){return $http.delete(url)})}function update(group){var cfg={headers:c8yBase.contentHeaders("group")};return buildGroupUrl(group).then(function(url){return $http.put(url,group,cfg).then(function(){return group})})}function create(group){var cfg={headers:c8yBase.contentHeaders("group")};return buildGroupsUrl().then(function(url){return $http.post(url,group,cfg).then(function(res){var location=res.headers("location");var id=location.match(/\d+$/)[0];return detail(id).then(function(res){return res.data})})})}function save(group){return group.id?update(group):create(group)}function listRoles(filters){var _filter=c8yBase.pageSizeFilter(filters);var cfg={params:_filter,cache:true};var onList=c8yBase.cleanListCallback("roles",listRoles,_filter);return buildRolesUrl().then(function(url){return $http.get(url,cfg).then(onList)})}function findRole(roleId){return listRoles().then(function(roles){var selRole;roles.forEach(function(role){if(role.id===roleId){selRole=role;return false}});return selRole})}function addUserToGroup(group,user){var data={user:_.pick(user,["id","self"])};return buildGroupUsersUrl(group).then(function(url){return $http.post(url,data)})}function removeUserFromGroup(group,user){return buildGroupUsersUrl(group,user).then(function(url){return $http.delete(url)})}function updateGroups(user,groupIds){var references=_.get(user,"groups.references",[]);var userGroupsIds=references.map(function(ref){return ref.group.id});var actions=[];groupIds.forEach(function(groupId){if(userGroupsIds.indexOf(groupId)===-1){actions.push(addUserToGroup(groupId,user))}});userGroupsIds.forEach(function(groupId){if(groupIds.indexOf(groupId)===-1){actions.push(removeUserFromGroup(groupId,user))}});return $q.all(actions)}function addRoleToGroup(group,role){var cfg={headers:c8yBase.contentHeaders("roleReference")};return buildGroupRolesUrl(group).then(function(url){return $http.post(url,{role:role},cfg)})}function removeRoleFromGroup(group,role){return buildGroupRoleUrl(group,role).then(function(url){return $http.delete(url)})}function updateRoles(group,roleIds){var groupRoleIds=group.roles.references.map(function(ref){return ref.role.id});var actions=[];roleIds.forEach(function(roleId){if(groupRoleIds.indexOf(roleId)===-1){actions.push(findRole(roleId).then(function(role){return addRoleToGroup(group,role)}))}});groupRoleIds.forEach(function(roleId){if(roleIds.indexOf(roleId)===-1){actions.push(removeRoleFromGroup(group,roleId))}});return $q.all(actions)}return{list:list,detail:detail,remove:remove,create:create,update:update,
save:save,listRoles:listRoles,updateGroups:updateGroups,updateRoles:updateRoles}}})();(function(){"use strict";angular.module("c8y.core").factory("c8yUserPreferences",["$q","c8yInventory","c8yUser",c8yUserPreferences]);function c8yUserPreferences($q,c8yInventory,c8yUser){var localStorageKey="userPreferences";function get(key){return c8yUser.current().then(_.partial(getPreference,key))}function getPreference(key,user){var fragmentType=getFragmentType(key,user);return getPreferenceMo(user,fragmentType).then(_.partial(getPreferenceValue,fragmentType))}function getFragmentType(key,user){return key+user.userName.replace(/\./g,"__")}function getPreferenceMo(user,fragmentType){if(canUseInventoryStorage(user)){return c8yInventory.list({fragmentType:fragmentType}).then(function(list){return list.length?list[0]:{type:"c8y_UserPreference"}})}else{var storage=getLocalStorage();var mo={};mo[fragmentType]=storage[fragmentType];return $q.when(mo)}}function getPreferenceValue(fragmentType,preferenceMo){return preferenceMo[fragmentType]}function set(key,value){return c8yUser.current().then(_.partial(setPreference,key,value))}function setPreference(key,value,user){var fragmentType=getFragmentType(key,user);return getPreferenceMo(user,fragmentType).then(_.partial(setPreferenceValue,fragmentType,value,user))}function setPreferenceValue(fragmentType,value,user,preferenceMo){if(canUseInventoryStorage(user)){preferenceMo[fragmentType]=value;return c8yInventory.save(preferenceMo)}else{var storage=getLocalStorage();storage[fragmentType]=value;setLocalStorage(storage)}}function canUseInventoryStorage(user){return c8yUser.hasRole(user,"ROLE_INVENTORY_READ")&&c8yUser.hasRole(user,"ROLE_INVENTORY_ADMIN")}function getLocalStorage(){var data=window.localStorage.getItem(localStorageKey);try{data=JSON.parse(data)}catch(e){data={}}return data||{}}function setLocalStorage(data){window.localStorage.setItem(localStorageKey,JSON.stringify(data))}return{get:get,set:set}}})();(function(){"use strict";angular.module("c8y.core").service("c8yUtil",["$window","c8yBase",C8yUtil]);function C8yUtil($window,c8yBase){this.dateToString=function(date){return date&&moment(date).format(c8yBase.dateFormat)};this.stringToDate=function(date){return date&&moment(date).toDate()};this.setLocal=function(key,obj){$window.localStorage.setItem(key,JSON.stringify(obj))};this.getLocal=function(key){try{return JSON.parse($window.localStorage.getItem(key))}catch(e){if(e instanceof SyntaxError){return undefined}throw e}}}})();angular.module("c8y.core").factory("c8yWorkers",["c8yBase","$timeout",function(c8yBase,$timeout){"use strict";var exports={};exports.create=function(path){var self,worker=new Worker(c8yBase.url(path)),continueOnMessage=true;self={push:function(message){worker.postMessage(message);return self},terminateOnMessage:function(){continueOnMessage=false;return self},message:function(callback){worker.onmessage=function(message){$timeout(function(){callback(message.data);if(!continueOnMessage){worker.terminate()}})};return self},error:function(callback){worker.onerror=function(message){$timeout(function(){callback(message);if(!continueOnMessage){worker.terminate()}})};return self},terminate:function(){worker.terminate()}};return self};return exports}]);(function(){"use strict";var KeysMixin={};KeysMixin.getKeys=function(e){var reserved=this.reservedKeys||[];var isNotReservedKey=function(p){return reserved.indexOf(p)===-1};var props=_.keys(e);return props.filter(isNotReservedKey)};KeysMixin.getStandardKeys=function(e){var stdKeys=this.standardKeys||{};return _.pickBy(stdKeys,function(label,key){return _.has(e,key)})};KeysMixin.getNonStandardKeys=function(e){return _.difference(this.getKeys(e),_.keys(this.getStandardKeys(e)))};angular.module("c8y.core").constant("KeysMixin",KeysMixin)})();(function(){"use strict";angular.module("c8y.core").constant("latestMixinFactory",function($q){var Mixin={};Mixin.latest=function(fn){if(!_.isFunction(fn)){throw new TypeError("Argument needs to be a function")}var count=-1;return function(){var currCount=++count;var promise=fn.apply(this,arguments);if(!_.isFunction(promise.then)){throw new TypeError("Function must return a promise")}promise=promise.then(function(args){if(currCount!==count){return $q.reject("Promise is cancelled by a more recent one.")}return args},function(reason){if(currCount!==count){return $q.reject("Promise is cancelled by a more recent one.")}return $q.reject(reason)});return promise}};return Mixin})})();(function(){"use strict";angular.module("c8y.sdk",["c8y.core"]).constant("info",{});angular.module("c8y.ui",["c8y.core"])})();(function(){angular.module("c8y.sdk").directive("c8yLogin",["c8yCumulocity",c8yLogin]);function c8yLogin(c8yCumulocity){function link(scope,elem){elem.bind("click",function(){c8yCumulocity.login(scope.tenant(),scope.user(),scope.password(),scope.rememberMe()).then(scope.onSuccess).catch(scope.onFailure)})}return{restrict:"A",link:link,scope:{tenant:"&",user:"&",password:"&",rememberMe:"&",onSuccess:"&",onFailure:"&"}}}})();(function(){angular.module("c8y.sdk").directive("c8yLogout",["c8yCumulocity",c8yLogout]);function c8yLogout(c8yCumulocity){function link(scope,elem){elem.bind("click",function(event){c8yCumulocity.logout();scope.ngClick();event.stopPropagation()})}return{priority:1,restrict:"A",link:link,scope:{ngClick:"&"}}}})();(function(){angular.module("c8y.sdk").directive("c8yRepeat",["$injector","$compile","$rootScope",c8yRepeat]);function c8yRepeat($injector,$compile,$rootScope){function createLink(clonedElement){return function(scope,_elem,attrs){var elem=clonedElement;var serviceName;var ngRepeatLink;var parentScope;replaceWithNgRepeat();init();function replaceWithNgRepeat(){var regex=/^\s*([^\s]+)\s*in\s*([^\s]+)\s*/;var matches=regex.exec(attrs.c8yRepeat);var varName=matches[1];serviceName=matches[2];elem.removeAttr("c8y-repeat");elem.removeAttr("data-c8y-repeat");elem.attr("ng-repeat",varName+" in __c8y_serviceResult track by "+varName+".id");ngRepeatLink=$compile(elem);$(_elem).replaceWith(elem)}function assignRefreshFunction(){scope.refresh=fetchResults}function fetchResults(){if($rootScope.c8y&&$rootScope.c8y.user){callService().then(function(result){parentScope.__c8y_serviceResult=result})}}function callService(){var filter=scope.filter||{};return $injector.get("c8y"+capitalize(serviceName)).list(filter)}function capitalize(s){return s[0].toUpperCase()+s.slice(1)}function init(){parentScope=scope.$parent;ngRepeatLink(parentScope);assignRefreshFunction();$rootScope.$on("c8y.api.login",function(){fetchResults()});scope.$watch("filter",fetchResults,true)}}}return{restrict:"A",compile:function(element){return createLink($(element).clone())},transclude:false,scope:{filter:"=?",refresh:"=?"}}}})();(function(){"use strict";var STORAGE_KEY="_tcy8";angular.module("c8y.sdk").provider("c8yCumulocity",["info",c8yCumulocityProvider]).run(["$rootScope","$window","$q","info","c8yUser",run]);function run($rootScope,$window,$q,info,c8yUser){function setTokenFromStorage(){var token=$window.localStorage.getItem(STORAGE_KEY)||$window.sessionStorage.getItem(STORAGE_KEY);info.token=token}function setupAfterLogin(){if(!info.token||info.preventGetUser){return $q.reject("No token")}c8yUser.current().then(function(user){var c8y=$rootScope.c8y=$rootScope.c8y||{};c8y.user=user;$rootScope.$emit("c8y.api.login")})}setTokenFromStorage();setupAfterLogin()}function createGetters(info){function getBaseUrl(){return info.baseUrl}function getAppKey(){return info.appKey}function getTenant(){return info.tenant}return{getBaseUrl:getBaseUrl,getAppKey:getAppKey,getTenant:getTenant}}function c8yCumulocityProvider(info){function setBaseUrl(baseUrl){info.baseUrl=baseUrl}function setAppKey(appKey){info.appKey=appKey}function setTenant(tenant){info.tenant=tenant}var result={setBaseUrl:setBaseUrl,setAppKey:setAppKey,setTenant:setTenant,$get:["info","$window","$rootScope","c8yUser",c8yCumulocity]};_.assign(result,createGetters(info));return result}function c8yCumulocity(info,$window,$rootScope,c8yUser){var getters=createGetters(info);function login(tenant,user,password,remember){tenant=tenant||getters.getTenant();return c8yUser.login(tenant,user,password,remember).then(setUser).then(function(){$rootScope.$emit("c8y.api.login")})}function setUser(user){var c8y=$rootScope.c8y=$rootScope.c8y||{};c8y.user=user}function logout(){setUser(null);c8yUser.logout();$rootScope.$emit("c8y.api.logout")}var result={login:login,logout:logout};_.assign(result,getters);return result}})();
//# sourceMappingURL=build/main.js.map
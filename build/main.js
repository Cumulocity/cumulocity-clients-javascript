!function(){"use strict";angular.module("c8y.core",["angularFileUpload"])}(),function(){"use strict";function a(a,b,c,d,e){function f(a){var c=a.id||a;return b.url(B+"/"+c)}function g(c){var d=b.url(B),e=b.timeOrderFilter(b.pageSizeNoTotalFilter(c)),f={params:e},h=b.cleanListCallback("alarms",g,e);return a.get(d,f).then(h)}function h(b){var c=f(b);return a.get(c)}function i(c){var d=b.url(B),e=A(c,K);return a.post(d,e,D)}function j(b){var c=f(b),d=A(b,L);return a.put(c,d,D)}function k(a){return a.id?j(a):i(a)}function l(a,b){function c(b){var c="--";return a.status===G.ACKNOWLEDGED&&(c=b[b.length-1].user),b.forEach(function(a){var b=a.changes||[],d=!1;return b.forEach(function(a){return a.attribute===N&&a.newValue===G.ACKNOWLEDGED?(d=!0,!1):void 0}),d?(c=a.user||c,!1):void 0}),c}return b?c(b):e.list({source:a.id,pageSize:1e3}).then(c)}function m(a,b){function c(a){var b=a||[],c=b.length?b[b.length-1].creationTime:void 0;return b.forEach(function(a){var b=a.changes||[],d=!1;return b.forEach(function(b){return b.attribute===N&&b.newValue===G.ACKNOWLEDGED?(c=a.creationTime,d=!0,!1):void 0}),d?!1:void 0}),c}return b?c(b):e.list({source:a.id,pageSize:1e3}).then(c)}function n(a,b){function c(b){var c=b||[],d=a.creationTime,e=c.length?c[c.length-1].creationTime:void 0,f="";if(_.forEach(c,function(a){var b=a.changes||[],c=!1;return b.forEach(function(b){return b.attribute===N&&b.newValue===G.CLEARED?(e=a.creationTime,c=!0,!1):void 0}),c?!1:void 0}),d&&e){var g=moment(d),h=moment(e);f=moment.duration(g.diff(h)).humanize()}return f}return b?c(b):e.list({source:a.id,pageSize:1e3}).then(c)}function o(a){return-1!==J.indexOf(a)}function p(a){return!o(a)}function q(a){var b=angular.copy(a),c=Object.keys(b);return c.filter(p)}function r(a){var b=(angular.isObject(a)?a.severity:a).toUpperCase();return M[b]}function s(a,c){var d=[C,a];return c.id&&d.push(c.id),b.url(d.join("/"))}function t(c){var d="downtimeDuration",e=b.timeOrderFilter(c),f=s(d,e),g={params:e};return a.get(f,g)}function u(a){var b=new c.Counter(g,"/alarms/*");if(a){var d=[c.defaultPropertyMaps.date,c.defaultPropertyMaps.source];if(a.type){var e=a.type;d.push([function(a){return e===a.type}])}delete a.type,b.filter(a,d)}return b}function v(a,b){return d.all(_.map(a,function(a,c){return a?(b.status=c,g(b)):void 0})).then(y)}function w(a,b){return d.all(_.map(a,function(a){return b.source=a,g(b)})).then(y)}function x(a,b){var c=_.where(a,{severity:b});return c.length}function y(a){return _.filter(a,function(a){return angular.isDefined(a)})}function z(a){var b=_.memoize(a,function(a){return[a.id,":",a.time].join("")});return function(c,d){return d?b(c,d):a(c)}}var A=b.cleanFields,B="alarm/alarms",C=B+"/reports",D={headers:b.contentHeaders("alarm")},E={WARNING:"WARNING",MINOR:"MINOR",MAJOR:"MAJOR",CRITICAL:"CRITICAL"},F=Object.keys(E),G={ACTIVE:"ACTIVE",ACKNOWLEDGED:"ACKNOWLEDGED",CLEARED:"CLEARED"},H=Object.keys(G),I=["history","id","severity","self","source","creationTime","time","text","firstOccurrence","count","firstOccurrenceTime"],J=["status"].concat(I),K=["id"],L=["id","self","creationTime","type","time","count","history","firstOccurence","firstOccurrenceTime"],M={},N="status";return M[E.WARNING]="circle",M[E.MINOR]="exclamation-circle",M[E.MAJOR]="exclamation-circle",M[E.CRITICAL]="warning",M[G.CLEARED]="check-circle",M[G.ACKNOWLEDGED]="eye",M[G.ACTIVE]="bell",{list:g,listByStatus:v,listByDevices:w,getSeverityCount:x,detail:h,update:j,create:i,save:k,acknowledgedBy:z(l),ackTime:z(m),alarmDuration:z(n),severity:E,severityList:F,status:G,statusList:H,reservedKeys:J,icon:r,getKeys:q,reports:{downtimeDuration:t},createCounter:u}}angular.module("c8y.core").factory("c8yAlarms",["$http","c8yBase","c8yCounter","$q","c8yAudits",a])}(),angular.module("c8y.core").factory("c8yAudits",["$http","c8yBase",function(a,b){"use strict";function c(a){var c=a.id||a;return b.url(l+"/"+c)}function d(c){var e=b.url(l),f=b.pageSizeNoTotalFilter(c),g={params:f},h=b.cleanListCallback("auditRecords",d,f);return a.get(e,g).then(h).then(j)}function e(b){var d=c(b);return a.get(d)}function f(c){var d=b.url(l),e=k(c,r);return a.post(d,e,m)}function g(a){return-1!==q.indexOf(a)}function h(a){return!g(a)}function i(a){var b=angular.copy(a),c=Object.keys(b);return c.filter(h)}function j(a){return _.remove(a,{activity:"Availability monitoring record"}),a}var k=b.cleanFields,l="audit/auditRecords",m={headers:b.contentHeaders("auditRecord")},n={WARNING:"WARNING",MINOR:"MINOR",MAJOR:"MAJOR",CRITICAL:"CRITICAL"},o=Object.keys(n),p=["id","self","creationTime"],q=p,r=p;return{list:d,detail:e,create:f,severity:n,severityList:o,reservedKeys:q,getKeys:i}}]),angular.module("c8y.core").factory("c8yApplication",["$http","$location","$q","$window","$interval","c8yBase","c8yUser","c8yInventory",function(a,b,c,d,e,f,g,h){"use strict";function i(a){var b=angular.copy(a);return delete b.type,delete b.key,b}function j(b,c){return g.current().then(function(d){var e=d.tenant,g=f.pageSizeFilter(c),h={params:g,cache:!0},i=f.url(b)+"/"+e,k=f.cleanListCallback("applications",angular.bind(N,j,b),g);return a.get(i,h).then(k)})}function k(b,c){return g.current().then(function(d){b=b||d;var e=f.pageSizeFilter(c),g={params:e,cache:!0},h=f.url(K+"applicationsByUser/"+b.id),i=f.cleanListCallback("applications",angular.bind(N,k,b),e);return a.get(h,g).then(i)})}function l(a){return j(K+"applicationsByOwner",a)}function m(a){return j(K+"applicationsByTenant",a)}function n(){var b=f.url(K+"plugins"),c={params:f.pageSizeNoTotalFilter()};return a.get(b,c).then(function(a){return _.unique(a.data.plugins,"id")})}function o(){return m().then(function(a){a=_.uniq(a,"id");var b=[];return angular.forEach(a,function(a){J(a)&&b.push(p(a))}),c.all(b).then(_.flatten).then(_.partialRight(_.unique,function(a){return a.id}))})}function p(b){var c=f.url(L+"/"+b.contextPath+"/manifest"),d={params:f.pageSizeNoTotalFilter()};return a.get(c,d).then(function(a){return _.map(a.data.imports,q)})}function q(a){return{id:a.id,contextPath:a.rootContextPath,directoryName:a.directoryName,manifest:a}}function r(a){var b=a.id||a;return f.url(L+"/"+b)}function s(b){var c=r(b);return a.get(c)}function t(b){var d=r(b),e=angular.isObject(b)?b:{id:b},f=[],g=C(e).then(function(a){return a.config&&a.config.id?h.remove(a.config):!0});return f.push(g),f.push(a["delete"](d)),c.all(f)}function u(b){var c=r(b),e=i(b),f=angular.copy(M);return a.put(c,e,f)["finally"](function(){d.localStorage.setItem("refresh",b.contextPath)})}function v(b){var c=f.url(L),d=angular.copy(M);return a.post(c,b,d)}function w(a,b){return s(a).then(function(a){var c=a.data;return c.manifest=b,c}).then(u)}function x(a){return a.id?u(a):v(a)}function y(a){var c=b.port();return c=80===c||443===c?"":":"+c,b.protocol()+"://"+b.host()+c+"/apps/"+a.contextPath}function z(){var a=d.location.pathname.match(/\/apps\/(\w+)\/?/);return a&&a[1]}function A(){var a=z();return k().then(function(b){var c={};return b.forEach(function(b){return b.contextPath===a?(c=b,!1):void 0}),c})}function B(a){return h.list({type:"c8y_SmartAppApplication"}).then(function(b){var c=null;return b.forEach(function(b){return b.appId===a.id?(c=b,!1):void 0}),c})}function C(a){var b,d=a?c.when(a):A();return d.then(function(a){return b=a,a}).then(B).then(function(a){return b.config=a,b})}function D(a){var b=d.localStorage.getItem("refresh");b===z()&&(d.localStorage.setItem("refresh",void 0),a||d.location.reload())}function E(a){return J(a)?y(a):a.externalUrl}function F(a){var b=angular.isString(a)?a:a.type;return a.manifest&&(b="SMARTAPP"),O[b]}function G(){e(function(){D()},1e3,0,!1)}function H(a){var b=_.uniq(a,function(a){return a.id}),c=_.filter(b,function(a){var b=a.manifest&&a.manifest.noAppSwitcher;return b!==!0});return c}function I(){return k().then(H).then(function(a){return c.when(a)})}function J(a){return"HOSTED"===a.type}var K="application/",L=K+"applications",M={headers:f.contentHeaders("application",!0)},N=this,O={HOSTED:"cloud",EXTERNAL:"external-link-square",SMARTAPP:"puzzle-piece"};return D(!0),{list:m,listByUser:k,listByTenant:m,listByOwner:l,listPlugins:n,listPluginsByTenant:o,listPluginsByApplication:p,listByVisibleLinks:I,detail:s,update:u,create:v,remove:t,save:x,getHref:E,icon:F,getCurrent:A,getConfig:C,pollRefreshMessages:G,getCurrentContextPath:z,updateManifest:w}}]),angular.module("c8y.core").factory("c8yAuth",["$location","$window","info",function(a,b,c){"use strict";function d(a){var b=atob(a),c=b.match(/(([^\/]*)\/)?([^\/:]+):(.+)/);return{tenant:c[2],user:c[3],password:c[4]}}function e(a,b,c){return c=c?c+"/":"",btoa(c+a+":"+b)}function f(a){var f=d(i);c.token=i=e(f.user,a,f.tenant),b.localStorage.setItem(j,i)}function g(a){var b=a.url,d=!b.match(/http/)||b.match(/^https?\:\/\/.*cumulocity\.com/),e=b.startsWith(c.baseUrl);return(d||e)&&(a.headers||(a.headers={}),a.headers.Authorization||(a.headers.Authorization="Basic "+c.token),angular.extend(a.headers,{UseXBasic:!0})),a}function h(){angular.isFunction(c.logout)&&c.logout()}var i=c.token,j="_tcy8";return{decodeToken:d,logout:h,updatePassword:f,request:g}}]).config(["$httpProvider",function(a){a.interceptors.push("c8yAuth")}]),angular.module("c8y.core").factory("c8yBase",["$rootScope","$http","$window","info",function(a,b,c,d){"use strict";function e(a){return F+a+"+json"}function f(a,b){return{"Content-Type":e(a),Accept:b?e(angular.isString(b)?b:a):void 0}}function g(a,b){var c=angular.copy(a);return b.forEach(function(a){delete c[a]}),c}function h(a){return D()+a}function i(a){return angular.extend({pageSize:H},a)}function j(a){return angular.extend({withTotalPages:!0,pageSize:H},a)}function k(a){return angular.extend({dateFrom:"1970-01-01",dateTo:moment().add(1,"day").format(I)},a)}function l(a){return angular.extend({dateFrom:moment().subtract(1,"week").format(I),dateTo:moment().add(1,"day").format(I)},a)}function m(a){return angular.extend({dateFrom:moment().startOf("month").format(I)},a)}function n(a){return angular.extend({dateFrom:moment().subtract(1,"day").format(I),dateTo:moment().add(1,"day").format(I)},a)}function o(a,b){var c={};return b&&b.split("?")[1].split("&").forEach(function(a){var b=a.split("=");c[b[0]]=decodeURIComponent(b[1])}),c[a]}function p(a,b){var c=a.statistics,d=1===b?"next":"prev",e=a[d],f={currentPage:c.currentPage,pageSize:c.pageSize,startkey:o("startkey",e),startkey_docid:o("startkey_docid",e)},g=o("currentPage",e);return f.currentPage=parseInt(g),f}function q(a){var b=a.statistics,c={currentPage:1,pageSize:b.pageSize*b.currentPage,startkey:null,startkey_docid:null};return angular.isDefined(a.totalPages)&&(c.pageSize=b.pageSize),c}function r(a,b,c,d){var e=a.statistics,f=angular.isDefined(a.prev),g=angular.isDefined(a.next),h={};if(f){var i=angular.extend(angular.copy(c),p(a,-1));h.prev=angular.bind({},b,i)}if(g){var j=angular.extend(angular.copy(c),p(a,1));h.next=angular.bind({},b,j),angular.isDefined(e.totalPages)&&(h.more=(e.totalPages-e.currentPage)*e.pageSize)}var k=angular.extend(angular.copy(c),q(a)),l=angular.bind({},b,k);return h.statistics=e,h.blind=d,h.refresh=function(){return l().then(function(f){return f.statistics=e,f.paging=r(a,b,c,d),f})},h}function s(a,b,c){return function(d){var e=d.data,f=e[a];return f.statistics=e.statistics,c.withTotalPages||f.length!==parseInt(c.pageSize,10)||(e.statistics.totalPages=f.statistics.totalPages=+(1/0)),f.paging=r(e,b,c,!c.withTotalPages),f}}function t(a,b){var c=a.indexOf(b);c>=0&&a.splice(c,1)}function u(a,b){var c=angular.copy(a);return b.forEach(function(a){delete c[a]}),c}function v(a,b,c){var d=a&&a[b],e=d&&d[c],f=e&&e.$pristine,g=e&&e.$invalid;return f===!1&&g===!0}function w(a,b){return b.pageSize=1,b.withTotalPages=!0,a(b).then(function(a){return a.statistics.totalPages})}function x(a){return a||(a=""),String(a).replace(/c8y_/,"").replace(/([A-Z])/g," $1").replace(/^\s*/,"").replace(/\s*$/,"")}function y(a){return a&&a.data||a}function z(a){var b={},c=0;return b.values=_.constant(_.map(a,function(a){return angular.isObject(a)?b[a.name]={name:a.name,ordinal:c++,value:a.value}:b[a]={name:a,ordinal:c++,value:a}})),b}function A(a,b){if(b=b||"id",!angular.isObject(a))throw new Error("mo is not an object");return angular.isUndefined(a[b])&&(a[b]=String(Math.random()).substr(2)),a}function B(a){var b;if(angular.isObject(a)&&(b=a.id),(angular.isNumber(a)||angular.isString(a)&&a.match(/^\d+$/))&&(b=String(a)),!b)throw new Error("id cannot be found");return b}function C(a){try{return _.each(a,function(a){angular.module(a)}),!0}catch(b){return!1}}var D=function(){return d.baseUrl||"/"},E="X-Cumulocity-Application-Key",F="application/vnd.com.nsn.cumulocity.",G=d.appKey,H=d.pageSize||1e3,I="YYYY-MM-DD",J="YYYY-MM-DDTHH:mm:ssZ";if(!G)throw new Error("Application key must be defined");return b.defaults.headers.common[E]=G,{url:h,deleteProperties:g,mimeType:e,contentHeaders:f,PAGESIZE:H,pageSizeFilter:j,pageSizeNoTotalFilter:i,timeOrderFilter:k,lastWeekFilter:l,todayFilter:n,fromThisMonthStartFilter:m,cleanListCallback:s,removeFromList:t,cleanFields:u,dateFormat:I,dateFullFormat:J,invalid:v,getCount:w,humanizeFragment:x,getResData:y,createEnum:z,createLocalId:A,getId:B,checkIfModulesExist:C}}]),angular.module("c8y.core").factory("c8yBinary",["$q","$upload","$http","c8yBase","c8yInventory","info",function(a,b,c,d,e,f){"use strict";function g(a){var b=d.url(C),e=d.pageSizeFilter(a),f={params:e},h=!0,i=d.cleanListCallback("managedObjects",g,e,h);return c.get(b,f).then(i)}function h(a){return b.upload({url:d.url(C),method:"POST",headers:d.contentHeaders("managedObject"),data:{object:{name:a.name,type:a.type},filesize:a.size},file:a})}function i(a){return m(a).then(function(a){var b=a.getResponseHeader("Content-Type"),c=a.getResponseHeader("Content-Disposition"),d=new Blob([a.response],{type:b});saveAs(d,j(c))})}function j(a){return/filename="(.*)"/.exec(a)[1]}function k(a){return m(a).then(function(a){var b=a.getResponseHeader("Content-Type"),c=l(a.response);return"data:"+b+";base64,"+c})}function l(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;d>e;e++)b+=String.fromCharCode(c[e]);return btoa(b)}function m(b){var c=a.defer(),d=n(b),e=new XMLHttpRequest;return e.open("GET",d,!0),e.responseType="arraybuffer",e.onload=function(a){200===e.status?c.resolve(e):c.reject(e)},e.onprogress=function(a){angular.isDefined(a.loaded)&&c.notify(a.loaded/s(b))},e.setRequestHeader("Authorization","Basic "+f.token),e.setRequestHeader("UseXBasic",!0),e.send(),c.promise}function n(a){var b=a.id||a;return d.url(C+"/"+b)}function o(a){return a&&a.self&&a.self.replace(d.url(D),d.url(C))}function p(a){var b=n(a);return c["delete"](b)}function q(a){var b=["file","o"],c=r(a);return c&&b.splice(1,0,c),b.join("-")}function r(a){var b="";return angular.forEach(G,function(c,d){var e=F.exec(a.name)[1];if(angular.forEach(c.exts,function(a){return a===e?(b=d,!1):void 0}),!b){var f=a._attachments[Object.keys(a._attachments)[0]].content_type;angular.forEach(c.mimes,function(a){return a===f?(b=d,!1):void 0})}}),b}function s(a){return a._attachments[Object.keys(a._attachments)[0]].length}function t(a){var b=r(a);return"image"===b}function u(a){return a&&a.size<=E}function v(a){return a.id?x(a):w(a)}function w(a){var b=angular.extend(a,{c8y_IsBinary:!0});return e.createConfirm(b)}function x(a){return e.update(a)}function y(a,b){return e.detail(a,b)}function z(a){return e.remove(a)}function A(a){return a&&a.dataType&&a.data?"data:"+a.dataType+";base64,"+a.data:""}function B(a){var b=new RegExp("\\/inventory\\/binaries\\/(\\d+)|\\/inventory\\/managedObjects\\/(\\d+)"),c=a.match(b);return c&&(c[1]||c[2])}var C="inventory/binaries",D="inventory/managedObjects",E=52428800,F=/(?:\.([^.]+))?$/,G={archive:{mimes:[],exts:["7z","apk","cab","gz","iso","jar","rar","tar","zip"]},audio:{mimes:[],exts:["3gp","aiff","aac","amr","m4a","m4p","mp3","oga","ogg","raw","wav","wma"]},code:{mimes:[],exts:["aspx","exe","htm","html","jad","js","json","jsp","php","xml"]},excel:{mimes:[],exts:["xls","xlsx"]},image:{mimes:[],exts:["bmp","gif","jpeg","jpg","png","tiff"]},pdf:{mimes:[],exts:["pdf"]},powerpoint:{mimes:[],exts:["ppt","pptx"]},text:{mimes:[],exts:["txt"]},video:{mimes:[],exts:["3gp","asf","avi","flv","mov","mp4","ogv","qt","rm","rmvb","wmv"]},word:{mimes:[],exts:["doc","docx"]}};return angular.extend(angular.copy(e),{BYTES_SIZE_LIMIT:E,list:g,upload:h,downloadAndSaveAs:i,downloadAsDataUri:k,getDownloadUrl:o,removeBinary:p,icon:q,size:s,isImage:t,hasValidSize:u,getIdFromUrl:B,save:v,detail:y,remove:z,getDataUri:A})}]),angular.module("c8y.core").factory("c8yCepModule",["$http","$q","$timeout","c8yBase","c8yCepModuleExamples",function(a,b,c,d,e){"use strict";function f(a){var b="--"+g(),c=b+'\r\nContent-Disposition: form-data; name="file"; filename="module.cep"\r\nContent-Type: text/plain\r\n\r\n'+a+"\r\n"+b;return c}function g(){return"83ff53821b7c"}function h(b){var c=d.url(w+"/"+b.id),e={headers:d.contentHeaders(x,!0)},f={status:b.status};if(!b.id)throw new Error("Module id no defined");return a.put(c,f,e)}function i(b){var c=b.id,e=d.url(w+(c?"/"+c:"")),h=f(b.body),i=c?"put":"post",j=angular.extend(d.contentHeaders(x,!0),{"Content-Type":"multipart/form-data; boundary="+g()}),k={headers:j};return a[i](e,h,k)}function j(b){var c=d.url(w),e=d.pageSizeFilter(b),f={params:e},g=d.cleanListCallback("modules",j,e);return a.get(c,f).then(k).then(g)}function k(a){return a.data.modules=_.filter(a.data.modules,function(a){return!l(a)}),a}function l(a){return a&&/^smartRule\d+$/.test(a.name)}function m(b){var c=d.url(w),e=d.pageSizeFilter(b),f={params:e},g=d.cleanListCallback("modules",m,e);return a.get(c,f).then(g)}function n(c){var e=c.id||c,f=d.url(w+"/"+e),g=b.defer(),h=null,i=null,j={headers:{"Content-Type":"text/plain",Accept:"text/plain"}},k={headers:{Accept:d.mimeType(x)}},l=function(){if(h&&i){var a=/module (\w*);\s*\n*/;i.name=h.match(a)[1],i.body=h.replace(a,""),g.resolve(i)}};return a.get(f,k).then(function(b){i=b.data,a.get(f,j).success(function(a){h=a,l()})}),g.promise}function o(b){var c=b.id||b,e=d.url(w+"/"+c);return a["delete"](e)}function p(a){var c,d=b.defer(),e=angular.copy(a);return e.body?(e.name&&(e.body="module "+e.name+";\n"+e.body),c=i(e).then(null,function(a){d.reject(a)})):c=n(e),c.then(function(a){var b=a.body?a:a.data;e.status&&b.status!==e.status?(b.status=e.status,h(b).then(function(a){d.resolve(a.data)},function(a){d.reject(a.data)})):d.resolve(b)}),d.promise}function q(a){return j().then(function(c){var d;return c.forEach(function(b){return b.name===a?(d=b,!1):void 0}),d||b.reject("not found")})}function r(a){var b=a.name;return y[b]||(y[b]=q(b).then(function(a){return"DEPLOYED"!==a.status?(a.status="DEPLOYED",p(a)):a},function(){return p(a)})),y[b]}function s(a){return a.status="DEPLOYED",p(a)}function t(a){return u(a).then(s)}function u(a){return a.status="NOT_DEPLOYED",p(a)}function v(){return b.when(e)}var w="cep/modules",x="cepModule",y={};return{list:j,listWithSmartRules:m,isSmartRuleModule:l,detail:n,save:p,remove:o,examples:v,detailByName:q,createOrDeploy:r,deploy:s,redeploy:t,undeploy:u}}]).value("c8yCepModuleExamples",[{name:"Send alarms that are active since 30 minutes to email",value:'insert into SendEmail\nselect\n  "info@cumulocity.com" as sender,\n  "YOUR_EMAIL_HERE" as receiver,\n  "Alarm active since 30 mins: " || e.alarm.text as subject,\n  "Time: " || e.alarm.time.format() || \n  " Severity: " || e.alarm.severity.name() || \n  " Source: " || findManagedObjectById(e.alarm.source.value).getName() as text\nfrom pattern [\n   every e = AlarmCreated(alarm.status = CumulocityAlarmStatuses.ACTIVE, alarm.severity = CumulocitySeverities.CRITICAL) \n   -> (timer:interval(30 minutes) \n      and not AlarmUpdated(alarm.status != CumulocityAlarmStatuses.ACTIVE, alarm.id.value = e.alarm.id.value))\n];'},{name:"Select temperature readings over 100 degree",value:'select * from MeasurementCreated e\nwhere getNumber(e, "c8y_TemperatureMeasurement.T.value") > 100'},{name:"Create alarm when temperature over 100 degree",value:'insert into CreateAlarm \n  select\n    e.measurement.time as time,\n    e.measurement.source.value as source,\n    "com_cumulocity_TemperatureAlert" as type,\n    "Temperature too high" as text,\n    "ACTIVE" as status,\n    "CRITICAL" as severity\n  from MeasurementCreated e\n  where getNumber(e, "c8y_TemperatureMeasurement.T.value") > 100'},{name:"Create alarm when temperature below 0 degree",value:'insert into CreateAlarm \n  select\n    e.measurement.time as time,\n    e.measurement.source.value as source,\n    "com_cumulocity_TemperatureAlert" as type,\n    "Temperature too low" as text,\n    "ACTIVE" as status,\n    "CRITICAL" as severity\n  from MeasurementCreated e\n  where getNumber(e, "c8y_TemperatureMeasurement.T.value") < 0'},{name:"Create close relay operation when temperature readings over 100 degree",value:'insert into CreateOperation\n  select\n    "PENDING" as status,\n    «heating ID» as deviceId,\n    {\n      "c8y_Relay.relayState", "CLOSED"\n    } as fragments\n  from MeasurementCreated e\n  where getNumber(e, "c8y_TemperatureMeasurement.T.value") > 100'},{name:"Schedule device restart every day at 1am",value:'insert into CreateOperation\nselect\n  "PENDING" as status,\n  «device ID» as deviceId,\n  { "c8y_Restart", {} } as fragments\nfrom pattern [every timer:at(*, 1, *, *, *, *)];'},{name:"Select location change event once for 60 seconds",value:'select * from EventCreated e\nwhere getObject(e, "c8y_LocationMeasurement") is not null\noutput first every 60 seconds'},{name:"Display current temperature on device",value:'expression string js:prepareText(temp) [\n  function format(text, params){\n    for(param in params) {\n        text = text.replace("{" + param + "}", params[param])\n    }\n    return text\n  }\n  format("Current temperature is {0}", [temp])\n]\ninsert into CreateOperation\n	select\n      "PENDING" as status,\n      e.measurement.source.value as deviceId,\n      { "c8yDisplay", prepareText(\n        getNumber(e, "c8y_TemperatureMeasurement.T.value")\n	   ) } as fragments\n    from MeasurementCreated e\n    where e.measurement.type = "c8y_TemperatureMeasurement";'},{name:"Change the severities of alarms based on activity time",value:'/* Create "context" - definition of a group of events to be processed separately.\n * Context "Alarms" consists of AlarmCreated and AlarmUpdated: \n * with the same source and type = "power off". */\ncreate context Alarms partition by \nalarm.source from AlarmCreated(alarm.type = "power off"),\nalarm.source from AlarmUpdated(alarm.type = "power off");\n\n/* Update severity for all active AlarmCreated \n * after which there is no change to other status in 15 minutes. */\ncontext Alarms \ninsert into UpdateAlarm \nselect \n   a.alarm.id as id,\n   "MAJOR" as severity\nfrom pattern [\n   every a = AlarmCreated(alarm.status = CumulocityAlarmStatuses.ACTIVE) \n   -> (timer:interval(15 minutes) \n      and not AlarmUpdated(alarm.status != CumulocityAlarmStatuses.ACTIVE))\n];'},{name:"Create alarm if temperature was to low for 15 minutes",value:'create schema NotZeroMeasurementCreated (\n  measurement Measurement\n);\ncreate schema ZeroMeasurementCreated (\n  measurement Measurement\n);\ncreate schema CheckTimeDifference (\n  firstMeasurement Measurement,\n  lastMeasurement Measurement\n);\ninsert into CreateAlarm\n  select\n    check.lastMeasurement.source as source,\n    check.lastMeasurement.time as time,\n    "c8y_LowTemperatureAlarm" as type,\n    CumulocitySeverities.WARNING as severity,\n    CumulocityAlarmStatuses.ACTIVE as status,\n    "Temperature was too low for more than 15 minutes" as text\n  from CheckTimeDifference check\n  where check.lastMeasurement.time.after(check.firstMeasurement.time, 15min);\ninsert into CheckTimeDifference\n  select\n    firstM.measurement as firstMeasurement,\n    lastM.measurement as lastMeasurement\n  from pattern [\n    every (firstM = NotZeroMeasurementCreated ->\n    ZeroMeasurementCreated(measurement.source.value =firstM.measurement.source.value)) ->\n    ZeroMeasurementCreated until lastM = NotZeroMeasurementCreated(measurement.source.value = firstM.measurement.source.value)\n  ];\ninsert into NotZeroMeasurementCreated\n  select\n    m.measurement as measurement\n  from\n    MeasurementCreated m\n  where getNumber(m, "c8y_TemperatureMeasurement.T.value") > 0\n  AND m.measurement.type = "c8y_TemperatureMeasurement";\ninsert into ZeroMeasurementCreated\n  select\n    m.measurement as measurement\n  from\n    MeasurementCreated m\n  where getNumber(m, "c8y_TemperatureMeasurement.T.value") <= 0\n  AND m.measurement.type = "c8y_TemperatureMeasurement";'},{name:"Send simulator temperature to Zapier",value:'@Name("simulatortemperature")\nselect\n  e.measurement.source.value as id,\n  findManagedObjectById(e.measurement.source.value).getName() as name,\n  e.measurement.time.format() as time,\n  getNumber(e, "c8y_TemperatureMeasurement.T.value") as value,\nfrom MeasurementCreated e\n  where e.measurement.type = "TemperatureMeasurement"\n'},{name:"Send sales to Zapier",value:'@Name("sales")\nselect\n  getString(e, "com_nsn_startups_vendme_fragments_SalesReportInfo.vendingMachine_name") as id,\n  getString(e, "com_nsn_startups_vendme_fragments_SalesReportInfo.product_name") as name,\n  e.event.time.format() as time,\n  getNumber(e, "com_nsn_startups_vendme_fragments_SalesReportInfo.totalPaid") as value,\n  getString(e, "com_nsn_startups_vendme_fragments_SalesReportInfo.payment_type") as text\nfrom EventCreated e\n  where e.event.type = "com_nsn_startups_vendme_LiveSalesReport"\n'}]),function(){"use strict";function a(a,b,c){function d(a){function b(a){d.properties=[a],d.filterFn=function(b,c){return _.isEqual(b,c[a])},d.dependencies=[a]}function c(a){var b=a.length,c=_.last(a);return _.isArray(c)?(d.dependencies=c,d.filterFn=a[b-2],d.properties=a.slice(0,length-2),_.isFunction(d.filterFn)&&_.every(d.properties,String)):_.isFunction(c)?(d.dependencies=_.initial(a),d.filterFn=c,d.properties=d.dependencies,_.every(d.properties,String)):!1}a=_.cloneDeep(a);var d=this;if(this.properties=null,this.filterFn=null,this.dependencies=null,_.isArray(a)){if(!c(a))throw new Error("property map is not valid")}else{if(!_.isString(a))throw new Error("parameter is invalid");b(a)}}function e(a,b){function c(){a=_.pick(a,function(a){return void 0!==a})}function e(){_.forEach(_.keys(a),function(a){var b=_.any(g.propertyMapList,function(b){return _.any(b.properties,function(b){return b===a})});b||g.propertyMapList.push(new d(a))})}function f(){var a=_.reduce(g.propertyMapList,function(a,b){return _.forEach(b.dependencies,function(b){a[b]=!0}),a},{});a.id=!0,g.pickList=_.keys(a)}var g=this;this.pickList=null,this.queryParams=a,this.propertyMapList=b&&_.map(b,function(a){return new d(a)})||[],c(),e(),f()}function f(d,f){function g(){if(f){var b=c.realtimeActions();return _.forEach(b,function(a){c.addListener(t.__realtimeId,f,a,i)}),a.when(c.start(t.__realtimeId,f))}}function h(){f&&c.removeSubscriber(t.__realtimeId,f)}function i(a,b){if(!u){var c=t.count;z[a.name](b),m();var d=t.count;r&&d!==c&&r(d,c)}}function j(a){v?o(a)&&p.unshift(n(a)):q+=1}function k(a){if(v){var b=_.findIndex(p,{id:a.id});-1===b&&o(a)?p.unshift(n(a)):-1===b||o(a)||p.splice(b,1)}}function l(a){if(v){var b=_.findIndex(p,{id:a.id});-1!==b&&p.splice(b,1)}else q-=1}function m(){t.count=p&&p.length||q||0}function n(a){return _.pick(a,s.pickList)}function o(a){return s.matches(a)}if(!_.isFunction(d))throw new Error("list function must be provided");var p,q,r,s,t=this,u=!1,v=!1,w={pageSize:1},x=!1,y=!1,z={CREATE:j,UPDATE:k,DELETE:l};b.createLocalId(this,"__realtimeId"),this.start=function(){if(x)throw new Error("Cannot restart a counter instance, please create a new instance");return x=!0,this.refresh().then(g)},this.stop=function(){if(!x)throw new Error("Cannot stop counter instance without starting it first");if(y)throw new Error("Cannot stop an already stopped counter instance");y=!0,h()},this.onNotification=function(a){r=a},this.refresh=function(){u=!0;var b=v?s.queryParams:w;return a.when(d(b)).then(function(a){v?p=_.chain(a).filter(o).map(n).value():q=a.statistics.totalPages,m(),u=!1})},this.filter=function(a,b){if(!a&&!b)return w;if(v)throw new Error("filter can be set only once");v=!0,s=new e(a,b)}}d.prototype.matches=function(a,b){a=_.cloneDeep(a),_.forEach(this.properties,function(b){a[b]=a[b]||void 0});var c=_.values(_.pick(a,this.properties));return c.push(b),this.filterFn.apply(this,c)},e.prototype.matches=function(a){var b=this;return _.every(this.propertyMapList,function(c){return c.matches(b.queryParams,a)})};var g=["dateFrom","dateTo",function(a,b,c){var d=c&&(c.date||c.time);return d?a&&moment(a).isAfter(d)?!1:b&&moment(b).isBefore(d)?!1:!0:!1},["date","time"]],h=["source",function(a,b){return(b&&b.source&&b.source.id)===a},["source"]],i={date:g,source:h};return{Counter:f,defaultPropertyMaps:i}}angular.module("c8y.core").factory("c8yCounter",["$q","c8yBase","c8yRealtime",a])}(),angular.module("c8y.core").factory("c8yDeviceControl",["$http","$rootScope","$q","c8yBase","c8yRealtime",function(a,b,c,d,e){"use strict";function f(a){var b=a.id||a;return d.url(u+"/"+b)}function g(b){var c=d.url(u),e=d.pageSizeNoTotalFilter(b),f={params:e},h=d.cleanListCallback("operations",g,e);return a.get(c,f).then(h)}function h(a){var b=c.defer(),d=angular.extend(a||{},{pageSize:1e3}),e=!1,f=function(a){var c=angular.isDefined(a.paging.next)&&!(a.length<d.pageSize);return b.notify(a),c||b.resolve(!0),e?!0:c?a.paging.next().then(f):!0};return angular.extend(b.promise,{cancel:function(){e=!0,b.reject("canceled")}}),g(d).then(f),b.promise}function i(b){var c=f(b);return a.get(c)}function j(b){var c=d.url(u),e=t(b,z),f=angular.copy(w);if(!e.deviceId)throw new Error("c8yDeviceControl: data must have a deviceId property");return a.post(c,e,f).then(k)["finally"](function(a){return D.$emit("create"),a})}function k(a){var b=new RegExp(v),c=a.headers("Location").match(b);return parseInt(c[1],10)}function l(a){var b=j(a),d=b.then(function(b){a.id=b;var d=c.defer(),f="operation"+a.id,g="/operations/"+a.deviceId;return e.addListener(f,g,"UPDATE",function(b,c){c.id==a.id&&(c.status===x.SUCCESSFUL||c.status===x.FAILED?(e.stop(f,g),d.resolve(c)):d.notify(c))}),e.start(f,g),d.promise});return c.when({created:b,completed:d})}function m(b){var c=d.url(u)+"/"+b.id,e=t(b,z.concat(A)),f=angular.copy(w);return a.put(c,e,f)["finally"](function(){D.$emit("update")})}function n(a){return a.status=x.FAILED,a.failureReason="Operation cancelled by user.",m(a)}function o(a){return a.id?m(a):j(a)}function p(a){var b=angular.isString(a)?a:a.status;return C[b.toUpperCase()]}function q(a){return-1!==B.indexOf(a)}function r(a){return!q(a)}function s(a){var b=angular.copy(a),c=Object.keys(b);return c.filter(r)}var t=d.cleanFields,u="devicecontrol/operations",v="\\/devicecontrol\\/operations\\/(\\d+)",w={headers:d.contentHeaders("operation")},x={PENDING:"PENDING",SUCCESSFUL:"SUCCESSFUL",EXECUTING:"EXECUTING",FAILED:"FAILED"},y=Object.keys(x),z=["creationTime","deviceExternalIDs","id","self"],A=["deviceId"],B=z.concat(["deviceId"]),C={},D=b.$new(!0);return C[x.PENDING]={icon:"clock-o",cls:"text-muted"},C[x.EXECUTING]={icon:"refresh",cls:"text-info"},C[x.SUCCESSFUL]={icon:"check-circle",cls:"text-success"},C[x.FAILED]={icon:"times-circle",cls:"text-danger"},{list:g,listPaged:h,detail:i,create:j,createWithNotifications:l,update:m,cancel:n,save:o,status:x,statusList:y,getStyle:p,getKeys:s,events:D}}]),angular.module("c8y.core").factory("c8yEvents",["$http","c8yBase","c8yCounter",function(a,b,c){"use strict";function d(a){var c=a.id||a;return b.url(o+"/"+c)}function e(c){var d=b.url(o),f={params:b.timeOrderFilter(b.pageSizeNoTotalFilter(c))},g=b.cleanListCallback("events",e,f.params);return a.get(d,f).then(g)}function f(b){var c=d(b);return a.get(c)}function g(c){var d=b.url(o),e=n(c,q),f=angular.copy(p);return a.post(d,e,f)}function h(b){var c=d(b),e=n(b,q),f=angular.copy(p);
return a.put(c,e,f)}function i(a){return a.id?h(a):g(a)}function j(a){return-1!==q.indexOf(a)}function k(a){return!j(a)}function l(a){var b=angular.copy(a),c=Object.keys(b);return c.filter(k)}function m(a){var b=new c.Counter(e,"/events/*"),d=[c.defaultPropertyMaps.date,c.defaultPropertyMaps.source];if(a.type){var f=a.type;d.push([function(a){return f===a.type}])}return delete a.type,b.filter(a,d),b}var n=b.cleanFields,o="event/events",p={headers:b.contentHeaders("event")},q=["creationTime","id","self","source","text","time"];return{list:e,detail:f,create:g,update:h,save:i,reservedKeys:q,getKeys:l,createCounter:m}}]),angular.module("c8y.core").factory("c8yDeviceGroup",["c8yManagedObject",function(a){"use strict";function b(a){return!!a.childAssets.references.length}var c={},d="c8y_DeviceGroup";return c.list=function(b){var c={type:d,pageSize:1e4};return angular.isObject(b)&&(c=angular.extend(c,b)),a.list(c)},c.detail=function(b){return a.detail(b)},c.create=function(b){return b.type=d,a.create(b)},c.remove=function(c){return b(c)?!1:a.remove(c)},c.addDevice=function(b,c){return c.c8y_Groups=angular.isArray(c.c8y_Groups)?c.c8y_Groups:[],c.c8y_Groups.push({name:b.name,id:b.id}),a.update(c.id,{c8y_Groups:c.c8y_Groups}),a.addChildAsset(b,c)},c.removeDevice=function(b,c){return c.c8y_Groups=c.c8y_Groups.filter(function(a){return a.id!==b.id}),a.update(c.id,{c8y_Groups:c.c8y_Groups}),a.removeChildAsset(b,c)},c}]),angular.module("c8y.core").factory("c8yDeviceRegistration",["$http","c8yBase",function(a,b){"use strict";function c(a){var c=a.id||a;return b.url(p+"/"+c)}function d(c){var e=b.url(p),f=b.pageSizeFilter(c),g={params:f},h=b.cleanListCallback("newDeviceRequests",d,f);return a.get(e,g).then(h)}function e(b){var d=c(b);return a.get(d)}function f(c){var d=b.url(p),e=o(c,t),f=angular.copy(q);if(!e.id)throw new Error("c8yDeviceRegistration: data must have an id property");return a.post(d,e,f)}function g(b){var d=c(b),e={status:r.ACCEPTED},f=angular.copy(q);return a.put(d,e,f)}function h(b){var d=c(b);return a["delete"](d)}function i(a){var b=a.status||"UNKNOWN";return v[b.toUpperCase()]}function j(a){return i(a).icon}function k(a){return i(a).cls}function l(a){return-1!==u.indexOf(a)}function m(a){return!l(a)}function n(a){var b=angular.copy(a),c=Object.keys(b);return c.filter(m)}var o=b.cleanFields,p="devicecontrol/newDeviceRequests",q={headers:b.contentHeaders("newDeviceRequest")},r={WAITING_FOR_CONNECTION:"WAITING_FOR_CONNECTION",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",ACCEPTED:"ACCEPTED"},s=Object.keys(r),t=[],u=[],v={};return v[r.WAITING_FOR_CONNECTION]={icon:"unlink",cls:"text-danger"},v[r.PENDING_ACCEPTANCE]={icon:"circle",cls:"text-info"},v[r.ACCEPTED]={icon:"check-circle",cls:"text-success"},{list:d,detail:e,create:f,accept:g,cancel:h,status:r,statusList:s,getStyle:i,getKeys:n,statusIcon:j,statusClass:k}}]),angular.module("c8y.core").factory("c8yDevices",["$cacheFactory","$filter","c8yInventory","c8yUser",function(a,b,c,d){"use strict";function e(a){return angular.extend({skipChildrenNames:!0,fragmentType:E},a||{})}function f(a){var b=a.filter(function(a){return a[E]});return b.statistics=a.statistics,b.paging=a.paging,b}function g(a){var b=e(a),d=c.list(b);return b.text&&(d=d.then(f)),d}function h(a){var b=angular.copy(a);b[E]=!0,c.create(b)}function i(a){return a.id?t(a):h(a)}function j(a,b){var c=a&&a.c8y_SupportedOperations,d=angular.isArray(c)&&c.indexOf(b)>-1;return!!d}function k(a){var b=[];return angular.isArray(a.c8y_SupportedOperations)&&(b=a.c8y_SupportedOperations),b}function l(a){return"com_nsn_startups_vendme_VendingMachine"===a.type}function m(a){var b=a&&a.c8y_RequiredAvailability,c=a&&a.c8y_Availability,d=c&&c.status||(b?"UNKNOWN":"NOT_MONITORED");return d}function n(a){return F[m(a)].icon}function o(a){return F[m(a)].cls}function p(a){return G[s(a)].color}function q(a){return G[s(a)].icon}function r(a){return G[s(a)].tooltipText}function s(a){if(a.c8y_Availability&&a.c8y_Availability.lastMessage&&a.c8y_RequiredAvailability&&a.c8y_RequiredAvailability.responseInterval){var b=6e4,c=moment().valueOf(),d=moment(a.c8y_Availability.lastMessage).valueOf(),e=a.c8y_RequiredAvailability.responseInterval*b;return c-d-e>0}return null}function t(a){return u(a),c.update(a)}function u(a){var b=a&&a.id||a;H.cache&&delete H.cache[b]}function v(a,b){var d=angular.extend(b||{},{withParents:!0});return c.detail(a,d)}function w(a){var b=e(a);return c.getCount(b)}function x(a){return angular.isDefined(a[E])}function y(a){var b=l(a)?"com_nsn_startups_vendme_fragments_VendingMachineTypeInfo":"c8y_Hardware",c=a&&a[b];return c&&c.model}function z(a){var b=l(a)?"com_nsn_startups_vendme_fragments_VendingMachineTypeInfo":"c8y_Hardware",c=l(a)?"serial":"serialNumber",d=a&&a[b];return d&&d[c]}function A(a){var c=a.c8y_Availability,d=c&&b("relativeDateShort")(c.lastMessage);return d?"Last Message: "+d:"Connection not monitored"}function B(a){return v(a).then(function(a){var b=a.data,c=b.owner,e=b.c8y_IsDevice&&c&&c.match(/^device_/);return e=!1,e?d.detail(c).then(function(a){var b=a.data,c=d.groups(b),e=_.find(c,{name:"devices"});return e?d.remove(b):d}):b}).then(function(){c.remove(a)})}function C(a){return a?a.name?a.name:a.id?""+a.id:"<Device has no name>":void 0}function D(a){var b={id:a.id,c8y_RequiredAvailability:{}};return 0!=a.c8y_RequiredAvailability.responseInterval&&(b.c8y_RequiredAvailability.responseInterval=-a.c8y_RequiredAvailability.responseInterval),c.update(b)}var E="c8y_IsDevice",F={CONNECTED:{icon:"exchange",cls:"statusOk"},AVAILABLE:{icon:"check-circle",cls:"statusOk"},MAINTENANCE:{icon:"wrench",cls:"statusAlert"},UNAVAILABLE:{icon:"exclamation-circle",cls:"statusNok"},UNKNOWN:{icon:"circle",cls:"statusUnknown"},NOT_MONITORED:{icon:"circle",cls:"statusUnknown"}},G={"true":{icon:"check-circle",color:"green",tooltipText:"Valid"},"false":{icon:"exclamation-circle",color:"red",tooltipText:"Invalid"},"null":{icon:"circle",color:"#f3f3f3",tooltipText:"Unknown"}},H=_.memoize(v,function(a){return a&&(a.id||a)});return angular.extend(angular.copy(c),{list:g,save:i,update:t,detail:v,detailCached:H,create:h,removeWithUser:B,supportsOperation:j,getSupportedOperations:k,isVendme:l,statusIcon:n,statusClass:o,parseAvailability:m,getCount:w,isDevice:x,model:y,serial:z,availabilityTooltip:A,properName:C,switchResponseInterval:D,isLastValidMessage:s,lastValidMessageColor:p,lastValidMessageTooltip:r,lastValidMessageIcon:q})}]),angular.module("c8y.core").factory("c8yGeo",["$http",function(a){"use strict";function b(b){return a.jsonp(d,{params:{format:"json",q:b}})}function c(){return this.points=[],this}var d="//open.mapquestapi.com/nominatim/v1/search.php?json_callback=JSON_CALLBACK";return c.prototype.add=function(a){this.points.push(a)},c.prototype.reset=function(){this.points.length=0},c.prototype.get=function(){var a={southWest:{},northEast:{}};return this.points.length||(a=null),this.points.forEach(function(b){b.lat<(a.southWest.lat||1/0)&&(a.southWest.lat=b.lat),b.lng<(a.southWest.lng||1/0)&&(a.southWest.lng=b.lng),b.lat>(a.northEast.lat||-(1/0))&&(a.northEast.lat=b.lat),b.lng>(a.northEast.lng||-(1/0))&&(a.northEast.lng=b.lng)}),a},{geoCode:b,Bounds:c}}]),angular.module("c8y.core").factory("c8yGroupTypesConfig",["c8yInventory","$q",function(a,b){"use strict";function c(b){return b.type=m,a.save(b)}function d(){return a.list(n).then(e)}function e(a){return a.length>0?a[0]:f()}function f(){return{type:m,groups:g()}}function g(){return[j()]}function h(a){var c=a?b.when(a):d();return c.then(_.partial(i,{}))}function i(a,b){return a=a||{},_.forEach(b.groups||{},function(b){a[b.type]=b,a=i(a,b)}),a}function j(){return{type:"c8y_DeviceGroup",name:"Default Group",namePlural:"Default Groups",showInNavigator:!0,groups:[]}}function k(){return{type:"c8y_DeviceSubgroup",name:"Default Subgroup",namePlural:"Default Subgroups",showInNavigator:!1,groups:[]}}function l(){return{name:"",namePlural:"",type:"",showInNavigator:!1,groups:[]}}var m="c8y_GroupTypesConfig",n={type:m,pageSize:1};return{save:c,get:d,getLookup:h,getDeviceGroupType:j,getDeviceSubgroupType:k,getEmptyGroupType:l}}]),angular.module("c8y.core").factory("c8yGroups",["$q","c8yBase","c8yInventory","c8yGroupTypesConfig",function(a,b,c,d){"use strict";function e(d){return c.detail(d).then(b.getResData).then(f).then(function(b){return b.length>0?c.list({ids:b.join(","),pageSize:b.length}):a.when([])})}function f(b){var c=[];return c=c.concat(b.childAssets.references.map(g)),c=c.concat(b.childDevices.references.map(g)),a.when(c)}function g(a){return a.managedObject.id}function h(a){return d.getLookup().then(function(b){return[b[a]]}).then(k)}function i(){return j().then(k)}function j(){return d.get().then(function(a){return a.groups})}function k(b){if(b.length>0){var d=[];return _.forEach(b,function(a){d.push(c.list({type:a.type}))}),a.all(d).then(_.flatten)}return a.when([])}function l(a){return!!a.c8y_IsDeviceGroup||"c8y_DeviceGroup"===a.type}return{getGroupItems:e,getGroupTypeItems:h,getTopLevelGroups:i,isGroup:l}}]),angular.module("c8y.core").factory("c8yIdentity",["$http","c8yBase",function(a,b){"use strict";function c(a){return a.data.externalIds}function d(a){return b.url(j)+"/globalIds/"+(a.id||a)+"/externalIds"}function e(a){return b.url(j)+"/externalIds/"+a.type+"/"+a.externalId}function f(b,c){var e=d(b),f=angular.copy(k);return a.post(e,c,f)}function g(b){var c=e(b);return a["delete"](c)}function h(b){var e=d(b);return a.get(e).then(c)}function i(b){var c=e(b);return a.get(c)}var j="identity",k={headers:b.contentHeaders("externalId")};return{createIdentity:f,deleteIdentity:g,listExternalIds:h,getExternalId:i}}]),angular.module("c8y.core").factory("c8yInventory",["$http","$q","c8yBase","c8yRealtime",function(a,b,c,d){"use strict";function e(a){var b=a&&(a.id||a);return b&&c.url(N+"/"+b)}function f(a,b){return e(a)+"/"+b}function g(a,b,c){var d=b.id||b;return f(a,c)+"/"+d}function h(a){var b=a||{},c=["text","pageSize","currentPage","skipChildrenNames"];return b.text&&Object.keys(b).forEach(function(a){-1===c.indexOf(a)&&delete b[a]}),b}function i(b){var d=c.url(N),e=c.pageSizeFilter(h(b)),f={params:e},g=!0,j=c.cleanListCallback("managedObjects",i,e,g);return a.get(d,f).then(j)}function j(c,d){var f=e(c),g=d||{},h={params:g};return f?a.get(f,h):b.reject("Managed object not valid")}function k(a){return j(a)}function l(a,b){function c(a,b){e(b)}function e(a){f?angular.extend(f,a):f=a}var f,g=a.id||a,h=b.$id,i="/managedobjects/"+g,k=d.realtimeActions().UPDATE;return d.addListener(h,i,k,c),d.start(h,i),b.$on("stopRealtime",function(){d.stop(h,i)}),b.$on("$destroy",function(){d.stop(h,i)}),j(g).then(function(a){return e(a.data),f})}function m(b){var c=e(b);return a["delete"](c)}function n(b){var d=c.url(N),e=angular.copy(P),f=c.cleanFields(b,R);return a.post(d,f,e)}function o(a){return n(a).then(p).then(j)}function p(a){var b=new RegExp(O),c=a.headers("Location").match(b);return c[1]}function q(b){var d=e(b),f=angular.copy(P),g=c.cleanFields(b,R);return I(b),a.put(d,g,f)}function r(a){return a.id?q(a):n(a)}function s(b,c,d){var e=f(b,c),g=d||{};return k(b).then(function(a){return a.data[c].references.length}).then(function(b){return g.params={pageSize:b},a.get(e,g)})}function t(a){var b=a.data;return b.references.map(function(a){return a.managedObject})}function u(a,b){return s(a,"childDevices",b).then(t)}function v(a,b){return s(a,"childAssets",b).then(t)}function w(b,c,d){var e=f(b,d),g={managedObject:c},h=angular.copy(Q);return a.post(e,g,h)}function x(a,b,c,d){return j(a,{withParents:!0}).then(function(a){return a.data[b+"Parents"].references.map(function(a){return a.managedObject.id})}).then(function(a){var b=[];return a.length&&(b=i({ids:a.join(",")}),(c||d)&&(b=b.then(function(a){return a.filter(function(a){return c&&a.type===c||d&&angular.isDefined(a[d])})}))),b})}function y(a,b,c){return x(a,"device",b,c)}function z(a,b,c){return x(a,"asset",b,c)}function A(a,b,c){return C(a,"asset",b,c)}function B(a,b,c){return C(a,"device",b,c)}function C(a,b,c,d){var e="child"+b.charAt(0).toUpperCase()+b.slice(1)+"Id",f={withParents:!0};return f[e]=a.id,i(f).then(function(a){return(c||d)&&(a=a.filter(function(a){return c&&a.type===c||d&&angular.isDefined(a[d])})),a})}function D(a,b){return w(a,b,"childDevices")}function E(a,b){return w(a,b,"childAssets")}function F(b,c,d){var e=g(b,c,d);return a["delete"](e)}function G(a,b){return F(a,b,"childDevices")}function H(a,b){return F(a,b,"childAssets")}function I(a){var b=a&&a.id||a;delete S.cache[b]}function J(a){return c.getCount(i,a||{})}function K(b){var c=e(b)+"/supportedMeasurements";return a.get(c).then(function(a){return a.data.c8y_SupportedMeasurements})}function L(a,b){var c;K(a).then(function(a){return c=angular.isArray(a)&&a.indexOf(b)>-1,!!c})}function M(a){return Object.keys(c.cleanFields(a,_.union(R,["id","type","name","owner","self"])))}var N="inventory/managedObjects",O="\\/inventory\\/managedObjects\\/(\\d+)",P={headers:c.contentHeaders("managedObject")},Q={headers:c.contentHeaders("managedObjectReference")},R=["lastUpdated","assetParents","deviceParents","childAssets","childDevices","c8y_ActiveAlarmsStatus","c8y_Availability"],S=_.memoize(k,_.identity);return{list:i,detail:j,detailCached:S,detailRealtime:l,create:n,createConfirm:o,update:q,save:r,remove:m,childAssets:v,childDevices:u,addChildAsset:E,addChildDevice:D,removeChildAsset:H,removeChildDevice:G,parentsAsset:z,parentsDevice:y,directParentAssets:A,directParentDevices:B,getCount:J,getSupportedMeasurements:K,supportsMeasurement:L,getFragments:M}}]),angular.module("c8y.core").factory("c8yMeasurements",["$http","$q","c8yBase","c8yCepModule",function(a,b,c,d){"use strict";function e(a){var b=a.id||a;return c.url(q)+"/"+b}function f(b){var d=t,e=c.url(q),g=c.todayFilter(angular.extend({pageSize:d},b||{})),h={params:g},i=c.cleanListCallback("measurements",f,g);return a.get(e,h).then(i)}function g(b){var d=t,e=c.url(q+"/series"),f=c.todayFilter(angular.extend({pageSize:d},b||{})),h={params:f},i=function(a){return a.data},j=_.findIndex(g._cacheFilter,_.partial(_.isEqual,f)),k=j>=0?g._cacheRequest[j]:null;return k||(k=a.get(e,h).then(i),g._cacheFilter.push(angular.copy(f)),g._cacheRequest.push(k)),k}function h(a){var c=b.defer(),d=angular.extend(a||{},{pageSize:1e3,withTotalPages:!0}),e=!1,g=function(a){var b=angular.isDefined(a.paging.next)&&!(a.length<d.pageSize);return c.notify(a),b||c.resolve(!0),e?!0:b?a.paging.next().then(g):!0};return angular.extend(c.promise,{cancel:function(){e=!0,c.reject("canceled")}}),f(d).then(g),c.promise}function i(a){var c=b.defer(),d=angular.extend(a||{},{pageSize:1e3,withTotalPages:!0}),e=!1,f=function(a){return c.notify(a),a.paging.next||c.resolve(!0),e?!0:a.paging.next?a.paging.next().then(f):!0};return angular.extend(c.promise,{cancel:function(){e=!0,c.reject("canceled")}}),g(d).then(f),c.promise}function j(b){var c=e(b);return a.get(c)}function k(b){var d=c.url(q),e=p(b),f=angular.copy(r);if(!e.source)throw new Error("c8yMeasurement: source must be defined");return a.post(d,e,f)}function l(b){var c=e(b),d=p(b),f=angular.copy(r);return a.put(c,d,f)}function m(a){return a.id?l(a):k(a)}function n(b){var c=e(b);return a["delete"](c)}function o(){return d.createOrDeploy(s)}var p=c.clean,q="measurement/measurements",r={headers:c.contentHeaders("measurement")},s={status:"DEPLOYED",name:"c8yui_measurements",body:'insert into SendNotification select measurement as payload, "c8yui/measurements" as channelName from MeasurementCreated;'},t=1440;return g._cacheFilter=[],g._cacheRequest=[],{list:f,listPaged:h,listSeries:g,listSeriesPaged:i,detail:j,create:k,update:l,save:m,remove:n,activateCep:o}}]),angular.module("c8y.core").factory("c8yNotifications",["$rootScope","$q","$timeout","c8yBase","info",function(a,b,c,d,e){"use strict";function f(){return c(function(){s.getTransport().abort()},y)}function g(a){var b=m(a);b.scope.$emit("connected"),b.scope.connected=!0,k()}function h(a,b){q&&(c.cancel(),q=f()),a.$emit("message",b),k()}function i(a){a.counter--,a.counter||(s.unsubscribe(a.comet),delete t[a.channel],Object.keys(t).length||j())}function j(){q&&(c.cancel(q),q=void 0),s.removeListener(r),s.disconnect()}function k(){a.$$phase||a.$apply()}function l(){var a=b.defer();if(s.isDisconnected()){s.handshake();var c=s.addListener("/meta/connect",function(){a.resolve(!0),s.removeListener(c)});r=s.addListener("/meta/subscribe",g)}else a.resolve(!0);return a.promise}function m(a){var b=Object.keys(t).filter(function(b){return a.subscription.match(b)});return t[b[0]]}function n(a){return t[a]}function o(b){var c=n(b)||{},d=!1;return c.channel||(d=!0,t[b]=c,c.channel=b,c.scope=a.$new(!0),c.scope.unsubscribe=angular.bind({},i,c),c.counter=0),c.counter++,l().then(function(){return d&&(c.comet=s.subscribe(b,angular.bind({},h,c.scope)),q=f()),c.scope})}function p(a){var b=angular.copy("debug"===a?z:x);s.configure(b)}var q,r,s=$.cometd,t={},u="cep/customnotifications",v="cep/notifications",w=d.url(u),x={url:w,logLevel:"info",requestHeaders:{Authorization:"Basic "+e.token,UseXBasic:!0},appendMessageTypeToURL:!1},y=57e4,z=angular.copy(x);return z.url=d.url(v),s.unregisterTransport("websocket"),s.registerExtension("acceptEmptyMessages",{incoming:function(a){void 0===a.successful&&void 0===a.data&&(a.data={message:"The output from statement was empty"})}}),s.configure(angular.copy(x)),{subscribe:o,configure:p}}]),angular.module("c8y.core").factory("c8ySettings",["$http","c8yBase",function(a,b){"use strict";function c(a){return b.url(l+"/"+a.category+(a.key?"/"+a.key:""))}function d(a){return b.url(m+"/"+a.category+(a.key?"/"+a.key:""))}function e(a){return b.url(n+"/"+a.category+(a.key?"/"+a.key:""))}function f(c){var d=b.url(l),e=b.pageSizeFilter(c),g={params:e},h=b.cleanListCallback("options",f,e),i=a.get(d,g).then(h);return c&&c.category&&(i=i.then(function(a){var b=a.filter(function(a){return a.category===c.category});return b.paging=a.paging,b})),i}function g(b){var d=c(b),e=angular.copy(b),f=angular.copy(o);return a.put(d,e,f)}function h(c){var d=b.url(l),e=angular.copy(c),f=angular.copy(o);return a.post(d,e,f)}function i(b){var d=c(b);return a["delete"](d)}function j(b){var e="password"===b.category?d(b):c(b);return a.get(e)}function k(b){var c=e(b);return a.get(c)}var l="tenant/options",m="tenant/security-options",n="tenant/system/options",o={headers:b.contentHeaders("option")};return{list:f,detail:j,updateOption:g,createOption:h,deleteOption:i,getSystemOption:k}}]),angular.module("c8y.core").factory("c8yStatement",["$http","$q","$timeout","c8yBase",function(a,b,c,d){"use strict";function e(a){return a=angular.copy(a),delete a.id,delete a.module,a}function f(a){return"default"===a.name}function g(a){return angular.isObject(a)?a.id:a}function h(a){return d.url(l+"/"+j.id+"/statements"+(a?"/"+g(a):""))}function i(c){return function(e){var g,h,i=b.defer();return i.promise.then(function(){c(e).success(g).error(h)}),j?i.resolve():a.get(d.url(l)).success(function(b){for(var c in b.modules){var e=b.modules[c];if(f(e))return j=e,void i.resolve()}a.post(d.url(l),{name:"default"},m()).success(function(a){j=a,i.resolve()})}),{then:function(a,b){g=a,h=b},success:function(a){return g=a,this},error:function(a){return h=a,this}}}}var j,k={},l="cep/modules",m=function(){return d.requestConfig("cepModule","cepModule")},n=function(){return d.requestConfig("cepStatement","cepStatement")},o=[{name:"select temperate readings over 100 degree",value:'select * from MeasurementCreated e\nwhere getNumber(e, "c8y_TemperatureMeasurement.T.value") > 100'},{name:"create alarm when temperature over 100 degree",value:'insert into CreateAlarm \n  select\n    e.measurement.time as time,\n    e.measurement.source.value as source,\n    "com_cumulocity_TemperatureAlert" as type,\n    "Temperature too high" as text,\n    "ACTIVE" as status,\n    "CRITICAL" as severity\n  from MeasurementCreated e\n  where getNumber(e, "c8y_TemperatureMeasurement.T.value") > 100'},{name:"create alarm when temperature below 0 degree",value:'insert into CreateAlarm \n  select\n    e.measurement.time as time,\n    e.measurement.source.value as source,\n    "com_cumulocity_TemperatureAlert" as type,\n    "Temperature too low" as text,\n    "ACTIVE" as status,\n    "CRITICAL" as severity\n  from MeasurementCreated e\n  where getNumber(e, "c8y_TemperatureMeasurement.T.value") > 100'},{name:"create close replay operation when temperature readings over 100 degree",value:'insert into CreateOperation\n  select\n    "PENDING" as status,\n    «heating ID» as deviceId\n    {\n      "c8y_Relay.relayState", "CLOSED"\n    } as fragments\n  from MeasurementCreated e\n  where getNumber(e, "c8y_TemperatureMeasurement.T.value") > 100'},{name:"select location change event once for 60 seconds",value:'select * from EventCreated e\nwhere getObject(e, "c8y_LocationMeasurement") is not null\noutput first every 60 seconds'},{name:"send email notification with current temperature",value:'expression string js:prepareEmailText(temp, state) [\n    function format(text, params){\n            for(param in params) {\n                text = text.replace("{" + param + "}", params[param])\n            }\n        return text\n    }\n    format("Hello,\\n current temperature is {0} (state = {1}). Regards.", [temp, state])\n]\ninsert into SendEmail\nselect\n  "sender@sender" as sender,\n  "receiver@receiver" as receiver,\n  "Temperature critical!" as subject,\n  prepareEmailText(\n    getNumber(e, "c8y_TemperatureMeasurement.T.value"),\n    getString(e, "c8y_TemperatureMeasurement.T.state")\n   ) as text\nfrom MeasurementCreated e'},{name:"change the severities of alarms based on activity time",value:'/* Create "context" - definition of a group of events to be processed separately.\n * Context "Alarms" consists of AlarmCreated and AlarmUpdated: \n * with the same source and type = "power off". */\ncreate context Alarms partition by \nalarm.source from AlarmCreated(alarm.type = "power off"),\nalarm.source from AlarmUpdated(alarm.type = "power off");\n\n/* Update severity for all active AlarmCreated \n * after which there is no change to other status in 15 minutes. */\ncontext Alarms \ninsert into UpdateAlarm \nselect \n   a.alarm.id as id,\n   "MAJOR" as severity\nfrom pattern [\n   every a = AlarmCreated(alarm.status = CumulocityAlarmStatuses.ACTIVE) \n   -> (timer:interval(15 minutes) \n      and not AlarmUpdated(alarm.status != CumulocityAlarmStatuses.ACTIVE))\n];'}];return k.list=i(function(b){return a.get(d.url(l+"/"+j.id+"/statements"),b)}),k.detail=i(function(b){return a.get(h(b))}),k.remove=i(function(b){return a["delete"](h(b.id))}),k.save=i(function(b){var c,d=b.id;return c=d?a.put(h(d),e(b),n()):a.post(h(),e(b),n())}),k.examples=function(){return{success:function(a){c(function(){a(o)})}}},k}]),angular.module("c8y.core").factory("c8yStatistics",["c8yBase","$http",function(a,b){"use strict";function c(c){var d=a.url(e+"/summary"),f={params:c};return b.get(d,f)}function d(c){var d=a.url(e+"/allTenantsSummary"),f={params:a.timeOrderFilter(a.pageSizeNoTotalFilter(c))};return b.get(d,f).then(a.getResData)}var e="tenant/statistics";return{getSummary:c,list:d}}]),angular.module("c8y.core").factory("c8yUser",["$http","$q","$timeout","c8yBase","info","c8yAuth",function(a,b,c,d,e,f){"use strict";function g(a,b){return a.replace(/{tenant}/g,b)}function h(a){return a=angular.copy(a),a.id&&delete a.userName,delete a.id,delete a.self,delete a.effectiveRoles,a}function i(a){var b=a.id||a;return k().then(function(a){return a+"/"+b})}function j(){return b.when(d.url(O))}function k(){return m().then(function(a){return d.url(g(N,a.tenant))})}function l(a){var b=/\/user\/(\w+)\//,c=a.match(b);if(c.length<2)throw new Error("Cannot find tenant on user self URL");return c[1]}function m(c){var e,f=O,g=angular.copy(R);return c&&(P=null),e=P&&!angular.isFunction(P.then)?b.when(P):P=P||a.get(d.url(f),g).then(function(a){return P=a.data,P.tenant=l(P.self),P},function(){return P=null,b.reject()})}function n(b){var c=d.pageSizeFilter(b),e={params:c},f=d.cleanListCallback("users",n,c);return k().then(function(b){return a.get(b,e).then(f)})}function o(b,c){var d={silentError:!!c};return i(b).then(function(b){return a.get(b,d)})}function p(){var b=d.url(O),c=angular.copy(R);return a.get(b,c)}function q(b){return i(b).then(function(b){return a["delete"](b)})}function r(b){var c=h(b),d=angular.copy(Q);return k().then(function(b){return a.post(b,c,d)})}function s(b,c){var d=h(b),e=angular.copy(Q),f=c?j():i(b);return f.then(function(b){return a.put(b,d,e)})}function t(a){var b=a.id?s(a):r(a);return b.then(function(){v(a)}),b}function u(a){return s(a,!0).then(function(){v(a)})}function v(a){w(a).then(function(b){b&&f.updatePassword(x(a))})}function w(a){var c=a.id||a;return m().then(function(a){return b.when(a.id===c)})}function x(a){var b=f.decodeToken(e.token);return a.password||b.password}function y(a){var b=f.decodeToken(e.token);return b.password===a}function z(a){var b=a.groups&&a.groups.references||[];return b.map(function(a){return a.group})}function A(a){return a.id.match(/^device_/)}function B(a,b){var c=C(a,b);return c||(c=D(a,b)),c}function C(a,b){var c=!1;return a.roles&&a.roles.references&&angular.forEach(a.roles.references,function(a){a.role.id===b&&(c=!0)}),c}function D(a,b){var c=!1;return a.groups&&a.groups.references&&angular.forEach(a.groups.references,function(a){angular.forEach(a.group.roles.references,function(a){a.role.id===b&&(c=!0)})}),c}function E(b,c){var e=d.pageSizeFilter({moId:c}),f={params:e};return i(b).then(function(b){return a.get(b+"/devicePermissions",f)})}function F(a,c,d,e){return b.when(H(a,c,d)).then(_.partial(I,e))}function G(){K(),P=null,e.token=null}function H(a,b,c){return btoa((a?a+"/":"")+b+":"+c)}function I(b,c){return e.token=c,a.get(d.url(O),{headers:M(c)}).then(function(a){return e.token=c,J(c,b),a.data},function(){K()})}function J(a,b){b?window.localStorage.setItem(S,a):window.sessionStorage.setItem(S,a)}function K(){window.localStorage.removeItem(S),window.sessionStorage.removeItem(S)}function L(a){var b=_.some(a.groups.references,function(a){return"admins"===a.group.name});return b}function M(a){var b=a||e.token;return{Authorization:"Basic "+b,UseXBasic:!0,Accept:"application/vnd.com.nsn.cumulocity.user+json;"}}var N="user/{tenant}/users",O="user/currentUser",P=null,Q={headers:d.contentHeaders("user",!0)},R={headers:d.contentHeaders("user",!0)},S="_tcy8";return{current:m,checkIfCurrent:w,list:n,detail:o,detailCurrent:p,remove:q,save:t,saveCurrent:u,groups:z,isDeviceUser:A,hasRole:B,getDevicePermissions:E,login:F,logout:G,isAdmin:L,isCurrentPassword:y}}]),angular.module("c8y.core").factory("c8yUserGroup",["$http","$q","c8yBase","c8yUser",function(a,b,c,d){"use strict";function e(){return d.current().then(function(a){var b=a.tenant;return c.url(y+b+"/groups")})}function f(){return b.when(c.url(y+"roles"))}function g(a){var b=a.id||a;return d.current().then(function(a){var d=a.tenant;return c.url(y+d+"/groups/"+b)})}function h(a,b){return g(a).then(function(a){return a+"/users"+(b?"/"+(b.id||b):"")})}function i(a){return g(a).then(function(a){return a+"/roles"})}function j(a,b){var c=b.id||b;return i(a).then(function(a){return a+"/"+c})}function k(b){var d=c.pageSizeFilter(b),f={params:d},g=c.cleanListCallback("groups",k,d);return e().then(function(b){return a.get(b,f).then(g)})}function l(b){return g(b).then(function(b){return a.get(b)})}function m(b){return g(b).then(function(b){return a["delete"](b)})}function n(b){var d={headers:c.contentHeaders("group")};return g(b).then(function(c){return a.put(c,b,d).then(function(){return b})})}function o(b){var d={headers:c.contentHeaders("group")};return e().then(function(c){return a.post(c,b,d).then(function(a){var b=a.headers("location"),c=b.match(/\d+$/)[0];return l(c).then(function(a){return a.data})})})}function p(a){return a.id?n(a):o(a)}function q(b){var d=c.pageSizeFilter(b),e={params:d,cache:!0},g=c.cleanListCallback("roles",q,d);return f().then(function(b){return a.get(b,e).then(g)})}function r(a){return q().then(function(b){var c;return b.forEach(function(b){return b.id===a?(c=b,!1):void 0}),c})}function s(b,c){var d={user:c};return h(b).then(function(b){return a.post(b,d)})}function t(b,c){return h(b,c).then(function(b){return a["delete"](b)})}function u(a,c){var d=a&&a.groups&&a.groups.references||[],e=d.map(function(a){return a.group.id}),f=[];return c.forEach(function(b){-1===e.indexOf(b)&&f.push(s(b,a))}),e.forEach(function(b){-1===c.indexOf(b)&&f.push(t(b,a))}),b.all(f)}function v(b,d){var e={headers:c.contentHeaders("roleReference")};return i(b).then(function(b){return a.post(b,{role:d},e)})}function w(b,c){return j(b,c).then(function(b){return a["delete"](b)})}function x(a,c){var d=a.roles.references.map(function(a){return a.role.id}),e=[];return c.forEach(function(b){-1===d.indexOf(b)&&e.push(r(b).then(function(b){return v(a,b)}))}),d.forEach(function(b){-1===c.indexOf(b)&&e.push(w(a,b))}),b.all(e)}var y="user/";return{list:k,detail:l,remove:m,create:o,update:n,save:p,listRoles:q,updateGroups:u,updateRoles:x}}]),angular.module("c8y.core").factory("c8yRealtime",["$http","$rootScope","$timeout","c8yBase","info",function(a,b,c,d,e){"use strict";function f(){E.isDisconnected()&&!x&&(w?x=function(){E.handshake()}:E.handshake())}function g(){return c(function(){E.getTransport().abort()},B)}function h(a){if(E.isDisconnected())return f(),void D.push(a);var b=E.subscribe(a,function(b){var d=G[a].scope;d.$emit(b.data.realtimeAction,b.data.data),v&&(c.cancel(),v=g()),j()});return v=g(),G[a].subObj||(G[a].subObj=b),b}function i(a){a&&E.unsubscribe(a)}function j(){b.$$phase||b.$apply()}function k(a,b){G[b].subscribers[a].active?t(a,b):s(a,b)}function l(a){return F[a]}function m(){return G}function n(){return H}function o(a,b){var c=G[b];if(void 0===c)return!1;var d=c.subscribers[a];return d&&d.hasOwnProperty("active")?d.active:!1}function p(a,b){if(o(a,b)===!1)throw new Error('There is no listener registered for your scope on the channel "'+b+'"');t(a,b),delete G[b].subscribers[a],0===Object.keys(G[b].subscribers).length&&(G[b].scope.$destroy(),delete G[b])}function q(a,c){G[c]||(G[c]={scope:b.$new(!0),subscribers:{},activeSubscribers:0,subObj:void 0,ready:!1}),G[c].subscribers[a]={listeners:[],unreg:void 0}}function r(a,b,c,d){G[b]&&G[b].subscribers[a]||q(a,b),G[b].subscribers[a].listeners.push({watch:c,func:d})}function s(a,b){if(void 0===G[b])throw new Error('There is no listener registered for your scope on the channel "'+b+'"');var c=G[b].scope,d=G[b].subscribers[a].listeners,e=[];for(var f in d)e.push({watch:d[f].watch,func:c.$on(d[f].watch,d[f].func)});G[b].subscribers[a].unreg=e,G[b].subscribers[a].active=!0,0===G[b].activeSubscribers?h(b):G[b].ready&&c.$emit(a+"-subscribed"),G[b].activeSubscribers++}function t(a,b){var c,d=G[b].scope,e=G[b].subscribers[a].unreg;void 0!==e&&e.forEach(function(b){b.watch===a+"-unsubscribed"?c=b.func:b.func()}),c&&(d.$emit(a+"-unsubscribed"),c()),G[b].subscribers[a].unreg=void 0,G[b].subscribers[a].active=!1,G[b].activeSubscribers--,G[b].activeSubscribers<=0&&(G[b].subObj&&(i(G[b].subObj),G[b].subObj=void 0,G[b].ready=!1),G[b].activeSubscribers=0)}function u(a,b){o(a,b)===!0&&p(a,b)}var v,w,x,y,z="cep/realtime",A={url:d.url(z),logLevel:"info",requestHeaders:{Authorization:"Basic "+e.token,UseXBasic:!0},appendMessageTypeToURL:!1},B=57e4,C=0,D=[],E=new $.Cometd,F={},G={},H={CREATE:"CREATE",UPDATE:"UPDATE",DELETE:"DELETE"},I=b.$new(!0);return F[!0]="check-circle-o",F[!1]="circle-o",E.unregisterTransport("websocket"),E.configure(A),E.addListener("/meta/connect",function(a){D.forEach(function(a){h(a)}),D.length=0,a.successful?(y&&I.$emit("connect",{fromLastConnect:moment().diff(y,"seconds")}),y=moment()):I.$emit("connectfailure",a)}),E.addListener("/meta/disconnect",function(){w=!1,"function"==typeof x&&(x(),x=void 0)}),E.addListener("/meta/subscribe",function(a){if(a.successful){var b=G[a.subscription].scope,c=G[a.subscription].subscribers;
G[a.subscription].ready=!0,C++;for(var d in c)c[d].active&&b.$emit(d+"-subscribed");j()}else E.isDisconnected()||0!==C||(E.disconnect(),w=!0)}),E.addListener("/meta/unsubscribe",function(){C--,E.isDisconnected()||0!==C||(v&&(c.cancel(v),v=void 0),E.disconnect(),w=!0)}),{start:s,stop:t,bus:function(){return I},addListener:r,removeSubscriber:p,switchRealtime:k,icon:l,getStatus:o,realtimeActions:n,destroySubscription:u,getSubscriptionMap:m}}]),angular.module("c8y.core").factory("c8ySimulator",["$http","c8yBase",function(a,b){"use strict";function c(){var c=b.url(j);return a.get(c).then(b.getResData)}function d(c,d){var e=c.id||c,f=b.url(j+"/"+e),g={state:d},h=angular.copy(l);return a.put(f,g,h)}function e(c){var d=c.id||c,e=b.url(j+"/"+d),f=angular.copy(l);return a["delete"](e,f)}function f(){var c=b.url(k);return a.get(c).then(b.getResData)}function g(c){var d=b.url(i),e=angular.copy(c),f=angular.copy(m);return a.post(d,e,f)}function h(c){var d=b.url(j),e=angular.copy(c),f=angular.copy(l);return a.post(d,e,f)}var i="simulator/templates",j="simulator/configurations",k=i+"/sensors",l={headers:b.contentHeaders("simulator","simulator")},m={headers:b.contentHeaders("template","template")};return{list:c,changeState:d,deleteSimulator:e,createSimulator:h,createTemplate:g,getSensors:f}}]),angular.module("c8y.core").factory("c8yKpi",["$q","c8yInventory","c8yMeasurements","c8yDevices","c8yUser","c8yBase","c8yAlert","c8yBatchOp",function(a,b,c,d,e,f,g,h){"use strict";function i(){return b.list({fragmentType:u}).then(l)}function j(a){return i().then(function(b){return a&&a.length?_.filter(b,function(b){return a.indexOf(b.id)>-1}):b})}function k(a){var b=["assetParents",u,"childAssets","childDevices","deviceParents","id","lastUpdated","owner","self"],c=Object.keys(a);return _.every(c,function(a){return b.indexOf(a)>-1})}function l(c){var d=a.defer(),f=_.filter(c,function(a){return!k(a)&&!a.c8y_Kpi_Migrated}),j=_.pluck(_.filter(c,k,u));if(f.length){var l,m=_.map(_.reduce(_.flatten(_.pluck(f,u)),_.partial(n,j),[]),function(a){var c={};return c[u]=a,_.partial(b.save,c)}),p=_.map(f,function(a){return _.partial(o,a)}),q=_.flatten([m,p]),r=a.when();e.current().then(function(a){e.hasRole(a,"ROLE_INVENTORY_ADMIN")&&(l=h.run(q,"Migrating KPIs to new data model"),r=l.result.then(function(a){return"complete"===a?i():void g.danger("Failed to migrate KPIs to new data model!")}))}),d.resolve(r)}else d.resolve(_.filter(c,k));return d.promise}function m(a,b){return _.find(a,function(a){return a.fragment===b.fragment&&a.series===b.series&&a.unit===b.unit&&a.label===b.label})}function n(a,b,c){var d=m(a,c)||m(b,c);return!d&&c.fragment&&c.series&&b.push(c),b}function o(a){var c={id:a.id,c8y_Kpi_Migrated:!0};return b.save(c)}function p(a){return b.detail(a).then(function(a){var b=a.data.c8y_Kpi;return _.forEach(v,function(a){angular.isDefined(b[a])&&(b[a]=parseFloat(b[a]),isNaN(b[a])&&delete b[a])}),a})}function q(a){var b=moment().subtract(1,"month").format(f.dateFormat),d="DAILY";return c.listSeries({source:a,dateFrom:b,aggregationType:d}).then(function(a){return _.map(a.series,function(a){return{fragment:a.type,series:a.name}})})}function r(b){var c=b.id||b;return a.all([i(),q(c)]).then(function(a){var b=a[0],c=a[1],d=_.filter(b,function(a){return _.find(c,{fragment:a.c8y_Kpi.fragment,series:a.c8y_Kpi.series})}),e=_.filter(c,function(a){return!_.find(b,function(b){return b.c8y_Kpi.fragment===a.fragment&&b.c8y_Kpi.series===a.series})});return{matchKpi:d,nonKpiSeries:e}})}function s(a,b){var c=(b||{})[a.fragment]||{};return c.kpi=a,c.time=(b||{}).time,c.source=(b||{}).source,c}function t(a,b,d){var e=a.c8y_Kpi||a;return c.list(angular.extend(f.timeOrderFilter(),{revert:!0,fragmentType:e.fragment,source:b,pageSize:d||10})).then(function(b){return _.find(b,function(b){var c=b[a.fragment];return c&&angular.isDefined(c[a.series])})}).then(_.partial(s,e))}var u="c8y_Kpi",v=["target","min","max","yellowRangeMin","yellowRangeMax","redRangeMin","redRangeMax"];return{list:i,listByIds:j,detail:p,remove:b.remove,save:b.save,listKpiForDevice:r,getMeasurement:t}}]),angular.module("c8y.core").factory("c8yDeviceShell",["$http","$q","c8yBase",function(a,b,c){"use strict";function d(b){var d=e(b);return a.get(d).then(c.getResData).then(_.partial(f,b))}function e(a){var b="/apps/c8ydata/devicecommands/";return b+a+".json"}function f(a,c){var d;return d=angular.isArray(c)?_.chain(c).map(function(b){return g(b.templates,b.syntax,a)}).flatten().value():g(c.templates,c.syntax,a),b.when(d)}function g(a,b,c){return _.map(a||[],function(a){return angular.extend(a,{syntax:b,deviceType:c})})}return{getCommandTemplatesForDeviceType:d}}]),function(){"use strict";function a(a){function b(b){return b&&moment(b).format(a.dateFormat)}function c(a){return a&&moment(a).toDate()}return{dateToString:b,stringToDate:c}}angular.module("c8y.core").factory("c8yUtil",["c8yBase",a])}(),angular.module("c8y.core").factory("c8ySystem",["$http","$q","c8yBase","$window",function(a,b,c,d){"use strict";function e(){var b=c.url(g);return a.get(b).then(c.getResData)}function f(){return b.when(d.UI_VERSION||"dev")}var g="tenant/system/options/system/version";return{getBackendVersion:e,getUIVersion:f}}]),function(){function a(a,b,c){function d(e){var f=c.url(k);e=c.pageSizeFilter(e);var g={params:e,silentError:!0},h=c.cleanListCallback("retentionRules",d,e);return a.get(f,g).then(h,b.reject)}function e(c){var d=j(c);return d?a.get(d):b.reject("Retention rule object is not valid")}function f(b){var d=c.url(k);return a.post(d,b,l)}function g(b){var c=j(b);return a.put(c,b,l)}function h(a){return a.id?g(a):f(a)}function i(c){var d=j(c);return d?a["delete"](d):b.reject("Retention rule object is not valid")}function j(a){var b=a&&a.id||a;if(b)return c.url(k+"/"+b)}var k="retention/retentions",l={headers:{"Content-Type":"application/json"}},m=["ALARM","EVENT","MEASUREMENT","OPERATION","AUDIT","*"];return{list:d,detail:e,create:f,update:g,save:h,remove:i,dataTypes:m}}angular.module("c8y.core").factory("c8yRetentions",["$http","$q","c8yBase",a])}(),function(){"use strict";angular.module("c8y.sdk",["c8y.core"]).constant("info",{})}(),function(){"use strict";function a(a,b,c,d,f){function g(){var a=b.localStorage.getItem(e)||b.sessionStorage.getItem(e);d.token=a}function h(){return!d.token||d.preventGetUser?c.reject("No token"):void f.current().then(function(b){var c=a.c8y=a.c8y||{};c.user=b,a.$emit("c8y.api.login")})}g(),h()}function b(a){function b(){return a.baseUrl}function c(){return a.appKey}function d(){return a.tenant}return{getBaseUrl:b,getAppKey:c,getTenant:d}}function c(a){function c(b){a.baseUrl=b}function e(b){a.appKey=b}function f(b){a.tenant=b}var g={setBaseUrl:c,setAppKey:e,setTenant:f,$get:["info","$window","$rootScope","c8yUser",d]};return _.assign(g,b(a)),g}function d(a,c,d,e){function f(a,b,c,f){return a=a||i.getTenant(),e.login(a,b,c,f).then(g).then(function(){d.$emit("c8y.api.login")})}function g(a){var b=d.c8y=d.c8y||{};b.user=a}function h(){g(null),e.logout(),d.$emit("c8y.api.logout")}var i=b(a),j={login:f,logout:h};return _.assign(j,i),j}var e="_tcy8";angular.module("c8y.sdk").provider("c8yCumulocity",["info",c]).run(["$rootScope","$window","$q","info","c8yUser",a])}(),function(){function a(a){function b(b,c){c.bind("click",function(){a.login(b.tenant(),b.user(),b.password(),b.rememberMe()).then(b.onSuccess)["catch"](b.onFailure)})}return{restrict:"A",link:b,scope:{tenant:"&",user:"&",password:"&",rememberMe:"&",onSuccess:"&",onFailure:"&"}}}angular.module("c8y.sdk").directive("c8yLogin",["c8yCumulocity",a])}(),function(){function a(a){function b(b,c){c.bind("click",function(c){a.logout(),b.ngClick(),c.stopPropagation()})}return{priority:1,restrict:"A",link:b,scope:{ngClick:"&"}}}angular.module("c8y.sdk").directive("c8yLogout",["c8yCumulocity",a])}(),function(){function a(a,b,c){function d(d,e,f){function g(){var a=/^\s*([^\s]+)\s*in\s*([^\s]+)\s*/,c=a.exec(f.c8yRepeat),d=c[1];m=c[2],e.removeAttr("c8y-repeat"),e.removeAttr("data-c8y-repeat"),e.attr("ng-repeat",d+" in __c8y_serviceResult track by "+d+".id"),n=b(e)}function h(){d.refresh=i}function i(){c.c8y&&c.c8y.user&&j().then(function(a){o.__c8y_serviceResult=a})}function j(){var b=d.filter||{};return a.get("c8y"+k(m)).list(b)}function k(a){return a[0].toUpperCase()+a.slice(1)}function l(){o=d.$parent,n(o),h(),c.$on("c8y.api.login",function(){i()}),d.$watch("filter",i,!0)}var m,n,o;g(),l()}return{restrict:"A",link:d,transclude:!1,scope:{filter:"=?",refresh:"=?"}}}angular.module("c8y.sdk").directive("c8yRepeat",["$injector","$compile","$rootScope",a])}();
//# sourceMappingURL=main.js.map
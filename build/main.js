"use strict";!function(){var KEY={TAB:9,ENTER:13,ESC:27,SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,SHIFT:16,CTRL:17,ALT:18,PAGE_UP:33,PAGE_DOWN:34,HOME:36,END:35,BACKSPACE:8,DELETE:46,COMMAND:91,isControl:function(e){var k=e.which;switch(k){case KEY.COMMAND:case KEY.SHIFT:case KEY.CTRL:case KEY.ALT:return!0}return e.metaKey?!0:!1},isFunctionKey:function(k){return k=k.which?k.which:k,k>=112&&123>=k},isVerticalMovement:function(k){return~[KEY.UP,KEY.DOWN].indexOf(k)},isHorizontalMovement:function(k){return~[KEY.LEFT,KEY.RIGHT,KEY.BACKSPACE,KEY.DELETE].indexOf(k)}};void 0===angular.element.prototype.querySelectorAll&&(angular.element.prototype.querySelectorAll=function(selector){return angular.element(this[0].querySelectorAll(selector))}),angular.module("ui.select",[]).constant("uiSelectConfig",{theme:"bootstrap",searchEnabled:!0,placeholder:"",refreshDelay:1e3}).service("uiSelectMinErr",function(){var minErr=angular.$$minErr("ui.select");return function(){var error=minErr.apply(this,arguments),message=error.message.replace(new RegExp("\nhttp://errors.angularjs.org/.*"),"");return new Error(message)}}).service("RepeatParser",["uiSelectMinErr","$parse",function(uiSelectMinErr,$parse){var self=this;self.parse=function(expression){var match=expression.match(/^\s*(?:([\s\S]+?)\s+as\s+)?([\S]+?)\s+in\s+([\s\S]+?)(?:\s+track\s+by\s+([\s\S]+?))?\s*$/);if(!match)throw uiSelectMinErr("iexp","Expected expression in form of '_item_ in _collection_[ track by _id_]' but got '{0}'.",expression);return{itemName:match[2],source:$parse(match[3]),trackByExp:match[4],modelMapper:$parse(match[1]||match[2])}},self.getGroupNgRepeatExpression=function(){return"$group in $select.groups"},self.getNgRepeatExpression=function(itemName,source,trackByExp,grouped){var expression=itemName+" in "+(grouped?"$group.items":source);return trackByExp&&(expression+=" track by "+trackByExp),expression}}]).controller("uiSelectCtrl",["$scope","$element","$timeout","RepeatParser","uiSelectMinErr",function($scope,$element,$timeout,RepeatParser,uiSelectMinErr){function _resetSearchInput(){ctrl.resetSearchInput&&(ctrl.search=EMPTY_SEARCH,ctrl.selected&&ctrl.items.length&&!ctrl.multiple&&(ctrl.activeIndex=ctrl.items.indexOf(ctrl.selected)))}function _handleDropDownSelection(key){var processed=!0;switch(key){case KEY.DOWN:!ctrl.open&&ctrl.multiple?ctrl.activate(!1,!0):ctrl.activeIndex<ctrl.items.length-1&&ctrl.activeIndex++;break;case KEY.UP:!ctrl.open&&ctrl.multiple?ctrl.activate(!1,!0):ctrl.activeIndex>0&&ctrl.activeIndex--;break;case KEY.TAB:(!ctrl.multiple||ctrl.open)&&ctrl.select(ctrl.items[ctrl.activeIndex],!0);break;case KEY.ENTER:ctrl.open?ctrl.select(ctrl.items[ctrl.activeIndex]):ctrl.activate(!1,!0);break;case KEY.ESC:ctrl.close();break;default:processed=!1}return processed}function _handleMatchSelection(key){function getNewActiveMatchIndex(){switch(key){case KEY.LEFT:return~ctrl.activeMatchIndex?prev:last;case KEY.RIGHT:return~ctrl.activeMatchIndex&&curr!==last?next:(ctrl.activate(),!1);case KEY.BACKSPACE:return~ctrl.activeMatchIndex?(ctrl.removeChoice(curr),prev):last;case KEY.DELETE:return~ctrl.activeMatchIndex?(ctrl.removeChoice(ctrl.activeMatchIndex),curr):!1}}var caretPosition=_getCaretPosition(_searchInput[0]),length=ctrl.selected.length,first=0,last=length-1,curr=ctrl.activeMatchIndex,next=ctrl.activeMatchIndex+1,prev=ctrl.activeMatchIndex-1,newIndex=curr;return caretPosition>0||ctrl.search.length&&key==KEY.RIGHT?!1:(ctrl.close(),newIndex=getNewActiveMatchIndex(),ctrl.selected.length&&newIndex!==!1?ctrl.activeMatchIndex=Math.min(last,Math.max(first,newIndex)):ctrl.activeMatchIndex=-1,!0)}function _getCaretPosition(el){return angular.isNumber(el.selectionStart)?el.selectionStart:el.value.length}function _ensureHighlightVisible(){var container=$element.querySelectorAll(".ui-select-choices-content"),choices=container.querySelectorAll(".ui-select-choices-row");if(choices.length<1)throw uiSelectMinErr("choices","Expected multiple .ui-select-choices-row but got '{0}'.",choices.length);var highlighted=choices[ctrl.activeIndex],posY=highlighted.offsetTop+highlighted.clientHeight-container[0].scrollTop,height=container[0].offsetHeight;posY>height?container[0].scrollTop+=posY-height:posY<highlighted.clientHeight&&(ctrl.isGrouped&&0===ctrl.activeIndex?container[0].scrollTop=0:container[0].scrollTop-=highlighted.clientHeight-posY)}var ctrl=this,EMPTY_SEARCH="";ctrl.placeholder=void 0,ctrl.search=EMPTY_SEARCH,ctrl.activeIndex=0,ctrl.activeMatchIndex=-1,ctrl.items=[],ctrl.selected=void 0,ctrl.open=!1,ctrl.focus=!1,ctrl.focusser=void 0,ctrl.disabled=void 0,ctrl.searchEnabled=void 0,ctrl.resetSearchInput=void 0,ctrl.refreshDelay=void 0,ctrl.multiple=!1,ctrl.disableChoiceExpression=void 0,ctrl.isEmpty=function(){return angular.isUndefined(ctrl.selected)||null===ctrl.selected||""===ctrl.selected};var _searchInput=$element.querySelectorAll("input.ui-select-search");if(1!==_searchInput.length)throw uiSelectMinErr("searchInput","Expected 1 input.ui-select-search but got '{0}'.",_searchInput.length);ctrl.activate=function(initSearchValue,avoidReset){ctrl.disabled||ctrl.open||(avoidReset||_resetSearchInput(),ctrl.focusser.prop("disabled",!0),ctrl.open=!0,ctrl.activeMatchIndex=-1,ctrl.activeIndex=ctrl.activeIndex>=ctrl.items.length?0:ctrl.activeIndex,$timeout(function(){ctrl.search=initSearchValue||ctrl.search,_searchInput[0].focus()}))},ctrl.findGroupByName=function(name){return ctrl.groups&&ctrl.groups.filter(function(group){return group.name===name})[0]},ctrl.parseRepeatAttr=function(repeatAttr,groupByExp){function updateGroups(items){ctrl.groups=[],angular.forEach(items,function(item){var groupFn=$scope.$eval(groupByExp),groupName=angular.isFunction(groupFn)?groupFn(item):item[groupFn],group=ctrl.findGroupByName(groupName);group?group.items.push(item):ctrl.groups.push({name:groupName,items:[item]})}),ctrl.items=[],ctrl.groups.forEach(function(group){ctrl.items=ctrl.items.concat(group.items)})}function setPlainItems(items){ctrl.items=items}var setItemsFn=groupByExp?updateGroups:setPlainItems;ctrl.parserResult=RepeatParser.parse(repeatAttr),ctrl.isGrouped=!!groupByExp,ctrl.itemProperty=ctrl.parserResult.itemName,$scope.$watchCollection(ctrl.parserResult.source,function(items){if(void 0===items||null===items)ctrl.items=[];else{if(!angular.isArray(items))throw uiSelectMinErr("items","Expected an array but got '{0}'.",items);if(ctrl.multiple){var filteredItems=items.filter(function(i){return ctrl.selected.indexOf(i)<0});setItemsFn(filteredItems)}else setItemsFn(items);ctrl.ngModel.$modelValue=null}}),ctrl.multiple&&$scope.$watchCollection("$select.selected",function(selectedItems){var data=ctrl.parserResult.source($scope);if(selectedItems.length){var filteredItems=data.filter(function(i){return selectedItems.indexOf(i)<0});setItemsFn(filteredItems)}else setItemsFn(data);ctrl.sizeSearchInput()})};var _refreshDelayPromise;ctrl.refresh=function(refreshAttr){void 0!==refreshAttr&&(_refreshDelayPromise&&$timeout.cancel(_refreshDelayPromise),_refreshDelayPromise=$timeout(function(){$scope.$eval(refreshAttr)},ctrl.refreshDelay))},ctrl.setActiveItem=function(item){ctrl.activeIndex=ctrl.items.indexOf(item)},ctrl.isActive=function(itemScope){return ctrl.open&&ctrl.items.indexOf(itemScope[ctrl.itemProperty])===ctrl.activeIndex},ctrl.isDisabled=function(itemScope){if(ctrl.open){var item,itemIndex=ctrl.items.indexOf(itemScope[ctrl.itemProperty]),isDisabled=!1;return itemIndex>=0&&!angular.isUndefined(ctrl.disableChoiceExpression)&&(item=ctrl.items[itemIndex],isDisabled=!!itemScope.$eval(ctrl.disableChoiceExpression),item._uiSelectChoiceDisabled=isDisabled),isDisabled}},ctrl.select=function(item,skipFocusser){if(void 0===item||!item._uiSelectChoiceDisabled){var locals={};locals[ctrl.parserResult.itemName]=item,ctrl.onSelectCallback($scope,{$item:item,$model:ctrl.parserResult.modelMapper($scope,locals)}),ctrl.multiple?(ctrl.selected.push(item),ctrl.sizeSearchInput()):ctrl.selected=item,ctrl.close(skipFocusser)}},ctrl.close=function(skipFocusser){ctrl.open&&(_resetSearchInput(),ctrl.open=!1,ctrl.multiple||$timeout(function(){ctrl.focusser.prop("disabled",!1),skipFocusser||ctrl.focusser[0].focus()},0,!1))},ctrl.toggle=function(e){ctrl.open?ctrl.close():ctrl.activate(),e.preventDefault(),e.stopPropagation()},ctrl.removeChoice=function(index){var removedChoice=ctrl.selected[index],locals={};locals[ctrl.parserResult.itemName]=removedChoice,ctrl.selected.splice(index,1),ctrl.activeMatchIndex=-1,ctrl.sizeSearchInput(),ctrl.onRemoveCallback($scope,{$item:removedChoice,$model:ctrl.parserResult.modelMapper($scope,locals)})},ctrl.getPlaceholder=function(){return ctrl.multiple&&ctrl.selected.length?void 0:ctrl.placeholder};var containerSizeWatch;ctrl.sizeSearchInput=function(){var input=_searchInput[0],container=_searchInput.parent().parent()[0];_searchInput.css("width","10px");var calculate=function(){var newWidth=container.clientWidth-input.offsetLeft-10;50>newWidth&&(newWidth=container.clientWidth),_searchInput.css("width",newWidth+"px")};$timeout(function(){0!==container.clientWidth||containerSizeWatch?containerSizeWatch||calculate():containerSizeWatch=$scope.$watch(function(){return container.clientWidth},function(newValue){0!==newValue&&(calculate(),containerSizeWatch(),containerSizeWatch=null)})},0,!1)},_searchInput.on("keydown",function(e){var key=e.which;$scope.$apply(function(){var processed=!1;ctrl.multiple&&KEY.isHorizontalMovement(key)&&(processed=_handleMatchSelection(key)),!processed&&ctrl.items.length>0&&(processed=_handleDropDownSelection(key)),processed&&key!=KEY.TAB&&(e.preventDefault(),e.stopPropagation())}),KEY.isVerticalMovement(key)&&ctrl.items.length>0&&_ensureHighlightVisible()}),_searchInput.on("blur",function(){$timeout(function(){ctrl.activeMatchIndex=-1})}),$scope.$on("$destroy",function(){_searchInput.off("keydown blur")})}]).directive("uiSelect",["$document","uiSelectConfig","uiSelectMinErr","$compile","$parse",function($document,uiSelectConfig,uiSelectMinErr,$compile,$parse){return{restrict:"EA",templateUrl:function(tElement,tAttrs){var theme=tAttrs.theme||uiSelectConfig.theme;return theme+(angular.isDefined(tAttrs.multiple)?"/select-multiple.tpl.html":"/select.tpl.html")},replace:!0,transclude:!0,require:["uiSelect","ngModel"],scope:!0,controller:"uiSelectCtrl",controllerAs:"$select",link:function(scope,element,attrs,ctrls,transcludeFn){function onDocumentClick(e){var contains=!1;contains=window.jQuery?window.jQuery.contains(element[0],e.target):element[0].contains(e.target),contains||($select.close(),scope.$digest())}var $select=ctrls[0],ngModel=ctrls[1],searchInput=element.querySelectorAll("input.ui-select-search");$select.multiple=angular.isDefined(attrs.multiple)?""===attrs.multiple?!0:"true"===attrs.multiple.toLowerCase():!1,$select.onSelectCallback=$parse(attrs.onSelect),$select.onRemoveCallback=$parse(attrs.onRemove),ngModel.$parsers.unshift(function(inputValue){var result,locals={};if($select.multiple){for(var resultMultiple=[],j=$select.selected.length-1;j>=0;j--)locals={},locals[$select.parserResult.itemName]=$select.selected[j],result=$select.parserResult.modelMapper(scope,locals),resultMultiple.unshift(result);return resultMultiple}return locals={},locals[$select.parserResult.itemName]=inputValue,result=$select.parserResult.modelMapper(scope,locals)}),ngModel.$formatters.unshift(function(inputValue){var result,data=$select.parserResult.source(scope,{$select:{search:""}}),locals={};if(data){if($select.multiple){var resultMultiple=[],checkFnMultiple=function(list,value){if(list&&list.length){for(var p=list.length-1;p>=0;p--)if(locals[$select.parserResult.itemName]=list[p],result=$select.parserResult.modelMapper(scope,locals),result==value)return resultMultiple.unshift(list[p]),!0;return!1}};if(!inputValue)return resultMultiple;for(var k=inputValue.length-1;k>=0;k--)checkFnMultiple($select.selected,inputValue[k])||checkFnMultiple(data,inputValue[k]);return resultMultiple}var checkFnSingle=function(d){return locals[$select.parserResult.itemName]=d,result=$select.parserResult.modelMapper(scope,locals),result==inputValue};if($select.selected&&checkFnSingle($select.selected))return $select.selected;for(var i=data.length-1;i>=0;i--)if(checkFnSingle(data[i]))return data[i]}return inputValue}),$select.ngModel=ngModel;var focusser=angular.element("<input ng-disabled='$select.disabled' class='ui-select-focusser ui-select-offscreen' type='text' aria-haspopup='true' role='button' />");attrs.tabindex&&attrs.$observe("tabindex",function(value){$select.multiple?searchInput.attr("tabindex",value):focusser.attr("tabindex",value),element.removeAttr("tabindex")}),$compile(focusser)(scope),$select.focusser=focusser,$select.multiple||(element.append(focusser),focusser.bind("focus",function(){scope.$evalAsync(function(){$select.focus=!0})}),focusser.bind("blur",function(){scope.$evalAsync(function(){$select.focus=!1})}),focusser.bind("keydown",function(e){return e.which===KEY.BACKSPACE?(e.preventDefault(),e.stopPropagation(),$select.select(void 0),void scope.$apply()):void(e.which===KEY.TAB||KEY.isControl(e)||KEY.isFunctionKey(e)||e.which===KEY.ESC||((e.which==KEY.DOWN||e.which==KEY.UP||e.which==KEY.ENTER||e.which==KEY.SPACE)&&(e.preventDefault(),e.stopPropagation(),$select.activate()),scope.$digest()))}),focusser.bind("keyup input",function(e){e.which===KEY.TAB||KEY.isControl(e)||KEY.isFunctionKey(e)||e.which===KEY.ESC||e.which==KEY.ENTER||e.which===KEY.BACKSPACE||($select.activate(focusser.val()),focusser.val(""),scope.$digest())})),scope.$watch("searchEnabled",function(){var searchEnabled=scope.$eval(attrs.searchEnabled);$select.searchEnabled=void 0!==searchEnabled?searchEnabled:!0}),attrs.$observe("disabled",function(){$select.disabled=void 0!==attrs.disabled?attrs.disabled:!1}),attrs.$observe("resetSearchInput",function(){var resetSearchInput=scope.$eval(attrs.resetSearchInput);$select.resetSearchInput=void 0!==resetSearchInput?resetSearchInput:!0}),$select.multiple?(scope.$watchCollection(function(){return ngModel.$modelValue},function(newValue,oldValue){oldValue!=newValue&&(ngModel.$modelValue=null)}),scope.$watchCollection("$select.selected",function(){ngModel.$setViewValue(Date.now())}),focusser.prop("disabled",!0)):scope.$watch("$select.selected",function(newValue){ngModel.$viewValue!==newValue&&ngModel.$setViewValue(newValue)}),ngModel.$render=function(){if($select.multiple&&!angular.isArray(ngModel.$viewValue)){if(!angular.isUndefined(ngModel.$viewValue)&&null!==ngModel.$viewValue)throw uiSelectMinErr("multiarr","Expected model value to be array but got '{0}'",ngModel.$viewValue);$select.selected=[]}$select.selected=ngModel.$viewValue},$document.on("click",onDocumentClick),scope.$on("$destroy",function(){$document.off("click",onDocumentClick)}),transcludeFn(scope,function(clone){var transcluded=angular.element("<div>").append(clone),transcludedMatch=transcluded.querySelectorAll(".ui-select-match");if(transcludedMatch.removeAttr("ui-select-match"),1!==transcludedMatch.length)throw uiSelectMinErr("transcluded","Expected 1 .ui-select-match but got '{0}'.",transcludedMatch.length);element.querySelectorAll(".ui-select-match").replaceWith(transcludedMatch);var transcludedChoices=transcluded.querySelectorAll(".ui-select-choices");if(transcludedChoices.removeAttr("ui-select-choices"),1!==transcludedChoices.length)throw uiSelectMinErr("transcluded","Expected 1 .ui-select-choices but got '{0}'.",transcludedChoices.length);element.querySelectorAll(".ui-select-choices").replaceWith(transcludedChoices)})}}}]).directive("uiSelectChoices",["uiSelectConfig","RepeatParser","uiSelectMinErr","$compile",function(uiSelectConfig,RepeatParser,uiSelectMinErr,$compile){return{restrict:"EA",require:"^uiSelect",replace:!0,transclude:!0,templateUrl:function(tElement){var theme=tElement.parent().attr("theme")||uiSelectConfig.theme;return theme+"/choices.tpl.html"},compile:function(tElement,tAttrs){if(!tAttrs.repeat)throw uiSelectMinErr("repeat","Expected 'repeat' expression.");return function(scope,element,attrs,$select,transcludeFn){var groupByExp=attrs.groupBy;if($select.parseRepeatAttr(attrs.repeat,groupByExp),$select.disableChoiceExpression=attrs.uiDisableChoice,groupByExp){var groups=element.querySelectorAll(".ui-select-choices-group");if(1!==groups.length)throw uiSelectMinErr("rows","Expected 1 .ui-select-choices-group but got '{0}'.",groups.length);groups.attr("ng-repeat",RepeatParser.getGroupNgRepeatExpression())}var choices=element.querySelectorAll(".ui-select-choices-row");if(1!==choices.length)throw uiSelectMinErr("rows","Expected 1 .ui-select-choices-row but got '{0}'.",choices.length);choices.attr("ng-repeat",RepeatParser.getNgRepeatExpression($select.parserResult.itemName,"$select.items",$select.parserResult.trackByExp,groupByExp)).attr("ng-mouseenter","$select.setActiveItem("+$select.parserResult.itemName+")").attr("ng-click","$select.select("+$select.parserResult.itemName+")");var rowsInner=element.querySelectorAll(".ui-select-choices-row-inner");if(1!==rowsInner.length)throw uiSelectMinErr("rows","Expected 1 .ui-select-choices-row-inner but got '{0}'.",rowsInner.length);rowsInner.attr("uis-transclude-append",""),$compile(element,transcludeFn)(scope),scope.$watch("$select.search",function(newValue){newValue&&!$select.open&&$select.multiple&&$select.activate(!1,!0),$select.activeIndex=0,$select.refresh(attrs.refresh)}),attrs.$observe("refreshDelay",function(){var refreshDelay=scope.$eval(attrs.refreshDelay);$select.refreshDelay=void 0!==refreshDelay?refreshDelay:uiSelectConfig.refreshDelay})}}}}]).directive("uisTranscludeAppend",function(){return{link:function(scope,element,attrs,ctrl,transclude){transclude(scope,function(clone){element.append(clone)})}}}).directive("uiSelectMatch",["uiSelectConfig",function(uiSelectConfig){return{restrict:"EA",require:"^uiSelect",replace:!0,transclude:!0,templateUrl:function(tElement){var theme=tElement.parent().attr("theme")||uiSelectConfig.theme,multi=tElement.parent().attr("multiple");return theme+(multi?"/match-multiple.tpl.html":"/match.tpl.html")},link:function(scope,element,attrs,$select){attrs.$observe("placeholder",function(placeholder){$select.placeholder=void 0!==placeholder?placeholder:uiSelectConfig.placeholder}),$select.multiple&&$select.sizeSearchInput()}}}]).filter("highlight",function(){function escapeRegexp(queryToEscape){return queryToEscape.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}return function(matchItem,query){return query&&matchItem?matchItem.replace(new RegExp(escapeRegexp(query),"gi"),'<span class="ui-select-highlight">$&</span>'):matchItem}})}(),angular.module("ui.select").run(["$templateCache",function($templateCache){$templateCache.put("bootstrap/choices.tpl.html",'<ul class="ui-select-choices ui-select-choices-content dropdown-menu" role="menu" aria-labelledby="dLabel" ng-show="$select.items.length > 0"><li class="ui-select-choices-group"><div class="divider" ng-show="$select.isGrouped && $index > 0"></div><div ng-show="$select.isGrouped" class="ui-select-choices-group-label dropdown-header">{{$group.name}}</div><div class="ui-select-choices-row" ng-class="{active: $select.isActive(this), disabled: $select.isDisabled(this)}"><a href="javascript:void(0)" class="ui-select-choices-row-inner"></a></div></li></ul>'),$templateCache.put("bootstrap/match-multiple.tpl.html",'<span class="ui-select-match"><span ng-repeat="$item in $select.selected"><span style="margin-right: 3px;" class="ui-select-match-item btn btn-default btn-xs" tabindex="-1" type="button" ng-disabled="$select.disabled" ng-click="$select.activeMatchIndex = $index;" ng-class="{\'btn-primary\':$select.activeMatchIndex === $index}"><span class="close ui-select-match-close" ng-hide="$select.disabled" ng-click="$select.removeChoice($index)">&nbsp;&times;</span> <span uis-transclude-append=""></span></span></span></span>'),$templateCache.put("bootstrap/match.tpl.html",'<button type="button" class="btn btn-default form-control ui-select-match" tabindex="-1" ng-hide="$select.open" ng-disabled="$select.disabled" ng-class="{\'btn-default-focus\':$select.focus}" ;="" ng-click="$select.activate()"><span ng-show="$select.searchEnabled && $select.isEmpty()" class="text-muted">{{$select.placeholder}}</span> <span ng-hide="$select.isEmpty()" ng-transclude=""></span> <span class="caret ui-select-toggle" ng-click="$select.toggle($event)"></span></button>'),$templateCache.put("bootstrap/select-multiple.tpl.html",'<div class="ui-select-multiple ui-select-bootstrap dropdown form-control" ng-class="{open: $select.open}"><div><div class="ui-select-match"></div><input type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" class="ui-select-search input-xs" placeholder="{{$select.getPlaceholder()}}" ng-disabled="$select.disabled" ng-hide="$select.disabled" ng-click="$select.activate()" ng-model="$select.search"></div><div class="ui-select-choices"></div></div>'),$templateCache.put("bootstrap/select.tpl.html",'<div class="ui-select-bootstrap dropdown" ng-class="{open: $select.open}"><div class="ui-select-match"></div><input type="text" autocomplete="off" tabindex="-1" class="form-control ui-select-search" placeholder="{{$select.placeholder}}" ng-model="$select.search" ng-show="$select.searchEnabled && $select.open"><div class="ui-select-choices"></div></div>'),$templateCache.put("select2/choices.tpl.html",'<ul class="ui-select-choices ui-select-choices-content select2-results"><li class="ui-select-choices-group" ng-class="{\'select2-result-with-children\': $select.isGrouped}"><div ng-show="$select.isGrouped" class="ui-select-choices-group-label select2-result-label">{{$group.name}}</div><ul ng-class="{\'select2-result-sub\': $select.isGrouped, \'select2-result-single\': !$select.isGrouped}"><li class="ui-select-choices-row" ng-class="{\'select2-highlighted\': $select.isActive(this), \'select2-disabled\': $select.isDisabled(this)}"><div class="select2-result-label ui-select-choices-row-inner"></div></li></ul></li></ul>'),$templateCache.put("select2/match-multiple.tpl.html",'<span class="ui-select-match"><li class="ui-select-match-item select2-search-choice" ng-repeat="$item in $select.selected" ng-class="{\'select2-search-choice-focus\':$select.activeMatchIndex === $index}"><span uis-transclude-append=""></span> <a href="javascript:;" class="ui-select-match-close select2-search-choice-close" ng-click="$select.removeChoice($index)" tabindex="-1"></a></li></span>'),$templateCache.put("select2/match.tpl.html",'<a class="select2-choice ui-select-match" ng-class="{\'select2-default\': $select.isEmpty()}" ng-click="$select.activate()"><span ng-show="$select.searchEnabled && $select.isEmpty()" class="select2-chosen">{{$select.placeholder}}</span> <span ng-hide="$select.isEmpty()" class="select2-chosen" ng-transclude=""></span> <span class="select2-arrow ui-select-toggle" ng-click="$select.toggle($event)"><b></b></span></a>'),$templateCache.put("select2/select-multiple.tpl.html",'<div class="ui-select-multiple select2 select2-container select2-container-multi" ng-class="{\'select2-container-active select2-dropdown-open\': $select.open,\n                \'select2-container-disabled\': $select.disabled}"><ul class="select2-choices"><span class="ui-select-match"></span><li class="select2-search-field"><input type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" class="select2-input ui-select-search" placeholder="{{$select.getPlaceholder()}}" ng-disabled="$select.disabled" ng-hide="$select.disabled" ng-model="$select.search" ng-click="$select.activate()" style="width: 34px;"></li></ul><div class="select2-drop select2-with-searchbox select2-drop-active" ng-class="{\'select2-display-none\': !$select.open}"><div class="ui-select-choices"></div></div></div>'),$templateCache.put("select2/select.tpl.html",'<div class="select2 select2-container" ng-class="{\'select2-container-active select2-dropdown-open\': $select.open,\n                \'select2-container-disabled\': $select.disabled,\n                \'select2-container-active\': $select.focus }"><div class="ui-select-match"></div><div class="select2-drop select2-with-searchbox select2-drop-active" ng-class="{\'select2-display-none\': !$select.open}"><div class="select2-search" ng-show="$select.searchEnabled"><input type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" class="ui-select-search select2-input" ng-model="$select.search"></div><div class="ui-select-choices"></div></div></div>'),$templateCache.put("selectize/choices.tpl.html",'<div ng-show="$select.open" class="ui-select-choices selectize-dropdown single"><div class="ui-select-choices-content selectize-dropdown-content"><div class="ui-select-choices-group optgroup"><div ng-show="$select.isGrouped" class="ui-select-choices-group-label optgroup-header">{{$group.name}}</div><div class="ui-select-choices-row" ng-class="{active: $select.isActive(this), disabled: $select.isDisabled(this)}"><div class="option ui-select-choices-row-inner" data-selectable=""></div></div></div></div></div>'),$templateCache.put("selectize/match.tpl.html",'<div ng-hide="$select.searchEnabled && ($select.open || $select.isEmpty())" class="ui-select-match" ng-transclude=""></div>'),$templateCache.put("selectize/select.tpl.html",'<div class="selectize-control single"><div class="selectize-input" ng-class="{\'focus\': $select.open, \'disabled\': $select.disabled, \'selectize-focus\' : $select.focus}" ng-click="$select.activate()"><div class="ui-select-match"></div><input type="text" autocomplete="off" tabindex="-1" class="ui-select-search ui-select-toggle" ng-click="$select.toggle($event)" placeholder="{{$select.placeholder}}" ng-model="$select.search" ng-hide="!$select.searchEnabled || ($select.selected && !$select.open)" ng-disabled="$select.disabled"></div><div class="ui-select-choices"></div></div>')}]);var qrcode=function(){function qrPolynomial(num,shift){if("undefined"==typeof num.length)throw new Error(num.length+"/"+shift);var _num=function(){for(var offset=0;offset<num.length&&0==num[offset];)offset+=1;for(var _num=new Array(num.length-offset+shift),i=0;i<num.length-offset;i+=1)_num[i]=num[i+offset];return _num}(),_this={};return _this.getAt=function(index){return _num[index]},_this.getLength=function(){return _num.length},_this.multiply=function(e){for(var num=new Array(_this.getLength()+e.getLength()-1),i=0;i<_this.getLength();i+=1)for(var j=0;j<e.getLength();j+=1)num[i+j]^=QRMath.gexp(QRMath.glog(_this.getAt(i))+QRMath.glog(e.getAt(j)));return qrPolynomial(num,0)},_this.mod=function(e){if(_this.getLength()-e.getLength()<0)return _this;for(var ratio=QRMath.glog(_this.getAt(0))-QRMath.glog(e.getAt(0)),num=new Array(_this.getLength()),i=0;i<_this.getLength();i+=1)num[i]=_this.getAt(i);for(var i=0;i<e.getLength();i+=1)num[i]^=QRMath.gexp(QRMath.glog(e.getAt(i))+ratio);return qrPolynomial(num,0).mod(e)},_this}var qrcode=function(typeNumber,errorCorrectLevel){var PAD0=236,PAD1=17,_typeNumber=typeNumber,_errorCorrectLevel=QRErrorCorrectLevel[errorCorrectLevel],_modules=null,_moduleCount=0,_dataCache=null,_dataList=new Array,_this={},makeImpl=function(test,maskPattern){_moduleCount=4*_typeNumber+17,_modules=function(moduleCount){for(var modules=new Array(moduleCount),row=0;moduleCount>row;row+=1){modules[row]=new Array(moduleCount);for(var col=0;moduleCount>col;col+=1)modules[row][col]=null}return modules}(_moduleCount),setupPositionProbePattern(0,0),setupPositionProbePattern(_moduleCount-7,0),setupPositionProbePattern(0,_moduleCount-7),setupPositionAdjustPattern(),setupTimingPattern(),setupTypeInfo(test,maskPattern),_typeNumber>=7&&setupTypeNumber(test),null==_dataCache&&(_dataCache=createData(_typeNumber,_errorCorrectLevel,_dataList)),mapData(_dataCache,maskPattern)},setupPositionProbePattern=function(row,col){for(var r=-1;7>=r;r+=1)if(!(-1>=row+r||row+r>=_moduleCount))for(var c=-1;7>=c;c+=1)-1>=col+c||col+c>=_moduleCount||(r>=0&&6>=r&&(0==c||6==c)||c>=0&&6>=c&&(0==r||6==r)||r>=2&&4>=r&&c>=2&&4>=c?_modules[row+r][col+c]=!0:_modules[row+r][col+c]=!1)},getBestMaskPattern=function(){for(var minLostPoint=0,pattern=0,i=0;8>i;i+=1){makeImpl(!0,i);var lostPoint=QRUtil.getLostPoint(_this);(0==i||minLostPoint>lostPoint)&&(minLostPoint=lostPoint,pattern=i)}return pattern},setupTimingPattern=function(){for(var r=8;_moduleCount-8>r;r+=1)null==_modules[r][6]&&(_modules[r][6]=r%2==0);for(var c=8;_moduleCount-8>c;c+=1)null==_modules[6][c]&&(_modules[6][c]=c%2==0)},setupPositionAdjustPattern=function(){for(var pos=QRUtil.getPatternPosition(_typeNumber),i=0;i<pos.length;i+=1)for(var j=0;j<pos.length;j+=1){var row=pos[i],col=pos[j];if(null==_modules[row][col])for(var r=-2;2>=r;r+=1)for(var c=-2;2>=c;c+=1)-2==r||2==r||-2==c||2==c||0==r&&0==c?_modules[row+r][col+c]=!0:_modules[row+r][col+c]=!1}},setupTypeNumber=function(test){for(var bits=QRUtil.getBCHTypeNumber(_typeNumber),i=0;18>i;i+=1){var mod=!test&&1==(bits>>i&1);_modules[Math.floor(i/3)][i%3+_moduleCount-8-3]=mod}for(var i=0;18>i;i+=1){var mod=!test&&1==(bits>>i&1);_modules[i%3+_moduleCount-8-3][Math.floor(i/3)]=mod}},setupTypeInfo=function(test,maskPattern){for(var data=_errorCorrectLevel<<3|maskPattern,bits=QRUtil.getBCHTypeInfo(data),i=0;15>i;i+=1){var mod=!test&&1==(bits>>i&1);6>i?_modules[i][8]=mod:8>i?_modules[i+1][8]=mod:_modules[_moduleCount-15+i][8]=mod}for(var i=0;15>i;i+=1){var mod=!test&&1==(bits>>i&1);8>i?_modules[8][_moduleCount-i-1]=mod:9>i?_modules[8][15-i-1+1]=mod:_modules[8][15-i-1]=mod}_modules[_moduleCount-8][8]=!test},mapData=function(data,maskPattern){for(var inc=-1,row=_moduleCount-1,bitIndex=7,byteIndex=0,maskFunc=QRUtil.getMaskFunction(maskPattern),col=_moduleCount-1;col>0;col-=2)for(6==col&&(col-=1);;){for(var c=0;2>c;c+=1)if(null==_modules[row][col-c]){var dark=!1;byteIndex<data.length&&(dark=1==(data[byteIndex]>>>bitIndex&1));var mask=maskFunc(row,col-c);mask&&(dark=!dark),_modules[row][col-c]=dark,bitIndex-=1,-1==bitIndex&&(byteIndex+=1,bitIndex=7)}if(row+=inc,0>row||row>=_moduleCount){row-=inc,inc=-inc;break}}},createBytes=function(buffer,rsBlocks){for(var offset=0,maxDcCount=0,maxEcCount=0,dcdata=new Array(rsBlocks.length),ecdata=new Array(rsBlocks.length),r=0;r<rsBlocks.length;r+=1){var dcCount=rsBlocks[r].dataCount,ecCount=rsBlocks[r].totalCount-dcCount;maxDcCount=Math.max(maxDcCount,dcCount),maxEcCount=Math.max(maxEcCount,ecCount),dcdata[r]=new Array(dcCount);for(var i=0;i<dcdata[r].length;i+=1)dcdata[r][i]=255&buffer.getBuffer()[i+offset];offset+=dcCount;var rsPoly=QRUtil.getErrorCorrectPolynomial(ecCount),rawPoly=qrPolynomial(dcdata[r],rsPoly.getLength()-1),modPoly=rawPoly.mod(rsPoly);ecdata[r]=new Array(rsPoly.getLength()-1);for(var i=0;i<ecdata[r].length;i+=1){var modIndex=i+modPoly.getLength()-ecdata[r].length;ecdata[r][i]=modIndex>=0?modPoly.getAt(modIndex):0}}for(var totalCodeCount=0,i=0;i<rsBlocks.length;i+=1)totalCodeCount+=rsBlocks[i].totalCount;for(var data=new Array(totalCodeCount),index=0,i=0;maxDcCount>i;i+=1)for(var r=0;r<rsBlocks.length;r+=1)i<dcdata[r].length&&(data[index]=dcdata[r][i],index+=1);for(var i=0;maxEcCount>i;i+=1)for(var r=0;r<rsBlocks.length;r+=1)i<ecdata[r].length&&(data[index]=ecdata[r][i],index+=1);return data},createData=function(typeNumber,errorCorrectLevel,dataList){for(var rsBlocks=QRRSBlock.getRSBlocks(typeNumber,errorCorrectLevel),buffer=qrBitBuffer(),i=0;i<dataList.length;i+=1){var data=dataList[i];buffer.put(data.getMode(),4),buffer.put(data.getLength(),QRUtil.getLengthInBits(data.getMode(),typeNumber)),data.write(buffer)}for(var totalDataCount=0,i=0;i<rsBlocks.length;i+=1)totalDataCount+=rsBlocks[i].dataCount;if(buffer.getLengthInBits()>8*totalDataCount)throw new Error("code length overflow. ("+buffer.getLengthInBits()+">"+8*totalDataCount+")");for(buffer.getLengthInBits()+4<=8*totalDataCount&&buffer.put(0,4);buffer.getLengthInBits()%8!=0;)buffer.putBit(!1);for(;;){if(buffer.getLengthInBits()>=8*totalDataCount)break;if(buffer.put(PAD0,8),buffer.getLengthInBits()>=8*totalDataCount)break;
buffer.put(PAD1,8)}return createBytes(buffer,rsBlocks)};return _this.addData=function(data){var newData=qr8BitByte(data);_dataList.push(newData),_dataCache=null},_this.isDark=function(row,col){if(0>row||row>=_moduleCount||0>col||col>=_moduleCount)throw new Error(row+","+col);return _modules[row][col]},_this.getModuleCount=function(){return _moduleCount},_this.make=function(){makeImpl(!1,getBestMaskPattern())},_this.createTableTag=function(cellSize,margin){cellSize=cellSize||2,margin="undefined"==typeof margin?4*cellSize:margin;var qrHtml="";qrHtml+='<table style="',qrHtml+=" border-width: 0px; border-style: none;",qrHtml+=" border-collapse: collapse;",qrHtml+=" padding: 0px; margin: "+margin+"px;",qrHtml+='">',qrHtml+="<tbody>";for(var r=0;r<_this.getModuleCount();r+=1){qrHtml+="<tr>";for(var c=0;c<_this.getModuleCount();c+=1)qrHtml+='<td style="',qrHtml+=" border-width: 0px; border-style: none;",qrHtml+=" border-collapse: collapse;",qrHtml+=" padding: 0px; margin: 0px;",qrHtml+=" width: "+cellSize+"px;",qrHtml+=" height: "+cellSize+"px;",qrHtml+=" background-color: ",qrHtml+=_this.isDark(r,c)?"#000000":"#ffffff",qrHtml+=";",qrHtml+='"/>';qrHtml+="</tr>"}return qrHtml+="</tbody>",qrHtml+="</table>"},_this.createImgTag=function(cellSize,margin){cellSize=cellSize||2,margin="undefined"==typeof margin?4*cellSize:margin;var size=_this.getModuleCount()*cellSize+2*margin,min=margin,max=size-margin;return createImgTag(size,size,function(x,y){if(x>=min&&max>x&&y>=min&&max>y){var c=Math.floor((x-min)/cellSize),r=Math.floor((y-min)/cellSize);return _this.isDark(r,c)?0:1}return 1})},_this};qrcode.stringToBytes=function(s){for(var bytes=new Array,i=0;i<s.length;i+=1){var c=s.charCodeAt(i);bytes.push(255&c)}return bytes},qrcode.createStringToBytes=function(unicodeData,numChars){var unicodeMap=function(){for(var bin=base64DecodeInputStream(unicodeData),read=function(){var b=bin.read();if(-1==b)throw new Error;return b},count=0,unicodeMap={};;){var b0=bin.read();if(-1==b0)break;var b1=read(),b2=read(),b3=read(),k=String.fromCharCode(b0<<8|b1),v=b2<<8|b3;unicodeMap[k]=v,count+=1}if(count!=numChars)throw new Error(count+" != "+numChars);return unicodeMap}(),unknownChar="?".charCodeAt(0);return function(s){for(var bytes=new Array,i=0;i<s.length;i+=1){var c=s.charCodeAt(i);if(128>c)bytes.push(c);else{var b=unicodeMap[s.charAt(i)];"number"==typeof b?(255&b)==b?bytes.push(b):(bytes.push(b>>>8),bytes.push(255&b)):bytes.push(unknownChar)}}return bytes}};var QRMode={MODE_NUMBER:1,MODE_ALPHA_NUM:2,MODE_8BIT_BYTE:4,MODE_KANJI:8},QRErrorCorrectLevel={L:1,M:0,Q:3,H:2},QRMaskPattern={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7},QRUtil=function(){var PATTERN_POSITION_TABLE=[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],G15=1335,G18=7973,G15_MASK=21522,_this={},getBCHDigit=function(data){for(var digit=0;0!=data;)digit+=1,data>>>=1;return digit};return _this.getBCHTypeInfo=function(data){for(var d=data<<10;getBCHDigit(d)-getBCHDigit(G15)>=0;)d^=G15<<getBCHDigit(d)-getBCHDigit(G15);return(data<<10|d)^G15_MASK},_this.getBCHTypeNumber=function(data){for(var d=data<<12;getBCHDigit(d)-getBCHDigit(G18)>=0;)d^=G18<<getBCHDigit(d)-getBCHDigit(G18);return data<<12|d},_this.getPatternPosition=function(typeNumber){return PATTERN_POSITION_TABLE[typeNumber-1]},_this.getMaskFunction=function(maskPattern){switch(maskPattern){case QRMaskPattern.PATTERN000:return function(i,j){return(i+j)%2==0};case QRMaskPattern.PATTERN001:return function(i,j){return i%2==0};case QRMaskPattern.PATTERN010:return function(i,j){return j%3==0};case QRMaskPattern.PATTERN011:return function(i,j){return(i+j)%3==0};case QRMaskPattern.PATTERN100:return function(i,j){return(Math.floor(i/2)+Math.floor(j/3))%2==0};case QRMaskPattern.PATTERN101:return function(i,j){return i*j%2+i*j%3==0};case QRMaskPattern.PATTERN110:return function(i,j){return(i*j%2+i*j%3)%2==0};case QRMaskPattern.PATTERN111:return function(i,j){return(i*j%3+(i+j)%2)%2==0};default:throw new Error("bad maskPattern:"+maskPattern)}},_this.getErrorCorrectPolynomial=function(errorCorrectLength){for(var a=qrPolynomial([1],0),i=0;errorCorrectLength>i;i+=1)a=a.multiply(qrPolynomial([1,QRMath.gexp(i)],0));return a},_this.getLengthInBits=function(mode,type){if(type>=1&&10>type)switch(mode){case QRMode.MODE_NUMBER:return 10;case QRMode.MODE_ALPHA_NUM:return 9;case QRMode.MODE_8BIT_BYTE:return 8;case QRMode.MODE_KANJI:return 8;default:throw new Error("mode:"+mode)}else if(27>type)switch(mode){case QRMode.MODE_NUMBER:return 12;case QRMode.MODE_ALPHA_NUM:return 11;case QRMode.MODE_8BIT_BYTE:return 16;case QRMode.MODE_KANJI:return 10;default:throw new Error("mode:"+mode)}else{if(!(41>type))throw new Error("type:"+type);switch(mode){case QRMode.MODE_NUMBER:return 14;case QRMode.MODE_ALPHA_NUM:return 13;case QRMode.MODE_8BIT_BYTE:return 16;case QRMode.MODE_KANJI:return 12;default:throw new Error("mode:"+mode)}}},_this.getLostPoint=function(qrcode){for(var moduleCount=qrcode.getModuleCount(),lostPoint=0,row=0;moduleCount>row;row+=1)for(var col=0;moduleCount>col;col+=1){for(var sameCount=0,dark=qrcode.isDark(row,col),r=-1;1>=r;r+=1)if(!(0>row+r||row+r>=moduleCount))for(var c=-1;1>=c;c+=1)0>col+c||col+c>=moduleCount||(0!=r||0!=c)&&dark==qrcode.isDark(row+r,col+c)&&(sameCount+=1);sameCount>5&&(lostPoint+=3+sameCount-5)}for(var row=0;moduleCount-1>row;row+=1)for(var col=0;moduleCount-1>col;col+=1){var count=0;qrcode.isDark(row,col)&&(count+=1),qrcode.isDark(row+1,col)&&(count+=1),qrcode.isDark(row,col+1)&&(count+=1),qrcode.isDark(row+1,col+1)&&(count+=1),(0==count||4==count)&&(lostPoint+=3)}for(var row=0;moduleCount>row;row+=1)for(var col=0;moduleCount-6>col;col+=1)qrcode.isDark(row,col)&&!qrcode.isDark(row,col+1)&&qrcode.isDark(row,col+2)&&qrcode.isDark(row,col+3)&&qrcode.isDark(row,col+4)&&!qrcode.isDark(row,col+5)&&qrcode.isDark(row,col+6)&&(lostPoint+=40);for(var col=0;moduleCount>col;col+=1)for(var row=0;moduleCount-6>row;row+=1)qrcode.isDark(row,col)&&!qrcode.isDark(row+1,col)&&qrcode.isDark(row+2,col)&&qrcode.isDark(row+3,col)&&qrcode.isDark(row+4,col)&&!qrcode.isDark(row+5,col)&&qrcode.isDark(row+6,col)&&(lostPoint+=40);for(var darkCount=0,col=0;moduleCount>col;col+=1)for(var row=0;moduleCount>row;row+=1)qrcode.isDark(row,col)&&(darkCount+=1);var ratio=Math.abs(100*darkCount/moduleCount/moduleCount-50)/5;return lostPoint+=10*ratio},_this}(),QRMath=function(){for(var EXP_TABLE=new Array(256),LOG_TABLE=new Array(256),i=0;8>i;i+=1)EXP_TABLE[i]=1<<i;for(var i=8;256>i;i+=1)EXP_TABLE[i]=EXP_TABLE[i-4]^EXP_TABLE[i-5]^EXP_TABLE[i-6]^EXP_TABLE[i-8];for(var i=0;255>i;i+=1)LOG_TABLE[EXP_TABLE[i]]=i;var _this={};return _this.glog=function(n){if(1>n)throw new Error("glog("+n+")");return LOG_TABLE[n]},_this.gexp=function(n){for(;0>n;)n+=255;for(;n>=256;)n-=255;return EXP_TABLE[n]},_this}(),QRRSBlock=function(){var RS_BLOCK_TABLE=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16]],qrRSBlock=function(totalCount,dataCount){var _this={};return _this.totalCount=totalCount,_this.dataCount=dataCount,_this},_this={},getRsBlockTable=function(typeNumber,errorCorrectLevel){switch(errorCorrectLevel){case QRErrorCorrectLevel.L:return RS_BLOCK_TABLE[4*(typeNumber-1)+0];case QRErrorCorrectLevel.M:return RS_BLOCK_TABLE[4*(typeNumber-1)+1];case QRErrorCorrectLevel.Q:return RS_BLOCK_TABLE[4*(typeNumber-1)+2];case QRErrorCorrectLevel.H:return RS_BLOCK_TABLE[4*(typeNumber-1)+3];default:return void 0}};return _this.getRSBlocks=function(typeNumber,errorCorrectLevel){var rsBlock=getRsBlockTable(typeNumber,errorCorrectLevel);if("undefined"==typeof rsBlock)throw new Error("bad rs block @ typeNumber:"+typeNumber+"/errorCorrectLevel:"+errorCorrectLevel);for(var length=rsBlock.length/3,list=new Array,i=0;length>i;i+=1)for(var count=rsBlock[3*i+0],totalCount=rsBlock[3*i+1],dataCount=rsBlock[3*i+2],j=0;count>j;j+=1)list.push(qrRSBlock(totalCount,dataCount));return list},_this}(),qrBitBuffer=function(){var _buffer=new Array,_length=0,_this={};return _this.getBuffer=function(){return _buffer},_this.getAt=function(index){var bufIndex=Math.floor(index/8);return 1==(_buffer[bufIndex]>>>7-index%8&1)},_this.put=function(num,length){for(var i=0;length>i;i+=1)_this.putBit(1==(num>>>length-i-1&1))},_this.getLengthInBits=function(){return _length},_this.putBit=function(bit){var bufIndex=Math.floor(_length/8);_buffer.length<=bufIndex&&_buffer.push(0),bit&&(_buffer[bufIndex]|=128>>>_length%8),_length+=1},_this},qr8BitByte=function(data){var _mode=QRMode.MODE_8BIT_BYTE,_bytes=qrcode.stringToBytes(data),_this={};return _this.getMode=function(){return _mode},_this.getLength=function(buffer){return _bytes.length},_this.write=function(buffer){for(var i=0;i<_bytes.length;i+=1)buffer.put(_bytes[i],8)},_this},byteArrayOutputStream=function(){var _bytes=new Array,_this={};return _this.writeByte=function(b){_bytes.push(255&b)},_this.writeShort=function(i){_this.writeByte(i),_this.writeByte(i>>>8)},_this.writeBytes=function(b,off,len){off=off||0,len=len||b.length;for(var i=0;len>i;i+=1)_this.writeByte(b[i+off])},_this.writeString=function(s){for(var i=0;i<s.length;i+=1)_this.writeByte(s.charCodeAt(i))},_this.toByteArray=function(){return _bytes},_this.toString=function(){var s="";s+="[";for(var i=0;i<_bytes.length;i+=1)i>0&&(s+=","),s+=_bytes[i];return s+="]"},_this},base64EncodeOutputStream=function(){var _buffer=0,_buflen=0,_length=0,_base64="",_this={},writeEncoded=function(b){_base64+=String.fromCharCode(encode(63&b))},encode=function(n){if(0>n);else{if(26>n)return 65+n;if(52>n)return 97+(n-26);if(62>n)return 48+(n-52);if(62==n)return 43;if(63==n)return 47}throw new Error("n:"+n)};return _this.writeByte=function(n){for(_buffer=_buffer<<8|255&n,_buflen+=8,_length+=1;_buflen>=6;)writeEncoded(_buffer>>>_buflen-6),_buflen-=6},_this.flush=function(){if(_buflen>0&&(writeEncoded(_buffer<<6-_buflen),_buffer=0,_buflen=0),_length%3!=0)for(var padlen=3-_length%3,i=0;padlen>i;i+=1)_base64+="="},_this.toString=function(){return _base64},_this},base64DecodeInputStream=function(str){var _str=str,_pos=0,_buffer=0,_buflen=0,_this={};_this.read=function(){for(;8>_buflen;){if(_pos>=_str.length){if(0==_buflen)return-1;throw new Error("unexpected end of file./"+_buflen)}var c=_str.charAt(_pos);if(_pos+=1,"="==c)return _buflen=0,-1;c.match(/^\s$/)||(_buffer=_buffer<<6|decode(c.charCodeAt(0)),_buflen+=6)}var n=_buffer>>>_buflen-8&255;return _buflen-=8,n};var decode=function(c){if(c>=65&&90>=c)return c-65;if(c>=97&&122>=c)return c-97+26;if(c>=48&&57>=c)return c-48+52;if(43==c)return 62;if(47==c)return 63;throw new Error("c:"+c)};return _this},gifImage=function(width,height){var _width=width,_height=height,_data=new Array(width*height),_this={};_this.setPixel=function(x,y,pixel){_data[y*_width+x]=pixel},_this.write=function(out){out.writeString("GIF87a"),out.writeShort(_width),out.writeShort(_height),out.writeByte(128),out.writeByte(0),out.writeByte(0),out.writeByte(0),out.writeByte(0),out.writeByte(0),out.writeByte(255),out.writeByte(255),out.writeByte(255),out.writeString(","),out.writeShort(0),out.writeShort(0),out.writeShort(_width),out.writeShort(_height),out.writeByte(0);var lzwMinCodeSize=2,raster=getLZWRaster(lzwMinCodeSize);out.writeByte(lzwMinCodeSize);for(var offset=0;raster.length-offset>255;)out.writeByte(255),out.writeBytes(raster,offset,255),offset+=255;out.writeByte(raster.length-offset),out.writeBytes(raster,offset,raster.length-offset),out.writeByte(0),out.writeString(";")};var bitOutputStream=function(out){var _out=out,_bitLength=0,_bitBuffer=0,_this={};return _this.write=function(data,length){if(data>>>length!=0)throw new Error("length over");for(;_bitLength+length>=8;)_out.writeByte(255&(data<<_bitLength|_bitBuffer)),length-=8-_bitLength,data>>>=8-_bitLength,_bitBuffer=0,_bitLength=0;_bitBuffer=data<<_bitLength|_bitBuffer,_bitLength+=length},_this.flush=function(){_bitLength>0&&_out.writeByte(_bitBuffer)},_this},getLZWRaster=function(lzwMinCodeSize){for(var clearCode=1<<lzwMinCodeSize,endCode=(1<<lzwMinCodeSize)+1,bitLength=lzwMinCodeSize+1,table=lzwTable(),i=0;clearCode>i;i+=1)table.add(String.fromCharCode(i));table.add(String.fromCharCode(clearCode)),table.add(String.fromCharCode(endCode));var byteOut=byteArrayOutputStream(),bitOut=bitOutputStream(byteOut);bitOut.write(clearCode,bitLength);var dataIndex=0,s=String.fromCharCode(_data[dataIndex]);for(dataIndex+=1;dataIndex<_data.length;){var c=String.fromCharCode(_data[dataIndex]);dataIndex+=1,table.contains(s+c)?s+=c:(bitOut.write(table.indexOf(s),bitLength),table.size()<4095&&(table.size()==1<<bitLength&&(bitLength+=1),table.add(s+c)),s=c)}return bitOut.write(table.indexOf(s),bitLength),bitOut.write(endCode,bitLength),bitOut.flush(),byteOut.toByteArray()},lzwTable=function(){var _map={},_size=0,_this={};return _this.add=function(key){if(_this.contains(key))throw new Error("dup key:"+key);_map[key]=_size,_size+=1},_this.size=function(){return _size},_this.indexOf=function(key){return _map[key]},_this.contains=function(key){return"undefined"!=typeof _map[key]},_this};return _this},createImgTag=function(width,height,getPixel,alt){for(var gif=gifImage(width,height),y=0;height>y;y+=1)for(var x=0;width>x;x+=1)gif.setPixel(x,y,getPixel(x,y));var b=byteArrayOutputStream();gif.write(b);for(var base64=base64EncodeOutputStream(),bytes=b.toByteArray(),i=0;i<bytes.length;i+=1)base64.writeByte(bytes[i]);base64.flush();var img="";return img+="<img",img+=' src="',img+="data:image/gif;base64,",img+=base64,img+='"',img+=' width="',img+=width,img+='"',img+=' height="',img+=height,img+='"',alt&&(img+=' alt="',img+=alt,img+='"'),img+="/>"};return qrcode}();angular.module("monospaced.qrcode",[]).directive("qrcode",["$window",function($window){var canvas2D=!!$window.CanvasRenderingContext2D,levels={L:"Low",M:"Medium",Q:"Quartile",H:"High"},draw=function(context,qr,modules,tile){for(var row=0;modules>row;row++)for(var col=0;modules>col;col++){var w=Math.ceil((col+1)*tile)-Math.floor(col*tile),h=Math.ceil((row+1)*tile)-Math.floor(row*tile);context.fillStyle=qr.isDark(row,col)?"#000":"#fff",context.fillRect(Math.round(col*tile),Math.round(row*tile),w,h)}};return{restrict:"E",template:'<a class="qrcode" style="display: table;"><canvas style="display: block; max-width: 100%;"></canvas></a>',link:function(scope,element,attrs){var error,version,errorCorrectionLevel,data,size,modules,tile,qr,domElement=element[0],canvas=element.find("canvas")[0],link=element.find("a")[0],context=canvas2D?canvas.getContext("2d"):null,trim=/^\s+|\s+$/g,setVersion=function(value){version=Math.max(1,Math.min(parseInt(value,10),10))||4},setErrorCorrectionLevel=function(value){errorCorrectionLevel=value in levels?value:"M"},setData=function(value){if(value){data=value.replace(trim,""),qr=qrcode(version,errorCorrectionLevel),qr.addData(data);try{qr.make()}catch(e){return void(error=e.message)}error=!1,modules=qr.getModuleCount()}},setSize=function(value){size=parseInt(value,10)||2*modules,tile=size/modules,canvas.width=canvas.height=size},render=function(){return qr?error?(canvas2D?(link.download="",link.href=""):domElement.innerHTML='<img src width="'+size+'"height="'+size+'"class="qrcode"style="display: block;max-width: 100%;">',void scope.$emit("qrcode:error",error)):void(canvas2D?(draw(context,qr,modules,tile),link.download="qrcode.png",link.href=canvas.toDataURL("image/png")):(domElement.innerHTML=qr.createImgTag(tile,0),element.find("img").addClass("qrcode").css({display:"block","max-width":"100%"}))):void 0};setVersion(attrs.version),setErrorCorrectionLevel(attrs.errorCorrectionLevel),setSize(attrs.size),attrs.$observe("version",function(value){value&&(setVersion(value),setData(data),setSize(size),render())}),attrs.$observe("errorCorrectionLevel",function(value){value&&(setErrorCorrectionLevel(value),setData(data),setSize(size),render())}),attrs.$observe("data",function(value){value&&(setData(value),setSize(size),render())}),attrs.$observe("size",function(value){value&&(setSize(value),render())})}}}]),function(){var angularFileUpload=angular.module("angularFileUpload",[]);angularFileUpload.service("$upload",["$http","$q","$timeout",function($http,$q,$timeout){function sendHttp(config){config.method=config.method||"POST",config.headers=config.headers||{},config.transformRequest=config.transformRequest||function(data,headersGetter){return window.ArrayBuffer&&data instanceof window.ArrayBuffer?data:$http.defaults.transformRequest[0](data,headersGetter)};var deferred=$q.defer();window.XMLHttpRequest.__isShim&&(config.headers.__setXHR_=function(){return function(xhr){xhr&&(config.__XHR=xhr,config.xhrFn&&config.xhrFn(xhr),xhr.upload.addEventListener("progress",function(e){deferred.notify(e)},!1),xhr.upload.addEventListener("load",function(e){e.lengthComputable&&deferred.notify(e)},!1))}}),$http(config).then(function(r){deferred.resolve(r)},function(e){deferred.reject(e)},function(n){deferred.notify(n)});var promise=deferred.promise;return promise.success=function(fn){return promise.then(function(response){fn(response.data,response.status,response.headers,config)}),promise},promise.error=function(fn){return promise.then(null,function(response){fn(response.data,response.status,response.headers,config)}),promise},promise.progress=function(fn){return promise.then(null,null,function(update){fn(update)}),promise},promise.abort=function(){return config.__XHR&&$timeout(function(){config.__XHR.abort()}),promise},promise.xhr=function(fn){return config.xhrFn=function(origXhrFn){return function(){origXhrFn&&origXhrFn.apply(promise,arguments),fn.apply(promise,arguments)}}(config.xhrFn),promise},promise}this.upload=function(config){config.headers=config.headers||{},config.headers["Content-Type"]=void 0,config.transformRequest=config.transformRequest||$http.defaults.transformRequest;var formData=new FormData,origTransformRequest=config.transformRequest,origData=config.data;return config.transformRequest=function(formData,headerGetter){if(origData)if(config.formDataAppender)for(var key in origData){var val=origData[key];config.formDataAppender(formData,key,val)}else for(var key in origData){var val=origData[key];if("function"==typeof origTransformRequest)val=origTransformRequest(val,headerGetter);else for(var i=0;i<origTransformRequest.length;i++){var transformFn=origTransformRequest[i];"function"==typeof transformFn&&(val=transformFn(val,headerGetter))}formData.append(key,val)}if(null!=config.file){var fileFormName=config.fileFormDataName||"file";if("[object Array]"===Object.prototype.toString.call(config.file))for(var isFileFormNameString="[object String]"===Object.prototype.toString.call(fileFormName),i=0;i<config.file.length;i++)formData.append(isFileFormNameString?fileFormName:fileFormName[i],config.file[i],config.fileName&&config.fileName[i]||config.file[i].name);else formData.append(fileFormName,config.file,config.fileName||config.file.name)}return formData},config.data=formData,sendHttp(config)},this.http=function(config){return sendHttp(config)}}]),angularFileUpload.directive("ngFileSelect",["$parse","$timeout",function($parse,$timeout){return function(scope,elem,attr){var fn=$parse(attr.ngFileSelect);if("input"!==elem[0].tagName.toLowerCase()||"file"!==(elem.attr("type")&&elem.attr("type").toLowerCase())){for(var fileElem=angular.element('<input type="file">'),attrs=elem[0].attributes,i=0;i<attrs.length;i++)"type"!==attrs[i].name.toLowerCase()&&fileElem.attr(attrs[i].name,attrs[i].value);attr.multiple&&fileElem.attr("multiple","true"),fileElem.css("width","1px").css("height","1px").css("opacity",0).css("position","absolute").css("filter","alpha(opacity=0)").css("padding",0).css("margin",0).css("overflow","hidden"),fileElem.attr("__wrapper_for_parent_",!0),elem.append(fileElem),elem[0].__file_click_fn_delegate_=function(){fileElem[0].click()},elem.bind("click",elem[0].__file_click_fn_delegate_),elem.css("overflow","hidden"),elem=fileElem}elem.bind("change",function(evt){var fileList,i,files=[];if(fileList=evt.__files_||evt.target.files,null!=fileList)for(i=0;i<fileList.length;i++)files.push(fileList.item(i));$timeout(function(){fn(scope,{$files:files,$event:evt})})})}}]),angularFileUpload.directive("ngFileDropAvailable",["$parse","$timeout",function($parse,$timeout){return function(scope,elem,attr){if("draggable"in document.createElement("span")){var fn=$parse(attr.ngFileDropAvailable);$timeout(function(){fn(scope)})}}}]),angularFileUpload.directive("ngFileDrop",["$parse","$timeout","$location",function($parse,$timeout,$location){return function(scope,elem,attr){function isASCII(str){return/^[\000-\177]*$/.test(str)}function extractFiles(evt,callback){var files=[],items=evt.dataTransfer.items;if(items&&items.length>0&&items[0].webkitGetAsEntry&&"file"!=$location.protocol()&&items[0].webkitGetAsEntry().isDirectory)for(var i=0;i<items.length;i++){var entry=items[i].webkitGetAsEntry();null!=entry&&(isASCII(entry.name)?traverseFileTree(files,entry):items[i].webkitGetAsEntry().isDirectory||files.push(items[i].getAsFile()))}else{var fileList=evt.dataTransfer.files;if(null!=fileList)for(var i=0;i<fileList.length;i++)files.push(fileList.item(i))}!function waitForProcess(delay){$timeout(function(){processing?waitForProcess(10):callback(files)},delay||0)}()}function traverseFileTree(files,entry,path){if(null!=entry)if(entry.isDirectory){var dirReader=entry.createReader();processing++,dirReader.readEntries(function(entries){for(var i=0;i<entries.length;i++)traverseFileTree(files,entries[i],(path?path:"")+entry.name+"/");processing--})}else processing++,entry.file(function(file){processing--,file._relativePath=(path?path:"")+file.name,files.push(file)})}if("draggable"in document.createElement("span")){var leaveTimeout=null;elem[0].addEventListener("dragover",function(evt){if(evt.preventDefault(),$timeout.cancel(leaveTimeout),!elem[0].__drag_over_class_)if(attr.ngFileDragOverClass&&attr.ngFileDragOverClass.search(/\) *$/)>-1){var dragOverClass=$parse(attr.ngFileDragOverClass)(scope,{$event:evt});elem[0].__drag_over_class_=dragOverClass}else elem[0].__drag_over_class_=attr.ngFileDragOverClass||"dragover";elem.addClass(elem[0].__drag_over_class_)},!1),elem[0].addEventListener("dragenter",function(evt){evt.preventDefault()},!1),elem[0].addEventListener("dragleave",function(evt){leaveTimeout=$timeout(function(){elem.removeClass(elem[0].__drag_over_class_),elem[0].__drag_over_class_=null},attr.ngFileDragOverDelay||1)},!1);var fn=$parse(attr.ngFileDrop);elem[0].addEventListener("drop",function(evt){evt.preventDefault(),elem.removeClass(elem[0].__drag_over_class_),elem[0].__drag_over_class_=null,extractFiles(evt,function(files){fn(scope,{$files:files,$event:evt})})},!1);var processing=0}}}])}();var saveAs=saveAs||function(view){if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var doc=view.document,get_URL=function(){return view.URL||view.webkitURL||view},save_link=doc.createElementNS("http://www.w3.org/1999/xhtml","a"),can_use_save_link="download"in save_link,click=function(node){var event=doc.createEvent("MouseEvents");event.initMouseEvent("click",!0,!1,view,0,0,0,0,0,!1,!1,!1,!1,0,null),node.dispatchEvent(event)},webkit_req_fs=view.webkitRequestFileSystem,req_fs=view.requestFileSystem||webkit_req_fs||view.mozRequestFileSystem,throw_outside=function(ex){(view.setImmediate||view.setTimeout)(function(){throw ex},0)},force_saveable_type="application/octet-stream",fs_min_size=0,arbitrary_revoke_timeout=500,revoke=function(file){var revoker=function(){"string"==typeof file?get_URL().revokeObjectURL(file):file.remove()};view.chrome?revoker():setTimeout(revoker,arbitrary_revoke_timeout)},dispatch=function(filesaver,event_types,event){event_types=[].concat(event_types);for(var i=event_types.length;i--;){var listener=filesaver["on"+event_types[i]];if("function"==typeof listener)try{listener.call(filesaver,event||filesaver)}catch(ex){throw_outside(ex)}}},auto_bom=function(blob){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(blob.type)?new Blob(["\ufeff",blob],{type:blob.type}):blob},FileSaver=function(blob,name){blob=auto_bom(blob);var object_url,target_view,slice,filesaver=this,type=blob.type,blob_changed=!1,dispatch_all=function(){dispatch(filesaver,"writestart progress write writeend".split(" "))},fs_error=function(){if((blob_changed||!object_url)&&(object_url=get_URL().createObjectURL(blob)),target_view)target_view.location.href=object_url;else{var new_tab=view.open(object_url,"_blank");void 0==new_tab&&"undefined"!=typeof safari&&(view.location.href=object_url)}filesaver.readyState=filesaver.DONE,dispatch_all(),revoke(object_url)},abortable=function(func){return function(){return filesaver.readyState!==filesaver.DONE?func.apply(this,arguments):void 0}},create_if_not_found={create:!0,exclusive:!1};return filesaver.readyState=filesaver.INIT,name||(name="download"),can_use_save_link?(object_url=get_URL().createObjectURL(blob),save_link.href=object_url,save_link.download=name,click(save_link),filesaver.readyState=filesaver.DONE,dispatch_all(),void revoke(object_url)):(view.chrome&&type&&type!==force_saveable_type&&(slice=blob.slice||blob.webkitSlice,blob=slice.call(blob,0,blob.size,force_saveable_type),blob_changed=!0),webkit_req_fs&&"download"!==name&&(name+=".download"),(type===force_saveable_type||webkit_req_fs)&&(target_view=view),req_fs?(fs_min_size+=blob.size,void req_fs(view.TEMPORARY,fs_min_size,abortable(function(fs){fs.root.getDirectory("saved",create_if_not_found,abortable(function(dir){var save=function(){dir.getFile(name,create_if_not_found,abortable(function(file){file.createWriter(abortable(function(writer){writer.onwriteend=function(event){target_view.location.href=file.toURL(),filesaver.readyState=filesaver.DONE,dispatch(filesaver,"writeend",event),revoke(file)},writer.onerror=function(){var error=writer.error;error.code!==error.ABORT_ERR&&fs_error()},"writestart progress write abort".split(" ").forEach(function(event){writer["on"+event]=filesaver["on"+event]}),writer.write(blob),filesaver.abort=function(){writer.abort(),filesaver.readyState=filesaver.DONE},filesaver.readyState=filesaver.WRITING}),fs_error)}),fs_error)};dir.getFile(name,{create:!1},abortable(function(file){file.remove(),save()}),abortable(function(ex){ex.code===ex.NOT_FOUND_ERR?save():fs_error()}))}),fs_error)}),fs_error)):void fs_error())},FS_proto=FileSaver.prototype,saveAs=function(blob,name){return new FileSaver(blob,name)};return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(blob,name){return navigator.msSaveOrOpenBlob(auto_bom(blob),name)}:(FS_proto.abort=function(){var filesaver=this;filesaver.readyState=filesaver.DONE,dispatch(filesaver,"abort")},FS_proto.readyState=FS_proto.INIT=0,FS_proto.WRITING=1,FS_proto.DONE=2,FS_proto.error=FS_proto.onwritestart=FS_proto.onprogress=FS_proto.onwrite=FS_proto.onabort=FS_proto.onerror=FS_proto.onwriteend=null,saveAs)}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!=define.amd&&define([],function(){return saveAs}),function(global,factory){"function"==typeof define&&define.amd?define([],factory):"undefined"!=typeof module&&module.exports?module.exports=factory():global.tv4=factory()}(this,function(){function recursiveCompare(A,B){if(A===B)return!0;if("object"==typeof A&&"object"==typeof B){if(Array.isArray(A)!==Array.isArray(B))return!1;if(Array.isArray(A)){if(A.length!==B.length)return!1;for(var i=0;i<A.length;i++)if(!recursiveCompare(A[i],B[i]))return!1}else{var key;for(key in A)if(void 0===B[key]&&void 0!==A[key])return!1;for(key in B)if(void 0===A[key]&&void 0!==B[key])return!1;for(key in A)if(!recursiveCompare(A[key],B[key]))return!1}return!0}return!1}function parseURI(url){var m=String(url).replace(/^\s+|\s+$/g,"").match(/^([^:\/?#]+:)?(\/\/(?:[^:@]*(?::[^:@]*)?@)?(([^:\/?#]*)(?::(\d*))?))?([^?#]*)(\?[^#]*)?(#[\s\S]*)?/);return m?{href:m[0]||"",protocol:m[1]||"",authority:m[2]||"",host:m[3]||"",hostname:m[4]||"",port:m[5]||"",pathname:m[6]||"",search:m[7]||"",hash:m[8]||""}:null}function resolveUrl(base,href){function removeDotSegments(input){var output=[];return input.replace(/^(\.\.?(\/|$))+/,"").replace(/\/(\.(\/|$))+/g,"/").replace(/\/\.\.$/,"/../").replace(/\/?[^\/]*/g,function(p){"/.."===p?output.pop():output.push(p)}),output.join("").replace(/^\//,"/"===input.charAt(0)?"/":"")}return href=parseURI(href||""),base=parseURI(base||""),href&&base?(href.protocol||base.protocol)+(href.protocol||href.authority?href.authority:base.authority)+removeDotSegments(href.protocol||href.authority||"/"===href.pathname.charAt(0)?href.pathname:href.pathname?(base.authority&&!base.pathname?"/":"")+base.pathname.slice(0,base.pathname.lastIndexOf("/")+1)+href.pathname:base.pathname)+(href.protocol||href.authority||href.pathname?href.search:href.search||base.search)+href.hash:null}function getDocumentUri(uri){return uri.split("#")[0]}function normSchema(schema,baseUri){if(schema&&"object"==typeof schema)if(void 0===baseUri?baseUri=schema.id:"string"==typeof schema.id&&(baseUri=resolveUrl(baseUri,schema.id),schema.id=baseUri),Array.isArray(schema))for(var i=0;i<schema.length;i++)normSchema(schema[i],baseUri);else{"string"==typeof schema.$ref&&(schema.$ref=resolveUrl(baseUri,schema.$ref));for(var key in schema)"enum"!==key&&normSchema(schema[key],baseUri)}}function ValidationError(code,message,dataPath,schemaPath,subErrors){if(Error.call(this),void 0===code)throw new Error("No code supplied for error: "+message);this.message=message,this.code=code,this.dataPath=dataPath||"",this.schemaPath=schemaPath||"",this.subErrors=subErrors||null;var err=new Error(this.message);if(this.stack=err.stack||err.stacktrace,!this.stack)try{throw err}catch(err){this.stack=err.stack||err.stacktrace}}function isTrustedUrl(baseUrl,testUrl){if(testUrl.substring(0,baseUrl.length)===baseUrl){var remainder=testUrl.substring(baseUrl.length);if(testUrl.length>0&&"/"===testUrl.charAt(baseUrl.length-1)||"#"===remainder.charAt(0)||"?"===remainder.charAt(0))return!0}return!1}function createApi(language){var globalContext=new ValidatorContext,currentLanguage=language||"en",api={addFormat:function(){globalContext.addFormat.apply(globalContext,arguments)},language:function(code){return code?(languages[code]||(code=code.split("-")[0]),languages[code]?(currentLanguage=code,code):!1):currentLanguage},addLanguage:function(code,messageMap){var key;for(key in ErrorCodes)messageMap[key]&&!messageMap[ErrorCodes[key]]&&(messageMap[ErrorCodes[key]]=messageMap[key]);var rootCode=code.split("-")[0];if(languages[rootCode]){languages[code]=Object.create(languages[rootCode]);for(key in messageMap)"undefined"==typeof languages[rootCode][key]&&(languages[rootCode][key]=messageMap[key]),languages[code][key]=messageMap[key]}else languages[code]=messageMap,languages[rootCode]=messageMap;return this},freshApi:function(language){var result=createApi();
return language&&result.language(language),result},validate:function(data,schema,checkRecursive,banUnknownProperties){var context=new ValidatorContext(globalContext,!1,languages[currentLanguage],checkRecursive,banUnknownProperties);"string"==typeof schema&&(schema={$ref:schema}),context.addSchema("",schema);var error=context.validateAll(data,schema,null,null,"");return!error&&banUnknownProperties&&(error=context.banUnknownProperties()),this.error=error,this.missing=context.missing,this.valid=null===error,this.valid},validateResult:function(){var result={};return this.validate.apply(result,arguments),result},validateMultiple:function(data,schema,checkRecursive,banUnknownProperties){var context=new ValidatorContext(globalContext,!0,languages[currentLanguage],checkRecursive,banUnknownProperties);"string"==typeof schema&&(schema={$ref:schema}),context.addSchema("",schema),context.validateAll(data,schema,null,null,""),banUnknownProperties&&context.banUnknownProperties();var result={};return result.errors=context.errors,result.missing=context.missing,result.valid=0===result.errors.length,result},addSchema:function(){return globalContext.addSchema.apply(globalContext,arguments)},getSchema:function(){return globalContext.getSchema.apply(globalContext,arguments)},getSchemaMap:function(){return globalContext.getSchemaMap.apply(globalContext,arguments)},getSchemaUris:function(){return globalContext.getSchemaUris.apply(globalContext,arguments)},getMissingUris:function(){return globalContext.getMissingUris.apply(globalContext,arguments)},dropSchemas:function(){globalContext.dropSchemas.apply(globalContext,arguments)},defineKeyword:function(){globalContext.defineKeyword.apply(globalContext,arguments)},defineError:function(codeName,codeNumber,defaultMessage){if("string"!=typeof codeName||!/^[A-Z]+(_[A-Z]+)*$/.test(codeName))throw new Error("Code name must be a string in UPPER_CASE_WITH_UNDERSCORES");if("number"!=typeof codeNumber||codeNumber%1!==0||1e4>codeNumber)throw new Error("Code number must be an integer > 10000");if("undefined"!=typeof ErrorCodes[codeName])throw new Error("Error already defined: "+codeName+" as "+ErrorCodes[codeName]);if("undefined"!=typeof ErrorCodeLookup[codeNumber])throw new Error("Error code already used: "+ErrorCodeLookup[codeNumber]+" as "+codeNumber);ErrorCodes[codeName]=codeNumber,ErrorCodeLookup[codeNumber]=codeName,ErrorMessagesDefault[codeName]=ErrorMessagesDefault[codeNumber]=defaultMessage;for(var langCode in languages){var language=languages[langCode];language[codeName]&&(language[codeNumber]=language[codeNumber]||language[codeName])}},reset:function(){globalContext.reset(),this.error=null,this.missing=[],this.valid=!0},missing:[],error:null,valid:!0,normSchema:normSchema,resolveUrl:resolveUrl,getDocumentUri:getDocumentUri,errorCodes:ErrorCodes};return api}Object.keys||(Object.keys=function(){var hasOwnProperty=Object.prototype.hasOwnProperty,hasDontEnumBug=!{toString:null}.propertyIsEnumerable("toString"),dontEnums=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],dontEnumsLength=dontEnums.length;return function(obj){if("object"!=typeof obj&&"function"!=typeof obj||null===obj)throw new TypeError("Object.keys called on non-object");var result=[];for(var prop in obj)hasOwnProperty.call(obj,prop)&&result.push(prop);if(hasDontEnumBug)for(var i=0;dontEnumsLength>i;i++)hasOwnProperty.call(obj,dontEnums[i])&&result.push(dontEnums[i]);return result}}()),Object.create||(Object.create=function(){function F(){}return function(o){if(1!==arguments.length)throw new Error("Object.create implementation only accepts one parameter.");return F.prototype=o,new F}}()),Array.isArray||(Array.isArray=function(vArg){return"[object Array]"===Object.prototype.toString.call(vArg)}),Array.prototype.indexOf||(Array.prototype.indexOf=function(searchElement){if(null===this)throw new TypeError;var t=Object(this),len=t.length>>>0;if(0===len)return-1;var n=0;if(arguments.length>1&&(n=Number(arguments[1]),n!==n?n=0:0!==n&&n!==1/0&&n!==-(1/0)&&(n=(n>0||-1)*Math.floor(Math.abs(n)))),n>=len)return-1;for(var k=n>=0?n:Math.max(len-Math.abs(n),0);len>k;k++)if(k in t&&t[k]===searchElement)return k;return-1}),Object.isFrozen||(Object.isFrozen=function(obj){for(var key="tv4_test_frozen_key";obj.hasOwnProperty(key);)key+=Math.random();try{return obj[key]=!0,delete obj[key],!1}catch(e){return!0}});var ValidatorContext=function(parent,collectMultiple,errorMessages,checkRecursive,trackUnknownProperties){if(this.missing=[],this.missingMap={},this.formatValidators=parent?Object.create(parent.formatValidators):{},this.schemas=parent?Object.create(parent.schemas):{},this.collectMultiple=collectMultiple,this.errors=[],this.handleError=collectMultiple?this.collectError:this.returnError,checkRecursive&&(this.checkRecursive=!0,this.scanned=[],this.scannedFrozen=[],this.scannedFrozenSchemas=[],this.scannedFrozenValidationErrors=[],this.validatedSchemasKey="tv4_validation_id",this.validationErrorsKey="tv4_validation_errors_id"),trackUnknownProperties&&(this.trackUnknownProperties=!0,this.knownPropertyPaths={},this.unknownPropertyPaths={}),this.errorMessages=errorMessages,this.definedKeywords={},parent)for(var key in parent.definedKeywords)this.definedKeywords[key]=parent.definedKeywords[key].slice(0)};ValidatorContext.prototype.defineKeyword=function(keyword,keywordFunction){this.definedKeywords[keyword]=this.definedKeywords[keyword]||[],this.definedKeywords[keyword].push(keywordFunction)},ValidatorContext.prototype.createError=function(code,messageParams,dataPath,schemaPath,subErrors){var messageTemplate=this.errorMessages[code]||ErrorMessagesDefault[code];if("string"!=typeof messageTemplate)return new ValidationError(code,"Unknown error code "+code+": "+JSON.stringify(messageParams),dataPath,schemaPath,subErrors);var message=messageTemplate.replace(/\{([^{}]*)\}/g,function(whole,varName){var subValue=messageParams[varName];return"string"==typeof subValue||"number"==typeof subValue?subValue:whole});return new ValidationError(code,message,dataPath,schemaPath,subErrors)},ValidatorContext.prototype.returnError=function(error){return error},ValidatorContext.prototype.collectError=function(error){return error&&this.errors.push(error),null},ValidatorContext.prototype.prefixErrors=function(startIndex,dataPath,schemaPath){for(var i=startIndex;i<this.errors.length;i++)this.errors[i]=this.errors[i].prefixWith(dataPath,schemaPath);return this},ValidatorContext.prototype.banUnknownProperties=function(){for(var unknownPath in this.unknownPropertyPaths){var error=this.createError(ErrorCodes.UNKNOWN_PROPERTY,{path:unknownPath},unknownPath,""),result=this.handleError(error);if(result)return result}return null},ValidatorContext.prototype.addFormat=function(format,validator){if("object"==typeof format){for(var key in format)this.addFormat(key,format[key]);return this}this.formatValidators[format]=validator},ValidatorContext.prototype.resolveRefs=function(schema,urlHistory){if(void 0!==schema.$ref){if(urlHistory=urlHistory||{},urlHistory[schema.$ref])return this.createError(ErrorCodes.CIRCULAR_REFERENCE,{urls:Object.keys(urlHistory).join(", ")},"","");urlHistory[schema.$ref]=!0,schema=this.getSchema(schema.$ref,urlHistory)}return schema},ValidatorContext.prototype.getSchema=function(url,urlHistory){var schema;if(void 0!==this.schemas[url])return schema=this.schemas[url],this.resolveRefs(schema,urlHistory);var baseUrl=url,fragment="";if(-1!==url.indexOf("#")&&(fragment=url.substring(url.indexOf("#")+1),baseUrl=url.substring(0,url.indexOf("#"))),"object"==typeof this.schemas[baseUrl]){schema=this.schemas[baseUrl];var pointerPath=decodeURIComponent(fragment);if(""===pointerPath)return this.resolveRefs(schema,urlHistory);if("/"!==pointerPath.charAt(0))return void 0;for(var parts=pointerPath.split("/").slice(1),i=0;i<parts.length;i++){var component=parts[i].replace(/~1/g,"/").replace(/~0/g,"~");if(void 0===schema[component]){schema=void 0;break}schema=schema[component]}if(void 0!==schema)return this.resolveRefs(schema,urlHistory)}void 0===this.missing[baseUrl]&&(this.missing.push(baseUrl),this.missing[baseUrl]=baseUrl,this.missingMap[baseUrl]=baseUrl)},ValidatorContext.prototype.searchSchemas=function(schema,url){if(schema&&"object"==typeof schema){"string"==typeof schema.id&&isTrustedUrl(url,schema.id)&&void 0===this.schemas[schema.id]&&(this.schemas[schema.id]=schema);for(var key in schema)if("enum"!==key)if("object"==typeof schema[key])this.searchSchemas(schema[key],url);else if("$ref"===key){var uri=getDocumentUri(schema[key]);uri&&void 0===this.schemas[uri]&&void 0===this.missingMap[uri]&&(this.missingMap[uri]=uri)}}},ValidatorContext.prototype.addSchema=function(url,schema){if("string"!=typeof url||"undefined"==typeof schema){if("object"!=typeof url||"string"!=typeof url.id)return;schema=url,url=schema.id}(url=getDocumentUri(url)+"#")&&(url=getDocumentUri(url)),this.schemas[url]=schema,delete this.missingMap[url],normSchema(schema,url),this.searchSchemas(schema,url)},ValidatorContext.prototype.getSchemaMap=function(){var map={};for(var key in this.schemas)map[key]=this.schemas[key];return map},ValidatorContext.prototype.getSchemaUris=function(filterRegExp){var list=[];for(var key in this.schemas)(!filterRegExp||filterRegExp.test(key))&&list.push(key);return list},ValidatorContext.prototype.getMissingUris=function(filterRegExp){var list=[];for(var key in this.missingMap)(!filterRegExp||filterRegExp.test(key))&&list.push(key);return list},ValidatorContext.prototype.dropSchemas=function(){this.schemas={},this.reset()},ValidatorContext.prototype.reset=function(){this.missing=[],this.missingMap={},this.errors=[]},ValidatorContext.prototype.validateAll=function(data,schema,dataPathParts,schemaPathParts,dataPointerPath){var topLevel;if(schema=this.resolveRefs(schema),!schema)return null;if(schema instanceof ValidationError)return this.errors.push(schema),schema;var frozenIndex,startErrorCount=this.errors.length,scannedFrozenSchemaIndex=null,scannedSchemasIndex=null;if(this.checkRecursive&&data&&"object"==typeof data){if(topLevel=!this.scanned.length,data[this.validatedSchemasKey]){var schemaIndex=data[this.validatedSchemasKey].indexOf(schema);if(-1!==schemaIndex)return this.errors=this.errors.concat(data[this.validationErrorsKey][schemaIndex]),null}if(Object.isFrozen(data)&&(frozenIndex=this.scannedFrozen.indexOf(data),-1!==frozenIndex)){var frozenSchemaIndex=this.scannedFrozenSchemas[frozenIndex].indexOf(schema);if(-1!==frozenSchemaIndex)return this.errors=this.errors.concat(this.scannedFrozenValidationErrors[frozenIndex][frozenSchemaIndex]),null}if(this.scanned.push(data),Object.isFrozen(data))-1===frozenIndex&&(frozenIndex=this.scannedFrozen.length,this.scannedFrozen.push(data),this.scannedFrozenSchemas.push([])),scannedFrozenSchemaIndex=this.scannedFrozenSchemas[frozenIndex].length,this.scannedFrozenSchemas[frozenIndex][scannedFrozenSchemaIndex]=schema,this.scannedFrozenValidationErrors[frozenIndex][scannedFrozenSchemaIndex]=[];else{if(!data[this.validatedSchemasKey])try{Object.defineProperty(data,this.validatedSchemasKey,{value:[],configurable:!0}),Object.defineProperty(data,this.validationErrorsKey,{value:[],configurable:!0})}catch(e){data[this.validatedSchemasKey]=[],data[this.validationErrorsKey]=[]}scannedSchemasIndex=data[this.validatedSchemasKey].length,data[this.validatedSchemasKey][scannedSchemasIndex]=schema,data[this.validationErrorsKey][scannedSchemasIndex]=[]}}var errorCount=this.errors.length,error=this.validateBasic(data,schema,dataPointerPath)||this.validateNumeric(data,schema,dataPointerPath)||this.validateString(data,schema,dataPointerPath)||this.validateArray(data,schema,dataPointerPath)||this.validateObject(data,schema,dataPointerPath)||this.validateCombinations(data,schema,dataPointerPath)||this.validateFormat(data,schema,dataPointerPath)||this.validateDefinedKeywords(data,schema,dataPointerPath)||null;if(topLevel){for(;this.scanned.length;){var item=this.scanned.pop();delete item[this.validatedSchemasKey]}this.scannedFrozen=[],this.scannedFrozenSchemas=[]}if(error||errorCount!==this.errors.length)for(;dataPathParts&&dataPathParts.length||schemaPathParts&&schemaPathParts.length;){var dataPart=dataPathParts&&dataPathParts.length?""+dataPathParts.pop():null,schemaPart=schemaPathParts&&schemaPathParts.length?""+schemaPathParts.pop():null;error&&(error=error.prefixWith(dataPart,schemaPart)),this.prefixErrors(errorCount,dataPart,schemaPart)}return null!==scannedFrozenSchemaIndex?this.scannedFrozenValidationErrors[frozenIndex][scannedFrozenSchemaIndex]=this.errors.slice(startErrorCount):null!==scannedSchemasIndex&&(data[this.validationErrorsKey][scannedSchemasIndex]=this.errors.slice(startErrorCount)),this.handleError(error)},ValidatorContext.prototype.validateFormat=function(data,schema){if("string"!=typeof schema.format||!this.formatValidators[schema.format])return null;var errorMessage=this.formatValidators[schema.format].call(null,data,schema);return"string"==typeof errorMessage||"number"==typeof errorMessage?this.createError(ErrorCodes.FORMAT_CUSTOM,{message:errorMessage}).prefixWith(null,"format"):errorMessage&&"object"==typeof errorMessage?this.createError(ErrorCodes.FORMAT_CUSTOM,{message:errorMessage.message||"?"},errorMessage.dataPath||null,errorMessage.schemaPath||"/format"):null},ValidatorContext.prototype.validateDefinedKeywords=function(data,schema){for(var key in this.definedKeywords)for(var validationFunctions=this.definedKeywords[key],i=0;i<validationFunctions.length;i++){var func=validationFunctions[i],result=func(data,schema[key],schema);if("string"==typeof result||"number"==typeof result)return this.createError(ErrorCodes.KEYWORD_CUSTOM,{key:key,message:result}).prefixWith(null,"format");if(result&&"object"==typeof result){var code=result.code||ErrorCodes.KEYWORD_CUSTOM;if("string"==typeof code){if(!ErrorCodes[code])throw new Error("Undefined error code (use defineError): "+code);code=ErrorCodes[code]}var messageParams="object"==typeof result.message?result.message:{key:key,message:result.message||"?"},schemaPath=result.schemaPath||"/"+key.replace(/~/g,"~0").replace(/\//g,"~1");return this.createError(code,messageParams,result.dataPath||null,schemaPath)}}return null},ValidatorContext.prototype.validateBasic=function(data,schema,dataPointerPath){var error;return(error=this.validateType(data,schema,dataPointerPath))?error.prefixWith(null,"type"):(error=this.validateEnum(data,schema,dataPointerPath))?error.prefixWith(null,"type"):null},ValidatorContext.prototype.validateType=function(data,schema){if(void 0===schema.type)return null;var dataType=typeof data;null===data?dataType="null":Array.isArray(data)&&(dataType="array");var allowedTypes=schema.type;"object"!=typeof allowedTypes&&(allowedTypes=[allowedTypes]);for(var i=0;i<allowedTypes.length;i++){var type=allowedTypes[i];if(type===dataType||"integer"===type&&"number"===dataType&&data%1===0)return null}return this.createError(ErrorCodes.INVALID_TYPE,{type:dataType,expected:allowedTypes.join("/")})},ValidatorContext.prototype.validateEnum=function(data,schema){if(void 0===schema["enum"])return null;for(var i=0;i<schema["enum"].length;i++){var enumVal=schema["enum"][i];if(recursiveCompare(data,enumVal))return null}return this.createError(ErrorCodes.ENUM_MISMATCH,{value:"undefined"!=typeof JSON?JSON.stringify(data):data})},ValidatorContext.prototype.validateNumeric=function(data,schema,dataPointerPath){return this.validateMultipleOf(data,schema,dataPointerPath)||this.validateMinMax(data,schema,dataPointerPath)||null},ValidatorContext.prototype.validateMultipleOf=function(data,schema){var multipleOf=schema.multipleOf||schema.divisibleBy;return void 0===multipleOf?null:"number"==typeof data&&data%multipleOf!==0?this.createError(ErrorCodes.NUMBER_MULTIPLE_OF,{value:data,multipleOf:multipleOf}):null},ValidatorContext.prototype.validateMinMax=function(data,schema){if("number"!=typeof data)return null;if(void 0!==schema.minimum){if(data<schema.minimum)return this.createError(ErrorCodes.NUMBER_MINIMUM,{value:data,minimum:schema.minimum}).prefixWith(null,"minimum");if(schema.exclusiveMinimum&&data===schema.minimum)return this.createError(ErrorCodes.NUMBER_MINIMUM_EXCLUSIVE,{value:data,minimum:schema.minimum}).prefixWith(null,"exclusiveMinimum")}if(void 0!==schema.maximum){if(data>schema.maximum)return this.createError(ErrorCodes.NUMBER_MAXIMUM,{value:data,maximum:schema.maximum}).prefixWith(null,"maximum");if(schema.exclusiveMaximum&&data===schema.maximum)return this.createError(ErrorCodes.NUMBER_MAXIMUM_EXCLUSIVE,{value:data,maximum:schema.maximum}).prefixWith(null,"exclusiveMaximum")}return null},ValidatorContext.prototype.validateString=function(data,schema,dataPointerPath){return this.validateStringLength(data,schema,dataPointerPath)||this.validateStringPattern(data,schema,dataPointerPath)||null},ValidatorContext.prototype.validateStringLength=function(data,schema){return"string"!=typeof data?null:void 0!==schema.minLength&&data.length<schema.minLength?this.createError(ErrorCodes.STRING_LENGTH_SHORT,{length:data.length,minimum:schema.minLength}).prefixWith(null,"minLength"):void 0!==schema.maxLength&&data.length>schema.maxLength?this.createError(ErrorCodes.STRING_LENGTH_LONG,{length:data.length,maximum:schema.maxLength}).prefixWith(null,"maxLength"):null},ValidatorContext.prototype.validateStringPattern=function(data,schema){if("string"!=typeof data||void 0===schema.pattern)return null;var regexp=new RegExp(schema.pattern);return regexp.test(data)?null:this.createError(ErrorCodes.STRING_PATTERN,{pattern:schema.pattern}).prefixWith(null,"pattern")},ValidatorContext.prototype.validateArray=function(data,schema,dataPointerPath){return Array.isArray(data)?this.validateArrayLength(data,schema,dataPointerPath)||this.validateArrayUniqueItems(data,schema,dataPointerPath)||this.validateArrayItems(data,schema,dataPointerPath)||null:null},ValidatorContext.prototype.validateArrayLength=function(data,schema){var error;return void 0!==schema.minItems&&data.length<schema.minItems&&(error=this.createError(ErrorCodes.ARRAY_LENGTH_SHORT,{length:data.length,minimum:schema.minItems}).prefixWith(null,"minItems"),this.handleError(error))?error:void 0!==schema.maxItems&&data.length>schema.maxItems&&(error=this.createError(ErrorCodes.ARRAY_LENGTH_LONG,{length:data.length,maximum:schema.maxItems}).prefixWith(null,"maxItems"),this.handleError(error))?error:null},ValidatorContext.prototype.validateArrayUniqueItems=function(data,schema){if(schema.uniqueItems)for(var i=0;i<data.length;i++)for(var j=i+1;j<data.length;j++)if(recursiveCompare(data[i],data[j])){var error=this.createError(ErrorCodes.ARRAY_UNIQUE,{match1:i,match2:j}).prefixWith(null,"uniqueItems");if(this.handleError(error))return error}return null},ValidatorContext.prototype.validateArrayItems=function(data,schema,dataPointerPath){if(void 0===schema.items)return null;var error,i;if(Array.isArray(schema.items)){for(i=0;i<data.length;i++)if(i<schema.items.length){if(error=this.validateAll(data[i],schema.items[i],[i],["items",i],dataPointerPath+"/"+i))return error}else if(void 0!==schema.additionalItems)if("boolean"==typeof schema.additionalItems){if(!schema.additionalItems&&(error=this.createError(ErrorCodes.ARRAY_ADDITIONAL_ITEMS,{}).prefixWith(""+i,"additionalItems"),this.handleError(error)))return error}else if(error=this.validateAll(data[i],schema.additionalItems,[i],["additionalItems"],dataPointerPath+"/"+i))return error}else for(i=0;i<data.length;i++)if(error=this.validateAll(data[i],schema.items,[i],["items"],dataPointerPath+"/"+i))return error;return null},ValidatorContext.prototype.validateObject=function(data,schema,dataPointerPath){return"object"!=typeof data||null===data||Array.isArray(data)?null:this.validateObjectMinMaxProperties(data,schema,dataPointerPath)||this.validateObjectRequiredProperties(data,schema,dataPointerPath)||this.validateObjectProperties(data,schema,dataPointerPath)||this.validateObjectDependencies(data,schema,dataPointerPath)||null},ValidatorContext.prototype.validateObjectMinMaxProperties=function(data,schema){var error,keys=Object.keys(data);return void 0!==schema.minProperties&&keys.length<schema.minProperties&&(error=this.createError(ErrorCodes.OBJECT_PROPERTIES_MINIMUM,{propertyCount:keys.length,minimum:schema.minProperties}).prefixWith(null,"minProperties"),this.handleError(error))?error:void 0!==schema.maxProperties&&keys.length>schema.maxProperties&&(error=this.createError(ErrorCodes.OBJECT_PROPERTIES_MAXIMUM,{propertyCount:keys.length,maximum:schema.maxProperties}).prefixWith(null,"maxProperties"),this.handleError(error))?error:null},ValidatorContext.prototype.validateObjectRequiredProperties=function(data,schema){if(void 0!==schema.required)for(var i=0;i<schema.required.length;i++){var key=schema.required[i];if(void 0===data[key]){var error=this.createError(ErrorCodes.OBJECT_REQUIRED,{key:key}).prefixWith(null,""+i).prefixWith(null,"required");if(this.handleError(error))return error}}return null},ValidatorContext.prototype.validateObjectProperties=function(data,schema,dataPointerPath){var error;for(var key in data){var keyPointerPath=dataPointerPath+"/"+key.replace(/~/g,"~0").replace(/\//g,"~1"),foundMatch=!1;if(void 0!==schema.properties&&void 0!==schema.properties[key]&&(foundMatch=!0,error=this.validateAll(data[key],schema.properties[key],[key],["properties",key],keyPointerPath)))return error;if(void 0!==schema.patternProperties)for(var patternKey in schema.patternProperties){var regexp=new RegExp(patternKey);if(regexp.test(key)&&(foundMatch=!0,error=this.validateAll(data[key],schema.patternProperties[patternKey],[key],["patternProperties",patternKey],keyPointerPath)))return error}if(foundMatch)this.trackUnknownProperties&&(this.knownPropertyPaths[keyPointerPath]=!0,delete this.unknownPropertyPaths[keyPointerPath]);else if(void 0!==schema.additionalProperties){if(this.trackUnknownProperties&&(this.knownPropertyPaths[keyPointerPath]=!0,delete this.unknownPropertyPaths[keyPointerPath]),"boolean"==typeof schema.additionalProperties){if(!schema.additionalProperties&&(error=this.createError(ErrorCodes.OBJECT_ADDITIONAL_PROPERTIES,{}).prefixWith(key,"additionalProperties"),this.handleError(error)))return error}else if(error=this.validateAll(data[key],schema.additionalProperties,[key],["additionalProperties"],keyPointerPath))return error}else this.trackUnknownProperties&&!this.knownPropertyPaths[keyPointerPath]&&(this.unknownPropertyPaths[keyPointerPath]=!0)}return null},ValidatorContext.prototype.validateObjectDependencies=function(data,schema,dataPointerPath){var error;if(void 0!==schema.dependencies)for(var depKey in schema.dependencies)if(void 0!==data[depKey]){var dep=schema.dependencies[depKey];if("string"==typeof dep){if(void 0===data[dep]&&(error=this.createError(ErrorCodes.OBJECT_DEPENDENCY_KEY,{key:depKey,missing:dep}).prefixWith(null,depKey).prefixWith(null,"dependencies"),this.handleError(error)))return error}else if(Array.isArray(dep))for(var i=0;i<dep.length;i++){var requiredKey=dep[i];if(void 0===data[requiredKey]&&(error=this.createError(ErrorCodes.OBJECT_DEPENDENCY_KEY,{key:depKey,missing:requiredKey}).prefixWith(null,""+i).prefixWith(null,depKey).prefixWith(null,"dependencies"),this.handleError(error)))return error}else if(error=this.validateAll(data,dep,[],["dependencies",depKey],dataPointerPath))return error}return null},ValidatorContext.prototype.validateCombinations=function(data,schema,dataPointerPath){return this.validateAllOf(data,schema,dataPointerPath)||this.validateAnyOf(data,schema,dataPointerPath)||this.validateOneOf(data,schema,dataPointerPath)||this.validateNot(data,schema,dataPointerPath)||null},ValidatorContext.prototype.validateAllOf=function(data,schema,dataPointerPath){if(void 0===schema.allOf)return null;for(var error,i=0;i<schema.allOf.length;i++){var subSchema=schema.allOf[i];if(error=this.validateAll(data,subSchema,[],["allOf",i],dataPointerPath))return error}return null},ValidatorContext.prototype.validateAnyOf=function(data,schema,dataPointerPath){if(void 0===schema.anyOf)return null;var oldUnknownPropertyPaths,oldKnownPropertyPaths,errors=[],startErrorCount=this.errors.length;this.trackUnknownProperties&&(oldUnknownPropertyPaths=this.unknownPropertyPaths,oldKnownPropertyPaths=this.knownPropertyPaths);for(var errorAtEnd=!0,i=0;i<schema.anyOf.length;i++){this.trackUnknownProperties&&(this.unknownPropertyPaths={},this.knownPropertyPaths={});var subSchema=schema.anyOf[i],errorCount=this.errors.length,error=this.validateAll(data,subSchema,[],["anyOf",i],dataPointerPath);if(null===error&&errorCount===this.errors.length){if(this.errors=this.errors.slice(0,startErrorCount),this.trackUnknownProperties){for(var knownKey in this.knownPropertyPaths)oldKnownPropertyPaths[knownKey]=!0,delete oldUnknownPropertyPaths[knownKey];for(var unknownKey in this.unknownPropertyPaths)oldKnownPropertyPaths[unknownKey]||(oldUnknownPropertyPaths[unknownKey]=!0);errorAtEnd=!1;continue}return null}error&&errors.push(error.prefixWith(null,""+i).prefixWith(null,"anyOf"))}return this.trackUnknownProperties&&(this.unknownPropertyPaths=oldUnknownPropertyPaths,this.knownPropertyPaths=oldKnownPropertyPaths),errorAtEnd?(errors=errors.concat(this.errors.slice(startErrorCount)),this.errors=this.errors.slice(0,startErrorCount),this.createError(ErrorCodes.ANY_OF_MISSING,{},"","/anyOf",errors)):void 0},ValidatorContext.prototype.validateOneOf=function(data,schema,dataPointerPath){if(void 0===schema.oneOf)return null;var oldUnknownPropertyPaths,oldKnownPropertyPaths,validIndex=null,errors=[],startErrorCount=this.errors.length;this.trackUnknownProperties&&(oldUnknownPropertyPaths=this.unknownPropertyPaths,oldKnownPropertyPaths=this.knownPropertyPaths);for(var i=0;i<schema.oneOf.length;i++){this.trackUnknownProperties&&(this.unknownPropertyPaths={},this.knownPropertyPaths={});var subSchema=schema.oneOf[i],errorCount=this.errors.length,error=this.validateAll(data,subSchema,[],["oneOf",i],dataPointerPath);if(null===error&&errorCount===this.errors.length){if(null!==validIndex)return this.errors=this.errors.slice(0,startErrorCount),this.createError(ErrorCodes.ONE_OF_MULTIPLE,{index1:validIndex,index2:i},"","/oneOf");if(validIndex=i,this.trackUnknownProperties){for(var knownKey in this.knownPropertyPaths)oldKnownPropertyPaths[knownKey]=!0,delete oldUnknownPropertyPaths[knownKey];for(var unknownKey in this.unknownPropertyPaths)oldKnownPropertyPaths[unknownKey]||(oldUnknownPropertyPaths[unknownKey]=!0)}}else error&&errors.push(error.prefixWith(null,""+i).prefixWith(null,"oneOf"))}return this.trackUnknownProperties&&(this.unknownPropertyPaths=oldUnknownPropertyPaths,this.knownPropertyPaths=oldKnownPropertyPaths),null===validIndex?(errors=errors.concat(this.errors.slice(startErrorCount)),this.errors=this.errors.slice(0,startErrorCount),this.createError(ErrorCodes.ONE_OF_MISSING,{},"","/oneOf",errors)):(this.errors=this.errors.slice(0,startErrorCount),null)},ValidatorContext.prototype.validateNot=function(data,schema,dataPointerPath){if(void 0===schema.not)return null;var oldUnknownPropertyPaths,oldKnownPropertyPaths,oldErrorCount=this.errors.length;this.trackUnknownProperties&&(oldUnknownPropertyPaths=this.unknownPropertyPaths,oldKnownPropertyPaths=this.knownPropertyPaths,this.unknownPropertyPaths={},this.knownPropertyPaths={});var error=this.validateAll(data,schema.not,null,null,dataPointerPath),notErrors=this.errors.slice(oldErrorCount);return this.errors=this.errors.slice(0,oldErrorCount),this.trackUnknownProperties&&(this.unknownPropertyPaths=oldUnknownPropertyPaths,this.knownPropertyPaths=oldKnownPropertyPaths),null===error&&0===notErrors.length?this.createError(ErrorCodes.NOT_PASSED,{},"","/not"):null};var ErrorCodes={INVALID_TYPE:0,ENUM_MISMATCH:1,ANY_OF_MISSING:10,ONE_OF_MISSING:11,ONE_OF_MULTIPLE:12,NOT_PASSED:13,NUMBER_MULTIPLE_OF:100,NUMBER_MINIMUM:101,NUMBER_MINIMUM_EXCLUSIVE:102,NUMBER_MAXIMUM:103,NUMBER_MAXIMUM_EXCLUSIVE:104,STRING_LENGTH_SHORT:200,STRING_LENGTH_LONG:201,STRING_PATTERN:202,OBJECT_PROPERTIES_MINIMUM:300,OBJECT_PROPERTIES_MAXIMUM:301,OBJECT_REQUIRED:302,OBJECT_ADDITIONAL_PROPERTIES:303,OBJECT_DEPENDENCY_KEY:304,ARRAY_LENGTH_SHORT:400,ARRAY_LENGTH_LONG:401,ARRAY_UNIQUE:402,ARRAY_ADDITIONAL_ITEMS:403,FORMAT_CUSTOM:500,KEYWORD_CUSTOM:501,CIRCULAR_REFERENCE:600,UNKNOWN_PROPERTY:1e3},ErrorCodeLookup={};for(var key in ErrorCodes)ErrorCodeLookup[ErrorCodes[key]]=key;var ErrorMessagesDefault={INVALID_TYPE:"invalid type: {type} (expected {expected})",ENUM_MISMATCH:"No enum match for: {value}",ANY_OF_MISSING:'Data does not match any schemas from "anyOf"',ONE_OF_MISSING:'Data does not match any schemas from "oneOf"',ONE_OF_MULTIPLE:'Data is valid against more than one schema from "oneOf": indices {index1} and {index2}',NOT_PASSED:'Data matches schema from "not"',NUMBER_MULTIPLE_OF:"Value {value} is not a multiple of {multipleOf}",NUMBER_MINIMUM:"Value {value} is less than minimum {minimum}",NUMBER_MINIMUM_EXCLUSIVE:"Value {value} is equal to exclusive minimum {minimum}",NUMBER_MAXIMUM:"Value {value} is greater than maximum {maximum}",NUMBER_MAXIMUM_EXCLUSIVE:"Value {value} is equal to exclusive maximum {maximum}",STRING_LENGTH_SHORT:"String is too short ({length} chars), minimum {minimum}",STRING_LENGTH_LONG:"String is too long ({length} chars), maximum {maximum}",STRING_PATTERN:"String does not match pattern: {pattern}",OBJECT_PROPERTIES_MINIMUM:"Too few properties defined ({propertyCount}), minimum {minimum}",OBJECT_PROPERTIES_MAXIMUM:"Too many properties defined ({propertyCount}), maximum {maximum}",OBJECT_REQUIRED:"Missing required property: {key}",OBJECT_ADDITIONAL_PROPERTIES:"Additional properties not allowed",OBJECT_DEPENDENCY_KEY:"Dependency failed - key must exist: {missing} (due to key: {key})",ARRAY_LENGTH_SHORT:"Array is too short ({length}), minimum {minimum}",ARRAY_LENGTH_LONG:"Array is too long ({length}), maximum {maximum}",ARRAY_UNIQUE:"Array items are not unique (indices {match1} and {match2})",ARRAY_ADDITIONAL_ITEMS:"Additional items not allowed",FORMAT_CUSTOM:"Format validation failed ({message})",KEYWORD_CUSTOM:"Keyword failed: {key} ({message})",CIRCULAR_REFERENCE:"Circular $refs: {urls}",UNKNOWN_PROPERTY:"Unknown property (not in schema)"};ValidationError.prototype=Object.create(Error.prototype),ValidationError.prototype.constructor=ValidationError,ValidationError.prototype.name="ValidationError",ValidationError.prototype.prefixWith=function(dataPrefix,schemaPrefix){if(null!==dataPrefix&&(dataPrefix=dataPrefix.replace(/~/g,"~0").replace(/\//g,"~1"),this.dataPath="/"+dataPrefix+this.dataPath),null!==schemaPrefix&&(schemaPrefix=schemaPrefix.replace(/~/g,"~0").replace(/\//g,"~1"),this.schemaPath="/"+schemaPrefix+this.schemaPath),null!==this.subErrors)for(var i=0;i<this.subErrors.length;i++)this.subErrors[i].prefixWith(dataPrefix,schemaPrefix);return this};var languages={},tv4=createApi();return tv4.addLanguage("en-gb",ErrorMessagesDefault),tv4.tv4=tv4,tv4}),!function(undefined){var ObjectPath={parse:function(str){if("string"!=typeof str)throw new TypeError("ObjectPath.parse must be passed a string");for(var d,b,q,c,i=0,parts=[];i<str.length;)if(d=str.indexOf(".",i),b=str.indexOf("[",i),-1===d&&-1===b)parts.push(str.slice(i,str.length)),i=str.length;else if(-1===b||-1!==d&&b>d)parts.push(str.slice(i,d)),i=d+1;else if(b>i&&(parts.push(str.slice(i,b)),i=b),q=str.slice(b+1,b+2),'"'!==q&&"'"!==q)c=str.indexOf("]",b),-1===c&&(c=str.length),parts.push(str.slice(i+1,c)),i="."===str.slice(c+1,c+2)?c+2:c+1;else{for(c=str.indexOf(q+"]",b),-1===c&&(c=str.length);"\\"===str.slice(c-1,c)&&b<str.length;)b++,c=str.indexOf(q+"]",b);parts.push(str.slice(i+2,c).replace(new RegExp("\\"+q,"g"),q)),i="."===str.slice(c+2,c+3)?c+3:c+2}return parts},stringify:function(arr,quote){return Array.isArray(arr)||(arr=[arr.toString()]),quote='"'===quote?'"':"'",arr.map(function(n){return"["+quote+n.toString().replace(new RegExp(quote,"g"),"\\"+quote)+quote+"]";
}).join("")},normalize:function(data,quote){return ObjectPath.stringify(Array.isArray(data)?data:ObjectPath.parse(data),quote)},registerModule:function(angular){angular.module("ObjectPath",[]).provider("ObjectPath",function(){this.parse=ObjectPath.parse,this.stringify=ObjectPath.stringify,this.normalize=ObjectPath.normalize,this.$get=function(){return ObjectPath}})}};"function"==typeof define&&define.amd?define(function(){return ObjectPath}):"object"==typeof exports?exports.ObjectPath=ObjectPath:window.ObjectPath=ObjectPath}(),function(root,factory){"function"==typeof define&&define.amd?define(["angular","objectpath","tv4"],factory):"object"==typeof exports?module.exports=factory(require("angular"),require("objectpath"),require("tv4")):root.schemaForm=factory(root.angular,root.objectpath,root.tv4)}(this,function(angular,objectpath,tv4){var deps=[];try{angular.module("ngSanitize"),deps.push("ngSanitize")}catch(e){}try{angular.module("ui.sortable"),deps.push("ui.sortable")}catch(e){}try{angular.module("angularSpectrumColorpicker"),deps.push("angularSpectrumColorpicker")}catch(e){}var schemaForm=angular.module("schemaForm",deps);return angular.module("schemaForm").provider("sfPath",[function(){var ObjectPath=window.ObjectPath||objectpath,sfPath={parse:ObjectPath.parse};1===angular.version.major&&angular.version.minor<3?sfPath.stringify=function(arr){return Array.isArray(arr)?arr.join("."):arr.toString()}:sfPath.stringify=ObjectPath.stringify,sfPath.normalize=function(data,quote){return sfPath.stringify(Array.isArray(data)?data:sfPath.parse(data),quote)},this.parse=sfPath.parse,this.stringify=sfPath.stringify,this.normalize=sfPath.normalize,this.$get=function(){return sfPath}}]),angular.module("schemaForm").factory("sfSelect",["sfPath",function(sfPath){var numRe=/^\d+$/;return function(projection,obj,valueToSet){obj||(obj=this);var parts="string"==typeof projection?sfPath.parse(projection):projection;if("undefined"!=typeof valueToSet&&1===parts.length)return obj[parts[0]]=valueToSet,obj;"undefined"!=typeof valueToSet&&"undefined"==typeof obj[parts[0]]&&(obj[parts[0]]=parts.length>2&&numRe.test(parts[1])?[]:{});for(var value=obj[parts[0]],i=1;i<parts.length;i++){if(""===parts[i])return void 0;if("undefined"!=typeof valueToSet){if(i===parts.length-1)return value[parts[i]]=valueToSet,valueToSet;var tmp=value[parts[i]];("undefined"==typeof tmp||null===tmp)&&(tmp=numRe.test(parts[i+1])?[]:{},value[parts[i]]=tmp),value=tmp}else value&&(value=value[parts[i]])}return value}}]),angular.module("schemaForm").provider("sfBuilder",["sfPathProvider",function(sfPathProvider){var SNAKE_CASE_REGEXP=/[A-Z]/g,snakeCase=function(name,separator){return separator=separator||"_",name.replace(SNAKE_CASE_REGEXP,function(letter,pos){return(pos?separator:"")+letter.toLowerCase()})},builders={ngModel:function(args){if(args.form.key){var key=args.form.key;args.state.keyRedaction&&(key=key.slice(args.state.keyRedaction));var modelValue;if(args.state.modelValue)modelValue=args.state.modelValue;else{var strKey=sfPathProvider.stringify(key).replace(/"/g,"&quot;");modelValue=args.state.modelName||"model",strKey&&(modelValue+=("["!==strKey[0]?".":"")+strKey)}for(var nodes=args.fieldFrag.querySelectorAll("[sf-field-model]"),i=0;i<nodes.length;i++){var n=nodes[i],conf=n.getAttribute("sf-field-model");if(conf&&""!==conf)if("replaceAll"===conf)for(var attributes=n.attributes,j=0;attributes.length;j++)attributes[j].value&&-1!==attributes[j].value.indexOf("$$value")&&(attributes[j].value=attributes[j].value.replace(/\$\$value\$\$/g,modelValue));else{var val=n.getAttribute(conf);val&&val.indexOf("$$value$$")?n.setAttribute(conf,val.replace(/\$\$value\$\$/g,modelValue)):n.setAttribute(conf,modelValue)}else n.setAttribute("ng-model",modelValue)}}},simpleTransclusion:function(args){var children=args.build(args.form.items,args.path+".items",args.state);args.fieldFrag.firstChild.appendChild(children)},ngModelOptions:function(args){args.form.ngModelOptions&&Object.keys(args.form.ngModelOptions).length>0&&args.fieldFrag.firstChild.setAttribute("ng-model-options",JSON.stringify(args.form.ngModelOptions))},transclusion:function(args){var transclusions=args.fieldFrag.querySelectorAll("[sf-field-transclude]");if(transclusions.length)for(var i=0;i<transclusions.length;i++){var n=transclusions[i],sub=args.form[n.getAttribute("sf-field-transclude")];if(sub){sub=Array.isArray(sub)?sub:[sub];var childFrag=args.build(sub,args.path+"."+sub,args.state);n.appendChild(childFrag)}}}};this.builders=builders,this.$get=["$templateCache","schemaFormDecorators","sfPath",function($templateCache,schemaFormDecorators,sfPath){var checkForSlot=function(form,slots){if(form.key){var slot=slots[sfPath.stringify(form.key)];if(slot){for(;slot.firstChild;)slot.removeChild(slot.firstChild);return slot}}},build=function(items,decorator,templateFn,slots,path,state){state=state||{},path=path||"schemaForm.form";var container=document.createDocumentFragment();return items.reduce(function(frag,f,index){if(f.type){var field=decorator[f.type]||decorator["default"];if(field.replace){var tmpl,div=document.createElement("div"),template=templateFn(field.template)||templateFn([decorator["default"].template]);for(div.innerHTML=template,tmpl=document.createDocumentFragment();div.childNodes.length>0;)tmpl.appendChild(div.childNodes[0]);tmpl.firstChild.setAttribute("sf-field",path+"["+index+"]");var args={fieldFrag:tmpl,form:f,state:state,path:path+"["+index+"]",build:function(items,path,state){return build(items,decorator,templateFn,slots,path,state)}};"function"==typeof field.builder?field.builder(args):field.builder.forEach(function(fn){fn(args)}),(checkForSlot(f,slots)||frag).appendChild(tmpl)}else{var n=document.createElement(snakeCase(decorator.__name,"-"));n.setAttribute("form",path+"["+index+"]"),(checkForSlot(f,slots)||frag).appendChild(n)}return frag}},container),container};return{build:function(form,decorator,slots){return build(form,decorator,function(url){return $templateCache.get(url)},slots)},builder:builders,internalBuild:build}}]}]),angular.module("schemaForm").provider("schemaFormDecorators",["$compileProvider","sfPathProvider",function($compileProvider,sfPathProvider){var defaultDecorator="",decorators={},templateUrl=function(name,form){"sfDecorator"===name&&(name=defaultDecorator);var decorator=decorators[name];return decorator[form.type]?decorator[form.type].template:decorator["default"].template},createDirective=function(name){$compileProvider.directive(name,["$parse","$compile","$http","$templateCache","$interpolate","$q","sfErrorMessage","sfPath","sfSelect",function($parse,$compile,$http,$templateCache,$interpolate,$q,sfErrorMessage,sfPath,sfSelect){return{restrict:"AE",replace:!1,transclude:!1,scope:!0,require:"?^sfSchema",link:function(scope,element,attrs,sfSchema){scope.$on("schemaFormPropagateNgModelController",function(event,ngModel){event.stopPropagation(),event.preventDefault(),scope.ngModel=ngModel}),scope.showTitle=function(){return scope.form&&scope.form.notitle!==!0&&scope.form.title},scope.listToCheckboxValues=function(list){var values={};return angular.forEach(list,function(v){values[v]=!0}),values},scope.checkboxValuesToList=function(values){var lst=[];return angular.forEach(values,function(v,k){v&&lst.push(k)}),lst},scope.buttonClick=function($event,form){angular.isFunction(form.onClick)?form.onClick($event,form):angular.isString(form.onClick)&&(sfSchema?sfSchema.evalInParentScope(form.onClick,{$event:$event,form:form}):scope.$eval(form.onClick,{$event:$event,form:form}))},scope.evalExpr=function(expression,locals){return sfSchema?sfSchema.evalInParentScope(expression,locals):scope.$eval(expression,locals)},scope.evalInScope=function(expression,locals){return expression?scope.$eval(expression,locals):void 0},scope.interp=function(expression,locals){return expression&&$interpolate(expression)(locals)},scope.hasSuccess=function(){return scope.ngModel?scope.ngModel.$valid&&(!scope.ngModel.$pristine||!scope.ngModel.$isEmpty(scope.ngModel.$modelValue)):!1},scope.hasError=function(){return scope.ngModel?scope.ngModel.$invalid&&!scope.ngModel.$pristine:!1},scope.errorMessage=function(schemaError){return sfErrorMessage.interpolate(schemaError&&schemaError.code+""||"default",scope.ngModel&&scope.ngModel.$modelValue||"",scope.ngModel&&scope.ngModel.$viewValue||"",scope.form,scope.options&&scope.options.validationMessage)};var once=scope.$watch(attrs.form,function(form){if(form){form.ngModelOptions=form.ngModelOptions||{},scope.form=form;var templatePromise;if("template"===form.type&&form.template)templatePromise=$q.when(form.template);else{var url="template"===form.type?form.templateUrl:templateUrl(name,form);templatePromise=$http.get(url,{cache:$templateCache}).then(function(res){return res.data})}templatePromise.then(function(template){if(form.key){var key=form.key?sfPathProvider.stringify(form.key).replace(/"/g,"&quot;"):"";template=template.replace(/\$\$value\$\$/g,"model"+("["!==key[0]?".":"")+key)}if(element.html(template),form.condition){var evalExpr='evalExpr(form.condition,{ model: model, "arrayIndex": arrayIndex})';form.key&&(evalExpr='evalExpr(form.condition,{ model: model, "arrayIndex": arrayIndex, "modelValue": model'+sfPath.stringify(form.key)+"})"),angular.forEach(element.children(),function(child){var ngIf=child.getAttribute("ng-if");child.setAttribute("ng-if",ngIf?"("+ngIf+") || ("+evalExpr+")":evalExpr)})}$compile(element.contents())(scope)}),form.key&&(scope.$on("schemaForm.error."+form.key.join("."),function(event,error,validationMessage,validity){(validationMessage===!0||validationMessage===!1)&&(validity=validationMessage,validationMessage=void 0),scope.ngModel&&error&&(scope.ngModel.$setDirty?scope.ngModel.$setDirty():(scope.ngModel.$dirty=!0,scope.ngModel.$pristine=!1),validationMessage&&(form.validationMessage||(form.validationMessage={}),form.validationMessage[error]=validationMessage),scope.ngModel.$setValidity(error,validity===!0),validity===!0&&scope.$broadcast("schemaFormValidate"))}),scope.$on("$destroy",function(){if(!scope.externalDestructionInProgress){var destroyStrategy=form.destroyStrategy||scope.options&&scope.options.destroyStrategy||"remove";if(form.key&&"retain"!==destroyStrategy){var obj=scope.model;if(form.key.length>1&&(obj=sfSelect(form.key.slice(0,form.key.length-1),obj)),void 0===obj)return;var type=form.schema&&form.schema.type||"";"empty"===destroyStrategy&&-1!==type.indexOf("string")?obj[form.key.slice(-1)]="":"empty"===destroyStrategy&&-1!==type.indexOf("object")?obj[form.key.slice(-1)]={}:"empty"===destroyStrategy&&-1!==type.indexOf("array")?obj[form.key.slice(-1)]=[]:"null"===destroyStrategy?obj[form.key.slice(-1)]=null:delete obj[form.key.slice(-1)]}}})),once()}})}}}])},createManualDirective=function(type,templateUrl,transclude){transclude=angular.isDefined(transclude)?transclude:!1,$compileProvider.directive("sf"+angular.uppercase(type[0])+type.substr(1),function(){return{restrict:"EAC",scope:!0,replace:!0,transclude:transclude,template:'<sf-decorator form="form"></sf-decorator>',link:function(scope,element,attrs){var watchThis={items:"c",titleMap:"c",schema:"c"},form={type:type},once=!0;angular.forEach(attrs,function(value,name){if("$"!==name[0]&&0!==name.indexOf("ng")&&"sfField"!==name){var updateForm=function(val){angular.isDefined(val)&&val!==form[name]&&(form[name]=val,once&&form.type&&(form.key||angular.isUndefined(attrs.key))&&(scope.form=form,once=!1))};"model"===name?scope.$watch(value,function(val){val&&scope.model!==val&&(scope.model=val)}):"c"===watchThis[name]?scope.$watchCollection(value,updateForm):attrs.$observe(name,updateForm)}})}}})};this.createDecorator=function(name,templates){decorators[name]={__name:name},angular.forEach(templates,function(url,type){decorators[name][type]={template:url,replace:!1,builder:[]}}),decorators[defaultDecorator]||(defaultDecorator=name),createDirective(name)},this.defineDecorator=function(name,fields){decorators[name]={__name:name},angular.forEach(fields,function(field,type){field.builder=field.builder||[],field.replace=angular.isDefined(field.replace)?field.replace:!0,decorators[name][type]=field}),decorators[defaultDecorator]||(defaultDecorator=name),createDirective(name)},this.createDirective=createManualDirective,this.createDirectives=function(templates){angular.forEach(templates,function(url,type){createManualDirective(type,url)})},this.decorator=function(name){return name=name||defaultDecorator,decorators[name]},this.addMapping=function(name,type,url,builder,replace){decorators[name]&&(decorators[name][type]={template:url,builder:builder,replace:!!replace})},this.$get=function(){return{decorator:function(name){return decorators[name]||decorators[defaultDecorator]},defaultDecorator:defaultDecorator}},createDirective("sfDecorator")}]),angular.module("schemaForm").provider("sfErrorMessage",function(){var defaultMessages={"default":"Field does not validate",0:"Invalid type, expected {{schema.type}}",1:"No enum match for: {{viewValue}}",10:'Data does not match any schemas from "anyOf"',11:'Data does not match any schemas from "oneOf"',12:'Data is valid against more than one schema from "oneOf"',13:'Data matches schema from "not"',100:"Value is not a multiple of {{schema.divisibleBy}}",101:"{{viewValue}} is less than the allowed minimum of {{schema.minimum}}",102:"{{viewValue}} is equal to the exclusive minimum {{schema.minimum}}",103:"{{viewValue}} is greater than the allowed maximum of {{schema.maximum}}",104:"{{viewValue}} is equal to the exclusive maximum {{schema.maximum}}",105:"Value is not a valid number",200:"String is too short ({{viewValue.length}} chars), minimum {{schema.minLength}}",201:"String is too long ({{viewValue.length}} chars), maximum {{schema.maxLength}}",202:"String does not match pattern: {{schema.pattern}}",300:"Too few properties defined, minimum {{schema.minProperties}}",301:"Too many properties defined, maximum {{schema.maxProperties}}",302:"Required",303:"Additional properties not allowed",304:"Dependency failed - key must exist",400:"Array is too short ({{value.length}}), minimum {{schema.minItems}}",401:"Array is too long ({{value.length}}), maximum {{schema.maxItems}}",402:"Array items are not unique",403:"Additional items not allowed",500:"Format validation failed",501:'Keyword failed: "{{title}}"',600:"Circular $refs",1e3:"Unknown property (not in schema)"};defaultMessages.number=defaultMessages[105],defaultMessages.required=defaultMessages[302],defaultMessages.min=defaultMessages[101],defaultMessages.max=defaultMessages[103],defaultMessages.maxlength=defaultMessages[201],defaultMessages.minlength=defaultMessages[200],defaultMessages.pattern=defaultMessages[202],this.setDefaultMessages=function(messages){defaultMessages=messages},this.getDefaultMessages=function(){return defaultMessages},this.setDefaultMessage=function(error,msg){defaultMessages[error]=msg},this.$get=["$interpolate",function($interpolate){var service={};return service.defaultMessages=defaultMessages,service.interpolate=function(error,value,viewValue,form,global){global=global||{};var validationMessage=form.validationMessage||{};0===error.indexOf("tv4-")&&(error=error.substring(4));var message=validationMessage["default"]||global["default"]||"";[validationMessage,global,defaultMessages].some(function(val){return angular.isString(val)||angular.isFunction(val)?(message=val,!0):val&&val[error]?(message=val[error],!0):void 0});var context={error:error,value:value,viewValue:viewValue,form:form,schema:form.schema,title:form.title||form.schema&&form.schema.title};return angular.isFunction(message)?message(context):$interpolate(message)(context)},service}]}),angular.module("schemaForm").provider("schemaForm",["sfPathProvider",function(sfPathProvider){var stripNullType=function(type){if(Array.isArray(type)&&2==type.length){if("null"===type[0])return type[1];if("null"===type[1])return type[0]}return type},enumToTitleMap=function(enm){var titleMap=[];return enm.forEach(function(name){titleMap.push({name:name,value:name})}),titleMap},canonicalTitleMap=function(titleMap,originalEnum){if(!angular.isArray(titleMap)){var canonical=[];return originalEnum?angular.forEach(originalEnum,function(value,index){canonical.push({name:titleMap[value],value:value})}):angular.forEach(titleMap,function(name,value){canonical.push({name:name,value:value})}),canonical}return titleMap},defaultFormDefinition=function(name,schema,options){var rules=defaults[stripNullType(schema.type)];if(rules)for(var def,i=0;i<rules.length;i++)if(def=rules[i](name,schema,options))return def.schema["x-schema-form"]&&angular.isObject(def.schema["x-schema-form"])&&(def=angular.extend(def,def.schema["x-schema-form"])),def},stdFormObj=function(name,schema,options){options=options||{};var f=options.global&&options.global.formDefaults?angular.copy(options.global.formDefaults):{};return options.global&&options.global.supressPropertyTitles===!0?f.title=schema.title:f.title=schema.title||name,schema.description&&(f.description=schema.description),(options.required===!0||schema.required===!0)&&(f.required=!0),schema.maxLength&&(f.maxlength=schema.maxLength),schema.minLength&&(f.minlength=schema.maxLength),(schema.readOnly||schema.readonly)&&(f.readonly=!0),schema.minimum&&(f.minimum=schema.minimum+(schema.exclusiveMinimum?1:0)),schema.maximum&&(f.maximum=schema.maximum-(schema.exclusiveMaximum?1:0)),schema.validationMessage&&(f.validationMessage=schema.validationMessage),schema.enumNames&&(f.titleMap=canonicalTitleMap(schema.enumNames,schema["enum"])),f.schema=schema,f.ngModelOptions=f.ngModelOptions||{},f},text=function(name,schema,options){if("string"===stripNullType(schema.type)&&!schema["enum"]){var f=stdFormObj(name,schema,options);return f.key=options.path,f.type="text",options.lookup[sfPathProvider.stringify(options.path)]=f,f}},number=function(name,schema,options){if("number"===stripNullType(schema.type)){var f=stdFormObj(name,schema,options);return f.key=options.path,f.type="number",options.lookup[sfPathProvider.stringify(options.path)]=f,f}},integer=function(name,schema,options){if("integer"===stripNullType(schema.type)){var f=stdFormObj(name,schema,options);return f.key=options.path,f.type="number",options.lookup[sfPathProvider.stringify(options.path)]=f,f}},checkbox=function(name,schema,options){if("boolean"===stripNullType(schema.type)){var f=stdFormObj(name,schema,options);return f.key=options.path,f.type="checkbox",options.lookup[sfPathProvider.stringify(options.path)]=f,f}},select=function(name,schema,options){if("string"===stripNullType(schema.type)&&schema["enum"]){var f=stdFormObj(name,schema,options);return f.key=options.path,f.type="select",f.titleMap||(f.titleMap=enumToTitleMap(schema["enum"])),f.trackBy="value",options.lookup[sfPathProvider.stringify(options.path)]=f,f}},checkboxes=function(name,schema,options){if("array"===stripNullType(schema.type)&&schema.items&&schema.items["enum"]){var f=stdFormObj(name,schema,options);return f.key=options.path,f.type="checkboxes",f.titleMap||(f.titleMap=enumToTitleMap(schema.items["enum"])),options.lookup[sfPathProvider.stringify(options.path)]=f,f}},fieldset=function(name,schema,options){if("object"===stripNullType(schema.type)){var f=stdFormObj(name,schema,options);return f.type="fieldset",f.items=[],options.lookup[sfPathProvider.stringify(options.path)]=f,angular.forEach(schema.properties,function(v,k){var path=options.path.slice();if(path.push(k),options.ignore[sfPathProvider.stringify(path)]!==!0){var required=schema.required&&-1!==schema.required.indexOf(k),def=defaultFormDefinition(k,v,{path:path,required:required||!1,lookup:options.lookup,ignore:options.ignore,global:options.global});def&&f.items.push(def)}}),f}},array=function(name,schema,options){if("array"===stripNullType(schema.type)){var f=stdFormObj(name,schema,options);f.type="array",f.key=options.path,options.lookup[sfPathProvider.stringify(options.path)]=f;var required=schema.required&&-1!==schema.required.indexOf(options.path[options.path.length-1]),arrPath=options.path.slice();return arrPath.push(""),f.items=[defaultFormDefinition(name,schema.items,{path:arrPath,required:required||!1,lookup:options.lookup,ignore:options.ignore,global:options.global})],f}},defaults={string:[select,text],object:[fieldset],number:[number],integer:[integer],"boolean":[checkbox],array:[checkboxes,array]},postProcessFn=function(form){return form};this.defaults=defaults,this.stdFormObj=stdFormObj,this.defaultFormDefinition=defaultFormDefinition,this.postProcess=function(fn){postProcessFn=fn},this.appendRule=function(type,rule){defaults[type]||(defaults[type]=[]),defaults[type].push(rule)},this.prependRule=function(type,rule){defaults[type]||(defaults[type]=[]),defaults[type].unshift(rule)},this.createStandardForm=stdFormObj,this.$get=function(){var service={};return service.merge=function(schema,form,ignore,options,readonly){form=form||["*"],options=options||{},readonly=readonly||schema.readonly||schema.readOnly;var stdForm=service.defaults(schema,ignore,options),idx=form.indexOf("*");-1!==idx&&(form=form.slice(0,idx).concat(stdForm.form).concat(form.slice(idx+1)));var lookup=stdForm.lookup;return postProcessFn(form.map(function(obj){if("string"==typeof obj&&(obj={key:obj}),obj.key&&"string"==typeof obj.key&&(obj.key=sfPathProvider.parse(obj.key)),obj.titleMap&&(obj.titleMap=canonicalTitleMap(obj.titleMap)),"select"===obj.type&&(obj.trackBy=obj.trackBy||"value"),obj.itemForm){obj.items=[];var str=sfPathProvider.stringify(obj.key),stdForm=lookup[str];angular.forEach(stdForm.items,function(item){var o=angular.copy(obj.itemForm);o.key=item.key,obj.items.push(o)})}if(obj.key){var strid=sfPathProvider.stringify(obj.key);if(lookup[strid]){var schemaDefaults=lookup[strid];angular.forEach(schemaDefaults,function(value,attr){void 0===obj[attr]&&(obj[attr]=schemaDefaults[attr])})}}return readonly===!0&&(obj.readonly=!0),obj.items&&(obj.items=service.merge(schema,obj.items,ignore,options,obj.readonly)),obj.tabs&&angular.forEach(obj.tabs,function(tab){tab.items=service.merge(schema,tab.items,ignore,options,obj.readonly)}),"checkbox"===obj.type&&angular.isUndefined(obj.schema["default"])&&(obj.schema["default"]=!1),obj}))},service.defaults=function(schema,ignore,globalOptions){var form=[],lookup={};if(ignore=ignore||{},globalOptions=globalOptions||{},"object"!==stripNullType(schema.type))throw new Error('Not implemented. Only type "object" allowed at root level of schema.');return angular.forEach(schema.properties,function(v,k){if(ignore[k]!==!0){var required=schema.required&&-1!==schema.required.indexOf(k),def=defaultFormDefinition(k,v,{path:[k],lookup:lookup,ignore:ignore,required:required,global:globalOptions});def&&form.push(def)}}),{form:form,lookup:lookup}},service.traverseSchema=function(schema,fn,path,ignoreArrays){ignoreArrays=angular.isDefined(ignoreArrays)?ignoreArrays:!0,path=path||[];var traverse=function(schema,fn,path){if(fn(schema,path),angular.forEach(schema.properties,function(prop,name){var currentPath=path.slice();currentPath.push(name),traverse(prop,fn,currentPath)}),!ignoreArrays&&schema.items){var arrPath=path.slice();arrPath.push(""),traverse(schema.items,fn,arrPath)}};traverse(schema,fn,path||[])},service.traverseForm=function(form,fn){fn(form),angular.forEach(form.items,function(f){service.traverseForm(f,fn)}),form.tabs&&angular.forEach(form.tabs,function(tab){angular.forEach(tab.items,function(f){service.traverseForm(f,fn)})})},service}}]),angular.module("schemaForm").factory("sfValidator",[function(){var validator={};return validator.validate=function(form,value){if(!form)return{valid:!0};var schema=form.schema;if(!schema)return{valid:!0};""===value&&(value=void 0),"number"===form.type&&null===value&&(value=void 0);var wrap={type:"object",properties:{}},propName=form.key[form.key.length-1];wrap.properties[propName]=schema,form.required&&(wrap.required=[propName]);var valueWrap={};return angular.isDefined(value)&&(valueWrap[propName]=value),tv4.validateResult(valueWrap,wrap)},validator}]),angular.module("schemaForm").directive("sfArray",["sfSelect","schemaForm","sfValidator","sfPath",function(sfSelect,schemaForm,sfValidator,sfPath){var setIndex=function(index){return function(form){form.key&&(form.key[form.key.indexOf("")]=index)}};return{restrict:"A",scope:!0,require:"?ngModel",link:function(scope,element,attrs,ngModel){var formDefCache={};scope.validateArray=angular.noop,ngModel&&scope.$emit("schemaFormPropagateNgModelController",ngModel);var once=scope.$watch(attrs.sfArray,function(form){var list=sfSelect(form.key,scope.model);if(scope.$watch("model"+sfPath.normalize(form.key),function(value){list=scope.modelArray=value}),angular.isUndefined(list)&&(list=[],sfSelect(form.key,scope.model,list)),scope.modelArray=list,form.items){var subForm=form.items[0];form.items.length>1&&(subForm={type:"section",items:form.items.map(function(item){return item.ngModelOptions=form.ngModelOptions,angular.isUndefined(item.readonly)&&(item.readonly=form.readonly),item})})}if(scope.copyWithIndex=function(index){if(!formDefCache[index]&&subForm){var copy=angular.copy(subForm);copy.arrayIndex=index,schemaForm.traverseForm(copy,setIndex(index)),formDefCache[index]=copy}return formDefCache[index]},scope.appendToArray=function(){var len=list.length,copy=scope.copyWithIndex(len);if(schemaForm.traverseForm(copy,function(part){if(part.key){var def;angular.isDefined(part["default"])&&(def=part["default"]),angular.isDefined(part.schema)&&angular.isDefined(part.schema["default"])&&(def=part.schema["default"]),angular.isDefined(def)&&sfSelect(part.key,scope.model,def)}}),len===list.length){var dflt,type=sfSelect("schema.items.type",form);"object"===type?dflt={}:"array"===type&&(dflt=[]),list.push(dflt)}return scope.validateArray(),list},scope.deleteFromArray=function(index){return list.splice(index,1),scope.validateArray(),ngModel&&ngModel.$setDirty&&ngModel.$setDirty(),list},form.titleMap||form.startEmpty===!0||0!==list.length||scope.appendToArray(),form.titleMap&&form.titleMap.length>0){scope.titleMapValues=[];var updateTitleMapValues=function(arr){scope.titleMapValues=[],arr=arr||[],form.titleMap.forEach(function(item){scope.titleMapValues.push(-1!==arr.indexOf(item.value))})};updateTitleMapValues(scope.modelArray),scope.$watchCollection("modelArray",updateTitleMapValues),scope.$watchCollection("titleMapValues",function(vals,old){if(vals&&vals!==old){for(var arr=scope.modelArray;arr.length>0;)arr.pop();form.titleMap.forEach(function(item,index){vals[index]&&arr.push(item.value)}),scope.validateArray()}})}if(ngModel){var error;scope.validateArray=function(){var result=sfValidator.validate(form,scope.modelArray.length>0?scope.modelArray:void 0);Object.keys(ngModel.$error).filter(function(k){return 0===k.indexOf("tv4-")}).forEach(function(k){ngModel.$setValidity(k,!0)}),result.valid!==!1||!result.error||""!==result.error.dataPath&&result.error.dataPath!=="/"+form.key[form.key.length-1]||(ngModel.$setViewValue(scope.modelArray),error=result.error,ngModel.$setValidity("tv4-"+result.error.code,!1))},scope.$on("schemaFormValidate",scope.validateArray),scope.hasSuccess=function(){return ngModel.$valid&&!ngModel.$pristine},scope.hasError=function(){return ngModel.$invalid},scope.schemaError=function(){return error}}once()})}}}]),angular.module("schemaForm").directive("sfChanged",function(){return{require:"ngModel",restrict:"AC",scope:!1,link:function(scope,element,attrs,ctrl){var form=scope.$eval(attrs.sfChanged);form&&form.onChange&&ctrl.$viewChangeListeners.push(function(){angular.isFunction(form.onChange)?form.onChange(ctrl.$modelValue,form):scope.evalExpr(form.onChange,{modelValue:ctrl.$modelValue,form:form})})}}}),angular.module("schemaForm").directive("sfField",["$parse","$compile","$http","$templateCache","$interpolate","$q","sfErrorMessage","sfPath","sfSelect",function($parse,$compile,$http,$templateCache,$interpolate,$q,sfErrorMessage,sfPath,sfSelect){return{restrict:"AE",replace:!1,transclude:!1,scope:!0,require:"?^sfSchema",link:{pre:function(scope){scope.$on("schemaFormPropagateNgModelController",function(event,ngModel){event.stopPropagation(),event.preventDefault(),scope.ngModel=ngModel}),scope.form=null},post:function(scope,element,attrs,sfSchema){scope.showTitle=function(){return scope.form&&scope.form.notitle!==!0&&scope.form.title},scope.listToCheckboxValues=function(list){var values={};return angular.forEach(list,function(v){values[v]=!0}),values},scope.checkboxValuesToList=function(values){var lst=[];return angular.forEach(values,function(v,k){v&&lst.push(k)}),lst},scope.buttonClick=function($event,form){angular.isFunction(form.onClick)?form.onClick($event,form):angular.isString(form.onClick)&&(sfSchema?sfSchema.evalInParentScope(form.onClick,{$event:$event,form:form}):scope.$eval(form.onClick,{$event:$event,form:form}))},scope.evalExpr=function(expression,locals){return sfSchema?sfSchema.evalInParentScope(expression,locals):scope.$eval(expression,locals)},scope.evalInScope=function(expression,locals){return expression?scope.$eval(expression,locals):void 0},scope.interp=function(expression,locals){return expression&&$interpolate(expression)(locals)},scope.hasSuccess=function(){return scope.ngModel?scope.ngModel.$valid&&(!scope.ngModel.$pristine||!scope.ngModel.$isEmpty(scope.ngModel.$modelValue)):!1},scope.hasError=function(){return scope.ngModel?scope.ngModel.$invalid&&!scope.ngModel.$pristine:!1},scope.errorMessage=function(schemaError){return sfErrorMessage.interpolate(schemaError&&schemaError.code+""||"default",scope.ngModel&&scope.ngModel.$modelValue||"",scope.ngModel&&scope.ngModel.$viewValue||"",scope.form,scope.options&&scope.options.validationMessage)};var once=scope.$watch(attrs.sfField,function(form){form&&(form.ngModelOptions=form.ngModelOptions||{},scope.form=form,form.key&&(scope.$on("schemaForm.error."+form.key.join("."),function(event,error,validationMessage,validity){(validationMessage===!0||validationMessage===!1)&&(validity=validationMessage,validationMessage=void 0),scope.ngModel&&error&&(scope.ngModel.$setDirty?scope.ngModel.$setDirty():(scope.ngModel.$dirty=!0,scope.ngModel.$pristine=!1),validationMessage&&(form.validationMessage||(form.validationMessage={}),form.validationMessage[error]=validationMessage),scope.ngModel.$setValidity(error,validity===!0),validity===!0&&scope.$broadcast("schemaFormValidate"))}),scope.$on("$destroy",function(){if(!scope.externalDestructionInProgress){var destroyStrategy=form.destroyStrategy||scope.options&&scope.options.destroyStrategy||"remove";if(form.key&&"retain"!==destroyStrategy){var obj=scope.model;if(form.key.length>1&&(obj=sfSelect(form.key.slice(0,form.key.length-1),obj)),void 0===obj)return;var type=form.schema&&form.schema.type||"";"empty"===destroyStrategy&&-1!==type.indexOf("string")?obj[form.key.slice(-1)]="":"empty"===destroyStrategy&&-1!==type.indexOf("object")?obj[form.key.slice(-1)]={}:"empty"===destroyStrategy&&-1!==type.indexOf("array")?obj[form.key.slice(-1)]=[]:"null"===destroyStrategy?obj[form.key.slice(-1)]=null:delete obj[form.key.slice(-1)]}}})),once())})}}}}]),angular.module("schemaForm").directive("sfMessage",["$injector","sfErrorMessage",function($injector,sfErrorMessage){return{scope:!1,restrict:"EA",link:function(scope,element,attrs){var $sanitize=$injector.has("$sanitize")?$injector.get("$sanitize"):function(html){return html},message="";attrs.sfMessage&&scope.$watch(attrs.sfMessage,function(msg){msg&&(message=$sanitize(msg),scope.ngModel?update(scope.ngModel.$valid):update())});var update=function(valid){if(valid&&!scope.hasError())element.html(message);else{var errors=[];angular.forEach(scope.ngModel&&scope.ngModel.$error||{},function(status,code){status&&errors.push(code)}),errors=errors.filter(function(e){return"schemaForm"!==e});var error=errors[0];error?element.html(sfErrorMessage.interpolate(error,scope.ngModel.$modelValue,scope.ngModel.$viewValue,scope.form,scope.options&&scope.options.validationMessage)):element.html(message);
}};update(),scope.$watchCollection("ngModel.$error",function(){scope.ngModel&&update(scope.ngModel.$valid)})}}}]),angular.module("schemaForm").directive("sfSchema",["$compile","schemaForm","schemaFormDecorators","sfSelect","sfPath","sfBuilder",function($compile,schemaForm,schemaFormDecorators,sfSelect,sfPath,sfBuilder){return{scope:{schema:"=sfSchema",initialForm:"=sfForm",model:"=sfModel",options:"=sfOptions"},controller:["$scope",function($scope){this.evalInParentScope=function(expr,locals){return $scope.$parent.$eval(expr,locals)}}],replace:!1,restrict:"A",transclude:!0,require:"?form",link:function(scope,element,attrs,formCtrl,transclude){scope.formCtrl=formCtrl;var ignore={};transclude(scope,function(clone){if(clone.addClass("schema-form-ignore"),element.prepend(clone),element[0].querySelectorAll){var models=element[0].querySelectorAll("[ng-model]");if(models)for(var i=0;i<models.length;i++){var key=models[i].getAttribute("ng-model");ignore[key.substring(key.indexOf(".")+1)]=!0}}});var childScope,lastDigest={},render=function(schema,form){var merged=schemaForm.merge(schema,form,ignore,scope.options);childScope&&(scope.externalDestructionInProgress=!0,childScope.$destroy(),scope.externalDestructionInProgress=!1),childScope=scope.$new(),childScope.schemaForm={form:merged,schema:schema},element.children(":not(.schema-form-ignore)").remove();for(var slots={},slotsFound=element[0].querySelectorAll("*[sf-insert-field]"),i=0;i<slotsFound.length;i++)slots[slotsFound[i].getAttribute("sf-insert-field")]=slotsFound[i];var decorator=schemaFormDecorators.decorator(attrs.sfUseDecorator);element[0].appendChild(sfBuilder.build(merged,decorator,slots)),$compile(element.children())(childScope),scope.options&&scope.options.setSchemaDefaults===!1||schemaForm.traverseSchema(schema,function(prop,path){if(angular.isDefined(prop["default"])){var val=sfSelect(path,scope.model);angular.isUndefined(val)&&sfSelect(path,scope.model,prop["default"])}}),scope.$emit("sf-render-finished",element)};scope.$watch(function(){var schema=scope.schema,form=scope.initialForm||["*"];form&&schema&&schema.type&&(lastDigest.form!==form||lastDigest.schema!==schema)&&Object.keys(schema.properties).length>0&&(lastDigest.schema=schema,lastDigest.form=form,render(schema,form))}),scope.$on("schemaFormRedraw",function(){var schema=scope.schema,form=scope.initialForm||["*"];schema&&render(schema,form)}),scope.$on("$destroy",function(){scope.externalDestructionInProgress=!0})}}}]),angular.module("schemaForm").directive("schemaValidate",["sfValidator","$parse","sfSelect",function(sfValidator,$parse,sfSelect){return{restrict:"A",scope:!1,priority:500,require:"ngModel",link:function(scope,element,attrs,ngModel){scope.$emit("schemaFormPropagateNgModelController",ngModel);var error=null,once=scope.$watch(attrs.schemaValidate,function(form){if(form){form.copyValueTo&&ngModel.$viewChangeListeners.push(function(){var paths=form.copyValueTo;angular.forEach(paths,function(path){sfSelect(path,scope.model,ngModel.$modelValue)})});var validate=function(viewValue){if(!form)return viewValue;if(scope.options&&scope.options.tv4Validation===!1)return viewValue;var result=sfValidator.validate(form,viewValue);return Object.keys(ngModel.$error).filter(function(k){return 0===k.indexOf("tv4-")}).forEach(function(k){ngModel.$setValidity(k,!0)}),result.valid?viewValue:(ngModel.$setValidity("tv4-"+result.error.code,!1),error=result.error,ngModel.$validators?viewValue:void 0)};"function"==typeof form.ngModel&&form.ngModel(ngModel),["$parsers","$viewChangeListeners","$formatters"].forEach(function(attr){form[attr]&&ngModel[attr]&&form[attr].forEach(function(fn){ngModel[attr].push(fn)})}),["$validators","$asyncValidators"].forEach(function(attr){form[attr]&&ngModel[attr]&&angular.forEach(form[attr],function(fn,name){ngModel[attr][name]=fn})}),ngModel.$parsers.push(validate),ngModel.$validators&&(ngModel.$validators.schemaForm=function(){return!Object.keys(ngModel.$error).some(function(e){return"schemaForm"!==e})}),scope.$on("schemaFormValidate",function(){ngModel.$setDirty?(ngModel.$setDirty(),ngModel.$setViewValue(ngModel.$viewValue),ngModel.$commitViewValue(),form.required&&ngModel.$isEmpty(ngModel.$modelValue)&&ngModel.$setValidity("tv4-302",!1)):ngModel.$setViewValue(ngModel.$viewValue)}),scope.schemaError=function(){return error},once()}})}}}]),schemaForm}),angular.module("schemaForm").run(["$templateCache",function($templateCache){$templateCache.put("directives/decorators/bootstrap/actions-trcl.html",'<div class="btn-group schema-form-actions {{form.htmlClass}}" ng-transclude=""></div>'),$templateCache.put("directives/decorators/bootstrap/actions.html",'<div class="btn-group schema-form-actions {{form.htmlClass}}"><input ng-repeat-start="item in form.items" type="submit" class="btn {{ item.style || \'btn-default\' }} {{form.fieldHtmlClass}}" value="{{item.title}}" ng-if="item.type === \'submit\'"> <button ng-repeat-end="" class="btn {{ item.style || \'btn-default\' }} {{form.fieldHtmlClass}}" type="button" ng-disabled="form.readonly" ng-if="item.type !== \'submit\'" ng-click="buttonClick($event,item)"><span ng-if="item.icon" class="{{item.icon}}"></span>{{item.title}}</button></div>'),$templateCache.put("directives/decorators/bootstrap/array.html",'<div sf-array="form" class="schema-form-array {{form.htmlClass}}" ng-model="$$value$$" ng-model-options="form.ngModelOptions"><h3 ng-show="form.title && form.notitle !== true">{{ form.title }}</h3><ol class="list-group" ng-model="modelArray" ui-sortable=""><li class="list-group-item {{form.fieldHtmlClass}}" ng-repeat="item in modelArray track by $index"><button ng-hide="form.readonly || form.remove === null" ng-click="deleteFromArray($index)" style="position: relative; z-index: 20;" type="button" class="close pull-right"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><sf-decorator ng-init="arrayIndex = $index" form="copyWithIndex($index)"></sf-decorator></li></ol><div class="clearfix" style="padding: 15px;"><button ng-hide="form.readonly || form.add === null" ng-click="appendToArray()" type="button" class="btn {{ form.style.add || \'btn-default\' }} pull-right"><i class="glyphicon glyphicon-plus"></i> {{ form.add || \'Add\'}}</button></div><div class="help-block" ng-show="(hasError() && errorMessage(schemaError())) || form.description" ng-bind-html="(hasError() && errorMessage(schemaError())) || form.description"></div></div>'),$templateCache.put("directives/decorators/bootstrap/checkbox.html",'<div class="checkbox schema-form-checkbox {{form.htmlClass}}" ng-class="{\'has-error\': form.disableErrorState !== true && hasError(), \'has-success\': form.disableSuccessState !== true && hasSuccess()}"><label class="{{form.labelHtmlClass}}"><input type="checkbox" sf-changed="form" ng-disabled="form.readonly" ng-model="$$value$$" ng-model-options="form.ngModelOptions" schema-validate="form" class="{{form.fieldHtmlClass}}" name="{{form.key.slice(-1)[0]}}"> <span ng-bind-html="form.title"></span></label><div class="help-block" sf-message="form.description"></div></div>'),$templateCache.put("directives/decorators/bootstrap/checkboxes.html",'<div sf-array="form" ng-model="$$value$$" class="form-group schema-form-checkboxes {{form.htmlClass}}" ng-class="{\'has-error\': form.disableErrorState !== true && hasError(), \'has-success\': form.disableSuccessState !== true && hasSuccess()}"><label class="control-label {{form.labelHtmlClass}}" ng-show="showTitle()">{{form.title}}</label><div class="checkbox" ng-repeat="val in titleMapValues track by $index"><label><input type="checkbox" ng-disabled="form.readonly" sf-changed="form" class="{{form.fieldHtmlClass}}" ng-model="titleMapValues[$index]" name="{{form.key.slice(-1)[0]}}"> <span ng-bind-html="form.titleMap[$index].name"></span></label></div><div class="help-block" sf-message="form.description"></div></div>'),$templateCache.put("directives/decorators/bootstrap/default.html",'<div class="form-group schema-form-{{form.type}} {{form.htmlClass}}" ng-class="{\'has-error\': form.disableErrorState !== true && hasError(), \'has-success\': form.disableSuccessState !== true && hasSuccess(), \'has-feedback\': form.feedback !== false }"><label class="control-label {{form.labelHtmlClass}}" ng-class="{\'sr-only\': !showTitle()}" for="{{form.key.slice(-1)[0]}}">{{form.title}}</label> <input ng-if="!form.fieldAddonLeft && !form.fieldAddonRight" ng-show="form.key" type="{{form.type}}" step="any" sf-changed="form" placeholder="{{form.placeholder}}" class="form-control {{form.fieldHtmlClass}}" id="{{form.key.slice(-1)[0]}}" ng-model-options="form.ngModelOptions" ng-model="$$value$$" ng-disabled="form.readonly" schema-validate="form" name="{{form.key.slice(-1)[0]}}" aria-describedby="{{form.key.slice(-1)[0] + \'Status\'}}"><div ng-if="form.fieldAddonLeft || form.fieldAddonRight" ng-class="{\'input-group\': (form.fieldAddonLeft || form.fieldAddonRight)}"><span ng-if="form.fieldAddonLeft" class="input-group-addon" ng-bind-html="form.fieldAddonLeft"></span> <input ng-show="form.key" type="{{form.type}}" step="any" sf-changed="form" placeholder="{{form.placeholder}}" class="form-control {{form.fieldHtmlClass}}" id="{{form.key.slice(-1)[0]}}" ng-model-options="form.ngModelOptions" ng-model="$$value$$" ng-disabled="form.readonly" schema-validate="form" name="{{form.key.slice(-1)[0]}}" aria-describedby="{{form.key.slice(-1)[0] + \'Status\'}}"> <span ng-if="form.fieldAddonRight" class="input-group-addon" ng-bind-html="form.fieldAddonRight"></span></div><span ng-if="form.feedback !== false" class="form-control-feedback" ng-class="evalInScope(form.feedback) || {\'glyphicon\': true, \'glyphicon-ok\': hasSuccess(), \'glyphicon-remove\': hasError() }" aria-hidden="true"></span> <span ng-if="hasError() || hasSuccess()" id="{{form.key.slice(-1)[0] + \'Status\'}}" class="sr-only">{{ hasSuccess() ? \'(success)\' : \'(error)\' }}</span><div class="help-block" sf-message="form.description"></div></div>'),$templateCache.put("directives/decorators/bootstrap/fieldset-trcl.html",'<fieldset ng-disabled="form.readonly" class="schema-form-fieldset {{form.htmlClass}}"><legend ng-class="{\'sr-only\': !showTitle() }">{{ form.title }}</legend><div class="help-block" ng-show="form.description" ng-bind-html="form.description"></div><div ng-transclude=""></div></fieldset>'),$templateCache.put("directives/decorators/bootstrap/fieldset.html",'<fieldset ng-disabled="form.readonly" class="schema-form-fieldset {{form.htmlClass}}"><legend ng-class="{\'sr-only\': !showTitle() }">{{ form.title }}</legend><div class="help-block" ng-show="form.description" ng-bind-html="form.description"></div><sf-decorator ng-repeat="item in form.items" form="item"></sf-decorator></fieldset>'),$templateCache.put("directives/decorators/bootstrap/help.html",'<div class="helpvalue schema-form-helpvalue {{form.htmlClass}}" ng-bind-html="form.helpvalue"></div>'),$templateCache.put("directives/decorators/bootstrap/radio-buttons.html",'<div class="form-group schema-form-radiobuttons {{form.htmlClass}}" ng-class="{\'has-error\': form.disableErrorState !== true && hasError(), \'has-success\': form.disableSuccessState !== true && hasSuccess()}"><div><label class="control-label {{form.labelHtmlClass}}" ng-show="showTitle()">{{form.title}}</label></div><div class="btn-group"><label class="btn {{ (item.value === $$value$$) ? form.style.selected || \'btn-default\' : form.style.unselected || \'btn-default\'; }}" ng-class="{ active: item.value === $$value$$ }" ng-repeat="item in form.titleMap"><input type="radio" class="{{form.fieldHtmlClass}}" sf-changed="form" style="display: none;" ng-disabled="form.readonly" ng-model="$$value$$" ng-model-options="form.ngModelOptions" schema-validate="form" ng-value="item.value" name="{{form.key.join(\'.\')}}"> <span ng-bind-html="item.name"></span></label></div><div class="help-block" sf-message="form.description"></div></div>'),$templateCache.put("directives/decorators/bootstrap/radios-inline.html",'<div class="form-group schema-form-radios-inline {{form.htmlClass}}" ng-class="{\'has-error\': form.disableErrorState !== true && hasError(), \'has-success\': form.disableSuccessState !== true && hasSuccess()}"><label class="control-label {{form.labelHtmlClass}}" ng-show="showTitle()">{{form.title}}</label><div><label class="radio-inline" ng-repeat="item in form.titleMap"><input type="radio" class="{{form.fieldHtmlClass}}" sf-changed="form" ng-disabled="form.readonly" ng-model="$$value$$" schema-validate="form" ng-value="item.value" name="{{form.key.join(\'.\')}}"> <span ng-bind-html="item.name"></span></label></div><div class="help-block" sf-message="form.description"></div></div>'),$templateCache.put("directives/decorators/bootstrap/radios.html",'<div class="form-group schema-form-radios {{form.htmlClass}}" ng-class="{\'has-error\': form.disableErrorState !== true && hasError(), \'has-success\': form.disableSuccessState !== true && hasSuccess()}"><label class="control-label {{form.labelHtmlClass}}" ng-show="showTitle()">{{form.title}}</label><div class="radio" ng-repeat="item in form.titleMap"><label><input type="radio" class="{{form.fieldHtmlClass}}" sf-changed="form" ng-disabled="form.readonly" ng-model="$$value$$" ng-model-options="form.ngModelOptions" schema-validate="form" ng-value="item.value" name="{{form.key.join(\'.\')}}"> <span ng-bind-html="item.name"></span></label></div><div class="help-block" sf-message="form.description"></div></div>'),$templateCache.put("directives/decorators/bootstrap/section.html",'<div class="schema-form-section {{form.htmlClass}}"><sf-decorator ng-repeat="item in form.items" form="item"></sf-decorator></div>'),$templateCache.put("directives/decorators/bootstrap/select.html",'<div class="form-group {{form.htmlClass}} schema-form-select" ng-class="{\'has-error\': form.disableErrorState !== true && hasError(), \'has-success\': form.disableSuccessState !== true && hasSuccess(), \'has-feedback\': form.feedback !== false}"><label class="control-label {{form.labelHtmlClass}}" ng-show="showTitle()">{{form.title}}</label><select ng-model="$$value$$" ng-model-options="form.ngModelOptions" ng-disabled="form.readonly" sf-changed="form" class="form-control {{form.fieldHtmlClass}}" schema-validate="form" ng-options="item.value as item.name group by item.group for item in form.titleMap track by item[form.trackBy]" name="{{form.key.slice(-1)[0]}}"></select><div class="help-block" sf-message="form.description"></div></div>'),$templateCache.put("directives/decorators/bootstrap/submit.html",'<div class="form-group schema-form-submit {{form.htmlClass}}"><input type="submit" class="btn {{ form.style || \'btn-primary\' }} {{form.fieldHtmlClass}}" value="{{form.title}}" ng-disabled="form.readonly" ng-if="form.type === \'submit\'"> <button class="btn {{ form.style || \'btn-default\' }}" type="button" ng-click="buttonClick($event,form)" ng-disabled="form.readonly" ng-if="form.type !== \'submit\'"><span ng-if="form.icon" class="{{form.icon}}"></span> {{form.title}}</button></div>'),$templateCache.put("directives/decorators/bootstrap/tabarray.html",'<div sf-array="form" ng-init="selected = { tab: 0 }" class="clearfix schema-form-tabarray schema-form-tabarray-{{form.tabType || \'left\'}} {{form.htmlClass}}"><div ng-if="!form.tabType || form.tabType !== \'right\'" ng-class="{\'col-xs-3\': !form.tabType || form.tabType === \'left\'}"><ul class="nav nav-tabs" ng-class="{ \'tabs-left\': !form.tabType || form.tabType === \'left\'}"><li ng-repeat="item in modelArray track by $index" ng-click="$event.preventDefault() || (selected.tab = $index)" ng-class="{active: selected.tab === $index}"><a href="#">{{interp(form.title,{\'$index\':$index, value: item}) || $index}}</a></li><li ng-hide="form.readonly" ng-click="$event.preventDefault() || (selected.tab = appendToArray().length - 1)"><a href="#"><i class="glyphicon glyphicon-plus"></i> {{ form.add || \'Add\'}}</a></li></ul></div><div ng-class="{\'col-xs-9\': !form.tabType || form.tabType === \'left\' || form.tabType === \'right\'}"><div class="tab-content {{form.fieldHtmlClass}}"><div class="tab-pane clearfix" ng-repeat="item in modelArray track by $index" ng-show="selected.tab === $index" ng-class="{active: selected.tab === $index}"><sf-decorator ng-init="arrayIndex = $index" form="copyWithIndex($index)"></sf-decorator><button ng-hide="form.readonly" ng-click="selected.tab = deleteFromArray($index).length - 1" type="button" class="btn {{ form.style.remove || \'btn-default\' }} pull-right"><i class="glyphicon glyphicon-trash"></i> {{ form.remove || \'Remove\'}}</button></div></div></div><div ng-if="form.tabType === \'right\'" class="col-xs-3"><ul class="nav nav-tabs tabs-right"><li ng-repeat="item in modelArray track by $index" ng-click="$event.preventDefault() || (selected.tab = $index)" ng-class="{active: selected.tab === $index}"><a href="#">{{interp(form.title,{\'$index\':$index, value: item}) || $index}}</a></li><li ng-hide="form.readonly" ng-click="$event.preventDefault() || appendToArray()"><a href="#"><i class="glyphicon glyphicon-plus"></i> {{ form.add || \'Add\'}}</a></li></ul></div></div>'),$templateCache.put("directives/decorators/bootstrap/tabs.html",'<div ng-init="selected = { tab: 0 }" class="schema-form-tabs {{form.htmlClass}}"><ul class="nav nav-tabs"><li ng-repeat="tab in form.tabs" ng-disabled="form.readonly" ng-click="$event.preventDefault() || (selected.tab = $index)" ng-class="{active: selected.tab === $index}"><a href="#">{{ tab.title }}</a></li></ul><div class="tab-content {{form.fieldHtmlClass}}"><div class="tab-pane" ng-disabled="form.readonly" ng-repeat="tab in form.tabs" ng-show="selected.tab === $index" ng-class="{active: selected.tab === $index}"><bootstrap-decorator ng-repeat="item in tab.items" form="item"></bootstrap-decorator></div></div></div>'),$templateCache.put("directives/decorators/bootstrap/textarea.html",'<div class="form-group has-feedback {{form.htmlClass}} schema-form-textarea" ng-class="{\'has-error\': form.disableErrorState !== true && hasError(), \'has-success\': form.disableSuccessState !== true && hasSuccess()}"><label class="{{form.labelHtmlClass}}" ng-class="{\'sr-only\': !showTitle()}" for="{{form.key.slice(-1)[0]}}">{{form.title}}</label> <textarea ng-if="!form.fieldAddonLeft && !form.fieldAddonRight" class="form-control {{form.fieldHtmlClass}}" id="{{form.key.slice(-1)[0]}}" sf-changed="form" placeholder="{{form.placeholder}}" ng-disabled="form.readonly" ng-model="$$value$$" ng-model-options="form.ngModelOptions" schema-validate="form" name="{{form.key.slice(-1)[0]}}"></textarea><div ng-if="form.fieldAddonLeft || form.fieldAddonRight" ng-class="{\'input-group\': (form.fieldAddonLeft || form.fieldAddonRight)}"><span ng-if="form.fieldAddonLeft" class="input-group-addon" ng-bind-html="form.fieldAddonLeft"></span> <textarea class="form-control {{form.fieldHtmlClass}}" id="{{form.key.slice(-1)[0]}}" sf-changed="form" placeholder="{{form.placeholder}}" ng-disabled="form.readonly" ng-model="$$value$$" ng-model-options="form.ngModelOptions" schema-validate="form" name="{{form.key.slice(-1)[0]}}"></textarea> <span ng-if="form.fieldAddonRight" class="input-group-addon" ng-bind-html="form.fieldAddonRight"></span></div><span class="help-block" sf-message="form.description"></span></div>')}]),angular.module("schemaForm").config(["schemaFormDecoratorsProvider",function(decoratorsProvider){var base="directives/decorators/bootstrap/";decoratorsProvider.defineDecorator("bootstrapDecorator",{textarea:{template:base+"textarea.html",replace:!1},fieldset:{template:base+"fieldset.html",replace:!1},array:{template:base+"array.html",replace:!1},tabarray:{template:base+"tabarray.html",replace:!1},tabs:{template:base+"tabs.html",replace:!1},section:{template:base+"section.html",replace:!1},conditional:{template:base+"section.html",replace:!1},actions:{template:base+"actions.html",replace:!1},select:{template:base+"select.html",replace:!1},checkbox:{template:base+"checkbox.html",replace:!1},checkboxes:{template:base+"checkboxes.html",replace:!1},number:{template:base+"default.html",replace:!1},password:{template:base+"default.html",replace:!1},submit:{template:base+"submit.html",replace:!1},button:{template:base+"submit.html",replace:!1},radios:{template:base+"radios.html",replace:!1},"radios-inline":{template:base+"radios-inline.html",replace:!1},radiobuttons:{template:base+"radio-buttons.html",replace:!1},help:{template:base+"help.html",replace:!1},"default":{template:base+"default.html",replace:!1}},[]),decoratorsProvider.createDirectives({textarea:base+"textarea.html",select:base+"select.html",checkbox:base+"checkbox.html",checkboxes:base+"checkboxes.html",number:base+"default.html",submit:base+"submit.html",button:base+"submit.html",text:base+"default.html",date:base+"default.html",password:base+"default.html",datepicker:base+"datepicker.html",input:base+"default.html",radios:base+"radios.html","radios-inline":base+"radios-inline.html",radiobuttons:base+"radio-buttons.html"})}]).directive("sfFieldset",function(){return{transclude:!0,scope:!0,templateUrl:"directives/decorators/bootstrap/fieldset-trcl.html",link:function(scope,element,attrs){scope.title=scope.$eval(attrs.title)}}}),this.org=this.org||{},org.cometd={},org.cometd.JSON={},org.cometd.JSON.toJSON=org.cometd.JSON.fromJSON=function(object){throw"Abstract"},org.cometd.Cometd=function(name){function _fieldValue(object,name){try{return object[name]}catch(x){return void 0}}function _isString(value){return org.cometd.Utils.isString(value)}function _isFunction(value){return void 0===value||null===value?!1:"function"==typeof value}function _log(level,args){if(window.console){var logger=window.console[level];_isFunction(logger)&&logger.apply(window.console,args)}}function _configure(configuration){_cometd._debug("Configuring cometd object with",configuration),_isString(configuration)&&(configuration={url:configuration}),configuration||(configuration={}),_config=_cometd._mixin(!1,_config,configuration);var url=_cometd.getURL();if(!url)throw"Missing required configuration parameter 'url' specifying the Bayeux server URL";var urlParts=/(^https?:\/\/)?(((\[[^\]]+\])|([^:\/\?#]+))(:(\d+))?)?([^\?#]*)(.*)?/.exec(url),hostAndPort=urlParts[2],uri=urlParts[8],afterURI=urlParts[9];if(_crossDomain=_cometd._isCrossDomain(hostAndPort),_config.appendMessageTypeToURL)if(void 0!==afterURI&&afterURI.length>0)_cometd._info("Appending message type to URI "+uri+afterURI+" is not supported, disabling 'appendMessageTypeToURL' configuration"),_config.appendMessageTypeToURL=!1;else{var uriSegments=uri.split("/"),lastSegmentIndex=uriSegments.length-1;uri.match(/\/$/)&&(lastSegmentIndex-=1),uriSegments[lastSegmentIndex].indexOf(".")>=0&&(_cometd._info("Appending message type to URI "+uri+" is not supported, disabling 'appendMessageTypeToURL' configuration"),_config.appendMessageTypeToURL=!1)}}function _removeListener(subscription){if(subscription){var subscriptions=_listeners[subscription.channel];subscriptions&&subscriptions[subscription.id]&&(delete subscriptions[subscription.id],_cometd._debug("Removed",subscription.listener?"listener":"subscription",subscription))}}function _removeSubscription(subscription){subscription&&!subscription.listener&&_removeListener(subscription)}function _clearSubscriptions(){for(var channel in _listeners){var subscriptions=_listeners[channel];if(subscriptions)for(var i=0;i<subscriptions.length;++i)_removeSubscription(subscriptions[i])}}function _setStatus(newStatus){_status!==newStatus&&(_cometd._debug("Status",_status,"->",newStatus),_status=newStatus)}function _isDisconnected(){return"disconnecting"===_status||"disconnected"===_status}function _nextMessageId(){return++_messageId}function _applyExtension(scope,callback,name,message,outgoing){try{return callback.call(scope,message)}catch(x){_cometd._debug("Exception during execution of extension",name,x);var exceptionCallback=_cometd.onExtensionException;if(_isFunction(exceptionCallback)){_cometd._debug("Invoking extension exception callback",name,x);try{exceptionCallback.call(_cometd,x,name,outgoing,message)}catch(xx){_cometd._info("Exception during execution of exception callback in extension",name,xx)}}return message}}function _applyIncomingExtensions(message){for(var i=0;i<_extensions.length&&(void 0!==message&&null!==message);++i){var index=_config.reverseIncomingExtensions?_extensions.length-1-i:i,extension=_extensions[index],callback=extension.extension.incoming;if(_isFunction(callback)){var result=_applyExtension(extension.extension,callback,extension.name,message,!1);message=void 0===result?message:result}}return message}function _applyOutgoingExtensions(message){for(var i=0;i<_extensions.length&&(void 0!==message&&null!==message);++i){var extension=_extensions[i],callback=extension.extension.outgoing;if(_isFunction(callback)){var result=_applyExtension(extension.extension,callback,extension.name,message,!0);message=void 0===result?message:result}}return message}function _notify(channel,message){var subscriptions=_listeners[channel];if(subscriptions&&subscriptions.length>0)for(var i=0;i<subscriptions.length;++i){var subscription=subscriptions[i];if(subscription)try{subscription.callback.call(subscription.scope,message)}catch(x){_cometd._debug("Exception during notification",subscription,message,x);var listenerCallback=_cometd.onListenerException;if(_isFunction(listenerCallback)){_cometd._debug("Invoking listener exception callback",subscription,x);try{listenerCallback.call(_cometd,x,subscription,subscription.listener,message)}catch(xx){_cometd._info("Exception during execution of listener callback",subscription,xx)}}}}}function _notifyListeners(channel,message){_notify(channel,message);for(var channelParts=channel.split("/"),last=channelParts.length-1,i=last;i>0;--i){var channelPart=channelParts.slice(0,i).join("/")+"/*";i===last&&_notify(channelPart,message),channelPart+="*",_notify(channelPart,message)}}function _cancelDelayedSend(){null!==_scheduledSend&&org.cometd.Utils.clearTimeout(_scheduledSend),_scheduledSend=null}function _delayedSend(operation){_cancelDelayedSend();var delay=_advice.interval+_backoff;_cometd._debug("Function scheduled in",delay,"ms, interval =",_advice.interval,"backoff =",_backoff,operation),_scheduledSend=org.cometd.Utils.setTimeout(_cometd,operation,delay)}function _send(sync,messages,longpoll,extraPath){for(var i=0;i<messages.length;++i){var message=messages[i];message.id=""+_nextMessageId(),_clientId&&(message.clientId=_clientId);var callback=void 0;_isFunction(message._callback)&&(callback=message._callback,delete message._callback),message=_applyOutgoingExtensions(message),void 0!==message&&null!==message?(messages[i]=message,callback&&(_publishCallbacks[message.id]=callback)):messages.splice(i--,1)}if(0!==messages.length){var url=_cometd.getURL();_config.appendMessageTypeToURL&&(url.match(/\/$/)||(url+="/"),extraPath&&(url+=extraPath));var envelope={url:url,sync:sync,messages:messages,onSuccess:function(rcvdMessages){try{_handleMessages.call(_cometd,rcvdMessages)}catch(x){_cometd._debug("Exception during handling of messages",x)}},onFailure:function(conduit,messages,failure){try{failure.connectionType=_cometd.getTransport().getType(),_handleFailure.call(_cometd,conduit,messages,failure)}catch(x){_cometd._debug("Exception during handling of failure",x)}}};_cometd._debug("Send",envelope),_transport.send(envelope,longpoll)}}function _queueSend(message){_batch>0||_internalBatch===!0?_messageQueue.push(message):_send(!1,[message],!1)}function _resetBackoff(){_backoff=0}function _increaseBackoff(){_backoff<_config.maxBackoff&&(_backoff+=_config.backoffIncrement)}function _startBatch(){++_batch}function _flushBatch(){var messages=_messageQueue;_messageQueue=[],messages.length>0&&_send(!1,messages,!1)}function _endBatch(){if(--_batch,0>_batch)throw"Calls to startBatch() and endBatch() are not paired";0!==_batch||_isDisconnected()||_internalBatch||_flushBatch()}function _connect(){if(!_isDisconnected()){var message={channel:"/meta/connect",connectionType:_transport.getType()};_connected||(message.advice={timeout:0}),_setStatus("connecting"),_cometd._debug("Connect sent",message),_send(!1,[message],!0,"connect"),_setStatus("connected")}}function _delayedConnect(){_setStatus("connecting"),_delayedSend(function(){_connect()})}function _updateAdvice(newAdvice){newAdvice&&(_advice=_cometd._mixin(!1,{},_config.advice,newAdvice),_cometd._debug("New advice",_advice))}function _disconnect(abort){_cancelDelayedSend(),abort&&_transport.abort(),_clientId=null,_setStatus("disconnected"),_batch=0,_resetBackoff(),_messageQueue.length>0&&(_handleFailure.call(_cometd,void 0,_messageQueue,{reason:"Disconnected"}),_messageQueue=[])}function _handshake(handshakeProps){_clientId=null,_clearSubscriptions(),_isDisconnected()?(_transports.reset(),_updateAdvice(_config.advice)):_updateAdvice(_cometd._mixin(!1,_advice,{reconnect:"retry"})),_batch=0,_internalBatch=!0,_handshakeProps=handshakeProps;var version="1.0",url=_cometd.getURL(),transportTypes=_transports.findTransportTypes(version,_crossDomain,url),bayeuxMessage={version:version,minimumVersion:"0.9",channel:"/meta/handshake",supportedConnectionTypes:transportTypes,advice:{timeout:_advice.timeout,interval:_advice.interval}},message=_cometd._mixin(!1,{},_handshakeProps,bayeuxMessage);if(_transport=_transports.negotiateTransport(transportTypes,version,_crossDomain,url),!_transport){var error="Could not find initial transport among: "+_transports.getTransportTypes();throw _cometd._warn(error),error}_cometd._debug("Initial transport is",_transport.getType()),_setStatus("handshaking"),_cometd._debug("Handshake sent",message),_send(!1,[message],!1,"handshake")}function _delayedHandshake(){_setStatus("handshaking"),_internalBatch=!0,_delayedSend(function(){_handshake(_handshakeProps)})}function _failHandshake(message){_notifyListeners("/meta/handshake",message),_notifyListeners("/meta/unsuccessful",message);var retry=!_isDisconnected()&&"none"!==_advice.reconnect;retry?(_increaseBackoff(),_delayedHandshake()):_disconnect(!1)}function _handshakeResponse(message){if(message.successful){_clientId=message.clientId;var url=_cometd.getURL(),newTransport=_transports.negotiateTransport(message.supportedConnectionTypes,message.version,_crossDomain,url);if(null===newTransport)throw"Could not negotiate transport with server; client "+_transports.findTransportTypes(message.version,_crossDomain,url)+", server "+message.supportedConnectionTypes;_transport!==newTransport&&(_cometd._debug("Transport",_transport,"->",newTransport),_transport=newTransport),_internalBatch=!1,_flushBatch(),message.reestablish=_reestablish,_reestablish=!0,_notifyListeners("/meta/handshake",message);var action=_isDisconnected()?"none":_advice.reconnect;switch(action){case"retry":_resetBackoff(),_delayedConnect();break;case"none":_disconnect(!1);break;default:throw"Unrecognized advice action "+action}}else _failHandshake(message)}function _handshakeFailure(message){_failHandshake(message)}function _failConnect(message){_notifyListeners("/meta/connect",message),_notifyListeners("/meta/unsuccessful",message);var action=_isDisconnected()?"none":_advice.reconnect;switch(action){case"retry":_delayedConnect(),_increaseBackoff();break;case"handshake":_transports.reset(),_resetBackoff(),_delayedHandshake();break;case"none":_disconnect(!1);break;default:throw"Unrecognized advice action"+action}}function _connectResponse(message){if(_connected=message.successful){_notifyListeners("/meta/connect",message);var action=_isDisconnected()?"none":_advice.reconnect;switch(action){case"retry":_resetBackoff(),_delayedConnect();break;case"none":_disconnect(!1);break;default:throw"Unrecognized advice action "+action}}else _failConnect(message)}function _connectFailure(message){_connected=!1,_failConnect(message)}function _failDisconnect(message){_disconnect(!0),_notifyListeners("/meta/disconnect",message),_notifyListeners("/meta/unsuccessful",message);
}function _disconnectResponse(message){message.successful?(_disconnect(!1),_notifyListeners("/meta/disconnect",message)):_failDisconnect(message)}function _disconnectFailure(message){_failDisconnect(message)}function _failSubscribe(message){var subscriptions=_listeners[message.subscription];if(subscriptions)for(var i=subscriptions.length-1;i>=0;--i){var subscription=subscriptions[i];if(subscription&&!subscription.listener){delete subscriptions[i],_cometd._debug("Removed failed subscription",subscription);break}}_notifyListeners("/meta/subscribe",message),_notifyListeners("/meta/unsuccessful",message)}function _subscribeResponse(message){message.successful?_notifyListeners("/meta/subscribe",message):_failSubscribe(message)}function _subscribeFailure(message){_failSubscribe(message)}function _failUnsubscribe(message){_notifyListeners("/meta/unsubscribe",message),_notifyListeners("/meta/unsuccessful",message)}function _unsubscribeResponse(message){message.successful?_notifyListeners("/meta/unsubscribe",message):_failUnsubscribe(message)}function _unsubscribeFailure(message){_failUnsubscribe(message)}function _handlePublishCallback(message){var callback=_publishCallbacks[message.id];_isFunction(callback)&&(delete _publishCallbacks[message.id],callback.call(_cometd,message))}function _failMessage(message){_handlePublishCallback(message),_notifyListeners("/meta/publish",message),_notifyListeners("/meta/unsuccessful",message)}function _messageResponse(message){void 0===message.successful?void 0!==message.data?_notifyListeners(message.channel,message):_cometd._warn("Unknown Bayeux Message",message):message.successful?(_handlePublishCallback(message),_notifyListeners("/meta/publish",message)):_failMessage(message)}function _messageFailure(failure){_failMessage(failure)}function _receive(message){if(message=_applyIncomingExtensions(message),void 0!==message&&null!==message){_updateAdvice(message.advice);var channel=message.channel;switch(channel){case"/meta/handshake":_handshakeResponse(message);break;case"/meta/connect":_connectResponse(message);break;case"/meta/disconnect":_disconnectResponse(message);break;case"/meta/subscribe":_subscribeResponse(message);break;case"/meta/unsubscribe":_unsubscribeResponse(message);break;default:_messageResponse(message)}}}function _hasSubscriptions(channel){var subscriptions=_listeners[channel];if(subscriptions)for(var i=0;i<subscriptions.length;++i)if(subscriptions[i])return!0;return!1}function _resolveScopedCallback(scope,callback){var delegate={scope:scope,method:callback};if(_isFunction(scope))delegate.scope=void 0,delegate.method=scope;else if(_isString(callback)){if(!scope)throw"Invalid scope "+scope;if(delegate.method=scope[callback],!_isFunction(delegate.method))throw"Invalid callback "+callback+" for scope "+scope}else if(!_isFunction(callback))throw"Invalid callback "+callback;return delegate}function _addListener(channel,scope,callback,isListener){var delegate=_resolveScopedCallback(scope,callback);_cometd._debug("Adding",isListener?"listener":"subscription","on",channel,"with scope",delegate.scope,"and callback",delegate.method);var subscription={channel:channel,scope:delegate.scope,callback:delegate.method,listener:isListener},subscriptions=_listeners[channel];return subscriptions||(subscriptions=[],_listeners[channel]=subscriptions),subscription.id=subscriptions.push(subscription)-1,_cometd._debug("Added",isListener?"listener":"subscription",subscription),subscription[0]=channel,subscription[1]=subscription.id,subscription}var _transport,_handshakeProps,_cometd=this,_name=name||"default",_crossDomain=!1,_transports=new org.cometd.TransportRegistry,_status="disconnected",_messageId=0,_clientId=null,_batch=0,_messageQueue=[],_internalBatch=!1,_listeners={},_backoff=0,_scheduledSend=null,_extensions=[],_advice={},_publishCallbacks={},_reestablish=!1,_connected=!1,_config={protocol:null,connectTimeout:0,maxConnections:2,backoffIncrement:1e3,maxBackoff:6e4,logLevel:"info",reverseIncomingExtensions:!0,maxNetworkDelay:1e4,requestHeaders:{},appendMessageTypeToURL:!0,autoBatch:!1,advice:{timeout:6e4,interval:0,reconnect:"retry"}};this._mixin=function(deep,target,objects){for(var result=target||{},i=2;i<arguments.length;++i){var object=arguments[i];if(void 0!==object&&null!==object)for(var propName in object){var prop=_fieldValue(object,propName),targ=_fieldValue(result,propName);if(prop!==target&&void 0!==prop)if(deep&&"object"==typeof prop&&null!==prop)if(prop instanceof Array)result[propName]=this._mixin(deep,targ instanceof Array?targ:[],prop);else{var source="object"!=typeof targ||targ instanceof Array?{}:targ;result[propName]=this._mixin(deep,source,prop)}else result[propName]=prop}}return result},this._warn=function(){_log("warn",arguments)},this._info=function(){"warn"!==_config.logLevel&&_log("info",arguments)},this._debug=function(){"debug"===_config.logLevel&&_log("debug",arguments)},this._isCrossDomain=function(hostAndPort){return hostAndPort&&hostAndPort!==window.location.host};var _handleMessages,_handleFailure;this.send=_queueSend,this.receive=_receive,_handleMessages=function(rcvdMessages){_cometd._debug("Received",rcvdMessages);for(var i=0;i<rcvdMessages.length;++i){var message=rcvdMessages[i];_receive(message)}},_handleFailure=function(conduit,messages,failure){_cometd._debug("handleFailure",conduit,messages,failure),failure.transport=conduit;for(var i=0;i<messages.length;++i){var message=messages[i],failureMessage={successful:!1,channel:message.channel,failure:failure};switch(failure.message=message,message.channel){case"/meta/handshake":failureMessage.id=message.id,_handshakeFailure(failureMessage);break;case"/meta/connect":failureMessage.id=message.id,_connectFailure(failureMessage);break;case"/meta/disconnect":failureMessage.id=message.id,_disconnectFailure(failureMessage);break;case"/meta/subscribe":failureMessage.id=message.id,failureMessage.subscription=message.subscription,_subscribeFailure(failureMessage);break;case"/meta/unsubscribe":failureMessage.id=message.id,failureMessage.subscription=message.subscription,_unsubscribeFailure(failureMessage);break;default:_messageFailure(failureMessage)}}},this.registerTransport=function(type,transport,index){var result=_transports.add(type,transport,index);return result&&(this._debug("Registered transport",type),_isFunction(transport.registered)&&transport.registered(type,this)),result},this.getTransportTypes=function(){return _transports.getTransportTypes()},this.unregisterTransport=function(type){var transport=_transports.remove(type);return null!==transport&&(this._debug("Unregistered transport",type),_isFunction(transport.unregistered)&&transport.unregistered()),transport},this.unregisterTransports=function(){_transports.clear()},this.findTransport=function(name){return _transports.find(name)},this.configure=function(configuration){_configure.call(this,configuration)},this.init=function(configuration,handshakeProps){this.configure(configuration),this.handshake(handshakeProps)},this.handshake=function(handshakeProps){_setStatus("disconnected"),_reestablish=!1,_handshake(handshakeProps)},this.disconnect=function(sync,disconnectProps){if(!_isDisconnected()){void 0===disconnectProps&&"boolean"!=typeof sync&&(disconnectProps=sync,sync=!1);var bayeuxMessage={channel:"/meta/disconnect"},message=this._mixin(!1,{},disconnectProps,bayeuxMessage);_setStatus("disconnecting"),_send(sync===!0,[message],!1,"disconnect")}},this.startBatch=function(){_startBatch()},this.endBatch=function(){_endBatch()},this.batch=function(scope,callback){var delegate=_resolveScopedCallback(scope,callback);this.startBatch();try{delegate.method.call(delegate.scope),this.endBatch()}catch(x){throw this._info("Exception during execution of batch",x),this.endBatch(),x}},this.addListener=function(channel,scope,callback){if(arguments.length<2)throw"Illegal arguments number: required 2, got "+arguments.length;if(!_isString(channel))throw"Illegal argument type: channel must be a string";return _addListener(channel,scope,callback,!0)},this.removeListener=function(subscription){if(!(subscription&&subscription.channel&&"id"in subscription))throw"Invalid argument: expected subscription, not "+subscription;_removeListener(subscription)},this.clearListeners=function(){_listeners={}},this.subscribe=function(channel,scope,callback,subscribeProps){if(arguments.length<2)throw"Illegal arguments number: required 2, got "+arguments.length;if(!_isString(channel))throw"Illegal argument type: channel must be a string";if(_isDisconnected())throw"Illegal state: already disconnected";_isFunction(scope)&&(subscribeProps=callback,callback=scope,scope=void 0);var send=!_hasSubscriptions(channel),subscription=_addListener(channel,scope,callback,!1);if(send){var bayeuxMessage={channel:"/meta/subscribe",subscription:channel},message=this._mixin(!1,{},subscribeProps,bayeuxMessage);_queueSend(message)}return subscription},this.unsubscribe=function(subscription,unsubscribeProps){if(arguments.length<1)throw"Illegal arguments number: required 1, got "+arguments.length;if(_isDisconnected())throw"Illegal state: already disconnected";this.removeListener(subscription);var channel=subscription.channel;if(!_hasSubscriptions(channel)){var bayeuxMessage={channel:"/meta/unsubscribe",subscription:channel},message=this._mixin(!1,{},unsubscribeProps,bayeuxMessage);_queueSend(message)}},this.resubscribe=function(subscription,subscribeProps){return _removeSubscription(subscription),subscription?this.subscribe(subscription.channel,subscription.scope,subscription.callback,subscribeProps):void 0},this.clearSubscriptions=function(){_clearSubscriptions()},this.publish=function(channel,content,publishProps,publishCallback){if(arguments.length<1)throw"Illegal arguments number: required 1, got "+arguments.length;if(!_isString(channel))throw"Illegal argument type: channel must be a string";if(/^\/meta\//.test(channel))throw"Illegal argument: cannot publish to meta channels";if(_isDisconnected())throw"Illegal state: already disconnected";_isFunction(content)?(publishCallback=content,content=publishProps={}):_isFunction(publishProps)&&(publishCallback=publishProps,publishProps={});var bayeuxMessage={channel:channel,data:content,_callback:publishCallback},message=this._mixin(!1,{},publishProps,bayeuxMessage);_queueSend(message)},this.getStatus=function(){return _status},this.isDisconnected=_isDisconnected,this.setBackoffIncrement=function(period){_config.backoffIncrement=period},this.getBackoffIncrement=function(){return _config.backoffIncrement},this.getBackoffPeriod=function(){return _backoff},this.setLogLevel=function(level){_config.logLevel=level},this.registerExtension=function(name,extension){if(arguments.length<2)throw"Illegal arguments number: required 2, got "+arguments.length;if(!_isString(name))throw"Illegal argument type: extension name must be a string";for(var existing=!1,i=0;i<_extensions.length;++i){var existingExtension=_extensions[i];if(existingExtension.name===name){existing=!0;break}}return existing?(this._info("Could not register extension with name",name,"since another extension with the same name already exists"),!1):(_extensions.push({name:name,extension:extension}),this._debug("Registered extension",name),_isFunction(extension.registered)&&extension.registered(name,this),!0)},this.unregisterExtension=function(name){if(!_isString(name))throw"Illegal argument type: extension name must be a string";for(var unregistered=!1,i=0;i<_extensions.length;++i){var extension=_extensions[i];if(extension.name===name){_extensions.splice(i,1),unregistered=!0,this._debug("Unregistered extension",name);var ext=extension.extension;_isFunction(ext.unregistered)&&ext.unregistered();break}}return unregistered},this.getExtension=function(name){for(var i=0;i<_extensions.length;++i){var extension=_extensions[i];if(extension.name===name)return extension.extension}return null},this.getName=function(){return _name},this.getClientId=function(){return _clientId},this.getURL=function(){if(_transport&&"object"==typeof _config.urls){var url=_config.urls[_transport.getType()];if(url)return url}return _config.url},this.getTransport=function(){return _transport},this.getConfiguration=function(){return this._mixin(!0,{},_config)},this.getAdvice=function(){return this._mixin(!0,{},_advice)},org.cometd.WebSocket=window.WebSocket,org.cometd.WebSocket||(org.cometd.WebSocket=window.MozWebSocket)},org.cometd.Utils={},org.cometd.Utils.isString=function(value){return void 0===value||null===value?!1:"string"==typeof value||value instanceof String},org.cometd.Utils.isArray=function(value){return void 0===value||null===value?!1:value instanceof Array},org.cometd.Utils.inArray=function(element,array){for(var i=0;i<array.length;++i)if(element===array[i])return i;return-1},org.cometd.Utils.setTimeout=function(cometd,funktion,delay){return window.setTimeout(function(){try{funktion()}catch(x){cometd._debug("Exception invoking timed function",funktion,x)}},delay)},org.cometd.Utils.clearTimeout=function(timeoutHandle){window.clearTimeout(timeoutHandle)},org.cometd.TransportRegistry=function(){var _types=[],_transports={};this.getTransportTypes=function(){return _types.slice(0)},this.findTransportTypes=function(version,crossDomain,url){for(var result=[],i=0;i<_types.length;++i){var type=_types[i];_transports[type].accept(version,crossDomain,url)===!0&&result.push(type)}return result},this.negotiateTransport=function(types,version,crossDomain,url){for(var i=0;i<_types.length;++i)for(var type=_types[i],j=0;j<types.length;++j)if(type===types[j]){var transport=_transports[type];if(transport.accept(version,crossDomain,url)===!0)return transport}return null},this.add=function(type,transport,index){for(var existing=!1,i=0;i<_types.length;++i)if(_types[i]===type){existing=!0;break}return existing||("number"!=typeof index?_types.push(type):_types.splice(index,0,type),_transports[type]=transport),!existing},this.find=function(type){for(var i=0;i<_types.length;++i)if(_types[i]===type)return _transports[type];return null},this.remove=function(type){for(var i=0;i<_types.length;++i)if(_types[i]===type){_types.splice(i,1);var transport=_transports[type];return delete _transports[type],transport}return null},this.clear=function(){_types=[],_transports={}},this.reset=function(){for(var i=0;i<_types.length;++i)_transports[_types[i]].reset()}},org.cometd.Transport=function(){var _type,_cometd;this.registered=function(type,cometd){_type=type,_cometd=cometd},this.unregistered=function(){_type=null,_cometd=null},this._debug=function(){_cometd._debug.apply(_cometd,arguments)},this._mixin=function(){return _cometd._mixin.apply(_cometd,arguments)},this.getConfiguration=function(){return _cometd.getConfiguration()},this.getAdvice=function(){return _cometd.getAdvice()},this.setTimeout=function(funktion,delay){return org.cometd.Utils.setTimeout(_cometd,funktion,delay)},this.clearTimeout=function(handle){org.cometd.Utils.clearTimeout(handle)},this.convertToMessages=function(response){if(org.cometd.Utils.isString(response))try{return org.cometd.JSON.fromJSON(response)}catch(x){throw this._debug("Could not convert to JSON the following string",'"'+response+'"'),x}if(org.cometd.Utils.isArray(response))return response;if(void 0===response||null===response)return[];if(response instanceof Object)return[response];throw"Conversion Error "+response+", typeof "+typeof response},this.accept=function(version,crossDomain,url){throw"Abstract"},this.getType=function(){return _type},this.send=function(envelope,metaConnect){throw"Abstract"},this.reset=function(){this._debug("Transport",_type,"reset")},this.abort=function(){this._debug("Transport",_type,"aborted")},this.toString=function(){return this.getType()}},org.cometd.Transport.derive=function(baseObject){function F(){}return F.prototype=baseObject,new F},org.cometd.RequestTransport=function(){function _coalesceEnvelopes(envelope){for(;_envelopes.length>0;){var envelopeAndRequest=_envelopes[0],newEnvelope=envelopeAndRequest[0],newRequest=envelopeAndRequest[1];if(newEnvelope.url!==envelope.url||newEnvelope.sync!==envelope.sync)break;_envelopes.shift(),envelope.messages=envelope.messages.concat(newEnvelope.messages),this._debug("Coalesced",newEnvelope.messages.length,"messages from request",newRequest.id)}}function _transportSend(envelope,request){if(this.transportSend(envelope,request),request.expired=!1,!envelope.sync){var maxDelay=this.getConfiguration().maxNetworkDelay,delay=maxDelay;request.metaConnect===!0&&(delay+=this.getAdvice().timeout),this._debug("Transport",this.getType(),"waiting at most",delay,"ms for the response, maxNetworkDelay",maxDelay);var self=this;request.timeout=this.setTimeout(function(){request.expired=!0;var errorMessage="Request "+request.id+" of transport "+self.getType()+" exceeded "+delay+" ms max network delay",failure={reason:errorMessage},xhr=request.xhr;failure.httpCode=self.xhrStatus(xhr),self.abortXHR(xhr),self._debug(errorMessage),self.complete(request,!1,request.metaConnect),envelope.onFailure(xhr,envelope.messages,failure)},delay)}}function _queueSend(envelope){var requestId=++_requestIds,request={id:requestId,metaConnect:!1};_requests.length<this.getConfiguration().maxConnections-1?(_requests.push(request),_transportSend.call(this,envelope,request)):(this._debug("Transport",this.getType(),"queueing request",requestId,"envelope",envelope),_envelopes.push([envelope,request]))}function _metaConnectComplete(request){var requestId=request.id;if(this._debug("Transport",this.getType(),"metaConnect complete, request",requestId),null!==_metaConnectRequest&&_metaConnectRequest.id!==requestId)throw"Longpoll request mismatch, completing request "+requestId;_metaConnectRequest=null}function _complete(request,success){var index=org.cometd.Utils.inArray(request,_requests);if(index>=0&&_requests.splice(index,1),_envelopes.length>0){var envelopeAndRequest=_envelopes.shift(),nextEnvelope=envelopeAndRequest[0],nextRequest=envelopeAndRequest[1];if(this._debug("Transport dequeued request",nextRequest.id),success)this.getConfiguration().autoBatch&&_coalesceEnvelopes.call(this,nextEnvelope),_queueSend.call(this,nextEnvelope),this._debug("Transport completed request",request.id,nextEnvelope);else{var self=this;this.setTimeout(function(){self.complete(nextRequest,!1,nextRequest.metaConnect);var failure={reason:"Previous request failed"},xhr=nextRequest.xhr;failure.httpCode=self.xhrStatus(xhr),nextEnvelope.onFailure(xhr,nextEnvelope.messages,failure)},0)}}}function _metaConnectSend(envelope){if(null!==_metaConnectRequest)throw"Concurrent metaConnect requests not allowed, request id="+_metaConnectRequest.id+" not yet completed";var requestId=++_requestIds;this._debug("Transport",this.getType(),"metaConnect send, request",requestId,"envelope",envelope);var request={id:requestId,metaConnect:!0};_transportSend.call(this,envelope,request),_metaConnectRequest=request}var _super=new org.cometd.Transport,_self=org.cometd.Transport.derive(_super),_requestIds=0,_metaConnectRequest=null,_requests=[],_envelopes=[];return _self.complete=function(request,success,metaConnect){metaConnect?_metaConnectComplete.call(this,request):_complete.call(this,request,success)},_self.transportSend=function(envelope,request){throw"Abstract"},_self.transportSuccess=function(envelope,request,responses){request.expired||(this.clearTimeout(request.timeout),this.complete(request,!0,request.metaConnect),responses&&responses.length>0?envelope.onSuccess(responses):envelope.onFailure(request.xhr,envelope.messages,{httpCode:204}))},_self.transportFailure=function(envelope,request,failure){request.expired||(this.clearTimeout(request.timeout),this.complete(request,!1,request.metaConnect),envelope.onFailure(request.xhr,envelope.messages,failure))},_self.send=function(envelope,metaConnect){metaConnect?_metaConnectSend.call(this,envelope):_queueSend.call(this,envelope)},_self.abort=function(){_super.abort();for(var i=0;i<_requests.length;++i){var request=_requests[i];this._debug("Aborting request",request),this.abortXHR(request.xhr)}_metaConnectRequest&&(this._debug("Aborting metaConnect request",_metaConnectRequest),this.abortXHR(_metaConnectRequest.xhr)),this.reset()},_self.reset=function(){_super.reset(),_metaConnectRequest=null,_requests=[],_envelopes=[]},_self.abortXHR=function(xhr){if(xhr)try{xhr.abort()}catch(x){this._debug(x)}},_self.xhrStatus=function(xhr){if(xhr)try{return xhr.status}catch(x){this._debug(x)}return-1},_self},org.cometd.LongPollingTransport=function(){var _super=new org.cometd.RequestTransport,_self=org.cometd.Transport.derive(_super),_supportsCrossDomain=!0;return _self.accept=function(version,crossDomain,url){return _supportsCrossDomain||!crossDomain},_self.xhrSend=function(packet){throw"Abstract"},_self.transportSend=function(envelope,request){this._debug("Transport",this.getType(),"sending request",request.id,"envelope",envelope);var self=this;try{var sameStack=!0;request.xhr=this.xhrSend({transport:this,url:envelope.url,sync:envelope.sync,headers:this.getConfiguration().requestHeaders,body:org.cometd.JSON.toJSON(envelope.messages),onSuccess:function(response){self._debug("Transport",self.getType(),"received response",response);var success=!1;try{var received=self.convertToMessages(response);0===received.length?(_supportsCrossDomain=!1,self.transportFailure(envelope,request,{httpCode:204})):(success=!0,self.transportSuccess(envelope,request,received))}catch(x){if(self._debug(x),!success){_supportsCrossDomain=!1;var failure={exception:x};failure.httpCode=self.xhrStatus(request.xhr),self.transportFailure(envelope,request,failure)}}},onError:function(reason,exception){_supportsCrossDomain=!1;var failure={reason:reason,exception:exception};failure.httpCode=self.xhrStatus(request.xhr),sameStack?self.setTimeout(function(){self.transportFailure(envelope,request,failure)},0):self.transportFailure(envelope,request,failure)}}),sameStack=!1}catch(x){_supportsCrossDomain=!1,this.setTimeout(function(){self.transportFailure(envelope,request,{exception:x})},0)}},_self.reset=function(){_super.reset(),_supportsCrossDomain=!0},_self},org.cometd.CallbackPollingTransport=function(){var _super=new org.cometd.RequestTransport,_self=org.cometd.Transport.derive(_super),_maxLength=2e3;return _self.accept=function(version,crossDomain,url){return!0},_self.jsonpSend=function(packet){throw"Abstract"},_self.transportSend=function(envelope,request){for(var self=this,start=0,length=envelope.messages.length,lengths=[];length>0;){var json=org.cometd.JSON.toJSON(envelope.messages.slice(start,start+length)),urlLength=envelope.url.length+encodeURI(json).length;if(urlLength>_maxLength){if(1===length)return void this.setTimeout(function(){self.transportFailure(envelope,request,{reason:"Bayeux message too big, max is "+_maxLength})},0);--length}else lengths.push(length),start+=length,length=envelope.messages.length-start}var envelopeToSend=envelope;if(lengths.length>1){var begin=0,end=lengths[0];this._debug("Transport",this.getType(),"split",envelope.messages.length,"messages into",lengths.join(" + ")),envelopeToSend=this._mixin(!1,{},envelope),envelopeToSend.messages=envelope.messages.slice(begin,end),envelopeToSend.onSuccess=envelope.onSuccess,envelopeToSend.onFailure=envelope.onFailure;for(var i=1;i<lengths.length;++i){var nextEnvelope=this._mixin(!1,{},envelope);begin=end,end+=lengths[i],nextEnvelope.messages=envelope.messages.slice(begin,end),nextEnvelope.onSuccess=envelope.onSuccess,nextEnvelope.onFailure=envelope.onFailure,this.send(nextEnvelope,request.metaConnect)}}this._debug("Transport",this.getType(),"sending request",request.id,"envelope",envelopeToSend);try{var sameStack=!0;this.jsonpSend({transport:this,url:envelopeToSend.url,sync:envelopeToSend.sync,headers:this.getConfiguration().requestHeaders,body:org.cometd.JSON.toJSON(envelopeToSend.messages),onSuccess:function(responses){var success=!1;try{var received=self.convertToMessages(responses);0===received.length?self.transportFailure(envelopeToSend,request,{httpCode:204}):(success=!0,self.transportSuccess(envelopeToSend,request,received))}catch(x){self._debug(x),success||self.transportFailure(envelopeToSend,request,{exception:x})}},onError:function(reason,exception){var failure={reason:reason,exception:exception};sameStack?self.setTimeout(function(){self.transportFailure(envelopeToSend,request,failure)},0):self.transportFailure(envelopeToSend,request,failure)}}),sameStack=!1}catch(xx){this.setTimeout(function(){self.transportFailure(envelopeToSend,request,{exception:xx})},0)}},_self},org.cometd.WebSocketTransport=function(){function _websocketConnect(){var url=_cometd.getURL().replace(/^http/,"ws");this._debug("Transport",this.getType(),"connecting to URL",url);var self=this,connectTimer=null,connectTimeout=_cometd.getConfiguration().connectTimeout;connectTimeout>0&&(connectTimer=this.setTimeout(function(){connectTimer=null,_opened||(self._debug("Transport",self.getType(),"timed out while connecting to URL",url,":",connectTimeout,"ms"),self.onClose(1002,"Connect Timeout"))},connectTimeout));var protocol=_cometd.getConfiguration().protocol,webSocket=protocol?new org.cometd.WebSocket(url,protocol):new org.cometd.WebSocket(url),onopen=function(){return self._debug("WebSocket opened",webSocket),connectTimer&&(self.clearTimeout(connectTimer),connectTimer=null),webSocket!==_webSocket?void self._debug("Ignoring open event, WebSocket",_webSocket):void self.onOpen()},onclose=function(event){var code=event?event.code:1e3,reason=event?event.reason:void 0;return self._debug("WebSocket closed",code,"/",reason,webSocket),connectTimer&&(self.clearTimeout(connectTimer),connectTimer=null),webSocket!==_webSocket?void self._debug("Ignoring close event, WebSocket",_webSocket):void self.onClose(code,reason)},onmessage=function(message){return self._debug("WebSocket message",message,webSocket),webSocket!==_webSocket?void self._debug("Ignoring message event, WebSocket",_webSocket):void self.onMessage(message)};webSocket.onopen=onopen,webSocket.onclose=onclose,webSocket.onerror=function(){onclose({code:1002,reason:"Error"})},webSocket.onmessage=onmessage,_webSocket=webSocket,this._debug("Transport",this.getType(),"configured callbacks on",webSocket)}function _webSocketSend(envelope,metaConnect){var json=org.cometd.JSON.toJSON(envelope.messages);_webSocket.send(json),this._debug("Transport",this.getType(),"sent",envelope,"metaConnect =",metaConnect);var maxDelay=this.getConfiguration().maxNetworkDelay,delay=maxDelay;metaConnect&&(delay+=this.getAdvice().timeout,_connected=!0);for(var self=this,webSocket=_webSocket,messageIds=[],i=0;i<envelope.messages.length;++i){var message=envelope.messages[i];message.id&&(messageIds.push(message.id),_timeouts[message.id]=this.setTimeout(function(){self.webSocketClose(webSocket,1e3,"Timeout")},delay))}this._debug("Transport",this.getType(),"waiting at most",delay,"ms for messages",messageIds,"maxNetworkDelay",maxDelay,", timeouts:",_timeouts)}function _send(envelope,metaConnect){try{null===_webSocket?_websocketConnect.call(this):_opened&&_webSocketSend.call(this,envelope,metaConnect)}catch(x){var webSocket=_webSocket;this.setTimeout(function(){envelope.onFailure(webSocket,envelope.messages,{exception:x})},0)}}var _cometd,_successCallback,_super=new org.cometd.Transport,_self=org.cometd.Transport.derive(_super),_supportsWebSocket=!0,_webSocketSupported=!1,_envelopes={},_timeouts={},_webSocket=null,_opened=!1,_connected=!1;return _self.onOpen=function(){this._debug("Transport",this.getType(),"opened",_webSocket),_opened=!0,_webSocketSupported=!0,this._debug("Sending pending messages",_envelopes);for(var key in _envelopes){var element=_envelopes[key],envelope=element[0],metaConnect=element[1];_successCallback=envelope.onSuccess,_webSocketSend.call(this,envelope,metaConnect)}},_self.onMessage=function(wsMessage){this._debug("Transport",this.getType(),"received websocket message",wsMessage,_webSocket);for(var close=!1,messages=this.convertToMessages(wsMessage.data),messageIds=[],i=0;i<messages.length;++i){var message=messages[i];if((/^\/meta\//.test(message.channel)||void 0===message.data)&&message.id){messageIds.push(message.id);var timeout=_timeouts[message.id];timeout&&(this.clearTimeout(timeout),delete _timeouts[message.id],this._debug("Transport",this.getType(),"removed timeout for message",message.id,", timeouts",_timeouts))}"/meta/connect"===message.channel&&(_connected=!1),"/meta/disconnect"!==message.channel||_connected||(close=!0)}for(var removed=!1,j=0;j<messageIds.length;++j){var id=messageIds[j];for(var key in _envelopes){var ids=key.split(","),index=org.cometd.Utils.inArray(id,ids);if(index>=0){removed=!0,ids.splice(index,1);var envelope=_envelopes[key][0],metaConnect=_envelopes[key][1];delete _envelopes[key],ids.length>0&&(_envelopes[ids.join(",")]=[envelope,metaConnect]);break}}}removed&&this._debug("Transport",this.getType(),"removed envelope, envelopes",_envelopes),_successCallback.call(this,messages),close&&this.webSocketClose(_webSocket,1e3,"Disconnect")},_self.onClose=function(code,reason){this._debug("Transport",this.getType(),"closed",code,reason,_webSocket),_supportsWebSocket=_webSocketSupported;for(var id in _timeouts)this.clearTimeout(_timeouts[id]);_timeouts={};for(var key in _envelopes){var envelope=_envelopes[key][0],metaConnect=_envelopes[key][1];metaConnect&&(_connected=!1),envelope.onFailure(_webSocket,envelope.messages,{websocketCode:code,reason:reason})}_envelopes={},_opened&&this.webSocketClose(_webSocket,1e3,"Close"),_opened=!1,_webSocket=null},_self.registered=function(type,cometd){_super.registered(type,cometd),_cometd=cometd},_self.accept=function(version,crossDomain,url){return _supportsWebSocket&&!!org.cometd.WebSocket&&_cometd.websocketEnabled!==!1},_self.send=function(envelope,metaConnect){this._debug("Transport",this.getType(),"sending",envelope,"metaConnect =",metaConnect);for(var messageIds=[],i=0;i<envelope.messages.length;++i){var message=envelope.messages[i];message.id&&messageIds.push(message.id)}_envelopes[messageIds.join(",")]=[envelope,metaConnect],this._debug("Transport",this.getType(),"stored envelope, envelopes",_envelopes),_send.call(this,envelope,metaConnect)},_self.webSocketClose=function(webSocket,code,reason){if(webSocket)try{webSocket.close(code,reason)}catch(x){this._debug(x)}},_self.abort=function(){_super.abort(),this.webSocketClose(_webSocket,1001,"Abort"),this.reset()},_self.reset=function(){_super.reset(),_opened&&this.webSocketClose(_webSocket,1e3,"Reset"),_supportsWebSocket=!0,_webSocketSupported=!1,_timeouts={},_envelopes={},_webSocket=null,_opened=!1,_successCallback=null},_self},function($){function bind($,org_cometd){function _setHeaders(xhr,headers){if(headers)for(var headerName in headers)"content-type"!==headerName.toLowerCase()&&xhr.setRequestHeader(headerName,headers[headerName])}function LongPollingTransport(){var _super=new org_cometd.LongPollingTransport,that=org_cometd.Transport.derive(_super);return that.xhrSend=function(packet){return $.ajax({url:packet.url,async:packet.sync!==!0,type:"POST",contentType:"application/json;charset=UTF-8",data:packet.body,xhrFields:{withCredentials:!0},beforeSend:function(xhr){return _setHeaders(xhr,packet.headers),!0},success:packet.onSuccess,error:function(xhr,reason,exception){packet.onError(reason,exception)}})},that}function CallbackPollingTransport(){var _super=new org_cometd.CallbackPollingTransport,that=org_cometd.Transport.derive(_super);return that.jsonpSend=function(packet){$.ajax({url:packet.url,async:packet.sync!==!0,type:"GET",dataType:"jsonp",jsonp:"jsonp",data:{message:packet.body},beforeSend:function(xhr){return _setHeaders(xhr,packet.headers),!0},success:packet.onSuccess,error:function(xhr,reason,exception){packet.onError(reason,exception)}})},that}return org_cometd.JSON.toJSON=JSON.stringify,org_cometd.JSON.fromJSON=JSON.parse,$.Cometd=function(name){var cometd=new org_cometd.Cometd(name);return org_cometd.WebSocket&&cometd.registerTransport("websocket",new org_cometd.WebSocketTransport),
cometd.registerTransport("long-polling",new LongPollingTransport),cometd.registerTransport("callback-polling",new CallbackPollingTransport),cometd},$.cometd=new $.Cometd,$.cometd}"function"==typeof define&&define.amd?define(["jquery","org/cometd"],bind):bind($,org.cometd)}(jQuery),function(o){function G(a){return"[object Function]"==Object.prototype.toString.call(a)}function H(a){return"[object Array]"==Object.prototype.toString.call(a)}function N(a,c){var b=/^\w+\:\/\//;return/^\/\/\/?/.test(a)?a=location.protocol+a:b.test(a)||"/"==a.charAt(0)||(a=(c||"")+a),b.test(a)?a:("/"==a.charAt(0)?D:C)+a}function s(a,c){for(var b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c}function O(a){for(var c=!1,b=0;b<a.scripts.length;b++)a.scripts[b].ready&&a.scripts[b].exec_trigger&&(c=!0,a.scripts[b].exec_trigger(),a.scripts[b].exec_trigger=null);return c}function t(a,c,b,d){a.onload=a.onreadystatechange=function(){a.readyState&&"complete"!=a.readyState&&"loaded"!=a.readyState||c[b]||(a.onload=a.onreadystatechange=null,d())}}function I(a){a.ready=a.finished=!0;for(var c=0;c<a.finished_listeners.length;c++)a.finished_listeners[c]();a.ready_listeners=[],a.finished_listeners=[]}function P(d,f,e,g,h){setTimeout(function(){var a,b,c=f.real_src;if("item"in i){if(!i[0])return void setTimeout(arguments.callee,25);i=i[0]}a=document.createElement("script"),f.type&&(a.type=f.type),f.charset&&(a.charset=f.charset),h?r?(e.elem=a,E?(a.preload=!0,a.onpreload=g):a.onreadystatechange=function(){"loaded"==a.readyState&&g()},a.src=c):h&&0==c.indexOf(D)&&d[y]?(b=new XMLHttpRequest,b.onreadystatechange=function(){4==b.readyState&&(b.onreadystatechange=function(){},e.text=b.responseText+"\n//@ sourceURL="+c,g())},b.open("GET",c),b.send()):(a.type="text/cache-script",t(a,e,"ready",function(){i.removeChild(a),g()}),a.src=c,i.insertBefore(a,i.firstChild)):F?(a.async=!1,t(a,e,"finished",g),a.src=c,i.insertBefore(a,i.firstChild)):(t(a,e,"finished",g),a.src=c,i.insertBefore(a,i.firstChild))},0)}function J(){function R(a,c,b){function f(){null!=d&&(d=null,I(b))}var d;p[c.src].finished||(a[u]||(p[c.src].finished=!0),d=b.elem||document.createElement("script"),c.type&&(d.type=c.type),c.charset&&(d.charset=c.charset),t(d,b,"finished",f),b.elem?b.elem=null:b.text?(d.onload=d.onreadystatechange=null,d.text=b.text):d.src=c.real_src,i.insertBefore(d,i.firstChild),b.text&&f())}function S(c,b,d,f){var e,g,h=function(){b.ready_cb(b,function(){R(c,b,e)})},j=function(){b.finished_cb(b,d)};b.src=N(b.src,c[B]),b.real_src=b.src+(c[A]?(/\?.*$/.test(b.src)?"&_":"?_")+~~(1e9*Math.random())+"=":""),p[b.src]||(p[b.src]={items:[],finished:!1}),g=p[b.src].items,c[u]||0==g.length?(e=g[g.length]={ready:!1,finished:!1,ready_listeners:[h],finished_listeners:[j]},P(c,b,e,f?function(){e.ready=!0;for(var a=0;a<e.ready_listeners.length;a++)e.ready_listeners[a]();e.ready_listeners=[]}:function(){I(e)},f)):(e=g[0],e.finished?j():e.finished_listeners.push(j))}function v(){function T(a,c){a.ready=!0,a.exec_trigger=c,x()}function U(a,c){a.ready=a.finished=!0,a.exec_trigger=null;for(var b=0;b<c.scripts.length;b++)if(!c.scripts[b].finished)return;c.finished=!0,x()}function x(){for(;j<h.length;)if(G(h[j]))try{h[j++]()}catch(err){}else{if(!h[j].finished){if(O(h[j]))continue;break}j++}j==h.length&&(w=!1,k=!1)}function V(){k&&k.scripts||h.push(k={scripts:[],finished:!0})}var e,k,g=s(l,{}),h=[],j=0,w=!1;return e={script:function(){for(var f=0;f<arguments.length;f++)!function(a,c){var b;H(a)||(c=[a]);for(var d=0;d<c.length;d++)V(),a=c[d],G(a)&&(a=a()),a&&(H(a)?(b=[].slice.call(a),b.unshift(d,1),[].splice.apply(c,b),d--):("string"==typeof a&&(a={src:a}),a=s(a,{ready:!1,ready_cb:T,finished:!1,finished_cb:U}),k.finished=!1,k.scripts.push(a),S(g,a,k,Q&&w),w=!0,g[z]&&e.wait()))}(arguments[f],arguments[f]);return e},wait:function(){if(arguments.length>0){for(var a=0;a<arguments.length;a++)h.push(arguments[a]);k=h[h.length-1]}else k=!1;return x(),e}},{script:e.script,wait:e.wait,setOptions:function(a){return s(a,g),e}}}var m,l={},Q=r||M,n=[],p={};return l[y]=!0,l[z]=!1,l[u]=!1,l[A]=!1,l[B]="",m={setGlobalDefaults:function(a){return s(a,l),m},setOptions:function(){return v().setOptions.apply(null,arguments)},script:function(){return v().script.apply(null,arguments)},wait:function(){return v().wait.apply(null,arguments)},queueScript:function(){return n[n.length]={type:"script",args:[].slice.call(arguments)},m},queueWait:function(){return n[n.length]={type:"wait",args:[].slice.call(arguments)},m},runQueue:function(){for(var d,a=m,c=n.length,b=c;--b>=0;)d=n.shift(),a=a[d.type].apply(null,d.args);return a},noConflict:function(){return o.$LAB=K,m},sandbox:function(){return J()}}}var K=o.$LAB,y="UseLocalXHR",z="AlwaysPreserveOrder",u="AllowDuplicates",A="CacheBust",B="BasePath",C=/^[^?#]*\//.exec(location.href)[0],D=/^\w+\:\/\/\/?[^\/]+/.exec(C)[0],i=document.head||document.getElementsByTagName("head"),L=o.opera&&"[object Opera]"==Object.prototype.toString.call(o.opera)||"MozAppearance"in document.documentElement.style,q=document.createElement("script"),E="boolean"==typeof q.preload,r=E||q.readyState&&"uninitialized"==q.readyState,F=!r&&q.async===!0,M=!r&&!F&&!L;o.$LAB=J(),function(a,c,b){null==document.readyState&&document[a]&&(document.readyState="loading",document[a](c,b=function(){document.removeEventListener(c,b,!1),document.readyState="complete"},!1))}("addEventListener","DOMContentLoaded")}(this),function(){angular.module("app",[]).constant("info",{})}(),function(){function run(info,c8yUser){info.token&&!info.preventGetUser&&c8yUser.current()}var core=angular.module("c8y.core",["angularFileUpload"]);core.run(["info","c8yUser",run])}(),function(){function run($rootScope,$window,$q,info,c8yUser){function setTokenFromStorage(){var token=$window.localStorage.getItem(STORAGE_KEY)||$window.sessionStorage.getItem(STORAGE_KEY);info.token=token}function setupAfterLogin(){return!info.token||info.preventGetUser?$q.reject("No token"):void c8yUser.current().then(function(user){var c8y=$rootScope.c8y=$rootScope.c8y||{};c8y.user=user,$rootScope.$emit("c8y.api.login")})}setTokenFromStorage(),setupAfterLogin()}function createGetters(info){function getBaseUrl(){return info.baseUrl}function getAppKey(){return info.appKey}function getTenant(){return info.tenant}return{getBaseUrl:getBaseUrl,getAppKey:getAppKey,getTenant:getTenant}}function c8yCumulocityProvider(info){function setBaseUrl(baseUrl){info.baseUrl=baseUrl}function setAppKey(appKey){info.appKey=appKey}function setTenant(tenant){info.tenant=tenant}var result={setBaseUrl:setBaseUrl,setAppKey:setAppKey,setTenant:setTenant,$get:["info","$window","$rootScope","c8yUser",c8yCumulocity]};return _.assign(result,createGetters(info)),result}function c8yCumulocity(info,$window,$rootScope,c8yUser){function login(tenant,user,password,remember){return tenant=tenant||getters.getTenant(),c8yUser.login(tenant,user,password,remember).then(setUser)}function setUser(user){var c8y=$rootScope.c8y=$rootScope.c8y||{};c8y.user=user,c8yUser.logout(),user?$rootScope.$emit("c8y.api.login"):$rootScope.$emit("c8y.api.logout")}function logout(){setUser(null),info.token=null,$window.localStorage.removeItem(STORAGE_KEY),$window.sessionStorage.removeItem(STORAGE_KEY)}var getters=createGetters(info),result={login:login,logout:logout};return _.assign(result,getters),result}var STORAGE_KEY="_tcy8";angular.module("c8y.core").provider("c8yCumulocity",["info",c8yCumulocityProvider]).run(["$rootScope","$window","$q","info","c8yUser",run])}(),angular.module("c8y.core").factory("c8yAlarms",["$http","c8yBase","c8yCounter","$q",function($http,c8yBase,c8yCounter,$q){function buildDetailUrl(alarm){var id=alarm.id||alarm;return c8yBase.url(path+"/"+id)}function list(filters){var url=c8yBase.url(path),_filters=c8yBase.timeOrderFilter(c8yBase.pageSizeNoTotalFilter(filters)),cfg={params:_filters},onList=c8yBase.cleanListCallback("alarms",list,_filters);return $http.get(url,cfg).then(onList)}function detail(alarm){var url=buildDetailUrl(alarm);return $http.get(url)}function create(alarm){var url=c8yBase.url(path),data=clean(alarm,removeKeys);return $http.post(url,data,defaultConfig)}function update(alarm){var url=buildDetailUrl(alarm),data=clean(alarm,removeKeysOnUpdate);return $http.put(url,data,defaultConfig)}function save(alarm){return alarm.id?update(alarm):create(alarm)}function acknowledgedBy(alarm){var history=alarm.history&&alarm.history.auditRecords||[],ackBy="--";return alarm.status===status.ACKNOWLEDGED&&(ackBy=history[history.length-1].user),history.forEach(function(historyItem){var changes=historyItem.changes||[],acknowledged=!1;return changes.forEach(function(change){return change.attribute===statusAttribute&&change.newValue===status.ACKNOWLEDGED?(acknowledged=!0,!1):void 0}),acknowledged?(ackBy=historyItem.user||ackBy,!1):void 0}),ackBy}function ackTime(alarm){var history=alarm.history&&alarm.history.auditRecords||[],time=history.length?history[history.length-1].creationTime:void 0;return history.forEach(function(historyItem){var changes=historyItem.changes||[],found=!1;return changes.forEach(function(change){return change.attribute===statusAttribute&&change.newValue===status.ACKNOWLEDGED?(time=historyItem.creationTime,found=!0,!1):void 0}),found?!1:void 0}),time}function alarmDuration(alarm){var history=alarm.history&&alarm.history.auditRecords||[],time=alarm.creationTime,endTime=history.length?history[history.length-1].creationTime:void 0,diff="";if(_.forEach(history,function(historyItem){var changes=historyItem.changes||[],found=!1;return changes.forEach(function(change){return change.attribute===statusAttribute&&change.newValue===status.CLEARED?(endTime=historyItem.creationTime,found=!0,!1):void 0}),found?!1:void 0}),time&&endTime){var _time=moment(time),_endTime=moment(endTime);diff=moment.duration(_time.diff(_endTime)).humanize()}return diff}function parseChanges(changes){var _changes=changes||[],outList=[];return _changes.forEach(function(change){return"revision"===change.attribute?!0:void outList.push(change.attribute+": "+change.previousValue+" > "+change.newValue)}),outList.join(" ; ")}function isReservedKey(key){return-1!==reservedKeys.indexOf(key)}function isNotReservedKey(key){return!isReservedKey(key)}function getKeys(alarm){var _alarm=angular.copy(alarm),props=Object.keys(_alarm);return props.filter(isNotReservedKey)}function icon(alarm){var severity=(angular.isObject(alarm)?alarm.severity:alarm).toUpperCase();return icons[severity]}function buildReportUrl(report,filters){var parts=[pathReports,report];return filters.id&&parts.push(filters.id),c8yBase.url(parts.join("/"))}function reportDownTimeDuration(filters){var report="downtimeDuration",_filters=c8yBase.timeOrderFilter(filters),url=buildReportUrl(report,_filters),cfg={params:_filters};return $http.get(url,cfg)}function createCounter(filter){var counter=new c8yCounter.Counter(list,"/alarms/*");if(filter){var filterConfig=[c8yCounter.defaultPropertyMaps.date,c8yCounter.defaultPropertyMaps.source];if(filter.type){var type=filter.type;filterConfig.push([function(obj){return type===obj.type}])}delete filter.type,counter.filter(filter,filterConfig)}return counter}function listByStatus(status,filters){return $q.all(_.map(status,function(value,key){return value?(filters.status=key,list(filters)):void 0})).then(onAlarms)}function listByDevices(ids,filters){return $q.all(_.map(ids,function(id){return filters.source=id,list(filters)})).then(onAlarms)}function getSeverityCount(alarms,severity){var result=_.where(alarms,{severity:severity});return result.length}function onAlarms(alarms){return _.filter(alarms,function(alarm){return angular.isDefined(alarm)})}var clean=c8yBase.cleanFields,path="alarm/alarms",pathReports=path+"/reports",defaultConfig={headers:c8yBase.contentHeaders("alarm")},severity={WARNING:"WARNING",MINOR:"MINOR",MAJOR:"MAJOR",CRITICAL:"CRITICAL"},severityList=Object.keys(severity),status={ACTIVE:"ACTIVE",ACKNOWLEDGED:"ACKNOWLEDGED",CLEARED:"CLEARED"},statusList=Object.keys(status),_reservedKeys=["history","id","severity","self","source","creationTime","time","text","firstOccurrence","count","firstOccurrenceTime"],reservedKeys=["status"].concat(_reservedKeys),removeKeys=["id"],removeKeysOnUpdate=["id","self","creationTime","type","time","count","history","firstOccurence","firstOccurrenceTime"],icons={},statusAttribute="status";return icons[severity.WARNING]="circle",icons[severity.MINOR]="exclamation-circle",icons[severity.MAJOR]="exclamation-circle",icons[severity.CRITICAL]="warning",icons[status.CLEARED]="check-circle",icons[status.ACKNOWLEDGED]="eye",icons[status.ACTIVE]="bell",{list:list,listByStatus:listByStatus,listByDevices:listByDevices,getSeverityCount:getSeverityCount,detail:detail,update:update,create:create,save:save,acknowledgedBy:acknowledgedBy,ackTime:ackTime,alarmDuration:_.memoize(alarmDuration,function(a){return a.id}),parseChanges:parseChanges,severity:severity,severityList:severityList,status:status,statusList:statusList,reservedKeys:reservedKeys,icon:icon,getKeys:getKeys,reports:{downtimeDuration:reportDownTimeDuration},createCounter:createCounter}}]),angular.module("c8y.core").factory("c8yAudits",["$http","c8yBase",function($http,c8yBase){function create(audit){var url=c8yBase.url(path),data=clean(audit,removeKeys);return $http.post(url,data,defaultConfig)}function isReservedKey(key){return-1!==reservedKeys.indexOf(key)}function isNotReservedKey(key){return!isReservedKey(key)}function getKeys(alarm){var _alarm=angular.copy(alarm),props=Object.keys(_alarm);return props.filter(isNotReservedKey)}var clean=c8yBase.cleanFields,path="audit/auditRecords",defaultConfig={headers:c8yBase.contentHeaders("auditRecord")},severity={WARNING:"WARNING",MINOR:"MINOR",MAJOR:"MAJOR",CRITICAL:"CRITICAL"},severityList=Object.keys(severity),_reservedKeys=["id","self","creationTime"],reservedKeys=_reservedKeys,removeKeys=_reservedKeys;return{create:create,severity:severity,severityList:severityList,reservedKeys:reservedKeys,getKeys:getKeys}}]),angular.module("c8y.core").factory("c8yApplication",["$http","$location","$q","$window","$interval","c8yBase","c8yUser","c8yInventory",function($http,$location,$q,$window,$interval,c8yBase,c8yUser,c8yInventory){function clean(app){var _app=angular.copy(app);return delete _app.type,delete _app.key,_app}function _list(path,filters){return c8yUser.current().then(function(user){var tenant=user.tenant,_filters=c8yBase.pageSizeFilter(filters),cfg={params:_filters,cache:!0},url=c8yBase.url(path)+"/"+tenant,onList=c8yBase.cleanListCallback("applications",angular.bind(self,_list,path),_filters);return $http.get(url,cfg).then(onList)})}function listByUser(user,filters){return c8yUser.current().then(function(currentUser){user=user||currentUser;var _filters=c8yBase.pageSizeFilter(filters),cfg={params:_filters,cache:!0},url=c8yBase.url(basePath+"applicationsByUser/"+user.id),onList=c8yBase.cleanListCallback("applications",angular.bind(self,listByUser,user),_filters);return $http.get(url,cfg).then(onList)})}function listByOwner(filters){return _list(basePath+"applicationsByOwner",filters)}function listByTenant(filters){return _list(basePath+"applicationsByTenant",filters)}function listPlugins(){var url=c8yBase.url(basePath+"plugins"),cfg={params:c8yBase.pageSizeNoTotalFilter()};return $http.get(url,cfg).then(function(res){return _.unique(res.data.plugins,"id")})}function listPluginsByTenant(){return listByTenant().then(function(apps){apps=_.uniq(apps,"id");var pluginPromises=[];return angular.forEach(apps,function(app){isHostedApp(app)&&pluginPromises.push(listPluginsByApplication(app))}),$q.all(pluginPromises).then(_.flatten).then(_.partialRight(_.unique,function(p){return p.id}))})}function listPluginsByApplication(app){var url=c8yBase.url(basePath2+"/"+app.contextPath+"/manifest"),cfg={params:c8yBase.pageSizeNoTotalFilter()};return $http.get(url,cfg).then(function(res){return _.map(res.data.imports,getPluginFromImportedManifest)})}function getPluginFromImportedManifest(manifest){return{id:manifest.id,contextPath:manifest.rootContextPath,directoryName:manifest.directoryName,manifest:manifest}}function buildDetailUrl(app){var id=app.id||app;return c8yBase.url(basePath2+"/"+id)}function detail(app){var url=buildDetailUrl(app);return $http.get(url)}function remove(app){var url=buildDetailUrl(app),_app=angular.isObject(app)?app:{id:app},actions=[],configPromise=getConfig(_app).then(function(app){return app.config&&app.config.id?c8yInventory.remove(app.config):!0});return actions.push(configPromise),actions.push($http["delete"](url)),$q.all(actions)}function update(app){var url=buildDetailUrl(app),cleanData=clean(app),cfg=angular.copy(defaultConfig);return $http.put(url,cleanData,cfg)["finally"](function(){$window.localStorage.setItem("refresh",app.contextPath)})}function create(app){var url=c8yBase.url(basePath2),cfg=angular.copy(defaultConfig);return $http.post(url,app,cfg)}function updateManifest(appId,manifest){return detail(appId).then(function(res){var app=res.data;return app.manifest=manifest,app}).then(update)}function save(app){return app.id?update(app):create(app)}function createUrl(app){var port=$location.port();return port=80===port||443===port?"":":"+port,$location.protocol()+"://"+$location.host()+port+"/apps/"+app.contextPath}function getCurrentContextPath(){var match=$window.location.pathname.match(/\/apps\/(\w+)\/?/);return match&&match[1]}function getCurrent(){var currentContextPath=getCurrentContextPath();return listByUser().then(function(applications){var currentApp={};return applications.forEach(function(app){return app.contextPath===currentContextPath?(currentApp=app,!1):void 0}),currentApp})}function getAppConfig(_app){return c8yInventory.list({type:"c8y_SmartAppApplication"}).then(function(apps){var config=null;return apps.forEach(function(app){return app.appId===_app.id?(config=app,!1):void 0}),config})}function getConfig(app){var outputApp,promise=app?$q.when(app):getCurrent();return promise.then(function(app){return outputApp=app,app}).then(getAppConfig).then(function(config){return outputApp.config=config,outputApp})}function getRefreshMessage(ignore){var contextPath=$window.localStorage.getItem("refresh");contextPath===getCurrentContextPath()&&($window.localStorage.setItem("refresh",void 0),ignore||$window.location.reload())}function getHref(app){return isHostedApp(app)?createUrl(app):app.externalUrl}function icon(application){var type=angular.isString(application)?application:application.type;return application.manifest&&(type="SMARTAPP"),iconMap[type]}function pollRefreshMessages(){$interval(function(){getRefreshMessage()},1e3,0,!1)}function filterApplications(apps){var unique=_.uniq(apps,function(app){return app.id}),hidden=_.filter(unique,function(app){var noAppSwitcher=app.manifest&&app.manifest.noAppSwitcher;return noAppSwitcher!==!0});return hidden}function listByVisibleLinks(){return listByUser().then(filterApplications).then(function(applications){return $q.when(applications)})}function isHostedApp(app){return"HOSTED"===app.type}var basePath="application/",basePath2=basePath+"applications",defaultConfig={headers:c8yBase.contentHeaders("application",!0)},self=this,iconMap={HOSTED:"cloud",EXTERNAL:"external-link-square",SMARTAPP:"puzzle-piece"};return getRefreshMessage(!0),{list:listByTenant,listByUser:listByUser,listByTenant:listByTenant,listByOwner:listByOwner,listPlugins:listPlugins,listPluginsByTenant:listPluginsByTenant,listPluginsByApplication:listPluginsByApplication,listByVisibleLinks:listByVisibleLinks,detail:detail,update:update,create:create,remove:remove,save:save,getHref:getHref,icon:icon,getCurrent:getCurrent,getConfig:getConfig,pollRefreshMessages:pollRefreshMessages,getCurrentContextPath:getCurrentContextPath,updateManifest:updateManifest}}]),angular.module("c8y.core").factory("c8yAuth",["$location","$window","info",function($location,$window,info){function decodeToken(token){var decoded=atob(token),split=decoded.match(/(([^\/]*)\/)?([^\/:]+):(.+)/);return{tenant:split[2],user:split[3],password:split[4]}}function encodeToken(user,password,tenant){return tenant=tenant?tenant+"/":"",btoa(tenant+user+":"+password)}function updatePassword(password){var decodedToken=decodeToken(token);info.token=token=encodeToken(decodedToken.user,password,decodedToken.tenant),$window.localStorage.setItem(TOKEN_KEY,token)}function transformRequest(config){var url=config.url,isCumulocity=!url.match(/http/)||url.match(/^https?\:\/\/.*cumulocity\.com/);return isCumulocity&&(config.headers||(config.headers={}),config.headers.Authorization||(config.headers.Authorization="Basic "+info.token),angular.extend(config.headers,{UseXBasic:!0})),config}function logout(){angular.isFunction(info.logout)&&info.logout()}var token=info.token,TOKEN_KEY="_tcy8";return{decodeToken:decodeToken,logout:logout,updatePassword:updatePassword,request:transformRequest}}]).config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push("c8yAuth")}]),angular.module("c8y.core").factory("c8yBase",["$rootScope","$http","$window","info",function($rootScope,$http,$window,info){function mimeType(type){return NAMESPACE+type+"+json"}function contentHeaders(contentType,acceptType){return{"Content-Type":mimeType(contentType),Accept:acceptType?mimeType(angular.isString(acceptType)?acceptType:contentType):void 0}}function deleteProperties(obj,properties){var _obj=angular.copy(obj);return properties.forEach(function(property){delete _obj[property]}),_obj}function url(path){return basePath()+path}function pageSizeNoTotalFilter(filter){return angular.extend({pageSize:pageSize},filter)}function pageSizeFilter(filter){return angular.extend({withTotalPages:!0,pageSize:pageSize},filter)}function timeOrderFilter(filter){return angular.extend({dateFrom:"1970-01-01",dateTo:moment().add(1,"day").format(dateFormat)},filter)}function lastWeekFilter(filter){return angular.extend({dateFrom:moment().subtract(1,"week").format(dateFormat),dateTo:moment().add(1,"day").format(dateFormat)},filter)}function fromThisMonthStartFilter(filter){return angular.extend({dateFrom:moment().startOf("month").format(dateFormat)},filter)}function todayFilter(filter){return angular.extend({dateFrom:moment().subtract(1,"day").format(dateFormat),dateTo:moment().add(1,"day").format(dateFormat)},filter)}function getParamFromUrl(paramName,url){var params={};return url&&url.split("?")[1].split("&").forEach(function(param){var split=param.split("=");params[split[0]]=decodeURIComponent(split[1])}),params[paramName]}function buildPagingObject(data,step){var stats=data.statistics,page=1===step?"next":"prev",pageUrl=data[page],result={currentPage:stats.currentPage,pageSize:stats.pageSize,startkey:getParamFromUrl("startkey",pageUrl),startkey_docid:getParamFromUrl("startkey_docid",pageUrl)},currentPageStr=getParamFromUrl("currentPage",pageUrl);return result.currentPage=parseInt(currentPageStr),result}function buildRefreshObject(data){var stats=data.statistics,result={currentPage:1,pageSize:stats.pageSize*stats.currentPage,startkey:null,startkey_docid:null};return angular.isDefined(data.totalPages)&&(result.pageSize=stats.pageSize),result}function buildPaging(data,fn,filter,blindPaging){var stats=data.statistics,hasPrev=angular.isDefined(data.prev),hasNext=angular.isDefined(data.next),output={};if(hasPrev){var prevFilter=angular.extend(angular.copy(filter),buildPagingObject(data,-1));output.prev=angular.bind({},fn,prevFilter)}if(hasNext){var nextFilter=angular.extend(angular.copy(filter),buildPagingObject(data,1));output.next=angular.bind({},fn,nextFilter),angular.isDefined(stats.totalPages)&&(output.more=(stats.totalPages-stats.currentPage)*stats.pageSize)}var refreshFilter=angular.extend(angular.copy(filter),buildRefreshObject(data)),refreshFn=angular.bind({},fn,refreshFilter);return output.statistics=stats,output.blind=blindPaging,output.refresh=function(){return refreshFn().then(function(list){return list.statistics=stats,list.paging=buildPaging(data,fn,filter,blindPaging),list})},output}function cleanListCallback(name,listFn,filters){return function(res){var data=res.data,list=data[name];return list.statistics=data.statistics,filters.withTotalPages||list.length!==parseInt(filters.pageSize,10)||(data.statistics.totalPages=list.statistics.totalPages=+(1/0)),list.paging=buildPaging(data,listFn,filters,!filters.withTotalPages),list}}function removeFromList(list,item){var ix=list.indexOf(item);ix>=0&&list.splice(ix,1)}function cleanFields(obj,fields){var _obj=angular.copy(obj);return fields.forEach(function(field){delete _obj[field]}),_obj}function invalid(scope,_form,_field){var form=scope&&scope[_form],field=form&&form[_field],pristine=field&&field.$pristine,_invalid=field&&field.$invalid;return pristine===!1&&_invalid===!0}function getCount(fn,filters){return filters.pageSize=1,filters.withTotalPages=!0,fn(filters).then(function(list){return list.statistics.totalPages})}function humanizeFragment(str){return str||(str=""),str.replace(/c8y_/,"").replace(/([A-Z])/g," $1").replace(/^\s*/,"").replace(/\s*$/,"")}function getResData(res){return res&&res.data||res}function createEnum(values){var e={},ordinal=0;return e.values=_.constant(_.map(values,function(value){return angular.isObject(value)?e[value.name]={name:value.name,ordinal:ordinal++,value:value.value}:e[value]={name:value,ordinal:ordinal++,value:value}})),e}function createLocalId(mo,key){if(key=key||"id",!angular.isObject(mo))throw new Error("mo is not an object");return angular.isUndefined(mo[key])&&(mo[key]=String(Math.random()).substr(2)),mo}function getId(refId){var id;if(angular.isObject(refId)&&(id=refId.id),(angular.isNumber(refId)||angular.isString(refId)&&refId.match(/^\d+$/))&&(id=String(refId)),!id)throw new Error("id cannot be found");return id}function checkIfModulesExist(modules){try{return _.each(modules,function(module){angular.module(module)}),!0}catch(e){return!1}}var basePath=function(){return info.baseUrl||"/"},HEADER_APPKEY="X-Cumulocity-Application-Key",NAMESPACE="application/vnd.com.nsn.cumulocity.",appKey=info.appKey,pageSize=info.pageSize||1e3,dateFormat="YYYY-MM-DD",dateFullFormat="YYYY-MM-DDTHH:mm:ssZ";if(!appKey)throw new Error("Application key must be defined");return $http.defaults.headers.common[HEADER_APPKEY]=appKey,{url:url,deleteProperties:deleteProperties,mimeType:mimeType,contentHeaders:contentHeaders,PAGESIZE:pageSize,pageSizeFilter:pageSizeFilter,pageSizeNoTotalFilter:pageSizeNoTotalFilter,timeOrderFilter:timeOrderFilter,lastWeekFilter:lastWeekFilter,todayFilter:todayFilter,fromThisMonthStartFilter:fromThisMonthStartFilter,cleanListCallback:cleanListCallback,removeFromList:removeFromList,cleanFields:cleanFields,dateFormat:dateFormat,dateFullFormat:dateFullFormat,invalid:invalid,getCount:getCount,humanizeFragment:humanizeFragment,getResData:getResData,createEnum:createEnum,createLocalId:createLocalId,getId:getId,checkIfModulesExist:checkIfModulesExist}}]),angular.module("c8y.core").factory("c8yBinary",["$q","$upload","$http","c8yBase","c8yInventory","info",function($q,$upload,$http,c8yBase,c8yInventory,info){function list(filters){var url=c8yBase.url(path),_filters=c8yBase.pageSizeFilter(filters),cfg={params:_filters},blindPaging=!0,onList=c8yBase.cleanListCallback("managedObjects",list,_filters,blindPaging);return $http.get(url,cfg).then(onList)}function upload(binary){return $upload.upload({url:c8yBase.url(path),method:"POST",headers:c8yBase.contentHeaders("managedObject"),data:{object:{name:binary.name,type:binary.type},filesize:binary.size},file:binary})}function downloadAndSaveAs(binary){return download(binary).then(function(xhr){var contentType=xhr.getResponseHeader("Content-Type"),contentDisposition=xhr.getResponseHeader("Content-Disposition"),blob=new Blob([xhr.response],{type:contentType});saveAs(blob,getFilenameFromContentDisposition(contentDisposition))})}function getFilenameFromContentDisposition(contentDisposition){return/filename="(.*)"/.exec(contentDisposition)[1]}function downloadAsDataUri(binary){return download(binary).then(function(xhr){var contentType=xhr.getResponseHeader("Content-Type"),base64=arrayBufferToBase64(xhr.response);return"data:"+contentType+";base64,"+base64})}function arrayBufferToBase64(buffer){for(var binary="",bytes=new Uint8Array(buffer),len=bytes.byteLength,i=0;len>i;i++)binary+=String.fromCharCode(bytes[i]);return btoa(binary)}function download(binary){var deferred=$q.defer(),url=buildFileUrl(binary),xhr=new XMLHttpRequest;return xhr.open("GET",url,!0),xhr.responseType="arraybuffer",xhr.onload=function(e){200===xhr.status?deferred.resolve(xhr):deferred.reject(xhr)},xhr.onprogress=function(e){angular.isDefined(e.loaded)&&deferred.notify(e.loaded/size(binary))},xhr.setRequestHeader("Authorization","Basic "+info.token),xhr.setRequestHeader("UseXBasic",!0),xhr.send(),deferred.promise}function buildFileUrl(binary){var id=binary.id||binary;return c8yBase.url(path+"/"+id)}function getDownloadUrl(binary){return binary&&binary.self&&binary.self.replace(c8yBase.url(managedObjectsPath),c8yBase.url(path))}function removeBinary(binary){var url=buildFileUrl(binary);return $http["delete"](url)}function icon(binary){var targetIcon=["file","o"],fileGenericType=getFileGenericType(binary);return fileGenericType&&targetIcon.splice(1,0,fileGenericType),targetIcon.join("-")}function getFileGenericType(binary){var type="";return angular.forEach(fileTypeIconsMap,function(iconCfg,icon){var moExt=fileNameRegexp.exec(binary.name)[1];if(angular.forEach(iconCfg.exts,function(ext){return ext===moExt?(type=icon,!1):void 0}),!type){var moMime=binary._attachments[Object.keys(binary._attachments)[0]].content_type;angular.forEach(iconCfg.mimes,function(mime){return mime===moMime?(type=icon,!1):void 0})}}),type}function size(binary){return binary._attachments[Object.keys(binary._attachments)[0]].length}function isImage(binary){var fileGenericType=getFileGenericType(binary);return"image"===fileGenericType}function hasValidSize(file){return file&&file.size<=BYTES_SIZE_LIMIT}function save(binary){return binary.id?update(binary):create(binary)}function create(binary){var mo=angular.extend(binary,{c8y_IsBinary:!0});return c8yInventory.createConfirm(mo)}function update(binary){return c8yInventory.update(binary)}function detail(binaryId,params){return c8yInventory.detail(binaryId,params)}function remove(binary){return c8yInventory.remove(binary)}function getDataUri(binary){return binary&&binary.dataType&&binary.data?"data:"+binary.dataType+";base64,"+binary.data:""}function getIdFromUrl(url){var regexp=new RegExp("\\/inventory\\/binaries\\/(\\d+)|\\/inventory\\/managedObjects\\/(\\d+)"),matches=url.match(regexp);return matches&&(matches[1]||matches[2])}var path="inventory/binaries",managedObjectsPath="inventory/managedObjects",BYTES_SIZE_LIMIT=52428800,fileNameRegexp=/(?:\.([^.]+))?$/,fileTypeIconsMap={archive:{mimes:[],exts:["7z","apk","cab","gz","iso","jar","rar","tar","zip"]},audio:{mimes:[],exts:["3gp","aiff","aac","amr","m4a","m4p","mp3","oga","ogg","raw","wav","wma"]},code:{mimes:[],exts:["aspx","exe","htm","html","jad","js","json","jsp","php","xml"]},excel:{mimes:[],exts:["xls","xlsx"]},image:{mimes:[],exts:["bmp","gif","jpeg","jpg","png","tiff"]},pdf:{mimes:[],exts:["pdf"]},powerpoint:{mimes:[],exts:["ppt","pptx"]},text:{mimes:[],exts:["txt"]},video:{mimes:[],exts:["3gp","asf","avi","flv","mov","mp4","ogv","qt","rm","rmvb","wmv"]},word:{mimes:[],exts:["doc","docx"]}};return angular.extend(angular.copy(c8yInventory),{BYTES_SIZE_LIMIT:BYTES_SIZE_LIMIT,list:list,upload:upload,downloadAndSaveAs:downloadAndSaveAs,downloadAsDataUri:downloadAsDataUri,getDownloadUrl:getDownloadUrl,removeBinary:removeBinary,icon:icon,size:size,isImage:isImage,hasValidSize:hasValidSize,getIdFromUrl:getIdFromUrl,save:save,detail:detail,remove:remove,getDataUri:getDataUri})}]),angular.module("c8y.core").factory("c8yCepModule",["$http","$q","$timeout","c8yBase","c8yCepModuleExamples",function($http,$q,$timeout,c8yBase,c8yCepModuleExamples){function wrapFileBody(body){
var _boundary="--"+boundary(),output=_boundary+'\r\nContent-Disposition: form-data; name="file"; filename="module.cep"\r\nContent-Type: text/plain\r\n\r\n'+body+"\r\n"+_boundary;return output}function boundary(){return"83ff53821b7c"}function updateStatus(module){var url=c8yBase.url(path+"/"+module.id),cfg={headers:c8yBase.contentHeaders(contentType,!0)},data={status:module.status};if(!module.id)throw new Error("Module id no defined");return $http.put(url,data,cfg)}function updateModule(module){var id=module.id,url=c8yBase.url(path+(id?"/"+id:"")),body=wrapFileBody(module.body),method=id?"put":"post",headers=angular.extend(c8yBase.contentHeaders(contentType,!0),{"Content-Type":"multipart/form-data; boundary="+boundary()}),cfg={headers:headers};return $http[method](url,body,cfg)}function list(filters){var url=c8yBase.url(path),_filters=c8yBase.pageSizeFilter(filters),cfg={params:_filters},onList=c8yBase.cleanListCallback("modules",list,_filters);return $http.get(url,cfg).then(filterSmartRulesFromRes).then(onList)}function filterSmartRulesFromRes(res){return res.data.modules=_.filter(res.data.modules,function(module){return!isSmartRuleModule(module)}),res}function isSmartRuleModule(module){return module&&/^smartRule\d+$/.test(module.name)}function listWithSmartRules(filters){var url=c8yBase.url(path),_filters=c8yBase.pageSizeFilter(filters),cfg={params:_filters},onList=c8yBase.cleanListCallback("modules",listWithSmartRules,_filters);return $http.get(url,cfg).then(onList)}function detail(_module){var id=_module.id||_module,url=c8yBase.url(path+"/"+id),def=$q.defer(),body=null,module=null,fileConfig={headers:{"Content-Type":"text/plain",Accept:"text/plain"}},dataConfig={headers:{Accept:c8yBase.mimeType(contentType)}},checkFinal=function(){if(body&&module){var nameMatch=/module (\w*);\s*\n*/;module.name=body.match(nameMatch)[1],module.body=body.replace(nameMatch,""),def.resolve(module)}};return $http.get(url,dataConfig).then(function(res){module=res.data,$http.get(url,fileConfig).success(function(data){body=data,checkFinal()})}),def.promise}function remove(module){var id=module.id||module,url=c8yBase.url(path+"/"+id);return $http["delete"](url)}function save(_module){var firstStep,def=$q.defer(),module=angular.copy(_module);return module.body?(module.name&&(module.body="module "+module.name+";\n"+module.body),firstStep=updateModule(module).then(null,function(data){def.reject(data)})):firstStep=detail(module),firstStep.then(function(res){var _module=res.body?res:res.data;module.status&&_module.status!==module.status?(_module.status=module.status,updateStatus(_module).then(function(res){def.resolve(res.data)},function(res){def.reject(res.data)})):def.resolve(_module)}),def.promise}function detailByName(name){return list().then(function(modules){var _module;return modules.forEach(function(m){return m.name===name?(_module=m,!1):void 0}),_module||$q.reject("not found")})}function createOrDeploy(module){var name=module.name;return cacheCreateOrDeploy[name]||(cacheCreateOrDeploy[name]=detailByName(name).then(function(module){return"DEPLOYED"!==module.status?(module.status="DEPLOYED",save(module)):module},function(){return save(module)})),cacheCreateOrDeploy[name]}function deploy(module){return module.status="DEPLOYED",save(module)}function redeploy(module){return undeploy(module).then(deploy)}function undeploy(module){return module.status="NOT_DEPLOYED",save(module)}function examples(){return $q.when(c8yCepModuleExamples)}var path="cep/modules",contentType="cepModule",cacheCreateOrDeploy={};return{list:list,listWithSmartRules:listWithSmartRules,isSmartRuleModule:isSmartRuleModule,detail:detail,save:save,remove:remove,examples:examples,detailByName:detailByName,createOrDeploy:createOrDeploy,deploy:deploy,redeploy:redeploy,undeploy:undeploy}}]).value("c8yCepModuleExamples",[{name:"Send alarms that are active since 30 minutes to email",value:'insert into SendEmail\nselect\n  "info@cumulocity.com" as sender,\n  "YOUR_EMAIL_HERE" as receiver,\n  "Alarm active since 30 mins: " || e.alarm.text as subject,\n  "Time: " || e.alarm.time.format() || \n  " Severity: " || e.alarm.severity.name() || \n  " Source: " || findManagedObjectById(e.alarm.source.value).getName() as text\nfrom pattern [\n   every e = AlarmCreated(alarm.status = CumulocityAlarmStatuses.ACTIVE, alarm.severity = CumulocitySeverities.CRITICAL) \n   -> (timer:interval(30 minutes) \n      and not AlarmUpdated(alarm.status != CumulocityAlarmStatuses.ACTIVE, alarm.id.value = e.alarm.id.value))\n];'},{name:"Select temperature readings over 100 degree",value:'select * from MeasurementCreated e\nwhere getNumber(e, "c8y_TemperatureMeasurement.T.value") > 100'},{name:"Create alarm when temperature over 100 degree",value:'insert into CreateAlarm \n  select\n    e.measurement.time as time,\n    e.measurement.source.value as source,\n    "com_cumulocity_TemperatureAlert" as type,\n    "Temperature too high" as text,\n    "ACTIVE" as status,\n    "CRITICAL" as severity\n  from MeasurementCreated e\n  where getNumber(e, "c8y_TemperatureMeasurement.T.value") > 100'},{name:"Create alarm when temperature below 0 degree",value:'insert into CreateAlarm \n  select\n    e.measurement.time as time,\n    e.measurement.source.value as source,\n    "com_cumulocity_TemperatureAlert" as type,\n    "Temperature too low" as text,\n    "ACTIVE" as status,\n    "CRITICAL" as severity\n  from MeasurementCreated e\n  where getNumber(e, "c8y_TemperatureMeasurement.T.value") < 0'},{name:"Create close relay operation when temperature readings over 100 degree",value:'insert into CreateOperation\n  select\n    "PENDING" as status,\n    «heating ID» as deviceId,\n    {\n      "c8y_Relay.relayState", "CLOSED"\n    } as fragments\n  from MeasurementCreated e\n  where getNumber(e, "c8y_TemperatureMeasurement.T.value") > 100'},{name:"Schedule device restart every day at 1am",value:'insert into CreateOperation\nselect\n  "PENDING" as status,\n  «device ID» as deviceId,\n  { "c8y_Restart", {} } as fragments\nfrom pattern [every timer:at(*, 1, *, *, *, *)];'},{name:"Select location change event once for 60 seconds",value:'select * from EventCreated e\nwhere getObject(e, "c8y_LocationMeasurement") is not null\noutput first every 60 seconds'},{name:"Display current temperature on device",value:'expression string js:prepareText(temp) [\n  function format(text, params){\n    for(param in params) {\n        text = text.replace("{" + param + "}", params[param])\n    }\n    return text\n  }\n  format("Current temperature is {0}", [temp])\n]\ninsert into CreateOperation\n	select\n      "PENDING" as status,\n      e.measurement.source.value as deviceId,\n      { "c8yDisplay", prepareText(\n        getNumber(e, "c8y_TemperatureMeasurement.T.value")\n	   ) } as fragments\n    from MeasurementCreated e\n    where e.measurement.type = "c8y_TemperatureMeasurement";'},{name:"Change the severities of alarms based on activity time",value:'/* Create "context" - definition of a group of events to be processed separately.\n * Context "Alarms" consists of AlarmCreated and AlarmUpdated: \n * with the same source and type = "power off". */\ncreate context Alarms partition by \nalarm.source from AlarmCreated(alarm.type = "power off"),\nalarm.source from AlarmUpdated(alarm.type = "power off");\n\n/* Update severity for all active AlarmCreated \n * after which there is no change to other status in 15 minutes. */\ncontext Alarms \ninsert into UpdateAlarm \nselect \n   a.alarm.id as id,\n   "MAJOR" as severity\nfrom pattern [\n   every a = AlarmCreated(alarm.status = CumulocityAlarmStatuses.ACTIVE) \n   -> (timer:interval(15 minutes) \n      and not AlarmUpdated(alarm.status != CumulocityAlarmStatuses.ACTIVE))\n];'},{name:"Create alarm if temperature was to low for 15 minutes",value:'create schema NotZeroMeasurementCreated (\n  measurement Measurement\n);\ncreate schema ZeroMeasurementCreated (\n  measurement Measurement\n);\ncreate schema CheckTimeDifference (\n  firstMeasurement Measurement,\n  lastMeasurement Measurement\n);\ninsert into CreateAlarm\n  select\n    check.lastMeasurement.source as source,\n    check.lastMeasurement.time as time,\n    "c8y_LowTemperatureAlarm" as type,\n    CumulocitySeverities.WARNING as severity,\n    CumulocityAlarmStatuses.ACTIVE as status,\n    "Temperature was too low for more than 15 minutes" as text\n  from CheckTimeDifference check\n  where check.lastMeasurement.time.after(check.firstMeasurement.time, 15min);\ninsert into CheckTimeDifference\n  select\n    firstM.measurement as firstMeasurement,\n    lastM.measurement as lastMeasurement\n  from pattern [\n    every (firstM = NotZeroMeasurementCreated ->\n    ZeroMeasurementCreated(measurement.source.value =firstM.measurement.source.value)) ->\n    ZeroMeasurementCreated until lastM = NotZeroMeasurementCreated(measurement.source.value = firstM.measurement.source.value)\n  ];\ninsert into NotZeroMeasurementCreated\n  select\n    m.measurement as measurement\n  from\n    MeasurementCreated m\n  where getNumber(m, "c8y_TemperatureMeasurement.T.value") > 0\n  AND m.measurement.type = "c8y_TemperatureMeasurement";\ninsert into ZeroMeasurementCreated\n  select\n    m.measurement as measurement\n  from\n    MeasurementCreated m\n  where getNumber(m, "c8y_TemperatureMeasurement.T.value") <= 0\n  AND m.measurement.type = "c8y_TemperatureMeasurement";'},{name:"Send simulator temperature to Zapier",value:'@Name("simulatortemperature")\nselect\n  e.measurement.source.value as id,\n  findManagedObjectById(e.measurement.source.value).getName() as name,\n  e.measurement.time.format() as time,\n  getNumber(e, "c8y_TemperatureMeasurement.T.value") as value,\nfrom MeasurementCreated e\n  where e.measurement.type = "TemperatureMeasurement"\n'},{name:"Send sales to Zapier",value:'@Name("sales")\nselect\n  getString(e, "com_nsn_startups_vendme_fragments_SalesReportInfo.vendingMachine_name") as id,\n  getString(e, "com_nsn_startups_vendme_fragments_SalesReportInfo.product_name") as name,\n  e.event.time.format() as time,\n  getNumber(e, "com_nsn_startups_vendme_fragments_SalesReportInfo.totalPaid") as value,\n  getString(e, "com_nsn_startups_vendme_fragments_SalesReportInfo.payment_type") as text\nfrom EventCreated e\n  where e.event.type = "com_nsn_startups_vendme_LiveSalesReport"\n'}]),function(){function c8yCounter($q,c8yBase,c8yRealtime){function PropertyMap(propertyMap){function createDefault(prop){that.properties=[prop],that.filterFn=function(propVal,obj){return _.isEqual(propVal,obj[prop])},that.dependencies=[prop]}function parse(propertyMap){var len=propertyMap.length,lastElem=_.last(propertyMap);return _.isArray(lastElem)?(that.dependencies=lastElem,that.filterFn=propertyMap[len-2],that.properties=propertyMap.slice(0,length-2),_.isFunction(that.filterFn)&&_.every(that.properties,String)):_.isFunction(lastElem)?(that.dependencies=_.initial(propertyMap),that.filterFn=lastElem,that.properties=that.dependencies,_.every(that.properties,String)):!1}propertyMap=_.cloneDeep(propertyMap);var that=this;if(this.properties=null,this.filterFn=null,this.dependencies=null,_.isArray(propertyMap)){if(!parse(propertyMap))throw new Error("property map is not valid")}else{if(!_.isString(propertyMap))throw new Error("parameter is invalid");createDefault(propertyMap)}}function FilterConfiguration(filter,config){function clearUndefinedProperties(){filter=_.pick(filter,function(val){return void 0!==val})}function fillEmptyMappings(){_.forEach(_.keys(filter),function(filterName){var hasMapping=_.any(that.propertyMapList,function(propertyMap){return _.any(propertyMap.properties,function(prop){return prop===filterName})});hasMapping||that.propertyMapList.push(new PropertyMap(filterName))})}function createPickList(){var pickListObj=_.reduce(that.propertyMapList,function(result,propertyMap){return _.forEach(propertyMap.dependencies,function(prop){result[prop]=!0}),result},{});pickListObj.id=!0,that.pickList=_.keys(pickListObj)}var that=this;this.pickList=null,this.queryParams=filter,this.propertyMapList=config&&_.map(config,function(propertyMap){return new PropertyMap(propertyMap)})||[],clearUndefinedProperties(),fillEmptyMappings(),createPickList()}function Counter(listFn,realtimeChannel){function subscribe(){if(realtimeChannel){var realtimeActions=c8yRealtime.realtimeActions();return _.forEach(realtimeActions,function(action){c8yRealtime.addListener(that.__realtimeId,realtimeChannel,action,onNotification)}),$q.when(c8yRealtime.start(that.__realtimeId,realtimeChannel))}}function unsubscribe(){realtimeChannel&&c8yRealtime.removeSubscriber(that.__realtimeId,realtimeChannel)}function onNotification(evt,obj){if(!isRefreshing){var oldCount=that.count;REALTIME_FN_MAP[evt.name](obj),updateCount();var newCount=that.count;notificationCallback&&newCount!==oldCount&&notificationCallback(newCount,oldCount)}}function onCreate(obj){hasFilter?filterMatches(obj)&&objects.unshift(map(obj)):count+=1}function onUpdate(obj){if(hasFilter){var idx=_.findIndex(objects,{id:obj.id});-1===idx&&filterMatches(obj)?objects.unshift(map(obj)):-1===idx||filterMatches(obj)||objects.splice(idx,1)}}function onDelete(obj){if(hasFilter){var idx=_.findIndex(objects,{id:obj.id});-1!==idx&&objects.splice(idx,1)}else count-=1}function updateCount(){that.count=objects&&objects.length||count||0}function map(obj){return _.pick(obj,filterConfig.pickList)}function filterMatches(obj){return filterConfig.matches(obj)}if(!_.isFunction(listFn))throw new Error("list function must be provided");var objects,count,notificationCallback,filterConfig,that=this,isRefreshing=!1,hasFilter=!1,filter={pageSize:1},isStarted=!1,isStopped=!1,REALTIME_FN_MAP={CREATE:onCreate,UPDATE:onUpdate,DELETE:onDelete};c8yBase.createLocalId(this,"__realtimeId"),this.start=function(){if(isStarted)throw new Error("Cannot restart a counter instance, please create a new instance");return isStarted=!0,this.refresh().then(subscribe)},this.stop=function(){if(!isStarted)throw new Error("Cannot stop counter instance without starting it first");if(isStopped)throw new Error("Cannot stop an already stopped counter instance");isStopped=!0,unsubscribe()},this.onNotification=function(callback){notificationCallback=callback},this.refresh=function(){isRefreshing=!0;var queryParams=hasFilter?filterConfig.queryParams:filter;return $q.when(listFn(queryParams)).then(function(objs){hasFilter?objects=_.chain(objs).filter(filterMatches).map(map).value():count=objs.statistics.totalPages,updateCount(),isRefreshing=!1})},this.filter=function(_filter,_filterConfig){if(!_filter&&!_filterConfig)return filter;if(hasFilter)throw new Error("filter can be set only once");hasFilter=!0,filterConfig=new FilterConfiguration(_filter,_filterConfig)}}PropertyMap.prototype.matches=function(filter,obj){filter=_.cloneDeep(filter),_.forEach(this.properties,function(prop){filter[prop]=filter[prop]||void 0});var args=_.values(_.pick(filter,this.properties));return args.push(obj),this.filterFn.apply(this,args)},FilterConfiguration.prototype.matches=function(obj){var that=this;return _.every(this.propertyMapList,function(propertyMap){return propertyMap.matches(that.queryParams,obj)})};var datePropertyMap=["dateFrom","dateTo",function(dateFrom,dateTo,obj){var date=obj&&(obj.date||obj.time);return date?dateFrom&&moment(dateFrom).isAfter(date)?!1:dateTo&&moment(dateTo).isBefore(date)?!1:!0:!1},["date","time"]],sourcePropertyMap=["source",function(source,obj){return(obj&&obj.source&&obj.source.id)===source},["source"]],defaultPropertyMaps={date:datePropertyMap,source:sourcePropertyMap};return{Counter:Counter,defaultPropertyMaps:defaultPropertyMaps}}angular.module("c8y.core").factory("c8yCounter",["$q","c8yBase","c8yRealtime",c8yCounter])}(),angular.module("c8y.core").factory("c8yDeviceControl",["$http","$rootScope","$q","c8yBase","c8yRealtime",function($http,$rootScope,$q,c8yBase,c8yRealtime){function buildDetailUrl(operation){var id=operation.id||operation;return c8yBase.url(path+"/"+id)}function list(filters){var url=c8yBase.url(path),_filters=c8yBase.pageSizeNoTotalFilter(filters),cfg={params:_filters},onList=c8yBase.cleanListCallback("operations",list,_filters);return $http.get(url,cfg).then(onList)}function listPaged(filters){var defer=$q.defer(),_filters=angular.extend(filters||{},{pageSize:1e3}),cancelled=!1,onList=function(list){var isNext=angular.isDefined(list.paging.next)&&!(list.length<_filters.pageSize);return defer.notify(list),isNext||defer.resolve(!0),cancelled?!0:isNext?list.paging.next().then(onList):!0};return angular.extend(defer.promise,{cancel:function(){cancelled=!0,defer.reject("canceled")}}),list(_filters).then(onList),defer.promise}function detail(operation){var url=buildDetailUrl(operation);return $http.get(url)}function create(operation){var url=c8yBase.url(path),data=clean(operation,cleanKeys),cfg=angular.copy(defaultConfig);if(!data.deviceId)throw new Error("c8yDeviceControl: data must have a deviceId property");return $http.post(url,data,cfg).then(getIdFromRes)["finally"](function(id){return evtBus.$emit("create"),id})}function getIdFromRes(res){var regexp=new RegExp(opIdLocationRegExp),matches=res.headers("Location").match(regexp);return parseInt(matches[1],10)}function createWithNotifications(operation){var created=create(operation),completed=created.then(function(operationId){operation.id=operationId;var deferred=$q.defer(),subscriptionId="operation"+operation.id,subscriptionChannel="/operations/"+operation.deviceId;return c8yRealtime.addListener(subscriptionId,subscriptionChannel,"UPDATE",function(evt,data){data.id==operation.id&&(data.status===status.SUCCESSFUL||data.status===status.FAILED?(c8yRealtime.stop(subscriptionId,subscriptionChannel),deferred.resolve(data)):deferred.notify(data))}),c8yRealtime.start(subscriptionId,subscriptionChannel),deferred.promise});return $q.when({created:created,completed:completed})}function update(operation){var url=c8yBase.url(path)+"/"+operation.id,data=clean(operation,cleanKeys.concat(cleanKeysUpdate)),cfg=angular.copy(defaultConfig);return $http.put(url,data,cfg)["finally"](function(){evtBus.$emit("update")})}function cancel(operation){return operation.status=status.FAILED,operation.failureReason="Operation cancelled by user.",update(operation)}function save(operation){return operation.id?update(operation):create(operation)}function getStyle(operationOrStatus){var _status=angular.isString(operationOrStatus)?operationOrStatus:operationOrStatus.status;return style[_status.toUpperCase()]}function isReservedKey(key){return-1!==reservedKeys.indexOf(key)}function isNotReservedKey(key){return!isReservedKey(key)}function getKeys(operation){var _operation=angular.copy(operation),props=Object.keys(_operation);return props.filter(isNotReservedKey)}var clean=c8yBase.cleanFields,path="devicecontrol/operations",opIdLocationRegExp="\\/devicecontrol\\/operations\\/(\\d+)",defaultConfig={headers:c8yBase.contentHeaders("operation")},status={PENDING:"PENDING",SUCCESSFUL:"SUCCESSFUL",EXECUTING:"EXECUTING",FAILED:"FAILED"},statusList=Object.keys(status),cleanKeys=["creationTime","deviceExternalIDs","id","self"],cleanKeysUpdate=["deviceId"],reservedKeys=cleanKeys.concat(["deviceId"]),style={},evtBus=$rootScope.$new(!0);return style[status.PENDING]={icon:"clock-o",cls:"text-muted"},style[status.EXECUTING]={icon:"refresh",cls:"text-info"},style[status.SUCCESSFUL]={icon:"check-circle",cls:"text-success"},style[status.FAILED]={icon:"times-circle",cls:"text-danger"},{list:list,listPaged:listPaged,detail:detail,create:create,createWithNotifications:createWithNotifications,update:update,cancel:cancel,save:save,status:status,statusList:statusList,getStyle:getStyle,getKeys:getKeys,events:evtBus}}]),angular.module("c8y.core").factory("c8yEvents",["$http","c8yBase","c8yCounter",function($http,c8yBase,c8yCounter){function buildDetailUrl(evt){var id=evt.id||evt;return c8yBase.url(path+"/"+id)}function list(filters){var url=c8yBase.url(path),cfg={params:c8yBase.timeOrderFilter(c8yBase.pageSizeNoTotalFilter(filters))},onList=c8yBase.cleanListCallback("events",list,cfg.params);return $http.get(url,cfg).then(onList)}function detail(evt){var url=buildDetailUrl(evt);return $http.get(url)}function create(evt){var url=c8yBase.url(path),data=clean(evt,reservedKeys),cfg=angular.copy(defaultConfig);return $http.post(url,data,cfg)}function update(evt){var url=buildDetailUrl(evt),data=clean(evt,reservedKeys),cfg=angular.copy(defaultConfig);return $http.put(url,data,cfg)}function save(evt){return evt.id?update(evt):create(evt)}function isReservedKey(key){return-1!==reservedKeys.indexOf(key)}function isNotReservedKey(key){return!isReservedKey(key)}function getKeys(evt){var _evt=angular.copy(evt),props=Object.keys(_evt);return props.filter(isNotReservedKey)}function createCounter(filter){var counter=new c8yCounter.Counter(list,"/events/*"),filterConfig=[c8yCounter.defaultPropertyMaps.date,c8yCounter.defaultPropertyMaps.source];if(filter.type){var type=filter.type;filterConfig.push([function(obj){return type===obj.type}])}return delete filter.type,counter.filter(filter,filterConfig),counter}var clean=c8yBase.cleanFields,path="event/events",defaultConfig={headers:c8yBase.contentHeaders("event")},reservedKeys=["creationTime","id","self","source","text","time"];return{list:list,detail:detail,create:create,update:update,save:save,reservedKeys:reservedKeys,getKeys:getKeys,createCounter:createCounter}}]),angular.module("c8y.core").factory("c8yDeviceGroup",["c8yManagedObject",function(c8yManagedObject){function hasDevices(group){return!!group.childAssets.references.length}var exports={},deviceGroupType="c8y_DeviceGroup";return exports.list=function(filter){var _filter={type:deviceGroupType,pageSize:1e4};return angular.isObject(filter)&&(_filter=angular.extend(_filter,filter)),c8yManagedObject.list(_filter)},exports.detail=function(id){return c8yManagedObject.detail(id)},exports.create=function(data){return data.type=deviceGroupType,c8yManagedObject.create(data)},exports.remove=function(data){return hasDevices(data)?!1:c8yManagedObject.remove(data)},exports.addDevice=function(group,device){return device.c8y_Groups=angular.isArray(device.c8y_Groups)?device.c8y_Groups:[],device.c8y_Groups.push({name:group.name,id:group.id}),c8yManagedObject.update(device.id,{c8y_Groups:device.c8y_Groups}),c8yManagedObject.addChildAsset(group,device)},exports.removeDevice=function(group,device){return device.c8y_Groups=device.c8y_Groups.filter(function(g){return g.id!==group.id}),c8yManagedObject.update(device.id,{c8y_Groups:device.c8y_Groups}),c8yManagedObject.removeChildAsset(group,device)},exports}]),angular.module("c8y.core").factory("c8yDeviceRegistration",["$http","c8yBase",function($http,c8yBase){function buildDetailUrl(device){var id=device.id||device;return c8yBase.url(path+"/"+id)}function list(filters){var url=c8yBase.url(path),_filters=c8yBase.pageSizeFilter(filters),cfg={params:_filters},onList=c8yBase.cleanListCallback("newDeviceRequests",list,_filters);return $http.get(url,cfg).then(onList)}function detail(devReg){var url=buildDetailUrl(devReg);return $http.get(url)}function create(device){var url=c8yBase.url(path),data=clean(device,cleanKeys),cfg=angular.copy(defaultConfig);if(!data.id)throw new Error("c8yDeviceRegistration: data must have an id property");return $http.post(url,data,cfg)}function accept(device){var url=buildDetailUrl(device),data={status:status.ACCEPTED},cfg=angular.copy(defaultConfig);return $http.put(url,data,cfg)}function cancel(devReg){var url=buildDetailUrl(devReg);return $http["delete"](url)}function getStyle(devReg){var status=devReg.status||"UNKNOWN";return style[status.toUpperCase()]}function newDeviceRequestsStatusIcon(device){return getStyle(device).icon}function newDeviceRequestsStatusClass(device){return getStyle(device).cls}function isReservedKey(key){return-1!==reservedKeys.indexOf(key)}function isNotReservedKey(key){return!isReservedKey(key)}function getKeys(devReg){var _devReg=angular.copy(devReg),props=Object.keys(_devReg);return props.filter(isNotReservedKey)}var clean=c8yBase.cleanFields,path="devicecontrol/newDeviceRequests",defaultConfig={headers:c8yBase.contentHeaders("newDeviceRequest")},status={WAITING_FOR_CONNECTION:"WAITING_FOR_CONNECTION",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",ACCEPTED:"ACCEPTED"},statusList=Object.keys(status),cleanKeys=[],reservedKeys=[],style={};return style[status.WAITING_FOR_CONNECTION]={icon:"unlink",cls:"text-danger"},style[status.PENDING_ACCEPTANCE]={icon:"circle",cls:"text-info"},style[status.ACCEPTED]={icon:"check-circle",cls:"text-success"},{list:list,detail:detail,create:create,accept:accept,cancel:cancel,status:status,statusList:statusList,getStyle:getStyle,getKeys:getKeys,statusIcon:newDeviceRequestsStatusIcon,statusClass:newDeviceRequestsStatusClass}}]),angular.module("c8y.core").factory("c8yDevices",["$cacheFactory","$filter","c8yInventory","c8yUser",function($cacheFactory,$filter,c8yInventory,c8yUser){function buildFilter(filter){return angular.extend({skipChildrenNames:!0,fragmentType:deviceFragmentType},filter||{})}function filterDevices(managedObjects){var filtered=managedObjects.filter(function(mo){return mo[deviceFragmentType]});return filtered.statistics=managedObjects.statistics,filtered.paging=managedObjects.paging,filtered}function list(filter){var _filter=buildFilter(filter),http=c8yInventory.list(_filter);return _filter.text&&(http=http.then(filterDevices)),http}function create(device){var mo=angular.copy(device);mo[deviceFragmentType]=!0,c8yInventory.create(mo)}function save(device){return device.id?update(device):create(device)}function supportsOperation(device,operation){var ops=device&&device.c8y_SupportedOperations,supports=angular.isArray(ops)&&ops.indexOf(operation)>-1;return!!supports}function getSupportedOperations(device){var ops=[];return angular.isArray(device.c8y_SupportedOperations)&&(ops=device.c8y_SupportedOperations),ops}function isVendme(device){return"com_nsn_startups_vendme_VendingMachine"===device.type}function parseAvailability(device){var requiredAvailability=device&&device.c8y_RequiredAvailability,availability=device&&device.c8y_Availability,status=availability&&availability.status||(requiredAvailability?"UNKNOWN":"NOT_MONITORED");return status}function statusIcon(device){return availabilityIconMap[parseAvailability(device)].icon}function statusClass(device){return availabilityIconMap[parseAvailability(device)].cls}function lastValidMessageColor(device){return lastValidMessageIconMap[isLastValidMessage(device)].color}function lastValidMessageIcon(device){return lastValidMessageIconMap[isLastValidMessage(device)].icon}function lastValidMessageTooltip(device){return lastValidMessageIconMap[isLastValidMessage(device)].tooltipText}function isLastValidMessage(device){if(device.c8y_Availability&&device.c8y_Availability.lastMessage&&device.c8y_RequiredAvailability&&device.c8y_RequiredAvailability.responseInterval){var msInMunute=6e4,now=moment().valueOf(),lastMessage=moment(device.c8y_Availability.lastMessage).valueOf(),responseInterval=device.c8y_RequiredAvailability.responseInterval*msInMunute;return now-lastMessage-responseInterval>0}return null}function update(mo){return removeCache(mo),c8yInventory.update(mo)}function removeCache(mo){var id=mo&&mo.id||mo;_detailCached.cache&&delete _detailCached.cache[id]}function detail(mo,params){var _params=angular.extend(params||{},{withParents:!0});return c8yInventory.detail(mo,_params)}function getCount(filter){var _filter=buildFilter(filter);return c8yInventory.getCount(_filter)}function isDevice(mo){return angular.isDefined(mo[deviceFragmentType])}function model(mo){var prop=isVendme(mo)?"com_nsn_startups_vendme_fragments_VendingMachineTypeInfo":"c8y_Hardware",hardware=mo&&mo[prop];return hardware&&hardware.model}function serial(mo){var prop=isVendme(mo)?"com_nsn_startups_vendme_fragments_VendingMachineTypeInfo":"c8y_Hardware",prop2=isVendme(mo)?"serial":"serialNumber",hardware=mo&&mo[prop];return hardware&&hardware[prop2]}function availabilityTooltip(mo){var availability=mo.c8y_Availability,lastMessage=availability&&$filter("relativeDateShort")(availability.lastMessage);return lastMessage?"Last Message: "+lastMessage:"Connection not monitored"}function removeWithUser(device){return detail(device).then(function(res){var device=res.data,owner=device.owner,canBeDevice=device.c8y_IsDevice&&owner&&owner.match(/^device_/);return canBeDevice=!1,canBeDevice?c8yUser.detail(owner).then(function(res){var user=res.data,groups=c8yUser.groups(user),isDevice=_.find(groups,{name:"devices"});return isDevice?c8yUser.remove(user):c8yUser}):device}).then(function(){c8yInventory.remove(device)})}function properName(device){return device?device.name?device.name:device.id?""+device.id:"<Device has no name>":void 0}function switchResponseInterval(device){var mo={id:device.id,c8y_RequiredAvailability:{}};return 0!=device.c8y_RequiredAvailability.responseInterval&&(mo.c8y_RequiredAvailability.responseInterval=-device.c8y_RequiredAvailability.responseInterval),c8yInventory.update(mo)}var deviceFragmentType="c8y_IsDevice",availabilityIconMap={CONNECTED:{icon:"exchange",cls:"statusOk"},AVAILABLE:{icon:"check-circle",cls:"statusOk"},MAINTENANCE:{icon:"wrench",cls:"statusAlert"},UNAVAILABLE:{icon:"exclamation-circle",cls:"statusNok"},UNKNOWN:{icon:"circle",cls:"statusUnknown"},NOT_MONITORED:{icon:"circle",cls:"statusUnknown"}},lastValidMessageIconMap={"true":{icon:"check-circle",color:"green",tooltipText:"Valid"},"false":{icon:"exclamation-circle",color:"red",tooltipText:"Invalid"},"null":{icon:"circle",color:"#f3f3f3",tooltipText:"Unknown"}},_detailCached=_.memoize(detail,function(moOrId){return moOrId&&(moOrId.id||moOrId)});return angular.extend(angular.copy(c8yInventory),{list:list,save:save,update:update,detail:detail,detailCached:_detailCached,create:create,removeWithUser:removeWithUser,supportsOperation:supportsOperation,getSupportedOperations:getSupportedOperations,isVendme:isVendme,statusIcon:statusIcon,statusClass:statusClass,parseAvailability:parseAvailability,getCount:getCount,isDevice:isDevice,model:model,serial:serial,availabilityTooltip:availabilityTooltip,properName:properName,switchResponseInterval:switchResponseInterval,isLastValidMessage:isLastValidMessage,lastValidMessageColor:lastValidMessageColor,lastValidMessageTooltip:lastValidMessageTooltip,lastValidMessageIcon:lastValidMessageIcon})}]),angular.module("c8y.core").factory("c8yGeo",["$http",function($http){function geoCode(address){return $http.jsonp(geoCodeSearchUrl,{params:{format:"json",q:address}})}function Bounds(){return this.points=[],this}var geoCodeSearchUrl="//open.mapquestapi.com/nominatim/v1/search.php?json_callback=JSON_CALLBACK";return Bounds.prototype.add=function(p){this.points.push(p)},Bounds.prototype.reset=function(){this.points.length=0},Bounds.prototype.get=function(){var bounds={southWest:{},northEast:{}};return this.points.length||(bounds=null),this.points.forEach(function(p){p.lat<(bounds.southWest.lat||1/0)&&(bounds.southWest.lat=p.lat),p.lng<(bounds.southWest.lng||1/0)&&(bounds.southWest.lng=p.lng),p.lat>(bounds.northEast.lat||-(1/0))&&(bounds.northEast.lat=p.lat),p.lng>(bounds.northEast.lng||-(1/0))&&(bounds.northEast.lng=p.lng)}),bounds},{geoCode:geoCode,Bounds:Bounds}}]),angular.module("c8y.core").factory("c8yGroupTypesConfig",["c8yInventory","$q",function(c8yInventory,$q){function save(config){return config.type=type,c8yInventory.save(config)}function get(){return c8yInventory.list(filtersGet).then(getFirstOrDefault)}function getFirstOrDefault(configs){return configs.length>0?configs[0]:getDefault()}function getDefault(){return{type:type,groups:getDefaultGroupTypes()}}function getDefaultGroupTypes(){return[getDeviceGroupType()]}function getLookup(config){var configPromise=config?$q.when(config):get();return configPromise.then(_.partial(getGroupTypesConfigLookup,{}))}function getGroupTypesConfigLookup(lookup,config){return lookup=lookup||{},_.forEach(config.groups||{},function(groupConfig){
lookup[groupConfig.type]=groupConfig,lookup=getGroupTypesConfigLookup(lookup,groupConfig)}),lookup}function getDeviceGroupType(){return{type:"c8y_DeviceGroup",name:"Default Group",namePlural:"Default Groups",showInNavigator:!0,groups:[]}}function getDeviceSubgroupType(){return{type:"c8y_DeviceSubgroup",name:"Default Subgroup",namePlural:"Default Subgroups",showInNavigator:!1,groups:[]}}function getEmptyGroupType(){return{name:"",namePlural:"",type:"",showInNavigator:!1,groups:[]}}var type="c8y_GroupTypesConfig",filtersGet={type:type,pageSize:1};return{save:save,get:get,getLookup:getLookup,getDeviceGroupType:getDeviceGroupType,getDeviceSubgroupType:getDeviceSubgroupType,getEmptyGroupType:getEmptyGroupType}}]),angular.module("c8y.core").factory("c8yGroups",["$q","c8yBase","c8yInventory","c8yGroupTypesConfig",function($q,c8yBase,c8yInventory,c8yGroupTypesConfig){function getGroupItems(group){return c8yInventory.detail(group).then(c8yBase.getResData).then(getChildrenIds).then(function(childrenIds){return childrenIds.length>0?c8yInventory.list({ids:childrenIds.join(","),pageSize:childrenIds.length}):$q.when([])})}function getChildrenIds(group){var childrenIds=[];return childrenIds=childrenIds.concat(group.childAssets.references.map(getIdFromManagedObjectReference)),childrenIds=childrenIds.concat(group.childDevices.references.map(getIdFromManagedObjectReference)),$q.when(childrenIds)}function getIdFromManagedObjectReference(ref){return ref.managedObject.id}function getGroupTypeItems(groupTypeName){return c8yGroupTypesConfig.getLookup().then(function(lookup){return[lookup[groupTypeName]]}).then(getGroupsByGroupTypes)}function getTopLevelGroups(){return getTopLevelGroupTypes().then(getGroupsByGroupTypes)}function getTopLevelGroupTypes(){return c8yGroupTypesConfig.get().then(function(config){return config.groups})}function getGroupsByGroupTypes(groupTypesList){if(groupTypesList.length>0){var promises=[];return _.forEach(groupTypesList,function(groupType){promises.push(c8yInventory.list({type:groupType.type}))}),$q.all(promises).then(_.flatten)}return $q.when([])}function isGroup(mo){return!!mo.c8y_IsDeviceGroup||"c8y_DeviceGroup"===mo.type}return{getGroupItems:getGroupItems,getGroupTypeItems:getGroupTypeItems,getTopLevelGroups:getTopLevelGroups,isGroup:isGroup}}]),angular.module("c8y.core").factory("c8yIdentity",["$http","c8yBase",function($http,c8yBase){function onExternalIds(res){return res.data.externalIds}function buildUrlMo(mo){return c8yBase.url(path)+"/globalIds/"+(mo.id||mo)+"/externalIds"}function buildUrl(identity){return c8yBase.url(path)+"/externalIds/"+identity.type+"/"+identity.externalId}function createIdentity(mo,identity){var url=buildUrlMo(mo),cfg=angular.copy(defaultConfig);return $http.post(url,identity,cfg)}function deleteIdentity(identity){var url=buildUrl(identity);return $http["delete"](url)}function listExternalIds(mo){var url=buildUrlMo(mo);return $http.get(url).then(onExternalIds)}function getExternalId(identity){var url=buildUrl(identity);return $http.get(url)}var path="identity",defaultConfig={headers:c8yBase.contentHeaders("externalId")};return{createIdentity:createIdentity,deleteIdentity:deleteIdentity,listExternalIds:listExternalIds,getExternalId:getExternalId}}]),angular.module("c8y.core").factory("c8yInventory",["$http","$q","c8yBase","c8yRealtime",function($http,$q,c8yBase,c8yRealtime){function buildDetailUrl(mo){var id=mo&&(mo.id||mo);return id&&c8yBase.url(path+"/"+id)}function buildChildrenUrl(mo,type){return buildDetailUrl(mo)+"/"+type}function buildChildUrl(mo,moChild,type){var id=moChild.id||moChild;return buildChildrenUrl(mo,type)+"/"+id}function cleanFilters(filters){var _filters=filters||{},allowedWithText=["text","pageSize","currentPage","skipChildrenNames"];return _filters.text&&Object.keys(_filters).forEach(function(key){-1===allowedWithText.indexOf(key)&&delete _filters[key]}),_filters}function list(filters){var url=c8yBase.url(path),_filters=c8yBase.pageSizeFilter(cleanFilters(filters)),cfg={params:_filters},blindPaging=!0,onList=c8yBase.cleanListCallback("managedObjects",list,_filters,blindPaging);return $http.get(url,cfg).then(onList)}function detail(mo,params){var url=buildDetailUrl(mo),_params=params||{},config={params:_params};return url?$http.get(url,config):$q.reject("Managed object not valid")}function detailCached(id){return detail(id)}function detailRealtime(mo,scope){function updateListener(evt,data){mergeMoRT(data)}function mergeMoRT(_mo){moRT?angular.extend(moRT,_mo):moRT=_mo}var moRT,moId=mo.id||mo,scopeId=scope.$id,channel="/managedobjects/"+moId,op=c8yRealtime.realtimeActions().UPDATE;return c8yRealtime.addListener(scopeId,channel,op,updateListener),c8yRealtime.start(scopeId,channel),scope.$on("stopRealtime",function(){c8yRealtime.stop(scopeId,channel)}),scope.$on("$destroy",function(){c8yRealtime.stop(scopeId,channel)}),detail(moId).then(function(res){return mergeMoRT(res.data),moRT})}function remove(mo){var url=buildDetailUrl(mo);return $http["delete"](url)}function create(mo){var url=c8yBase.url(path),cfg=angular.copy(defaultConfig),data=c8yBase.cleanFields(mo,fieldsToClean);return $http.post(url,data,cfg)}function createConfirm(mo){return create(mo).then(getIdFromRes).then(detail)}function getIdFromRes(res){var regexp=new RegExp(moIdLocationRegExp),matches=res.headers("Location").match(regexp);return matches[1]}function update(mo){var url=buildDetailUrl(mo),cfg=angular.copy(defaultConfig),data=c8yBase.cleanFields(mo,fieldsToClean);return removeCache(mo),$http.put(url,data,cfg)}function save(mo){return mo.id?update(mo):create(mo)}function children(mo,type,config){var url=buildChildrenUrl(mo,type),cfg=config||{};return detailCached(mo).then(function(res){return res.data[type].references.length}).then(function(childrenCount){return cfg.params={pageSize:childrenCount},$http.get(url,cfg)})}function onChildren(res){var data=res.data;return data.references.map(function(ref){return ref.managedObject})}function childDevices(mo,config){return children(mo,"childDevices",config).then(onChildren)}function childAssets(mo,config){return children(mo,"childAssets",config).then(onChildren)}function addChild(mo,moChild,type){var url=buildChildrenUrl(mo,type),data={managedObject:moChild},cfg=angular.copy(defaultConfigReference);return $http.post(url,data,cfg)}function parents(mo,parentType,moType,moFragmentType){return detail(mo,{withParents:!0}).then(function(res){return res.data[parentType+"Parents"].references.map(function(item){return item.managedObject.id})}).then(function(parentIds){var out=[];return parentIds.length&&(out=list({ids:parentIds.join(",")}),(moType||moFragmentType)&&(out=out.then(function(mos){return mos.filter(function(mo){return moType&&mo.type===moType||moFragmentType&&angular.isDefined(mo[moFragmentType])})}))),out})}function parentsDevice(mo,moType,moFragmentType){return parents(mo,"device",moType,moFragmentType)}function parentsAsset(mo,moType,moFragmentType){return parents(mo,"asset",moType,moFragmentType)}function directParentAssets(mo,moType,moFragmentType){return directParents(mo,"asset",moType,moFragmentType)}function directParentDevices(mo,moType,moFragmentType){return directParents(mo,"device",moType,moFragmentType)}function directParents(mo,parentType,moType,moFragmentType){var childIdParamName="child"+parentType.charAt(0).toUpperCase()+parentType.slice(1)+"Id",filters={withParents:!0};return filters[childIdParamName]=mo.id,list(filters).then(function(parents){return(moType||moFragmentType)&&(parents=parents.filter(function(p){return moType&&p.type===moType||moFragmentType&&angular.isDefined(p[moFragmentType])})),parents})}function addChildDevice(mo,moChild){return addChild(mo,moChild,"childDevices")}function addChildAsset(mo,moChild){return addChild(mo,moChild,"childAssets")}function removeChild(mo,moChild,type){var url=buildChildUrl(mo,moChild,type);return $http["delete"](url)}function removeChildDevice(mo,moChild){return removeChild(mo,moChild,"childDevices")}function removeChildAsset(mo,moChild){return removeChild(mo,moChild,"childAssets")}function removeCache(mo){var id=mo&&mo.id||mo;delete _detailCached.cache[id]}function getCount(filter){return c8yBase.getCount(list,filter||{})}function getSupportedMeasurements(mo){var url=buildDetailUrl(mo)+"/supportedMeasurements";return $http.get(url).then(function(res){return res.data.c8y_SupportedMeasurements})}function supportsMeasurement(mo,measurementType){var supports;getSupportedMeasurements(mo).then(function(measurements){return supports=angular.isArray(measurements)&&measurements.indexOf(measurementType)>-1,!!supports})}function getFragments(mo){return Object.keys(c8yBase.cleanFields(mo,_.union(fieldsToClean,["id","type","name","owner","self"])))}var path="inventory/managedObjects",moIdLocationRegExp="\\/inventory\\/managedObjects\\/(\\d+)",defaultConfig={headers:c8yBase.contentHeaders("managedObject")},defaultConfigReference={headers:c8yBase.contentHeaders("managedObjectReference")},fieldsToClean=["lastUpdated","assetParents","deviceParents","childAssets","childDevices","c8y_ActiveAlarmsStatus","c8y_Availability"],_detailCached=_.memoize(detailCached,_.identity);return{list:list,detail:detail,detailCached:_detailCached,detailRealtime:detailRealtime,create:create,createConfirm:createConfirm,update:update,save:save,remove:remove,childAssets:childAssets,childDevices:childDevices,addChildAsset:addChildAsset,addChildDevice:addChildDevice,removeChildAsset:removeChildAsset,removeChildDevice:removeChildDevice,parentsAsset:parentsAsset,parentsDevice:parentsDevice,directParentAssets:directParentAssets,directParentDevices:directParentDevices,getCount:getCount,getSupportedMeasurements:getSupportedMeasurements,supportsMeasurement:supportsMeasurement,getFragments:getFragments}}]),angular.module("c8y.core").factory("c8yMeasurements",["$http","$q","c8yBase","c8yCepModule",function($http,$q,c8yBase,c8yCepModule){function buildDetailUrl(measurement){var id=measurement.id||measurement;return c8yBase.url(path)+"/"+id}function list(filters){var page_size_custom=PAGE_SIZE,url=c8yBase.url(path),_filters=c8yBase.todayFilter(angular.extend({pageSize:page_size_custom},filters||{})),cfg={params:_filters},onList=c8yBase.cleanListCallback("measurements",list,_filters);return $http.get(url,cfg).then(onList)}function listSeries(filters){var page_size_custom=PAGE_SIZE,url=c8yBase.url(path+"/series"),_filters=c8yBase.todayFilter(angular.extend({pageSize:page_size_custom},filters||{})),cfg={params:_filters},onList=function(res){return res.data},requestIndex=_.findIndex(listSeries._cacheFilter,_.partial(_.isEqual,_filters)),request=requestIndex>=0?listSeries._cacheRequest[requestIndex]:null;return request||(request=$http.get(url,cfg).then(onList),listSeries._cacheFilter.push(angular.copy(_filters)),listSeries._cacheRequest.push(request)),request}function listPaged(filters){var defer=$q.defer(),_filters=angular.extend(filters||{},{pageSize:1e3,withTotalPages:!0}),cancelled=!1,onList=function(list){var isNext=angular.isDefined(list.paging.next)&&!(list.length<_filters.pageSize);return defer.notify(list),isNext||defer.resolve(!0),cancelled?!0:isNext?list.paging.next().then(onList):!0};return angular.extend(defer.promise,{cancel:function(){cancelled=!0,defer.reject("canceled")}}),list(_filters).then(onList),defer.promise}function listSeriesPaged(filters){var defer=$q.defer(),_filters=angular.extend(filters||{},{pageSize:1e3,withTotalPages:!0}),cancelled=!1,onList=function(list){return defer.notify(list),list.paging.next||defer.resolve(!0),cancelled?!0:list.paging.next?list.paging.next().then(onList):!0};return angular.extend(defer.promise,{cancel:function(){cancelled=!0,defer.reject("canceled")}}),listSeries(_filters).then(onList),defer.promise}function detail(measurement){var url=buildDetailUrl(measurement);return $http.get(url)}function create(measurement){var url=c8yBase.url(path),data=clean(measurement),cfg=angular.copy(defaultConfig);if(!data.source)throw new Error("c8yMeasurement: source must be defined");return $http.post(url,data,cfg)}function update(measurement){var url=buildDetailUrl(measurement),data=clean(measurement),cfg=angular.copy(defaultConfig);return $http.put(url,data,cfg)}function save(measurement){return measurement.id?update(measurement):create(measurement)}function remove(measurement){var url=buildDetailUrl(measurement);return $http["delete"](url)}function activateCep(){return c8yCepModule.createOrDeploy(cepModule)}var clean=c8yBase.clean,path="measurement/measurements",defaultConfig={headers:c8yBase.contentHeaders("measurement")},cepModule={status:"DEPLOYED",name:"c8yui_measurements",body:'insert into SendNotification select measurement as payload, "c8yui/measurements" as channelName from MeasurementCreated;'},PAGE_SIZE=1440;return listSeries._cacheFilter=[],listSeries._cacheRequest=[],{list:list,listPaged:listPaged,listSeries:listSeries,listSeriesPaged:listSeriesPaged,detail:detail,create:create,update:update,save:save,remove:remove,activateCep:activateCep}}]),angular.module("c8y.core").factory("c8yNotifications",["$rootScope","$q","$timeout","c8yBase","info",function($rootScope,$q,$timeout,c8yBase,info){function newAbortConnectionTimer(){return $timeout(function(){cometd.getTransport().abort()},timeout)}function onSubscribe(msg){var subscription=getSubscriptionByMsg(msg);subscription.scope.$emit("connected"),subscription.scope.connected=!0,scopeApply()}function onMessage(scope,msg){abortConnection&&($timeout.cancel(),abortConnection=newAbortConnectionTimer()),scope.$emit("message",msg),scopeApply()}function onUnsubscribe(sub){sub.counter--,sub.counter||(cometd.unsubscribe(sub.comet),delete subscriptionMap[sub.channel],Object.keys(subscriptionMap).length||disconnect())}function disconnect(){abortConnection&&($timeout.cancel(abortConnection),abortConnection=void 0),cometd.removeListener(onSubscribeListener),cometd.disconnect()}function scopeApply(){$rootScope.$$phase||$rootScope.$apply()}function connect(){var defer=$q.defer();if(cometd.isDisconnected()){cometd.handshake();var connectListener=cometd.addListener("/meta/connect",function(){defer.resolve(!0),cometd.removeListener(connectListener)});onSubscribeListener=cometd.addListener("/meta/subscribe",onSubscribe)}else defer.resolve(!0);return defer.promise}function getSubscriptionByMsg(msg){var subscriptions=Object.keys(subscriptionMap).filter(function(sub){return msg.subscription.match(sub)});return subscriptionMap[subscriptions[0]]}function getSubscription(channel){return subscriptionMap[channel]}function subscribe(channel){var sub=getSubscription(channel)||{},created=!1;return sub.channel||(created=!0,subscriptionMap[channel]=sub,sub.channel=channel,sub.scope=$rootScope.$new(!0),sub.scope.unsubscribe=angular.bind({},onUnsubscribe,sub),sub.counter=0),sub.counter++,connect().then(function(){return created&&(sub.comet=cometd.subscribe(channel,angular.bind({},onMessage,sub.scope)),abortConnection=newAbortConnectionTimer()),sub.scope})}function configure(type){var _cfg=angular.copy("debug"===type?debugNotificationsCfg:cfg);cometd.configure(_cfg)}var abortConnection,onSubscribeListener,cometd=$.cometd,subscriptionMap={},path="cep/customnotifications",pathNotifications="cep/notifications",url=c8yBase.url(path),cfg={url:url,logLevel:"info",requestHeaders:{Authorization:"Basic "+info.token,UseXBasic:!0},appendMessageTypeToURL:!1},timeout=57e4,debugNotificationsCfg=angular.copy(cfg);return debugNotificationsCfg.url=c8yBase.url(pathNotifications),cometd.unregisterTransport("websocket"),cometd.registerExtension("acceptEmptyMessages",{incoming:function(message){void 0===message.successful&&void 0===message.data&&(message.data={message:"The output from statement was empty"})}}),cometd.configure(angular.copy(cfg)),{subscribe:subscribe,configure:configure}}]),angular.module("c8y.core").factory("c8ySettings",["$http","c8yBase",function($http,c8yBase){function buildDetailUrl(option){return c8yBase.url(path+"/"+option.category+(option.key?"/"+option.key:""))}function buildDetailUrlForReadOnly(option){return c8yBase.url(pathReadOnly+"/"+option.category+(option.key?"/"+option.key:""))}function buildDetailUrlForSystem(option){return c8yBase.url(pathSystem+"/"+option.category+(option.key?"/"+option.key:""))}function list(filters){var url=c8yBase.url(path),_filters=c8yBase.pageSizeFilter(filters),cfg={params:_filters},onList=c8yBase.cleanListCallback("options",list,_filters),promise=$http.get(url,cfg).then(onList);return filters&&filters.category&&(promise=promise.then(function(options){var filtered=options.filter(function(opt){return opt.category===filters.category});return filtered.paging=options.paging,filtered})),promise}function updateOption(option){var url=buildDetailUrl(option),data=angular.copy(option),cfg=angular.copy(config);return $http.put(url,data,cfg)}function createOption(option){var url=c8yBase.url(path),data=angular.copy(option),cfg=angular.copy(config);return $http.post(url,data,cfg)}function deleteOption(option){var url=buildDetailUrl(option);return $http["delete"](url)}function detail(option){var url="password"===option.category?buildDetailUrlForReadOnly(option):buildDetailUrl(option);return $http.get(url)}function getSystemOption(option){var url=buildDetailUrlForSystem(option);return $http.get(url)}var path="tenant/options",pathReadOnly="tenant/security-options",pathSystem="tenant/system/options",config={headers:c8yBase.contentHeaders("option")};return{list:list,detail:detail,updateOption:updateOption,createOption:createOption,deleteOption:deleteOption,getSystemOption:getSystemOption}}]),angular.module("c8y.core").factory("c8yStatement",["$http","$q","$timeout","c8yBase",function($http,$q,$timeout,c8yBase){function clean(statement){return statement=angular.copy(statement),delete statement.id,delete statement.module,statement}function isDefaultModule(module){return"default"===module.name}function toId(id){return angular.isObject(id)?id.id:id}function buildStatementUrl(id){return c8yBase.url(path+"/"+defaultModule.id+"/statements"+(id?"/"+toId(id):""))}function ensureDefaultModule(callback){return function(param){var success,fail,deferred=$q.defer();return deferred.promise.then(function(){callback(param).success(success).error(fail)}),defaultModule?deferred.resolve():$http.get(c8yBase.url(path)).success(function(modules){for(var idx in modules.modules){var module=modules.modules[idx];if(isDefaultModule(module))return defaultModule=module,void deferred.resolve()}$http.post(c8yBase.url(path),{name:"default"},moduleConfig()).success(function(module){defaultModule=module,deferred.resolve()})}),{then:function(s,e){success=s,fail=e},success:function(s){return success=s,this},error:function(e){return fail=e,this}}}}var defaultModule,exports={},path="cep/modules",moduleConfig=function(){return c8yBase.requestConfig("cepModule","cepModule")},statementConfig=function(){return c8yBase.requestConfig("cepStatement","cepStatement")},examples=[{name:"select temperate readings over 100 degree",value:'select * from MeasurementCreated e\nwhere getNumber(e, "c8y_TemperatureMeasurement.T.value") > 100'},{name:"create alarm when temperature over 100 degree",value:'insert into CreateAlarm \n  select\n    e.measurement.time as time,\n    e.measurement.source.value as source,\n    "com_cumulocity_TemperatureAlert" as type,\n    "Temperature too high" as text,\n    "ACTIVE" as status,\n    "CRITICAL" as severity\n  from MeasurementCreated e\n  where getNumber(e, "c8y_TemperatureMeasurement.T.value") > 100'},{name:"create alarm when temperature below 0 degree",value:'insert into CreateAlarm \n  select\n    e.measurement.time as time,\n    e.measurement.source.value as source,\n    "com_cumulocity_TemperatureAlert" as type,\n    "Temperature too low" as text,\n    "ACTIVE" as status,\n    "CRITICAL" as severity\n  from MeasurementCreated e\n  where getNumber(e, "c8y_TemperatureMeasurement.T.value") > 100'},{name:"create close replay operation when temperature readings over 100 degree",value:'insert into CreateOperation\n  select\n    "PENDING" as status,\n    «heating ID» as deviceId\n    {\n      "c8y_Relay.relayState", "CLOSED"\n    } as fragments\n  from MeasurementCreated e\n  where getNumber(e, "c8y_TemperatureMeasurement.T.value") > 100'},{name:"select location change event once for 60 seconds",value:'select * from EventCreated e\nwhere getObject(e, "c8y_LocationMeasurement") is not null\noutput first every 60 seconds'},{name:"send email notification with current temperature",value:'expression string js:prepareEmailText(temp, state) [\n    function format(text, params){\n            for(param in params) {\n                text = text.replace("{" + param + "}", params[param])\n            }\n        return text\n    }\n    format("Hello,\\n current temperature is {0} (state = {1}). Regards.", [temp, state])\n]\ninsert into SendEmail\nselect\n  "sender@sender" as sender,\n  "receiver@receiver" as receiver,\n  "Temperature critical!" as subject,\n  prepareEmailText(\n    getNumber(e, "c8y_TemperatureMeasurement.T.value"),\n    getString(e, "c8y_TemperatureMeasurement.T.state")\n   ) as text\nfrom MeasurementCreated e'},{name:"change the severities of alarms based on activity time",value:'/* Create "context" - definition of a group of events to be processed separately.\n * Context "Alarms" consists of AlarmCreated and AlarmUpdated: \n * with the same source and type = "power off". */\ncreate context Alarms partition by \nalarm.source from AlarmCreated(alarm.type = "power off"),\nalarm.source from AlarmUpdated(alarm.type = "power off");\n\n/* Update severity for all active AlarmCreated \n * after which there is no change to other status in 15 minutes. */\ncontext Alarms \ninsert into UpdateAlarm \nselect \n   a.alarm.id as id,\n   "MAJOR" as severity\nfrom pattern [\n   every a = AlarmCreated(alarm.status = CumulocityAlarmStatuses.ACTIVE) \n   -> (timer:interval(15 minutes) \n      and not AlarmUpdated(alarm.status != CumulocityAlarmStatuses.ACTIVE))\n];'}];return exports.list=ensureDefaultModule(function(filters){return $http.get(c8yBase.url(path+"/"+defaultModule.id+"/statements"),filters)}),exports.detail=ensureDefaultModule(function(id){return $http.get(buildStatementUrl(id))}),exports.remove=ensureDefaultModule(function(statement){return $http["delete"](buildStatementUrl(statement.id))}),exports.save=ensureDefaultModule(function(statement){var request,id=statement.id;return request=id?$http.put(buildStatementUrl(id),clean(statement),statementConfig()):$http.post(buildStatementUrl(),clean(statement),statementConfig())}),exports.examples=function(){return{success:function(callback){$timeout(function(){callback(examples)})}}},exports}]),angular.module("c8y.core").factory("c8yStatistics",["c8yBase","$http",function(c8yBase,$http){function getSummary(params){var url=c8yBase.url(path+"/summary"),cfg={params:params};return $http.get(url,cfg)}function list(filters){var url=c8yBase.url(path+"/allTenantsSummary"),cfg={params:c8yBase.timeOrderFilter(c8yBase.pageSizeNoTotalFilter(filters))};return $http.get(url,cfg).then(c8yBase.getResData)}var path="tenant/statistics";return{getSummary:getSummary,list:list}}]),angular.module("c8y.core").factory("c8yUser",["$http","$q","$timeout","c8yBase","info","c8yAuth",function($http,$q,$timeout,c8yBase,info,c8yAuth){function applyTenant(url,tenant){return url.replace(/{tenant}/g,tenant)}function clean(user){return user=angular.copy(user),user.id&&delete user.userName,delete user.id,delete user.self,delete user.effectiveRoles,user}function buildUserUrl(user){var _id=user.id||user;return buildUsersUrl().then(function(url){return url+"/"+_id})}function buildCurrentUserUrl(){return $q.when(c8yBase.url(currentUserPath))}function buildUsersUrl(){return current().then(function(user){return c8yBase.url(applyTenant(path,user.tenant))})}function getTenantFromSelf(url){var FIND_TENANT=/\/user\/(\w+)\//,match=url.match(FIND_TENANT);if(match.length<2)throw new Error("Cannot find tenant on user self URL");return match[1]}function current(forceUpdate){var output,url=currentUserPath,cfg=angular.copy(configCurrentUser);return forceUpdate&&(currentUser=null),output=currentUser&&!angular.isFunction(currentUser.then)?$q.when(currentUser):currentUser=currentUser||$http.get(c8yBase.url(url),cfg).then(function(res){return currentUser=res.data,currentUser.tenant=getTenantFromSelf(currentUser.self),currentUser})["catch"](function(){return currentUser=null,$q.reject()})}function list(filter){var _filter=c8yBase.pageSizeFilter(filter),cfg={params:_filter},onList=c8yBase.cleanListCallback("users",list,_filter);return buildUsersUrl().then(function(url){return $http.get(url,cfg).then(onList)})}function detail(user,silentError){var cfg={silentError:!!silentError};return buildUserUrl(user).then(function(url){return $http.get(url,cfg)})}function detailCurrent(){var url=c8yBase.url(currentUserPath),cfg=angular.copy(configCurrentUser);return $http.get(url,cfg)}function remove(user){return buildUserUrl(user).then(function(url){return $http["delete"](url)})}function create(user){var data=clean(user),cfg=angular.copy(config);return buildUsersUrl().then(function(url){return $http.post(url,data,cfg)})}function update(user,isCurrent){var data=clean(user),cfg=angular.copy(config),url=isCurrent?buildCurrentUserUrl():buildUserUrl(user);return url.then(function(url){return $http.put(url,data,cfg)})}function save(user){var action=user.id?update(user):create(user);return action.then(function(){updateToken(user)}),action}function saveCurrent(user){return update(user,!0).then(function(){updateToken(user)})}function updateToken(user){checkIfCurrent(user).then(function(isCurrent){isCurrent&&c8yAuth.updatePassword(getPassword(user))})}function checkIfCurrent(user){var userId=user.id||user;return current().then(function(currentUser){return $q.when(currentUser.id===userId)})}function getPassword(user){var token=c8yAuth.decodeToken(info.token);return user.password||token.password}function isCurrentPassword(password){var token=c8yAuth.decodeToken(info.token);return token.password===password}function groups(user){var _groups=user.groups&&user.groups.references||[];return _groups.map(function(ref){return ref.group})}function isDeviceUser(user){return user.id.match(/^device_/)}function hasRole(user,roleId){var result=hasRoleInUser(user,roleId);return result||(result=hasRoleInGroups(user,roleId)),result}function hasRoleInUser(user,roleId){var result=!1;return user.roles&&user.roles.references&&angular.forEach(user.roles.references,function(ref){ref.role.id===roleId&&(result=!0)}),result}function hasRoleInGroups(user,roleId){var result=!1;return user.groups&&user.groups.references&&angular.forEach(user.groups.references,function(groupRef){angular.forEach(groupRef.group.roles.references,function(roleRef){roleRef.role.id===roleId&&(result=!0)})}),result}function getDevicePermissions(user,deviceId){var _filter=c8yBase.pageSizeFilter({moId:deviceId}),cfg={params:_filter};return buildUserUrl(user).then(function(url){return $http.get(url+"/devicePermissions",cfg)})}function login(tenant,username,password,remember){return $q.when(getToken(tenant,username,password)).then(_.partial(confirmToken,remember))}function logout(){currentUser=null}function getToken(tenant,username,password){return btoa((tenant?tenant+"/":"")+username+":"+password)}function confirmToken(remember,_token){info.token=_token;var user;return $http.get(c8yBase.url(currentUserPath),{headers:getHeaders(_token)}).then(function(res){info.token=_token,setToken(_token,remember),user=res.data}).then(angular.noop,function(){getToken()&&deleteToken()}).then(function(){return user})}function setToken(_token,remember){remember?window.localStorage.setItem("_tcy8",_token):window.sessionStorage.setItem("_tcy8",_token)}function deleteToken(){return window.localStorage.removeItem("_tcy8")}function isAdmin(user){var admin=_.some(user.groups.references,function(ref){return"admins"===ref.group.name});return admin}function getHeaders(_token){var t=_token||TOKEN;return{Authorization:"Basic "+t,UseXBasic:!0,Accept:"application/vnd.com.nsn.cumulocity.user+json;"}}var path="user/{tenant}/users",currentUserPath="user/currentUser",currentUser=null,config={headers:c8yBase.contentHeaders("user",!0)},configCurrentUser={headers:c8yBase.contentHeaders("user",!0)};return{current:current,checkIfCurrent:checkIfCurrent,list:list,detail:detail,detailCurrent:detailCurrent,remove:remove,save:save,saveCurrent:saveCurrent,groups:groups,isDeviceUser:isDeviceUser,hasRole:hasRole,getDevicePermissions:getDevicePermissions,login:login,logout:logout,isAdmin:isAdmin,isCurrentPassword:isCurrentPassword}}]),angular.module("c8y.core").factory("c8yUserGroup",["$http","$q","c8yBase","c8yUser",function($http,$q,c8yBase,c8yUser){function buildGroupsUrl(){return c8yUser.current().then(function(user){var tenant=user.tenant;return c8yBase.url(basePath+tenant+"/groups")})}function buildRolesUrl(){return $q.when(c8yBase.url(basePath+"roles"))}function buildGroupUrl(group){var groupId=group.id||group;return c8yUser.current().then(function(user){var tenant=user.tenant;return c8yBase.url(basePath+tenant+"/groups/"+groupId)})}function buildGroupUsersUrl(group,user){return buildGroupUrl(group).then(function(url){return url+"/users"+(user?"/"+(user.id||user):"")})}function buildGroupRolesUrl(group){return buildGroupUrl(group).then(function(url){return url+"/roles"})}function buildGroupRoleUrl(group,role){var roleId=role.id||role;return buildGroupRolesUrl(group).then(function(url){return url+"/"+roleId})}function list(filters){var _filter=c8yBase.pageSizeFilter(filters),cfg={params:_filter},onList=c8yBase.cleanListCallback("groups",list,_filter);return buildGroupsUrl().then(function(url){return $http.get(url,cfg).then(onList)})}function detail(group){return buildGroupUrl(group).then(function(url){return $http.get(url)})}function remove(group){return buildGroupUrl(group).then(function(url){return $http["delete"](url)})}function update(group){var cfg={headers:c8yBase.contentHeaders("group")};return buildGroupUrl(group).then(function(url){return $http.put(url,group,cfg).then(function(){return group})})}function create(group){var cfg={headers:c8yBase.contentHeaders("group")};return buildGroupsUrl().then(function(url){return $http.post(url,group,cfg).then(function(res){var location=res.headers("location"),id=location.match(/\d+$/)[0];return detail(id).then(function(res){return res.data})})})}function save(group){return group.id?update(group):create(group)}function listRoles(filters){var _filter=c8yBase.pageSizeFilter(filters),cfg={params:_filter,cache:!0},onList=c8yBase.cleanListCallback("roles",listRoles,_filter);return buildRolesUrl().then(function(url){return $http.get(url,cfg).then(onList)})}function findRole(roleId){return listRoles().then(function(roles){var selRole;return roles.forEach(function(role){return role.id===roleId?(selRole=role,!1):void 0}),selRole})}function addUserToGroup(group,user){var data={user:user};return buildGroupUsersUrl(group).then(function(url){return $http.post(url,data)})}function removeUserFromGroup(group,user){return buildGroupUsersUrl(group,user).then(function(url){return $http["delete"](url)})}function updateGroups(user,groupIds){var references=user&&user.groups&&user.groups.references||[],userGroupsIds=references.map(function(ref){return ref.group.id}),actions=[];return groupIds.forEach(function(groupId){-1===userGroupsIds.indexOf(groupId)&&actions.push(addUserToGroup(groupId,user))}),userGroupsIds.forEach(function(groupId){-1===groupIds.indexOf(groupId)&&actions.push(removeUserFromGroup(groupId,user))}),$q.all(actions)}function addRoleToGroup(group,role){var cfg={headers:c8yBase.contentHeaders("roleReference")};return buildGroupRolesUrl(group).then(function(url){return $http.post(url,{role:role},cfg)})}function removeRoleFromGroup(group,role){return buildGroupRoleUrl(group,role).then(function(url){return $http["delete"](url)})}function updateRoles(group,roleIds){
var groupRoleIds=group.roles.references.map(function(ref){return ref.role.id}),actions=[];return roleIds.forEach(function(roleId){-1===groupRoleIds.indexOf(roleId)&&actions.push(findRole(roleId).then(function(role){return addRoleToGroup(group,role)}))}),groupRoleIds.forEach(function(roleId){-1===roleIds.indexOf(roleId)&&actions.push(removeRoleFromGroup(group,roleId))}),$q.all(actions)}var basePath="user/";return{list:list,detail:detail,remove:remove,create:create,update:update,save:save,listRoles:listRoles,updateGroups:updateGroups,updateRoles:updateRoles}}]),angular.module("c8y.core").factory("c8yRealtime",["$http","$rootScope","$timeout","c8yBase","info",function($http,$rootScope,$timeout,c8yBase,info){function initConnection(){cometd.isDisconnected()&&!restartConnection&&(disconnecting?restartConnection=function(){cometd.handshake()}:cometd.handshake())}function newAbortConnectionTimer(){return $timeout(function(){cometd.getTransport().abort()},timeout)}function subscribe(channel){if(cometd.isDisconnected())return initConnection(),void subscriptionQueue.push(channel);var subObj=cometd.subscribe(channel,function(msg){var scope=subscriptionMap[channel].scope;scope.$emit(msg.data.realtimeAction,msg.data.data),abortConnection&&($timeout.cancel(),abortConnection=newAbortConnectionTimer()),apply()});return abortConnection=newAbortConnectionTimer(),subscriptionMap[channel].subObj||(subscriptionMap[channel].subObj=subObj),subObj}function unsubscribe(subObj){subObj&&cometd.unsubscribe(subObj)}function apply(){$rootScope.$$phase||$rootScope.$apply()}function switchRealtime(id,channel){subscriptionMap[channel].subscribers[id].active?stop(id,channel):start(id,channel)}function getIcon(status){return icons[status]}function getSubscriptionMap(){return subscriptionMap}function getRealtimeActions(){return realtimeActions}function getStatus(id,channel){var channelObj=subscriptionMap[channel];if(void 0===channelObj)return!1;var subscriber=channelObj.subscribers[id];return subscriber&&subscriber.hasOwnProperty("active")?subscriber.active:!1}function removeSubscriber(id,channel){if(getStatus(id,channel)===!1)throw new Error('There is no listener registered for your scope on the channel "'+channel+'"');stop(id,channel),delete subscriptionMap[channel].subscribers[id],0===Object.keys(subscriptionMap[channel].subscribers).length&&(subscriptionMap[channel].scope.$destroy(),delete subscriptionMap[channel])}function init(id,channel){subscriptionMap[channel]||(subscriptionMap[channel]={scope:$rootScope.$new(!0),subscribers:{},activeSubscribers:0,subObj:void 0,ready:!1}),subscriptionMap[channel].subscribers[id]={listeners:[],unreg:void 0}}function addListener(id,channel,watch,func){subscriptionMap[channel]&&subscriptionMap[channel].subscribers[id]||init(id,channel),subscriptionMap[channel].subscribers[id].listeners.push({watch:watch,func:func})}function start(id,channel){if(void 0===subscriptionMap[channel])throw new Error('There is no listener registered for your scope on the channel "'+channel+'"');var scope=subscriptionMap[channel].scope,listeners=subscriptionMap[channel].subscribers[id].listeners,unreg=[];for(var listener in listeners)unreg.push({watch:listeners[listener].watch,func:scope.$on(listeners[listener].watch,listeners[listener].func)});subscriptionMap[channel].subscribers[id].unreg=unreg,subscriptionMap[channel].subscribers[id].active=!0,0===subscriptionMap[channel].activeSubscribers?subscribe(channel):subscriptionMap[channel].ready&&scope.$emit(id+"-subscribed"),subscriptionMap[channel].activeSubscribers++}function stop(id,channel){var unsub,scope=subscriptionMap[channel].scope,unreg=subscriptionMap[channel].subscribers[id].unreg;void 0!==unreg&&unreg.forEach(function(element){element.watch===id+"-unsubscribed"?unsub=element.func:element.func()}),unsub&&(scope.$emit(id+"-unsubscribed"),unsub()),subscriptionMap[channel].subscribers[id].unreg=void 0,subscriptionMap[channel].subscribers[id].active=!1,subscriptionMap[channel].activeSubscribers--,subscriptionMap[channel].activeSubscribers<=0&&(subscriptionMap[channel].subObj&&(unsubscribe(subscriptionMap[channel].subObj),subscriptionMap[channel].subObj=void 0,subscriptionMap[channel].ready=!1),subscriptionMap[channel].activeSubscribers=0)}function destroySubscription(id,channel){getStatus(id,channel)===!0&&removeSubscriber(id,channel)}var abortConnection,disconnecting,restartConnection,lastConnect,path="cep/realtime",config={url:c8yBase.url(path),logLevel:"info",requestHeaders:{Authorization:"Basic "+info.token,UseXBasic:!0},appendMessageTypeToURL:!1},timeout=57e4,overallSubscriptions=0,subscriptionQueue=[],cometd=new $.Cometd,icons={},subscriptionMap={},realtimeActions={CREATE:"CREATE",UPDATE:"UPDATE",DELETE:"DELETE"},bus=$rootScope.$new(!0);return icons[!0]="check-circle-o",icons[!1]="circle-o",cometd.unregisterTransport("websocket"),cometd.configure(config),cometd.addListener("/meta/connect",function(data){subscriptionQueue.forEach(function(s){subscribe(s)}),subscriptionQueue.length=0,data.successful?(lastConnect&&bus.$emit("connect",{fromLastConnect:moment().diff(lastConnect,"seconds")}),lastConnect=moment()):bus.$emit("connectfailure",data)}),cometd.addListener("/meta/disconnect",function(){disconnecting=!1,"function"==typeof restartConnection&&(restartConnection(),restartConnection=void 0)}),cometd.addListener("/meta/subscribe",function(msg){if(msg.successful){var scope=subscriptionMap[msg.subscription].scope,subscribers=subscriptionMap[msg.subscription].subscribers;subscriptionMap[msg.subscription].ready=!0,overallSubscriptions++;for(var id in subscribers)subscribers[id].active&&scope.$emit(id+"-subscribed");apply()}else cometd.isDisconnected()||0!==overallSubscriptions||(cometd.disconnect(),disconnecting=!0)}),cometd.addListener("/meta/unsubscribe",function(){overallSubscriptions--,cometd.isDisconnected()||0!==overallSubscriptions||(abortConnection&&($timeout.cancel(abortConnection),abortConnection=void 0),cometd.disconnect(),disconnecting=!0)}),{start:start,stop:stop,bus:function(){return bus},addListener:addListener,removeSubscriber:removeSubscriber,switchRealtime:switchRealtime,icon:getIcon,getStatus:getStatus,realtimeActions:getRealtimeActions,destroySubscription:destroySubscription,getSubscriptionMap:getSubscriptionMap}}]),angular.module("c8y.core").factory("c8ySimulator",["$http","c8yBase",function($http,c8yBase){function list(){var simulatorUrl=c8yBase.url(configPath);return $http.get(simulatorUrl).then(c8yBase.getResData)}function changeState(simulator,newstate){var id=simulator.id||simulator,url=c8yBase.url(configPath+"/"+id),data={state:newstate},cfg=angular.copy(defaultConfigSimulator);return $http.put(url,data,cfg)}function deleteSimulator(simulator){var id=simulator.id||simulator,url=c8yBase.url(configPath+"/"+id),cfg=angular.copy(defaultConfigSimulator);return $http["delete"](url,cfg)}function getSensors(){var sensorsUrl=c8yBase.url(sensorsPath);return $http.get(sensorsUrl).then(c8yBase.getResData)}function createTemplate(template){var url=c8yBase.url(templatePath),data=angular.copy(template),cfg=angular.copy(defaultConfigTemplate);return $http.post(url,data,cfg)}function createSimulator(simulator){var url=c8yBase.url(configPath),data=angular.copy(simulator),cfg=angular.copy(defaultConfigSimulator);return $http.post(url,data,cfg)}var templatePath="simulator/templates",configPath="simulator/configurations",sensorsPath=templatePath+"/sensors",defaultConfigSimulator={headers:c8yBase.contentHeaders("simulator","simulator")},defaultConfigTemplate={headers:c8yBase.contentHeaders("template","template")};return{list:list,changeState:changeState,deleteSimulator:deleteSimulator,createSimulator:createSimulator,createTemplate:createTemplate,getSensors:getSensors}}]),angular.module("c8y.core").factory("c8yKpi",["$q","c8yInventory","c8yMeasurements","c8yDevices","c8yUser","c8yBase","c8yAlert","c8yBatchOp",function($q,c8yInventory,c8yMeasurements,c8yDevices,c8yUser,c8yBase,c8yAlert,c8yBatchOp){function list(){return c8yInventory.list({fragmentType:FRAG}).then(filterOld)}function listByIds(ids){return list().then(function(kpis){return ids&&ids.length?_.filter(kpis,function(kpi){return ids.indexOf(kpi.id)>-1}):kpis})}function isPureKpi(mo){var allowedKeys=["assetParents",FRAG,"childAssets","childDevices","deviceParents","id","lastUpdated","owner","self"],keys=Object.keys(mo);return _.every(keys,function(key){return allowedKeys.indexOf(key)>-1})}function filterOld(managedObjects){var defer=$q.defer(),oldDevices=_.filter(managedObjects,function(mo){return!isPureKpi(mo)&&!mo.c8y_Kpi_Migrated}),standaloneKpi=_.pluck(_.filter(managedObjects,isPureKpi,FRAG));if(oldDevices.length){var modal,kpisToCreate=_.map(_.reduce(_.flatten(_.pluck(oldDevices,FRAG)),_.partial(uniqueKpi,standaloneKpi),[]),function(k){var mo={};return mo[FRAG]=k,_.partial(c8yInventory.save,mo)}),devicesWithKpi=_.map(oldDevices,function(dev){return _.partial(migrateKpi,dev)}),ops=_.flatten([kpisToCreate,devicesWithKpi]),promise=$q.when();c8yUser.current().then(function(user){c8yUser.hasRole(user,"ROLE_INVENTORY_ADMIN")&&(modal=c8yBatchOp.run(ops,"Migrating KPIs to new data model"),promise=modal.result.then(function(result){return"complete"===result?list():void c8yAlert.danger("Failed to migrate KPIs to new data model!")}))}),defer.resolve(promise)}else defer.resolve(_.filter(managedObjects,isPureKpi));return defer.promise}function matchKpi(list,kpi){return _.find(list,function(k){return k.fragment===kpi.fragment&&k.series===kpi.series&&k.unit===kpi.unit&&k.label===kpi.label})}function uniqueKpi(existingList,list,kpi){var found=matchKpi(existingList,kpi)||matchKpi(list,kpi);return!found&&kpi.fragment&&kpi.series&&list.push(kpi),list}function migrateKpi(managedObject){var mo={id:managedObject.id,c8y_Kpi_Migrated:!0};return c8yInventory.save(mo)}function detail(id){return c8yInventory.detail(id).then(function(res){var data=res.data.c8y_Kpi;return _.forEach(FLOAT_FIELDS,function(field){angular.isDefined(data[field])&&(data[field]=parseFloat(data[field]),isNaN(data[field])&&delete data[field])}),res})}function deviceSeriesList(deviceId){var from=moment().subtract(1,"month").format(c8yBase.dateFormat),aggregation="DAILY";return c8yMeasurements.listSeries({source:deviceId,dateFrom:from,aggregationType:aggregation}).then(function(obj){return _.map(obj.series,function(def){return{fragment:def.type,series:def.name}})})}function listKpiForDevice(device){var deviceId=device.id||device;return $q.all([list(),deviceSeriesList(deviceId)]).then(function(promises){var kpis=promises[0],series=promises[1],matchKpi=_.filter(kpis,function(k){return _.find(series,{fragment:k.c8y_Kpi.fragment,series:k.c8y_Kpi.series})}),nonKpiSeries=_.filter(series,function(s){return!_.find(kpis,function(k){return k.c8y_Kpi.fragment===s.fragment&&k.c8y_Kpi.series===s.series})});return{matchKpi:matchKpi,nonKpiSeries:nonKpiSeries}})}function onMeasurement(kpi,measurement){var data=(measurement||{})[kpi.fragment]||{};return data.kpi=kpi,data.time=(measurement||{}).time,data.source=(measurement||{}).source,data}function getMeasurement(_kpi,device,overRidePageSize){var kpi=_kpi.c8y_Kpi||_kpi;return c8yMeasurements.list(angular.extend(c8yBase.timeOrderFilter(),{revert:!0,fragmentType:kpi.fragment,source:device,pageSize:overRidePageSize||10})).then(function(measurements){return _.find(measurements,function(m){var frag=m[_kpi.fragment];return frag&&angular.isDefined(frag[_kpi.series])})}).then(_.partial(onMeasurement,kpi))}var FRAG="c8y_Kpi",FLOAT_FIELDS=["target","min","max","yellowRangeMin","yellowRangeMax","redRangeMin","redRangeMax"];return{list:list,listByIds:listByIds,detail:detail,remove:c8yInventory.remove,save:c8yInventory.save,listKpiForDevice:listKpiForDevice,getMeasurement:getMeasurement}}]),angular.module("c8y.core").factory("c8yDeviceShell",["$http","$q","c8yBase",function($http,$q,c8yBase){function getCommandTemplatesForDeviceType(deviceType){var url=getCommandTemplatesUrl(deviceType);return $http.get(url).then(c8yBase.getResData).then(_.partial(extractCommandTemplatesFromData,deviceType))}function getCommandTemplatesUrl(deviceType){var commandTemplatesBaseUrl="/apps/c8ydata/devicecommands/";return commandTemplatesBaseUrl+deviceType+".json"}function extractCommandTemplatesFromData(deviceType,data){var templates;return templates=angular.isArray(data)?_.chain(data).map(function(d){return getExtendedTemplates(d.templates,d.syntax,deviceType)}).flatten().value():getExtendedTemplates(data.templates,data.syntax,deviceType),$q.when(templates)}function getExtendedTemplates(templates,syntax,deviceType){return _.map(templates||[],function(t){return angular.extend(t,{syntax:syntax,deviceType:deviceType})})}return{getCommandTemplatesForDeviceType:getCommandTemplatesForDeviceType}}]),function(){function c8yUtil(c8yBase){function dateToString(date){return date&&moment(date).format(c8yBase.dateFormat)}function stringToDate(date){return date&&moment(date).toDate()}return{dateToString:dateToString,stringToDate:stringToDate}}angular.module("c8y.core").factory("c8yUtil",["c8yBase",c8yUtil])}(),angular.module("c8y.core").factory("c8ySystem",["$http","$q","c8yBase","$window",function($http,$q,c8yBase,$window){function getBackendVersion(){var url=c8yBase.url(path);return $http.get(url).then(c8yBase.getResData)}function getUIVersion(){return $q.when($window.UI_VERSION||"dev")}var path="tenant/system/options/system/version";return{getBackendVersion:getBackendVersion,getUIVersion:getUIVersion}}]),function(){function c8yRetentions($http,$q,c8yBase){function list(filters){var url=c8yBase.url(path);filters=c8yBase.pageSizeFilter(filters);var cfg={params:filters,silentError:!0},onList=c8yBase.cleanListCallback("retentionRules",list,filters);return $http.get(url,cfg).then(onList,$q.reject)}function detail(ro){var url=buildDetailUrl(ro);return url?$http.get(url):$q.reject("Retention rule object is not valid")}function create(ro){var url=c8yBase.url(path);return $http.post(url,ro,defaultConfig)}function update(ro){var url=buildDetailUrl(ro);return $http.put(url,ro,defaultConfig)}function save(ro){return ro.id?update(ro):create(ro)}function remove(ro){var url=buildDetailUrl(ro);return url?$http["delete"](url):$q.reject("Retention rule object is not valid")}function buildDetailUrl(ro){var id=ro&&ro.id||ro;if(id)return c8yBase.url(path+"/"+id)}var path="retention/retentions",defaultConfig={headers:{"Content-Type":"application/json"}},dataTypes=["ALARM","EVENT","MEASUREMENT","OPERATION","AUDIT","*"];return{list:list,detail:detail,create:create,update:update,save:save,remove:remove,dataTypes:dataTypes}}angular.module("c8y.core").factory("c8yRetentions",["$http","$q","c8yBase",c8yRetentions])}(),function(){function c8yBaseUrl(info){function link(scope,elem,attrs){info.baseUrl=attrs.c8yBaseUrl}return{restrict:"A",link:link}}angular.module("c8y.core").directive("c8yBaseUrl",["info",c8yBaseUrl])}(),function(){function c8yLogin(c8yCumulocity){function link(scope,elem){elem.bind("click",function(){c8yCumulocity.login(scope.tenant(),scope.user(),scope.password(),scope.remember()).then(scope.onSuccess)["catch"](scope.onFailure)})}return{restrict:"A",link:link,scope:{tenant:"&",user:"&",password:"&",remember:"&",onSuccess:"&",onFailure:"&"}}}angular.module("c8y.core").directive("c8yLogin",["c8yCumulocity",c8yLogin])}(),function(){function c8yLogout(c8yCumulocity){function link(scope,elem){elem.bind("click",function(){c8yCumulocity.logout(),scope.ngClick()})}return{priority:1,terminal:!0,restrict:"A",link:link,scope:{ngClick:"&"}}}angular.module("c8y.core").directive("c8yLogout",["c8yCumulocity",c8yLogout])}(),function(){function c8yRepeat($injector,$compile,$rootScope){function compile(elem,attrs){function replaceWithNgRepeat(){var regex=/^\s*([^\s]+)\s*in\s*([^\s]+)\s*/,matches=regex.exec(attrs.c8yRepeat),varName=matches[1];serviceName=matches[2],elem.removeAttr("c8y-repeat"),elem.removeAttr("data-c8y-repeat"),elem.attr("ng-repeat",varName+" in __c8y_serviceResult track by "+varName+".id"),ngRepeatLink=$compile(elem)}var serviceName,ngRepeatLink;return replaceWithNgRepeat(),function(scope,elem,attrs,ctrl,transcludeFn){function assignRefreshFunction(){scope.refresh=fetchResults}function fetchResults(){$rootScope.c8y&&$rootScope.c8y.user&&callService().then(function(result){parentScope.__c8y_serviceResult=result})}function callService(){var filter=scope.filter||{};switch(serviceName){case"inventory":return $injector.get("c8yInventory").list(filter).then(function(res){return res.data});default:return $injector.get("c8y"+capitalize(serviceName)).list(filter)}}function capitalize(s){return s[0].toUpperCase()+s.slice(1)}function init(){parentScope=scope.$parent,ngRepeatLink(parentScope),assignRefreshFunction(),$rootScope.$on("c8y.api.login",function(){fetchResults()}),scope.$watch("filter",fetchResults,!0)}var parentScope;init()}}return{restrict:"A",compile:compile,transclude:!1,scope:{filter:"=?",refresh:"=?"}}}angular.module("c8y.core").directive("c8yRepeat",["$injector","$compile","$rootScope",c8yRepeat])}();
//# sourceMappingURL=main.js.map